#!/bin/bash

# Assume these packages are installed:
#  dnf install atlas blas lapack gsl gsl-devel openblas openblas-threads

# Assume these archive files are present:
export LAPACK_VERSION=3.12.0
export SUITESPARSE_VERSION=7.7.0
export ARPACK_NG_VERSION=3.9.1
export FFTW_VERSION=3.3.10
export QRUPDATE_VERSION=1.1.2
export OCTAVE_VERSION=9.1.0
export SEDUMI_VERSION=1.3.8
export YALMIP_VERSION=R20230622
for file in lapack-$LAPACK_VERSION".tar.gz" \
            SuiteSparse-$SUITESPARSE_VERSION".tar.gz" \
            arpack-ng-$ARPACK_NG_VERSION".tar.gz" \
            fftw-$FFTW_VERSION".tar.gz" \
            qrupdate-$QRUPDATE_VERSION".tar.gz" \
            octave-$OCTAVE_VERSION".tar.lz" \
            sedumi-$SEDUMI_VERSION".tar.gz" \
            YALMIP-$YALMIP_VERSION".tar.gz" ; 
do 
  cp -f /usr/local/src/octave/$file . ; 
done

# Disable CPU frequency scaling:
 for c in `seq 0 7` ; do
   echo "4500000">/sys/devices/system/cpu/cpu$c/cpufreq/scaling_min_freq ;
   echo "performance">/sys/devices/system/cpu/cpu$c/cpufreq/scaling_governor ;
 done ; 

# Show system information
uname -r
grep -m1 -A7 vendor_id /proc/cpuinfo
sudo cpupower -c all frequency-info
dnf list installed kernel* gcc* atlas* openblas* gsl* blas* lapack* \
    | grep -Ev metadata | awk '{print $1 "\t\t" $2}'

# Build local versions of the lapack and blas libraries
export LOCAL_PREFIX=`pwd`
source ./build-lapack.sh

# Build local versions of the other libraries used by octave
export LAPACK_DIR=$LOCAL_PREFIX/lapack/generic/lapack-$LAPACK_VERSION
export LD_LIBRARY_PATH=$LOCAL_PREFIX"/lib:"$LAPACK_DIR
source ./build-other-libs.sh

# Common octave configure options
export OCTAVE_CONFIG_OPTIONS=" \
       --disable-docs \
       --disable-java \
       --without-fltk \
       --without-qt \
       --without-sndfile \
       --without-portaudio \
       --without-magick \
       --without-glpk \
       --without-hdf5 \
       --with-arpack-includedir=$LOCAL_PREFIX/include \
       --with-arpack-libdir=$LOCAL_PREFIX/lib \
       --with-qrupdate-includedir=$LOCAL_PREFIX/include \
       --with-qrupdate-libdir=$LOCAL_PREFIX/lib \
       --with-amd-includedir=$LOCAL_PREFIX/include \
       --with-amd-libdir=$LOCAL_PREFIX/lib \
       --with-camd-includedir=$LOCAL_PREFIX/include \
       --with-camd-libdir=$LOCAL_PREFIX/lib \
       --with-colamd-includedir=$LOCAL_PREFIX/include \
       --with-colamd-libdir=$LOCAL_PREFIX/lib \
       --with-ccolamd-includedir=$LOCAL_PREFIX/include \
       --with-ccolamd-libdir=$LOCAL_PREFIX/lib \
       --with-cholmod-includedir=$LOCAL_PREFIX/include \
       --with-cholmod-libdir=$LOCAL_PREFIX/lib \
       --with-cxsparse-includedir=$LOCAL_PREFIX/include \
       --with-cxsparse-libdir=$LOCAL_PREFIX/lib \
       --with-umfpack-includedir=$LOCAL_PREFIX/include \
       --with-umfpack-libdir=$LOCAL_PREFIX/lib \
       --with-fftw3-includedir=$LOCAL_PREFIX/include \
       --with-fftw3-libdir=$LOCAL_PREFIX/lib \
       --with-fftw3f-includedir=$LOCAL_PREFIX/include \
       --with-fftw3f-libdir=$LOCAL_PREFIX/lib"

# Unpack Octave
rm -Rf octave-$OCTAVE_VERSION
tar -xf octave-$OCTAVE_VERSION".tar.lz"
# Patch
cat > octave-$OCTAVE_VERSION".patch.uue" << 'EOF'
begin-base64 644 octave-9.1.0.patch
LS0tIG9jdGF2ZS05LjEuMC9jb25maWd1cmUJMjAyNC0wMy0xMyAwNTowMDoy
My4wMDAwMDAwMDAgKzExMDAKKysrIG9jdGF2ZS05LjEuMC5uZXcvY29uZmln
dXJlCTIwMjQtMDUtMDUgMTI6MzA6NTkuOTI0NjY4NjgxICsxMDAwCkBAIC02
MjEsOCArNjIxLDggQEAKICMgSWRlbnRpdHkgb2YgdGhpcyBwYWNrYWdlLgog
UEFDS0FHRV9OQU1FPSdHTlUgT2N0YXZlJwogUEFDS0FHRV9UQVJOQU1FPSdv
Y3RhdmUnCi1QQUNLQUdFX1ZFUlNJT049JzkuMS4wJwotUEFDS0FHRV9TVFJJ
Tkc9J0dOVSBPY3RhdmUgOS4xLjAnCitQQUNLQUdFX1ZFUlNJT049JzkuMS4w
LXJvYmonCitQQUNLQUdFX1NUUklORz0nR05VIE9jdGF2ZSA5LjEuMC1yb2Jq
JwogUEFDS0FHRV9CVUdSRVBPUlQ9J2h0dHBzOi8vb2N0YXZlLm9yZy9idWdz
Lmh0bWwnCiBQQUNLQUdFX1VSTD0naHR0cHM6Ly93d3cuZ251Lm9yZy9zb2Z0
d2FyZS9vY3RhdmUvJwogCi0tLSBvY3RhdmUtOS4xLjAvbGliaW50ZXJwL2Nv
cmVmY24vbG9hZC1zYXZlLmNjCTIwMjQtMDMtMTMgMDU6MDA6MjMuMDAwMDAw
MDAwICsxMTAwCisrKyBvY3RhdmUtOS4xLjAubmV3L2xpYmludGVycC9jb3Jl
ZmNuL2xvYWQtc2F2ZS5jYwkyMDI0LTA1LTA1IDEyOjMwOjU5LjkzNTY2ODU5
MyArMTAwMApAQCAtMTI5LDggKzEyOSw4IEBACiB7CiAgIGNvbnN0IGludCBt
YWdpY19sZW4gPSAxMDsKICAgY2hhciBtYWdpY1ttYWdpY19sZW4rMV07Ci0g
IGlzLnJlYWQgKG1hZ2ljLCBtYWdpY19sZW4pOwogICBtYWdpY1ttYWdpY19s
ZW5dID0gJ1wwJzsKKyAgaXMucmVhZCAobWFnaWMsIG1hZ2ljX2xlbik7CiAK
ICAgaWYgKHN0cm5jbXAgKG1hZ2ljLCAiT2N0YXZlLTEtTCIsIG1hZ2ljX2xl
bikgPT0gMCkKICAgICBzd2FwID0gbWFjaF9pbmZvOjp3b3Jkc19iaWdfZW5k
aWFuICgpOwotLS0gb2N0YXZlLTkuMS4wL3NjcmlwdHMvZ3VpL3VpZmlndXJl
Lm0JMjAyNC0wMy0xMyAwNTowMDoyMy4wMDAwMDAwMDAgKzExMDAKKysrIG9j
dGF2ZS05LjEuMC5uZXcvc2NyaXB0cy9ndWkvdWlmaWd1cmUubQkyMDI0LTA1
LTA1IDEyOjMxOjUyLjE4NjI0NTEzMiArMTAwMApAQCAtMzcsNiArMzcsOSBA
QAogIyMgQHJlZntGaWd1cmUgUHJvcGVydGllc30uICBUaGlzIGZ1bmN0aW9u
IGRpZmZlcnMgZnJvbSBAY29kZXtmaWd1cmV9IGluIHRoYXQKICMjIHRoZSBj
cmVhdGVkIGZpZ3VyZSBpcyBvcHRpbWl6ZWQgZm9yIGFwcGxpY2F0aW9uIGRl
dmVsb3BtZW50LCByYXRoZXIgdGhhbgogIyMgcGxvdHRpbmcuICBUaGlzIG1l
YW5zIGZlYXR1cmVzIHN1Y2ggYXMgbWVudWJhcnMgYW5kIHRvb2xiYXJzIGFy
ZSB0dXJuZWQgb2ZmLgorIyMgVGhpcyBpcyBub3QgcGVyZmVjdCByZXBsYWNl
bWVudCBmb3IgdGhlIEBzY3ttYXRsYWJ9IHVpZmlndXJlIG9iamVjdCBhcyB0
aGUKKyMjIHByb3BlcnRpZXMgQHFjb2RleyJBdXRvUmVzaXplQ2hpbGRyZW4i
fSwgQHFjb2RleyJJY29uIn0sIGFuZAorIyMgQHFjb2RleyJTY3JvbGxhYmxl
In0gYXJlIG5vdCBpbXBsZW1lbnRlZC4KICMjIEBzZWVhbHNve3VpcGFuZWws
IHVpYnV0dG9uZ3JvdXB9CiAjIyBAZW5kIGRlZnR5cGVmbgogCkBAIC00Nywz
MyArNTAsNDQgQEAKIAogZnVuY3Rpb24gaCA9IHVpZmlndXJlICh2YXJhcmdp
bikKIAotICBpZiAobW9kIChuYXJnaW4sIDIpICE9IDApCisgIGlmIChyZW0g
KG5hcmdpbiwgMikgIT0gMCkKICAgICBlcnJvciAoInVpZmlndXJlOiBQUk9Q
RVJUWS9WQUxVRSBwYXJhbWV0ZXJzIG11c3Qgb2NjdXIgaW4gcGFpcnMiKTsK
ICAgZW5kaWYKIAorICBzdHJmY24gPSBAKHMpIGFueSAoc3RyY21waSAocywg
eydBdXRvUmVzaXplQ2hpbGRyZW4nLCAnSWNvbicsICdTY3JvbGxhYmxlJ30p
KTsKKyAgaWR4ID0gY2VsbGZ1biAoc3RyZmNuLCB2YXJhcmdpbiAoMToyOmVu
ZCkpOworICBwcm9wcz17fTsKKyAgaWYgKGFueSAoaWR4KSkKKyAgICBpZHgg
PSByZXBlbGVtIChpZHgsIDIpOyAKKyAgICBwcm9wcyA9IHZhcmFyZ2luKGlk
eCk7ICAjIHNhdmUgc3BlY2lhbCBwcm9wcyBmb3IgYXBwbHlpbmcgbGF0ZXIK
KyAgICB2YXJhcmdpbihpZHgpID0gW107ICAgICAjIHJlbW92ZSBzcGVjaWFs
IHByb3BzIGZyb20gdmFyYXJnaW4KKyAgZW5kaWYKKwogICBoID0gX19nb19m
aWd1cmVfXyAoTmFOLCAiaGFuZGxldmlzaWJpbGl0eSIsICJvZmYiLAogICAg
ICAgICAgICAgICAgICAgICAgICAgICAibnVtYmVydGl0bGUiLCAib2ZmIiwg
ImludGVnZXJoYW5kbGUiLCAib2ZmIiwKLSAgICAgICAgICAgICAgICAgICAg
ICAgICAgIm1lbnViYXIiLCAibm9uZSIsICJ0b29sYmFyIiwgIm5vbmUiKTsK
KyAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbnViYXIiLCAibm9uZSIs
ICJ0b29sYmFyIiwgIm5vbmUiLAorICAgICAgICAgICAgICAgICAgICAgICAg
ICB2YXJhcmdpbns6fSk7CiAKICAgIyMgQWRkIHVpZmlndXJlLXNwZWNpZmlj
IHByb3BlcnRpZXMgb24gdG9wIG9mIHJlZ3VsYXIgZmlndXJlIGdyYXBoaWNz
IG9iamVjdAogICAjIyBGSVhNRTogVGhlcmUgaXMgbm8gaW1wbGVtZW50YXRp
b24gYmVoaW5kIHRoZXNlIHByb3BlcnRpZXMuCiAgIGFkZHByb3BlcnR5ICgi
QXV0b1Jlc2l6ZUNoaWxkcmVuIiwgaCwgImJvb2xlYW4iLCAib24iKTsKKyAg
YWRkcHJvcGVydHkgKCJJY29uIiwgaCwgImRhdGEiLCBbXSk7CiAgIGFkZHBy
b3BlcnR5ICgiU2Nyb2xsYWJsZSIsIGgsICJib29sZWFuIiwgIm9mZiIpOwog
Ci0gICMjIEFwcGx5IGFueSBvdmVycmlkZXMuCi0gIGlmICghIGlzZW1wdHkg
KHZhcmFyZ2luKSkKLSAgICBzZXQgKGgsIHZhcmFyZ2luezp9KTsKKyAgIyMg
U2V0IHZhbHVlcyBmb3Igc3BlY2lhbCBwcm9wZXJ0aWVzIGFkZGVkIGFib3Zl
CisgIGlmICghIGlzZW1wdHkgKHByb3BzKSkKKyAgICBzZXQgKGgsIHByb3Bz
ezp9KTsKICAgZW5kaWYKIAogZW5kZnVuY3Rpb24KIAogCiAlIXRlc3QKLSUh
IGhmID0gdWlmaWd1cmUgKCJ2aXNpYmxlIiwgIm9mZiIpOworJSEgaGYgPSB1
aWZpZ3VyZSAoInZpc2libGUiLCAib2ZmIiwgIkljb24iLCBtYWdpYyAoMykp
OwogJSEgdW53aW5kX3Byb3RlY3QKICUhICAgYXNzZXJ0IChpc2ZpZ3VyZSAo
aGYpKTsKLSUhICAgYXNzZXJ0IChnZXQgKGhmLCB7Im51bWJlcnRpdGxlIiwg
Im1lbnViYXIiLCAic2Nyb2xsYWJsZSJ9KSwKLSUhICAgICAgICAgICAgICAg
ICAgICB7Im9mZiIsICJub25lIiwgIm9mZiJ9KTsKKyUhICAgYXNzZXJ0IChn
ZXQgKGhmLCB7Im51bWJlcnRpdGxlIiwgIm1lbnViYXIiLCAiaWNvbiIsICJz
Y3JvbGxhYmxlIn0pLAorJSEgICAgICAgICAgICAgICAgICAgIHsib2ZmIiwg
Im5vbmUiLCBtYWdpYygzKSwgIm9mZiJ9KTsKICUhIHVud2luZF9wcm90ZWN0
X2NsZWFudXAKICUhICAgY2xvc2UgKGhmKTsKICUhIGVuZF91bndpbmRfcHJv
dGVjdAotLS0gb2N0YXZlLTkuMS4wL3NjcmlwdHMvcGxvdC91dGlsL3ByaXZh
dGUvX19nbnVwbG90X2RyYXdfYXhlc19fLm0JMjAyNC0wMy0xMyAwNTowMDoy
My4wMDAwMDAwMDAgKzExMDAKKysrIG9jdGF2ZS05LjEuMC5uZXcvc2NyaXB0
cy9wbG90L3V0aWwvcHJpdmF0ZS9fX2dudXBsb3RfZHJhd19heGVzX18ubQky
MDI0LTA1LTA1IDEyOjMwOjU5Ljk0MTY2ODU0NSArMTAwMApAQCAtMjI4Myw3
ICsyMjgzLDcgQEAKICAgICBpZiAoISB3YXJuZWRfbGF0ZXgpCiAgICAgICBk
b193YXJuID0gKHdhcm5pbmcgKCJxdWVyeSIsICJPY3RhdmU6dGV4dF9pbnRl
cnByZXRlciIpKS5zdGF0ZTsKICAgICAgIGlmIChzdHJjbXAgKGRvX3dhcm4s
ICJvbiIpKQotICAgICAgICB3YXJuaW5nICgiT2N0YXZlOnRleHRfaW50ZXJw
cmV0ZXIiLAorICAgICAgICB3YXJuaW5nICgiT2N0YXZlOmxhdGV4LW1hcmt1
cC1ub3Qtc3VwcG9ydGVkLWZvci10aWNrLW1hcmtzIiwKICAgICAgICAgICAg
ICAgICAgImxhdGV4IG1hcmt1cCBub3Qgc3VwcG9ydGVkIGZvciB0aWNrIG1h
cmtzIik7CiAgICAgICAgIHdhcm5lZF9sYXRleCA9IHRydWU7CiAgICAgICBl
bmRpZgotLS0gb2N0YXZlLTkuMS4wL3NjcmlwdHMvc2V0L3VuaXF1ZS5tCTIw
MjQtMDMtMTMgMDU6MDA6MjMuMDAwMDAwMDAwICsxMTAwCisrKyBvY3RhdmUt
OS4xLjAubmV3L3NjcmlwdHMvc2V0L3VuaXF1ZS5tCTIwMjQtMDUtMDUgMTI6
MzA6NTkuOTQ1NjY4NTEyICsxMDAwCkBAIC04NCw5ICs4NCw2IEBACiAjIyBv
dXRwdXRzIEB2YXJ7aX0sIEB2YXJ7an0gd2lsbCBmb2xsb3cgdGhlIHNoYXBl
IG9mIHRoZSBpbnB1dCBAdmFye3h9IHJhdGhlcgogIyMgdGhhbiBhbHdheXMg
YmVpbmcgY29sdW1uIHZlY3RvcnMuCiAjIwotIyMgVGhlIHRoaXJkIG91dHB1
dCwgQHZhcntqfSwgaGFzIG5vdCBiZWVuIGltcGxlbWVudGVkIHlldCB3aGVu
IHRoZSBzb3J0Ci0jIyBvcmRlciBpcyBAcWNvZGV7InN0YWJsZSJ9LgotIyMK
ICMjIEBzZWVhbHNve3VuaXF1ZXRvbCwgdW5pb24sIGludGVyc2VjdCwgc2V0
ZGlmZiwgc2V0eG9yLCBpc21lbWJlcn0KICMjIEBlbmQgZGVmdHlwZWZuCiAK
QEAgLTIzMCwzNiArMjI3LDg2IEBACiAgICAgZW5kaWYKICAgZW5kaWYKIAot
ICAjIyBDYWxjdWxhdGUgaiBvdXRwdXQgKDNyZCBvdXRwdXQpCi0gIGlmIChu
YXJnb3V0ID4gMikKLSAgICBqID0gaTsgICMgY2hlYXAgd2F5IHRvIGNvcHkg
ZGltZW5zaW9ucwotICAgIGooaSkgPSBjdW1zdW0gKFsxOyAhIG1hdGNoKDop
XSk7Ci0gICAgaWYgKCEgb3B0c29ydGVkKQotICAgICAgd2FybmluZyAoInVu
aXF1ZTogdGhpcmQgb3V0cHV0IEogaXMgbm90IHlldCBpbXBsZW1lbnRlZCIp
OwotICAgICAgaiA9IFtdOwotICAgIGVuZGlmCi0KLSAgICBpZiAob3B0bGVn
YWN5ICYmIGlzcm93dmVjKQotICAgICAgaiA9IGouJzsKLSAgICBlbmRpZgot
ICBlbmRpZgotCiAgICMjIENhbGN1bGF0ZSBpIG91dHB1dCAoMm5kIG91dHB1
dCkKICAgaWYgKG5hcmdvdXQgPiAxKQorCiAgICAgaWYgKG9wdHNvcnRlZCkK
KwogICAgICAgaWR4ID0gZmluZCAobWF0Y2gpOworCiAgICAgICBpZiAoISBv
cHRsZWdhY3kgJiYgb3B0Zmlyc3QpCiAgICAgICAgIGlkeCArPSAxOyAgICMg
aW4tcGxhY2UgaXMgZmFzdGVyIHRoYW4gb3RoZXIgZm9ybXMgb2YgaW5jcmVt
ZW50CiAgICAgICBlbmRpZgorCisgICAgICBpZiAobmFyZ291dCA+IDIpCisg
ICAgICAgIGogPSBpOyAgIyBjaGVhcCB3YXkgdG8gY29weSBkaW1lbnNpb25z
CisgICAgICAgIGooaSkgPSBjdW1zdW0gKCEgW2ZhbHNlOyBtYXRjaCg6KV0p
OworICAgICAgZW5kaWYKKwogICAgICAgaShpZHgpID0gW107CisKICAgICBl
bHNlCi0gICAgICBpKFtmYWxzZTsgbWF0Y2goOildKSA9IFtdOwotICAgICAg
IyMgRklYTUU6IElzIHRoZXJlIGEgd2F5IHRvIGF2b2lkIGEgY2FsbCB0byBz
b3J0PwotICAgICAgaSA9IHNvcnQgKGkpOworCisgICAgICAjIyBHZXQgaW52
ZXJzZSBvZiBzb3J0IGluZGV4IGkgc28gdGhhdCBzb3J0KHgpKGspID0geC4K
KyAgICAgIGsgPSBpOyAgIyBjaGVhcCB3YXkgdG8gY29weSBkaW1lbnNpb25z
CisgICAgICBrKGkpID0gMTpuOworCisgICAgICBpZiAobmFyZ291dCA+IDIp
CisKKyAgICAgICAgIyMgR2VuZXJhdGUgbG9naWNhbCBpbmRleCBvZiBzb3J0
ZWQgdW5pcXVlIHZhbHVlIGxvY2F0aW9ucy4KKyAgICAgICAgbm9tYXRjaCA9
ICEgW2ZhbHNlOyBtYXRjaCg6KV07CisKKyAgICAgICAgIyMgQ2FsY3VsYXRl
IGkgb3V0cHV0IGFzIHRob3NlIGxvY2F0aW9ucyByZW1hcHBlZCB0byB1bnNv
cnRlZCB4LgorICAgICAgICBpX291dCA9IGZpbmQgKG5vbWF0Y2goaykpOwor
CisgICAgICAgICMjIEZpbmQgdGhlIGxpbmVhciBpbmRleGVzIG9mIHRoZSB1
bmlxdWUgZWxlbWVudHMgb2Ygc29ydCh4KS4KKyAgICAgICAgdSA9IGZpbmQg
KG5vbWF0Y2gpOworCisgICAgICAgICMjIEZpbmQgdW5pcXVlIGluZGV4ZXMg
Zm9yIGFsbCBlbGVtZW50IGxvY2F0aW9ucyAuCisgICAgICAgIGwgPSB1KGN1
bXN1bSAobm9tYXRjaCkpOworCisgICAgICAgICMjIGwoaykgZ2l2ZXMgdSBl
bGVtZW50IGxvY2F0aW9ucyBtYXBwZWQgYmFjayB0byB1bnNvcnRlZCB4LiBF
LmcuLAorICAgICAgICAjIyBmb3IgeCA9IFs0MCwyMCw0MCwyMCwyMCwzMCwx
MF0nICMgZGF0YQorICAgICAgICAjIyBpID0gICBbNywyLDQsNSw2LDEsM10n
ICAgICAgICAgICMgc29ydCh4KSBpbmRleCwgeChpKSA9IHNvcnQoeCkKKyAg
ICAgICAgIyMgbm9tYXRjaCA9IFsxLDEsMCwwLDEsMSwwXScgICAgICAjIGxv
Z2ljYWwgc29ydGVkIGluZGV4IG9mIHVuaXF1ZSB4CisgICAgICAgICMjIGlf
b3V0ID0gWzEsMiw2LDddJyAgICAgICAgICAgICAgIyB1bmlxdWUgb3V0cHV0
IGluZGV4LCB5ID0geChpX291dCkKKyAgICAgICAgIyMgayA9IFs2LDIsNywz
LDQsNSwxXScgICAgICAgICAgICAjIGludmVyc2UgaWR4IG9mIGksIHNvcnQo
eCkoaykgPSB4CisgICAgICAgICMjIGwgPSBbMSwyLDIsMiw1LDYsNl0nICAg
ICAgICAgICAgIyB1bmlxdWUgZWxlbS4gdG8gcmVwcm9kdWNlIHNvcnQoeCkK
KyAgICAgICAgIyMgbChrKSA9IFs2LDIsNiwyLDIsNSwxXScgICAgICAgICAj
IHVuaXF1ZSBlbGVtZW50cyB0byByZXByb2R1Y2UgKHgpCisgICAgICAgICMj
IGkobChrKSkgPSAgWzEsMiwxLDIsMiw2LDddJyAgICAgIyB1bmlxdWUgZWxl
bS4gbWFwcGVkIHRvIHNvcnQoeClpZHgKKyAgICAgICAgIyMKKyAgICAgICAg
IyMgaV9vdXQgPT0gaShsKGspKScgYnJvYWRjYXN0cyB0bzoKKyAgICAgICAg
IyMgIFsgMSAgMSAgMCAgMCAgMCAgMCAgMAorICAgICAgICAjIyAgICAwICAw
ICAxICAxICAxICAwICAwCisgICAgICAgICMjICAgIDAgIDAgIDAgIDAgIDAg
IDEgIDAKKyAgICAgICAgIyMgICAgMCAgMCAgMCAgMCAgMCAgMCAgMSBdCisg
ICAgICAgICMjIFJvdyB2YWx1ZSBvZiBlYWNoIGNvbHVtbiBtYXBzIGkobChr
KSkgdG8gaV9vdXQsIGdpdmVzIGogZm9yIHkoaik9eAorCisgICAgICAgICMj
IEZJWE1FOiAyLUQgcHJvamVjdGlvbiB0byBmaW5kIGogaW5jcmVhc2VzIGxh
cmdlc3Qgc3RvcmVkIGVsZW1lbnQKKyAgICAgICAgIyMgICAgICAgIGZyb20g
biB0byBtIHggbiAobSA9IG51bWVsICh5KSkgYW5kIHVzZXMgc2xvd2VyIGZp
bmQKKyAgICAgICAgIyMgICAgICAgIGNvZGVwYXRoLiAgSWRlYWxseSB3b3Vs
ZCBiZSByZXBsYWNlZCBieSBkaXJlY3QgbGluZWFyIG9yCisgICAgICAgICMj
ICAgICAgICBsb2dpY2FsIGluZGV4aW5nLgorCisgICAgICAgIFtqLH5dID0g
ZmluZCAoaV9vdXQgPT0gaShsKGspKScpOworCisgICAgICAgICMjIFJlcGxh
Y2UgZnVsbCB4LT4gc29ydCh4KSBvdXRwdXQgd2l0aCBkdXBsaWNhdGVzIHJl
bW92ZWQuCisgICAgICAgIGkgPSBpX291dDsKKyAgICAgIGVsc2UKKworICAg
ICAgICAjIyBGaW5kIGkgb3V0cHV0IGFzIHVuaXF1ZSB2YWx1ZSBsb2NhdGlv
bnMgcmVtYXBwZWQgdG8gdW5zb3J0ZWQgeC4KKyAgICAgICAgaSA9IGZpbmQg
KCEgW2ZhbHNlOyBtYXRjaCg6KV0oaykpOworCisgICAgICBlbmRpZgorCiAg
ICAgZW5kaWYKIAogICAgIGlmIChvcHRsZWdhY3kgJiYgaXNyb3d2ZWMpCiAg
ICAgICBpID0gaS4nOworCisgICAgICBpZiAobmFyZ291dCA+IDIpCisgICAg
ICAgIGogPSBqLic7CisgICAgICBlbmRpZgorCiAgICAgZW5kaWYKICAgZW5k
aWYKIApAQCAtMzAyLDExICszNDksMTAgQEAKICUhIGFzc2VydCAoaiwgWzE7
MTsyOzM7MzszOzRdKTsKIAogJSF0ZXN0Ci0lISBbeSxpLH5dID0gdW5pcXVl
IChbNCw0LDIsMiwyLDMsMV0sICJzdGFibGUiKTsKKyUhIFt5LGksal0gPSB1
bmlxdWUgKFs0LDQsMiwyLDIsMywxXSwgInN0YWJsZSIpOwogJSEgYXNzZXJ0
ICh5LCBbNCwyLDMsMV0pOwogJSEgYXNzZXJ0IChpLCBbMTszOzY7N10pOwot
JSEgIyMgRklYTUU6ICdqJyBpbnB1dCBub3QgY2FsY3VsYXRlZCB3aXRoIHN0
YWJsZQotJSEgIyNhc3NlcnQgKGosIFtdKTsKKyUhIGFzc2VydCAoaiwgWzE7
MTsyOzI7MjszOzRdKTsKIAogJSF0ZXN0CiAlISBbeSxpLGpdID0gdW5pcXVl
IChbMSwxLDIsMywzLDMsNF0nLCAibGFzdCIpOwpAQCAtMzM1LDExICszODEs
MTAgQEAKIAogJSF0ZXN0CiAlISBBID0gWzQsNSw2OyAxLDIsMzsgNCw1LDZd
OwotJSEgW3ksaSx+XSA9IHVuaXF1ZSAoQSwgInJvd3MiLCAic3RhYmxlIik7
CislISBbeSxpLGpdID0gdW5pcXVlIChBLCAicm93cyIsICJzdGFibGUiKTsK
ICUhIGFzc2VydCAoeSwgWzQsNSw2OyAxLDIsM10pOwogJSEgYXNzZXJ0IChB
KGksOiksIHkpOwotJSEgIyMgRklYTUU6ICdqJyBvdXRwdXQgbm90IGNhbGN1
bGF0ZWQgY29ycmVjdGx5IHdpdGggInN0YWJsZSIKLSUhICMjYXNzZXJ0ICh5
KGosOiksIEEpOworJSEgYXNzZXJ0ICh5KGosOiksIEEpOwogCiAjIyBUZXN0
ICJsZWdhY3kiIG9wdGlvbgogJSF0ZXN0CkBAIC0zNTUsNiArNDAwLDUyIEBA
CiAlISBhc3NlcnQgKGksIFsyOyA1OyA0OyAzXSk7CiAlISBhc3NlcnQgKGos
IFs0OyAxOyA0OyAzOyAyXSk7CiAKKyUhdGVzdCA8KjY1MTc2PgorJSEgYSA9
IFszIDIgMSAyOyAyIDEgMiAxXTsKKyUhIFtvMSwgbzIsIG8zXSA9IHVuaXF1
ZSAoYSk7CislISBhc3NlcnQgKHtvMSwgbzIsIG8zfSwge1sxOzI7M10sIFs0
OzI7MV0sIFszOzI7MjsxOzE7MjsyOzFdfSk7CislISBbbzEsIG8yLCBvM10g
PSB1bmlxdWUgKGEsICJzdGFibGUiKTsKKyUhIGFzc2VydCAoe28xLCBvMiwg
bzN9LCB7WzM7MjsxXSwgWzE7Mjs0XSwgWzE7MjsyOzM7MzsyOzI7M119KQor
CislIXRlc3QgPCo2NTE3Nj4KKyUhIGEgPSBbMyAyIDEgMjsgMiAxIDIgMV07
CislISBbbzEsIG8yLCBvM10gPSB1bmlxdWUgKGEoMSw6KSwgInJvd3MiKTsK
KyUhIGFzc2VydCAoe28xLCBvMiwgbzN9LCB7YSgxLDopLCAxLCAxfSk7Cisl
ISBbbzEsIG8yLCBvM10gPSB1bmlxdWUgKGEoMSw6KSwgInJvd3MiLCAic3Rh
YmxlIik7CislISBhc3NlcnQgKHtvMSwgbzIsIG8zfSwge2EoMSw6KSwgMSwg
MX0pOworJSEgW28xLCBvMiwgbzNdID0gdW5pcXVlIChhLCAicm93cyIpOwor
JSEgYXNzZXJ0ICh7bzEsIG8yLCBvM30sIHtbYSgyLDopOyBhKDEsOildLCBb
MjsxXSwgWzI7MV19KTsKKyUhIFtvMSwgbzIsIG8zXSA9IHVuaXF1ZSAoYSwg
InJvd3MiLCAic3RhYmxlIik7CislISBhc3NlcnQgKHtvMSwgbzIsIG8zfSwg
e2EsIFsxOzJdLCBbMTsyXX0pOworJSEgW28xLCBvMiwgbzNdID0gdW5pcXVl
IChbYTthXSwgInJvd3MiKTsKKyUhIGFzc2VydCAoe28xLCBvMiwgbzN9LCB7
W2EoMiw6KTsgYSgxLDopXSwgWzI7MV0sIFsyOzE7MjsxXX0pOworJSEgW28x
LCBvMiwgbzNdID0gdW5pcXVlIChbYTthXSwgInJvd3MiLCAic3RhYmxlIik7
CislISBhc3NlcnQgKHtvMSwgbzIsIG8zfSwge2EsIFsxOzJdLCBbMTsyOzE7
Ml19KTsKKworJSF0ZXN0IDwqNjUxNzY+CislISBhID0gZ2FsbGVyeSAoImlu
dGVnZXJkYXRhIiwgWy0xMDAsIDEwMF0sIDYsIDYpOworJSEgYSA9IFthKDIs
Oik7IGEoMTo1LDopOyBhKDI6Niw6KV07CislISBbbzEsIG8yLCBvM10gPSB1
bmlxdWUgKGEpOworJSEgYXNzZXJ0ICh7bzEsIG8xKG8zKSwgbzIsIG8zfSwg
e2EoOikobzIpLCBhKDopLCAuLi4KKyUhIFsyNjsyMjszNDs0NTs1NzsgNjsx
MTsxNzszMzsyODszNTsxNTs1NjsgMjs1OTsgNDs2NjsgLi4uCislISAgMTY7
NTA7NDk7Mjc7MjQ7Mzc7NDQ7NDg7Mzk7Mzg7MTM7MjM7IDU7MTI7NDY7NTU7
IDFdLCAuLi4KKyUhIFszNDsxNDszNDsxNjszMDsgNjszNDsxNjszMDsgNjsg
NzszMTsyODszMTsxMjsxODsgODszMTsxMjsxODsgODsgMjsyOTsgLi4uCisl
ISAgMjI7Mjk7IDE7MjE7MTA7Mjk7IDE7MjE7MTA7IDk7IDM7MTE7IDM7MjM7
Mjc7MjY7IDM7MjM7Mjc7MjY7MjQ7IDQ7MzI7IC4uLgorJSEgIDQ7IDI1OzIw
OzE5OyA0OzI1OzIwOzE5OzMzOzEzOyA1OzEzOzE1OyAyOzI0OzEzOzE1OyAy
OzI0OzE3XX0pOworJSEgW28xLCBvMiwgbzNdID0gdW5pcXVlIChhLCAic3Rh
YmxlIik7CislISBhc3NlcnQgKHtvMSwgbzEobzMpLCBvMiwgbzN9LCB7YSg6
KShvMiksIGEoOiksIC4uLgorJSEgWyAxOyAyOyA0OyA1OyA2OzExOzEyOzEz
OzE1OzE2OzE3OzIyOzIzOzI0OzI2OzI3OzI4OyAuLi4KKyUhICAzMzszNDsz
NTszNzszODszOTs0NDs0NTs0Njs0ODs0OTs1MDs1NTs1Njs1Nzs1OTs2Nl0s
IC4uLgorJSEgWyAxOyAyOyAxOyAzOyA0OyA1OyAxOyAzOyA0OyA1OyA2OyA3
OyA4OyA3OyA5OzEwOzExOyA3OyA5OzEwOzExOzEyOzEzOyAuLi4KKyUhICAx
NDsxMzsxNTsxNjsxNzsxMzsxNTsxNjsxNzsxODsxOTsyMDsxOTsyMTsyMjsy
MzsxOTsyMTsyMjsyMzsyNDsyNTsyNjsuLi4KKyUhICAyNTsyNzsyODsyOTsy
NTsyNzsyODsyOTszMDszMTszMjszMTszMzsxMjsyNDszMTszMzsxMjsyNDsz
NF19KTsKKyUhIFtvMSwgbzIsIG8zXSA9IHVuaXF1ZSAoYSwgInJvd3MiKTsK
KyUhIGFzc2VydCAoe28xLCBvMShvMyw6KSwgbzIsIG8zfSwge2EobzIsOiks
IGEsIC4uLgorJSEgWzY7MTE7Mjs0OzU7MV0sIFs2OzM7Njs0OzU7MTs2OzQ7
NTsxOzJdfSk7CislISBbbzEsIG8yLCBvM10gPSB1bmlxdWUgKGEsICJyb3dz
IiwgInN0YWJsZSIpOworJSEgYXNzZXJ0ICh7bzEsIG8xKG8zLDopLCBvMiwg
bzN9LCB7YShvMiw6KSwgYSwgLi4uCislISBbMTsyOzQ7NTs2OzExXSwgWzE7
MjsxOzM7NDs1OzE7Mzs0OzU7Nl19KTsKKwogIyMgVGVzdCBpbnB1dCB2YWxp
ZGF0aW9uCiAlIWVycm9yIDxJbnZhbGlkIGNhbGw+IHVuaXF1ZSAoKQogJSFl
cnJvciA8WCBtdXN0IGJlIGFuIGFycmF5IG9yIGNlbGwgYXJyYXkgb2Ygc3Ry
aW5ncz4gdW5pcXVlICh7MX0pCkBAIC0zNzYsNiArNDY3LDQgQEAKICUhZXJy
b3IgPGludmFsaWQgb3B0aW9uPiB1bmlxdWUgKHsiYSIsICJiIiwgImMifSwg
InJvd3MiLCAiVW5rbm93bk9wdGlvbjIiKQogJSFlcnJvciA8aW52YWxpZCBv
cHRpb24+IHVuaXF1ZSAoeyJhIiwgImIiLCAiYyJ9LCAiVW5rbm93bk9wdGlv
bjEiLCAibGFzdCIpCiAlIXdhcm5pbmcgPCJyb3dzIiBpcyBpZ25vcmVkIGZv
ciBjZWxsIGFycmF5cz4gdW5pcXVlICh7IjEifSwgInJvd3MiKTsKLSUhd2Fy
bmluZyA8dGhpcmQgb3V0cHV0IEogaXMgbm90IHlldCBpbXBsZW1lbnRlZD4K
LSUhIFt5LGksal0gPSB1bmlxdWUgKFsyLDFdLCAic3RhYmxlIik7Ci0lISBh
c3NlcnQgKGosIFtdKTsKKwo=
====
EOF
uudecode octave-$OCTAVE_VERSION.patch.uue > octave-$OCTAVE_VERSION.patch
pushd octave-$OCTAVE_VERSION
patch -p1 < ../octave-$OCTAVE_VERSION.patch
popd

# Build the benchmark versions
OCTAVE_DIR=$LOCAL_PREFIX/octave-$OCTAVE_VERSION ;
for BUILD in dbg shared shared-lto shared-pgo shared-lto-pgo ;
do
    #
    echo "Building" $BUILD
    #
    OCTAVE_INSTALL_DIR=$LOCAL_PREFIX/octave-$BUILD
    OCTAVE_BIN_DIR=$OCTAVE_INSTALL_DIR/bin
    OCTAVE_SHARE_DIR=$OCTAVE_INSTALL_DIR/share/octave
    OCTAVE_PACKAGE_DIR=$OCTAVE_SHARE_DIR/packages 
    OCTAVE_PACKAGES=$OCTAVE_SHARE_DIR/octave_packages
    #
    rm -Rf build-$BUILD
    #
    mkdir -p build-$BUILD
    #
    pushd build-$BUILD
    #
    source ../build-$BUILD.sh
    #
    make install
    # 
    $OCTAVE_BIN_DIR/octave-cli --eval "__octave_config_info__"
    #
    popd
    #
done

# Benchmark the builds with the generic lapack library
cat > iir_benchmark.m << 'EOF'
% Define a filter
fc=0.10;U=2;V=2;M=20;Q=8;R=3;tol=1e-6;
x0=[ 0.0089234, ...
     2.0000000, -2.0000000,  ...
     0.5000000, -0.5000000,  ...
    -0.5000000, -0.5000000,  0.5000000,  0.5000000,  0.5000000, ...
     0.5000000,  0.5000000,  0.5000000,  0.5000000,  0.8000000, ...
     0.6700726,  0.7205564,  0.8963898,  1.1980053,  1.3738387, ...
     1.4243225,  2.7644677,  2.8149515,  2.9907849,  1.9896753, ...
    -0.9698147, -0.8442244,  0.4511337,  0.4242641, ...
     1.8917946,  1.7780303,  1.2325954,  0.7853982 ]';
% Run
nplot=4000;
w=(0:(nplot-1))'*pi/nplot;
id=tic();
for n=1:100
  [A,gradA,hessA]=iirA(w,x0,U,V,M,Q,R,tol);
  [T,gradT,hessT]=iirT(w,x0,U,V,M,Q,R,tol);
  [P,gradP]=iirP(w,x0,U,V,M,Q,R,tol);
endfor
toc(id)
EOF
cp -f ../src/{fixResultNaN,iirA,iirP,iirT}.m .

for BUILD in dbg shared shared-lto shared-pgo shared-lto-pgo ;
do
    #
    echo "Testing " $BUILD
    #
    OCTAVE_BIN_DIR=$LOCAL_PREFIX/octave-$BUILD/bin
    for k in `seq 1 10`; do \
        LD_PRELOAD=$LAPACK_DIR"/liblapack.so:"$LAPACK_DIR"/libblas.so" \
                              $OCTAVE_BIN_DIR/octave-cli iir_benchmark.m
    done | awk -v build_var=$BUILD '{elapsed=elapsed+$4;}; \
      END {printf("iir_benchmark %s elapsed=%g\n",build_var,elapsed/10);}'
    #
done

# Now do library benchmarking
source ./library-benchmark.sh
