#!/bin/bash

# A script to build shared and static versions of the Lapack libraries:
#  1. Assumes the NETLIB source archive lapack-$LPVER.tgz is present
#  2. Under directory lapack-$LPVER, make.inc.example, SRC/Makefile and
#     BLAS/SRC/Makefile are modified with lapack-$LPVER.patch

alias cp=cp

MAKE_OPTS=""
ALL_BUILDS="generic intel haswell nehalem skylake"

# Patch lapack files make.inc.example, SRC/Makefile and BLAS/SRC/Makefile
cat > lapack-$LPVER.patch.uue << 'EOF'
begin-base64 644 lapack-3.7.1.patch
LS0tIGxhcGFjay0zLjcuMS9tYWtlLmluYy5leGFtcGxlCTIwMTctMDYtMTgg
MDg6NDY6NTMuMDAwMDAwMDAwICsxMDAwCisrKyBsYXBhY2stMy43LjEubW9k
L21ha2UuaW5jLmV4YW1wbGUJMjAxNy0xMS0xOSAxMzo0ODoyNC41Nzg1NTg0
OTYgKzExMDAKQEAgLTksNyArOSw4IEBACiAjICBDQyBpcyB0aGUgQyBjb21w
aWxlciwgbm9ybWFsbHkgaW52b2tlZCB3aXRoIG9wdGlvbnMgQ0ZMQUdTLgog
IwogQ0MgICAgID0gZ2NjCi1DRkxBR1MgPSAtTzMKK0JMRE9QVFMgPSAtZlBJ
QyAtbTY0IC1tdHVuZT1nZW5lcmljCitDRkxBR1MgPSAtTzMgJChCTERPUFRT
KQogCiAjICBNb2RpZnkgdGhlIEZPUlRSQU4gYW5kIE9QVFMgZGVmaW5pdGlv
bnMgdG8gcmVmZXIgdG8gdGhlIGNvbXBpbGVyCiAjICBhbmQgZGVzaXJlZCBj
b21waWxlciBvcHRpb25zIGZvciB5b3VyIG1hY2hpbmUuICBOT09QVCByZWZl
cnMgdG8KQEAgLTE5LDE1ICsyMCwxNSBAQAogIyAgYW5kIGhhbmRsZSB0aGVz
ZSBxdWFudGl0aWVzIGFwcHJvcHJpYXRlbHkuIEFzIGEgY29uc2VxdWVuY2Us
IG9uZQogIyAgc2hvdWxkIG5vdCBjb21waWxlIExBUEFDSyB3aXRoIGZsYWdz
IHN1Y2ggYXMgLWZmcGUtdHJhcD1vdmVyZmxvdy4KICMKLUZPUlRSQU4gPSBn
Zm9ydHJhbgotT1BUUyAgICA9IC1PMiAtZnJlY3Vyc2l2ZQorRk9SVFJBTiA9
IGdmb3J0cmFuIC1mcmVjdXJzaXZlICQoQkxET1BUUykKK09QVFMgICAgPSAt
TzIKIERSVk9QVFMgPSAkKE9QVFMpCi1OT09QVCAgID0gLU8wIC1mcmVjdXJz
aXZlCitOT09QVCAgID0gLU8wCiAKICMgIERlZmluZSBMT0FERVIgYW5kIExP
QURPUFRTIHRvIHJlZmVyIHRvIHRoZSBsb2FkZXIgYW5kIGRlc2lyZWQKICMg
IGxvYWQgb3B0aW9ucyBmb3IgeW91ciBtYWNoaW5lLgogIwotTE9BREVSICAg
PSBnZm9ydHJhbgorTE9BREVSICAgPSAkKEZPUlRSQU4pCiBMT0FET1BUUyA9
CiAKICMgIFRoZSBhcmNoaXZlciBhbmQgdGhlIGZsYWcocykgdG8gdXNlIHdo
ZW4gYnVpbGRpbmcgYW4gYXJjaGl2ZQpAQCAtNTksNyArNjAsNyBAQAogIyAg
VW5jb21tZW50IHRoZSBmb2xsb3dpbmcgbGluZSB0byBpbmNsdWRlIGRlcHJl
Y2F0ZWQgcm91dGluZXMgaW4KICMgIHRoZSBMQVBBQ0sgbGlicmFyeS4KICMK
LSNCVUlMRF9ERVBSRUNBVEVEID0gWWVzCitCVUlMRF9ERVBSRUNBVEVEID0g
WWVzCiAKICMgIExBUEFDS0UgaGFzIHRoZSBpbnRlcmZhY2UgdG8gc29tZSBy
b3V0aW5lcyBmcm9tIHRtZ2xpYi4KICMgIElmIExBUEFDS0VfV0lUSF9UTUcg
aXMgZGVmaW5lZCwgYWRkIHRob3NlIHJvdXRpbmVzIHRvIExBUEFDS0UuCkBA
IC03OCw3ICs3OSw3IEBACiAjICBtYWNoaW5lLXNwZWNpZmljLCBvcHRpbWl6
ZWQgQkxBUyBsaWJyYXJ5IHNob3VsZCBiZSB1c2VkIHdoZW5ldmVyCiAjICBw
b3NzaWJsZS4pCiAjCi1CTEFTTElCICAgICAgPSAuLi8uLi9saWJyZWZibGFz
LmEKK0JMQVNMSUIgICAgICA9IC4uLy4uL2xpYmJsYXMuYQogQ0JMQVNMSUIg
ICAgID0gLi4vLi4vbGliY2JsYXMuYQogTEFQQUNLTElCICAgID0gbGlibGFw
YWNrLmEKIFRNR0xJQiAgICAgICA9IGxpYnRtZ2xpYi5hCi0tLSBsYXBhY2st
My43LjEvQkxBUy9TUkMvTWFrZWZpbGUJMjAxNy0wNi0xOCAwODo0Njo1My4w
MDAwMDAwMDAgKzEwMDAKKysrIGxhcGFjay0zLjcuMS5tb2QvQkxBUy9TUkMv
TWFrZWZpbGUJMjAxNy0xMS0xOSAxMzo0ODoyNC41Nzk1NTg0ODYgKzExMDAK
QEAgLTU3LDYgKzU3LDEwIEBACiAKIGFsbDogJChCTEFTTElCKQogCitsaWJi
bGFzLnNvOiAkKEFMTE9CSikKKwkkKEZPUlRSQU4pIC1zaGFyZWQgLVdsLC1z
b25hbWUsJEAgLW8gJEAgJChBTExPQkopCisJY3AgLWYgbGliYmxhcy5zbyAu
Li8uLiA7CisKICMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICMgIENvbW1lbnQgb3V0IHRoZSBu
ZXh0IDYgZGVmaW5pdGlvbnMgaWYgeW91IGFscmVhZHkgaGF2ZQogIyAgdGhl
IExldmVsIDEgQkxBUy4KLS0tIGxhcGFjay0zLjcuMS9TUkMvTWFrZWZpbGUJ
MjAxNy0wNi0xOCAwODo0Njo1My4wMDAwMDAwMDAgKzEwMDAKKysrIGxhcGFj
ay0zLjcuMS5tb2QvU1JDL01ha2VmaWxlCTIwMTctMTEtMTkgMTM6NDg6MjQu
NTc5NTU4NDg2ICsxMTAwCkBAIC01MDcsOCArNTA3LDEyIEBACiAKIGFsbDog
Li4vJChMQVBBQ0tMSUIpCiAKK2xpYmxhcGFjay5zbzogJChBTExPQkopICQo
QUxMWE9CSikgJChERVBSRUNBVEVEKQorCSQoRk9SVFJBTikgLXNoYXJlZCAt
V2wsLXNvbmFtZSwkQCAtbyAkQCAkKEFMTE9CSikgJChBTExYT0JKKSAkKERF
UFJFQ0FURUQpCisJY3AgLWYgbGlibGFwYWNrLnNvIC4uIDsKKwogLi4vJChM
QVBBQ0tMSUIpOiAkKEFMTE9CSikgJChBTExYT0JKKSAkKERFUFJFQ0FURUQp
Ci0JJChBUkNIKSAkKEFSQ0hGTEFHUykgJEAgJF4KKwkkKEFSQ0gpICQoQVJD
SEZMQUdTKSAkQCAkKEFMTE9CSikgJChBTExYT0JKKSAkKERFUFJFQ0FURUQp
CiAJJChSQU5MSUIpICRACiAKIHNpbmdsZTogJChTTEFTUkMpICQoRFNMQVNS
QykgJChTWExBU1JDKSAkKFNDTEFVWCkgJChBTExBVVgpCg==
====
EOF
uudecode lapack-$LPVER.patch.uue
rm -Rf lapack-$LPVER
tar -xf lapack-$LPVER.tgz
pushd lapack-$LPVER
patch -p1 < ../lapack-$LPVER.patch
cp make.inc.example make.inc
popd

# Create directories
mkdir -p lapack
pushd lapack
mkdir -p $ALL_BUILDS

# Populate directories
for dir in $ALL_BUILDS ; do
  echo $dir
  pushd $dir
  cp -Rf ../../lapack-$LPVER .
  popd
done

# Set build options in each directory
for dir in generic intel ; do
  sed -i -e "s/^BLDOPTS\ *=.*/BLDOPTS\ \ = -fPIC -m64 -mtune=$dir/" $dir/lapack-$LPVER/make.inc
done
for dir in haswell nehalem skylake ; do
  sed -i -e "s/^BLDOPTS\ *=.*/BLDOPTS\ \ = -fPIC -march=$dir/" $dir/lapack-$LPVER/make.inc
done

# Build in each directory
for dir in $ALL_BUILDS ; do
  echo $dir ;
  pushd $dir/lapack-$LPVER/BLAS/SRC ;
  make $MAKE_OPTS ;
  make $MAKE_OPTS libblas.so ;
  popd
  pushd $dir/lapack-$LPVER/SRC ;
  make $MAKE_OPTS ;
  make $MAKE_OPTS liblapack.so ;
  popd;
done

# Done
popd
