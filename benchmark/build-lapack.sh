#!/bin/bash

# A script to build shared and static versions of the Lapack libraries:
#  1. Assumes the NETLIB source archive lapack-$LPVER.tar.gz is present
#  2. Under directory lapack-$LPVER, make.inc.example, SRC/Makefile and
#     BLAS/SRC/Makefile are modified with lapack-$LPVER.patch

alias cp=cp

MAKE_OPTS=""
ALL_BUILDS="generic intel haswell nehalem skylake"

# Patch lapack files make.inc.example, SRC/Makefile and BLAS/SRC/Makefile
export LPVER=3.8.0
cat > lapack-$LPVER.patch.uue << 'EOF'
begin-base64 644 lapack-3.8.0.patch
LS0tIGxhcGFjay0zLjguMC9tYWtlLmluYy5leGFtcGxlCTIwMTctMTEtMTMg
MTU6MTU6NTQuMDAwMDAwMDAwICsxMTAwCisrKyBsYXBhY2stMy44LjAubW9k
L21ha2UuaW5jLmV4YW1wbGUJMjAxOC0wMi0xNyAwODo0ODoyMS4wMjEwMjE5
NzMgKzExMDAKQEAgLTksNyArOSw4IEBACiAjICBDQyBpcyB0aGUgQyBjb21w
aWxlciwgbm9ybWFsbHkgaW52b2tlZCB3aXRoIG9wdGlvbnMgQ0ZMQUdTLgog
IwogQ0MgICAgID0gZ2NjCi1DRkxBR1MgPSAtTzMKK0JMRE9QVFMgPSAtZlBJ
QyAtbTY0IC1tdHVuZT1nZW5lcmljCitDRkxBR1MgPSAtTzMgJChCTERPUFRT
KQogCiAjICBNb2RpZnkgdGhlIEZPUlRSQU4gYW5kIE9QVFMgZGVmaW5pdGlv
bnMgdG8gcmVmZXIgdG8gdGhlIGNvbXBpbGVyCiAjICBhbmQgZGVzaXJlZCBj
b21waWxlciBvcHRpb25zIGZvciB5b3VyIG1hY2hpbmUuICBOT09QVCByZWZl
cnMgdG8KQEAgLTE5LDE1ICsyMCwxNSBAQAogIyAgYW5kIGhhbmRsZSB0aGVz
ZSBxdWFudGl0aWVzIGFwcHJvcHJpYXRlbHkuIEFzIGEgY29uc2VxdWVuY2Us
IG9uZQogIyAgc2hvdWxkIG5vdCBjb21waWxlIExBUEFDSyB3aXRoIGZsYWdz
IHN1Y2ggYXMgLWZmcGUtdHJhcD1vdmVyZmxvdy4KICMKLUZPUlRSQU4gPSBn
Zm9ydHJhbgotT1BUUyAgICA9IC1PMiAtZnJlY3Vyc2l2ZQorRk9SVFJBTiA9
IGdmb3J0cmFuIC1mcmVjdXJzaXZlICQoQkxET1BUUykKK09QVFMgICAgPSAt
TzIKIERSVk9QVFMgPSAkKE9QVFMpCi1OT09QVCAgID0gLU8wIC1mcmVjdXJz
aXZlCitOT09QVCAgID0gLU8wCiAKICMgIERlZmluZSBMT0FERVIgYW5kIExP
QURPUFRTIHRvIHJlZmVyIHRvIHRoZSBsb2FkZXIgYW5kIGRlc2lyZWQKICMg
IGxvYWQgb3B0aW9ucyBmb3IgeW91ciBtYWNoaW5lLgogIwotTE9BREVSICAg
PSBnZm9ydHJhbgorTE9BREVSICAgPSAkKEZPUlRSQU4pCiBMT0FET1BUUyA9
CiAKICMgIFRoZSBhcmNoaXZlciBhbmQgdGhlIGZsYWcocykgdG8gdXNlIHdo
ZW4gYnVpbGRpbmcgYW4gYXJjaGl2ZQpAQCAtNTksNyArNjAsNyBAQAogIyAg
VW5jb21tZW50IHRoZSBmb2xsb3dpbmcgbGluZSB0byBpbmNsdWRlIGRlcHJl
Y2F0ZWQgcm91dGluZXMgaW4KICMgIHRoZSBMQVBBQ0sgbGlicmFyeS4KICMK
LSNCVUlMRF9ERVBSRUNBVEVEID0gWWVzCitCVUlMRF9ERVBSRUNBVEVEID0g
WWVzCiAKICMgIExBUEFDS0UgaGFzIHRoZSBpbnRlcmZhY2UgdG8gc29tZSBy
b3V0aW5lcyBmcm9tIHRtZ2xpYi4KICMgIElmIExBUEFDS0VfV0lUSF9UTUcg
aXMgZGVmaW5lZCwgYWRkIHRob3NlIHJvdXRpbmVzIHRvIExBUEFDS0UuCkBA
IC03OCw3ICs3OSw3IEBACiAjICBtYWNoaW5lLXNwZWNpZmljLCBvcHRpbWl6
ZWQgQkxBUyBsaWJyYXJ5IHNob3VsZCBiZSB1c2VkIHdoZW5ldmVyCiAjICBw
b3NzaWJsZS4pCiAjCi1CTEFTTElCICAgICAgPSAuLi8uLi9saWJyZWZibGFz
LmEKK0JMQVNMSUIgICAgICA9IC4uLy4uL2xpYmJsYXMuYQogQ0JMQVNMSUIg
ICAgID0gLi4vLi4vbGliY2JsYXMuYQogTEFQQUNLTElCICAgID0gbGlibGFw
YWNrLmEKIFRNR0xJQiAgICAgICA9IGxpYnRtZ2xpYi5hCi0tLSBsYXBhY2st
My44LjAvU1JDL01ha2VmaWxlCTIwMTctMTEtMTMgMTU6MTU6NTQuMDAwMDAw
MDAwICsxMTAwCisrKyBsYXBhY2stMy44LjAubW9kL1NSQy9NYWtlZmlsZQky
MDE4LTAyLTE3IDA4OjQ4OjIxLjE3NTAyMDYxNSArMTEwMApAQCAtNTE0LDgg
KzUxNCwxMiBAQAogCiBhbGw6IC4uLyQoTEFQQUNLTElCKQogCitsaWJsYXBh
Y2suc286ICQoQUxMT0JKKSAkKEFMTFhPQkopICQoREVQUkVDQVRFRCkKKwkk
KEZPUlRSQU4pIC1zaGFyZWQgLVdsLC1zb25hbWUsJEAgLW8gJEAgJChBTExP
QkopICQoQUxMWE9CSikgJChERVBSRUNBVEVEKQorCWNwIC1mIGxpYmxhcGFj
ay5zbyAuLiA7CisKIC4uLyQoTEFQQUNLTElCKTogJChBTExPQkopICQoQUxM
WE9CSikgJChERVBSRUNBVEVEKQotCSQoQVJDSCkgJChBUkNIRkxBR1MpICRA
ICReCisJJChBUkNIKSAkKEFSQ0hGTEFHUykgJEAgJChBTExPQkopICQoQUxM
WE9CSikgJChERVBSRUNBVEVEKQogCSQoUkFOTElCKSAkQAogCiBzaW5nbGU6
ICQoU0xBU1JDKSAkKERTTEFTUkMpICQoU1hMQVNSQykgJChTQ0xBVVgpICQo
QUxMQVVYKQotLS0gbGFwYWNrLTMuOC4wL0JMQVMvU1JDL01ha2VmaWxlCTIw
MTctMTEtMTMgMTU6MTU6NTQuMDAwMDAwMDAwICsxMTAwCisrKyBsYXBhY2st
My44LjAubW9kL0JMQVMvU1JDL01ha2VmaWxlCTIwMTgtMDItMTcgMDg6NDg6
MjEuMTc1MDIwNjE1ICsxMTAwCkBAIC01Nyw2ICs1NywxMCBAQAogCiBhbGw6
ICQoQkxBU0xJQikKIAorbGliYmxhcy5zbzogJChBTExPQkopCisJJChGT1JU
UkFOKSAtc2hhcmVkIC1XbCwtc29uYW1lLCRAIC1vICRAICQoQUxMT0JKKQor
CWNwIC1mIGxpYmJsYXMuc28gLi4vLi4gOworCiAjLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAj
ICBDb21tZW50IG91dCB0aGUgbmV4dCA2IGRlZmluaXRpb25zIGlmIHlvdSBh
bHJlYWR5IGhhdmUKICMgIHRoZSBMZXZlbCAxIEJMQVMuCg==
====
EOF
uudecode lapack-$LPVER.patch.uue
rm -Rf lapack-$LPVER
tar -xf lapack-$LPVER.tar.gz
pushd lapack-$LPVER
patch -p1 < ../lapack-$LPVER.patch
cp make.inc.example make.inc
popd

# Create directories
mkdir -p lapack
pushd lapack
mkdir -p $ALL_BUILDS

# Populate directories
for dir in $ALL_BUILDS ; do
  echo $dir
  pushd $dir
  cp -Rf ../../lapack-$LPVER .
  popd
done

# Set build options in each directory
for dir in generic intel ; do
  sed -i -e "s/^BLDOPTS\ *=.*/BLDOPTS\ \ = -fPIC -m64 -mtune=$dir/" $dir/lapack-$LPVER/make.inc
done
for dir in haswell nehalem skylake ; do
  sed -i -e "s/^BLDOPTS\ *=.*/BLDOPTS\ \ = -fPIC -march=$dir/" $dir/lapack-$LPVER/make.inc
done

# Build in each directory
for dir in $ALL_BUILDS ; do
  echo $dir ;
  pushd $dir/lapack-$LPVER/BLAS/SRC ;
  make $MAKE_OPTS ;
  make $MAKE_OPTS libblas.so ;
  popd
  pushd $dir/lapack-$LPVER/SRC ;
  make $MAKE_OPTS ;
  make $MAKE_OPTS liblapack.so ;
  popd;
done

# Done
popd
