#!/bin/bash

# A script to build shared and static versions of the Lapack libraries:
#  1. Assumes the NETLIB source archive lapack-$LAPACK_VERSION.tar.gz is present
#  2. Under directory lapack-$LAPACK_VERSION, make.inc.example, SRC/Makefile and
#     BLAS/SRC/Makefile are modified with lapack-$LAPACK_VERSION.patch

alias cp=cp

MAKE_OPTS="-j 6"
ALL_BUILDS="generic intel haswell nehalem skylake"

# Patch lapack files make.inc.example, SRC/Makefile and BLAS/SRC/Makefile
cat > lapack-$LAPACK_VERSION.patch.uue << 'EOF'
begin-base64 644 lapack-3.12.0.patch
LS0tIGxhcGFjay0zLjEyLjAvQkxBUy9TUkMvTWFrZWZpbGUJMjAyMy0xMS0y
NSAwNzo0MToxNS4wMDAwMDAwMDAgKzExMDAKKysrIGxhcGFjay0zLjEyLjAu
bmV3L0JMQVMvU1JDL01ha2VmaWxlCTIwMjQtMDgtMTUgMjI6NTA6MjMuNjM3
MzE5OTIxICsxMDAwCkBAIC0xNDksNiArMTQ5LDkgQEAKIAkkKEFSKSAkKEFS
RkxBR1MpICRAICReCiAJJChSQU5MSUIpICRACiAKKyQobm90ZGlyICQoQkxB
U0xJQjolLmE9JS5zbykpOiAkKEFMTE9CSikKKwkkKEZDKSAtc2hhcmVkIC1X
bCwtc29uYW1lLCRAIC1vICRAICReCisKIC5QSE9OWTogc2luZ2xlIGRvdWJs
ZSBjb21wbGV4IGNvbXBsZXgxNgogc2luZ2xlOiAkKFNCTEFTMSkgJChBTExC
TEFTKSAkKFNCTEFTMikgJChTQkxBUzMpCiAJJChBUikgJChBUkZMQUdTKSAk
KEJMQVNMSUIpICReCi0tLSBsYXBhY2stMy4xMi4wL0lOU1RBTEwvbWFrZS5p
bmMuZ2ZvcnRyYW4tcXVhZAkyMDIzLTExLTI1IDA3OjQxOjE1LjAwMDAwMDAw
MCArMTEwMAorKysgbGFwYWNrLTMuMTIuMC5uZXcvSU5TVEFMTC9tYWtlLmlu
Yy5nZm9ydHJhbi1xdWFkCTIwMjQtMDgtMTUgMjI6NTA6NTUuMzc0MDQ4MDM3
ICsxMDAwCkBAIC03LDcgKzcsOCBAQAogIyAgQ0MgaXMgdGhlIEMgY29tcGls
ZXIsIG5vcm1hbGx5IGludm9rZWQgd2l0aCBvcHRpb25zIENGTEFHUy4KICMK
IENDID0gZ2NjCi1DRkxBR1MgPSAtTzMKK0JMRE9QVFMgPSAtZlBJQyAtbTY0
IC1tYXJjaD1uZWhhbGVtCitDRkxBR1MgPSAtTzMgJChCTERPUFRTKQogCiAj
ICBNb2RpZnkgdGhlIEZDIGFuZCBGRkxBR1MgZGVmaW5pdGlvbnMgdG8gdGhl
IGRlc2lyZWQgY29tcGlsZXIKICMgIGFuZCBkZXNpcmVkIGNvbXBpbGVyIG9w
dGlvbnMgZm9yIHlvdXIgbWFjaGluZS4gIE5PT1BUIHJlZmVycyB0bwpAQCAt
MjQsMTAgKzI1LDEwIEBACiAjICBzKi9jKiBhbmQgZCoveiogZW50cnkgcG9p
bnRzIHdpbGwgZXhwZWN0IDEyOC1iaXQgZmxvYXRpbmctcG9pbnQKICMgIHR5
cGUuCiAjCi1GQyA9IGdmb3J0cmFuCi1GRkxBR1MgPSAtTzIgLWZyZWN1cnNp
dmUgLWZyZWFsLTQtcmVhbC0xNiAtZnJlYWwtOC1yZWFsLTE2CitGQyA9IGdm
b3J0cmFuIC1mcmVjdXJzaXZlICQoQkxET1BUUykKK0ZGTEFHUyA9IC1PMiAt
ZnJlYWwtOC1yZWFsLTE2CiBGRkxBR1NfRFJWID0gJChGRkxBR1MpCi1GRkxB
R1NfTk9PUFQgPSAtTzAgLWZyZWN1cnNpdmUgLWZyZWFsLTQtcmVhbC0xNiAt
ZnJlYWwtOC1yZWFsLTE2CitGRkxBR1NfTk9PUFQgPSAtTzAgLWZyZWFsLTgt
cmVhbC0xNgogCiAjICBEZWZpbmUgTERGTEFHUyB0byB0aGUgZGVzaXJlZCBs
aW5rZXIgb3B0aW9ucyBmb3IgeW91ciBtYWNoaW5lLgogIwpAQCAtNjIsNyAr
NjMsNyBAQAogIyAgVW5jb21tZW50IHRoZSBmb2xsb3dpbmcgbGluZSB0byBp
bmNsdWRlIGRlcHJlY2F0ZWQgcm91dGluZXMgaW4KICMgIHRoZSBMQVBBQ0sg
bGlicmFyeS4KICMKLSNCVUlMRF9ERVBSRUNBVEVEID0gWWVzCitCVUlMRF9E
RVBSRUNBVEVEID0gWWVzCiAKICMgIExBUEFDS0UgaGFzIHRoZSBpbnRlcmZh
Y2UgdG8gc29tZSByb3V0aW5lcyBmcm9tIHRtZ2xpYi4KICMgIElmIExBUEFD
S0VfV0lUSF9UTUcgaXMgZGVmaW5lZCwgYWRkIHRob3NlIHJvdXRpbmVzIHRv
IExBUEFDS0UuCkBAIC04MSw4ICs4MiwxMyBAQAogIyAgbWFjaGluZS1zcGVj
aWZpYywgb3B0aW1pemVkIEJMQVMgbGlicmFyeSBzaG91bGQgYmUgdXNlZCB3
aGVuZXZlcgogIyAgcG9zc2libGUuKQogIwotQkxBU0xJQiAgICAgID0gJChU
T1BTUkNESVIpL2xpYnJlZmJsYXMuYQotQ0JMQVNMSUIgICAgID0gJChUT1BT
UkNESVIpL2xpYmNibGFzLmEKLUxBUEFDS0xJQiAgICA9ICQoVE9QU1JDRElS
KS9saWJsYXBhY2suYQotVE1HTElCICAgICAgID0gJChUT1BTUkNESVIpL2xp
YnRtZ2xpYi5hCi1MQVBBQ0tFTElCICAgPSAkKFRPUFNSQ0RJUikvbGlibGFw
YWNrZS5hCitCTEFTTElCICAgICAgPSBsaWJxYmxhcy5hCitDQkxBU0xJQiAg
ICAgPSBsaWJxY2JsYXMuYQorTEFQQUNLTElCICAgID0gbGlicWxhcGFjay5h
CitUTUdMSUIgICAgICAgPSBsaWJxdG1nbGliLmEKK0xBUEFDS0VMSUIgICA9
IGxpYnFsYXBhY2tlLmEKKworIyAgRE9DVU1FTlRBVElPTiBESVJFQ1RPUlkK
KyMgSWYgeW91IGdlbmVyYXRlIGh0bWwgcGFnZXMgKG1ha2UgaHRtbCksIGRv
Y3VtZW50YXRpb24gd2lsbCBiZSBwbGFjZWQgaW4gJChET0NTRElSKS9leHBs
b3JlLWh0bWwKKyMgSWYgeW91IGdlbmVyYXRlIG1hbiBwYWdlcyAobWFrZSBt
YW4pLCBkb2N1bWVudGF0aW9uIHdpbGwgYmUgcGxhY2VkIGluICQoRE9DU0RJ
UikvbWFuCitET0NTRElSICAgICAgID0gJChUT1BTUkNESVIpL0RPQ1MKLS0t
IGxhcGFjay0zLjEyLjAvU1JDL01ha2VmaWxlCTIwMjMtMTEtMjUgMDc6NDE6
MTUuMDAwMDAwMDAwICsxMTAwCisrKyBsYXBhY2stMy4xMi4wLm5ldy9TUkMv
TWFrZWZpbGUJMjAyNC0wOC0xNSAyMjo1MDoyMy42MzkzMTk5MDMgKzEwMDAK
QEAgLTU2MSw2ICs1NjEsOSBAQAogCSQoQVIpICQoQVJGTEFHUykgJEAgJF4K
IAkkKFJBTkxJQikgJEAKIAorJChub3RkaXIgJChMQVBBQ0tMSUI6JS5hPSUu
c28pKTogJChBTExPQkopICQoQUxMWE9CSikgJChERVBSRUNBVEVEKQorCSQo
RkMpIC1zaGFyZWQgLVdsLC1zb25hbWUsJEAgLW8gJEAgJF4KKwogLlBIT05Z
OiBzaW5nbGUgY29tcGxleCBkb3VibGUgY29tcGxleDE2CiAKIFNJTkdMRV9E
RVBTIDo9ICQoU0xBU1JDKSAkKERTTEFTUkMpCi0tLSBsYXBhY2stMy4xMi4w
L21ha2UuaW5jLmV4YW1wbGUJMjAyMy0xMS0yNSAwNzo0MToxNS4wMDAwMDAw
MDAgKzExMDAKKysrIGxhcGFjay0zLjEyLjAubmV3L21ha2UuaW5jLmV4YW1w
bGUJMjAyNC0wOC0xNSAyMjo1MDoyMy42NDEzMTk4ODYgKzEwMDAKQEAgLTcs
NyArNyw4IEBACiAjICBDQyBpcyB0aGUgQyBjb21waWxlciwgbm9ybWFsbHkg
aW52b2tlZCB3aXRoIG9wdGlvbnMgQ0ZMQUdTLgogIwogQ0MgPSBnY2MKLUNG
TEFHUyA9IC1PMworQkxET1BUUyA9IC1mUElDIC1tNjQgLW1hcmNoPW5laGFs
ZW0KK0NGTEFHUyA9IC1PMyAkKEJMRE9QVFMpCiAKICMgIE1vZGlmeSB0aGUg
RkMgYW5kIEZGTEFHUyBkZWZpbml0aW9ucyB0byB0aGUgZGVzaXJlZCBjb21w
aWxlcgogIyAgYW5kIGRlc2lyZWQgY29tcGlsZXIgb3B0aW9ucyBmb3IgeW91
ciBtYWNoaW5lLiAgTk9PUFQgcmVmZXJzIHRvCkBAIC0xNywxMCArMTgsMTAg
QEAKICMgIGFuZCBoYW5kbGUgdGhlc2UgcXVhbnRpdGllcyBhcHByb3ByaWF0
ZWx5LiBBcyBhIGNvbnNlcXVlbmNlLCBvbmUKICMgIHNob3VsZCBub3QgY29t
cGlsZSBMQVBBQ0sgd2l0aCBmbGFncyBzdWNoIGFzIC1mZnBlLXRyYXA9b3Zl
cmZsb3cuCiAjCi1GQyA9IGdmb3J0cmFuCi1GRkxBR1MgPSAtTzIgLWZyZWN1
cnNpdmUKK0ZDID0gZ2ZvcnRyYW4gLWZyZWN1cnNpdmUgJChCTERPUFRTKQor
RkZMQUdTID0gLU8yICMgLWZyZWFsLTgtcmVhbC0xNgogRkZMQUdTX0RSViA9
ICQoRkZMQUdTKQotRkZMQUdTX05PT1BUID0gLU8wIC1mcmVjdXJzaXZlCitG
RkxBR1NfTk9PUFQgPSAtTzAKIAogIyAgRGVmaW5lIExERkxBR1MgdG8gdGhl
IGRlc2lyZWQgbGlua2VyIG9wdGlvbnMgZm9yIHlvdXIgbWFjaGluZS4KICMK
QEAgLTU1LDcgKzU2LDcgQEAKICMgIFVuY29tbWVudCB0aGUgZm9sbG93aW5n
IGxpbmUgdG8gaW5jbHVkZSBkZXByZWNhdGVkIHJvdXRpbmVzIGluCiAjICB0
aGUgTEFQQUNLIGxpYnJhcnkuCiAjCi0jQlVJTERfREVQUkVDQVRFRCA9IFll
cworQlVJTERfREVQUkVDQVRFRCA9IFllcwogCiAjICBMQVBBQ0tFIGhhcyB0
aGUgaW50ZXJmYWNlIHRvIHNvbWUgcm91dGluZXMgZnJvbSB0bWdsaWIuCiAj
ICBJZiBMQVBBQ0tFX1dJVEhfVE1HIGlzIGRlZmluZWQsIGFkZCB0aG9zZSBy
b3V0aW5lcyB0byBMQVBBQ0tFLgpAQCAtNzQsMTEgKzc1LDExIEBACiAjICBt
YWNoaW5lLXNwZWNpZmljLCBvcHRpbWl6ZWQgQkxBUyBsaWJyYXJ5IHNob3Vs
ZCBiZSB1c2VkIHdoZW5ldmVyCiAjICBwb3NzaWJsZS4pCiAjCi1CTEFTTElC
ICAgICAgPSAkKFRPUFNSQ0RJUikvbGlicmVmYmxhcy5hCi1DQkxBU0xJQiAg
ICAgPSAkKFRPUFNSQ0RJUikvbGliY2JsYXMuYQotTEFQQUNLTElCICAgID0g
JChUT1BTUkNESVIpL2xpYmxhcGFjay5hCi1UTUdMSUIgICAgICAgPSAkKFRP
UFNSQ0RJUikvbGlidG1nbGliLmEKLUxBUEFDS0VMSUIgICA9ICQoVE9QU1JD
RElSKS9saWJsYXBhY2tlLmEKK0JMQVNMSUIgICAgICA9IGxpYmJsYXMuYQor
Q0JMQVNMSUIgICAgID0gbGliY2JsYXMuYQorTEFQQUNLTElCICAgID0gbGli
bGFwYWNrLmEKK1RNR0xJQiAgICAgICA9IGxpYnRtZ2xpYi5hCitMQVBBQ0tF
TElCICAgPSBsaWJsYXBhY2tlLmEKIAogIyAgRE9DVU1FTlRBVElPTiBESVJF
Q1RPUlkKICMgSWYgeW91IGdlbmVyYXRlIGh0bWwgcGFnZXMgKG1ha2UgaHRt
bCksIGRvY3VtZW50YXRpb24gd2lsbCBiZSBwbGFjZWQgaW4gJChET0NTRElS
KS9leHBsb3JlLWh0bWwK
====
EOF
uudecode lapack-$LAPACK_VERSION.patch.uue
rm -Rf lapack-$LAPACK_VERSION
tar -xf lapack-$LAPACK_VERSION.tar.gz
pushd lapack-$LAPACK_VERSION
patch -p1 < ../lapack-$LAPACK_VERSION.patch
cp make.inc.example make.inc
popd

# Create directories
mkdir -p lapack
pushd lapack
mkdir -p $ALL_BUILDS

# Populate directories
for dir in $ALL_BUILDS ; do
  echo $dir
  pushd $dir
  cp -Rf ../../lapack-$LAPACK_VERSION .
  popd
done

# Set build options in each directory
for dir in generic intel ; do
  sed -i -e "s/^BLDOPTS\ *=.*/BLDOPTS\ \ = -fPIC -m64 -mtune=$dir/" $dir/lapack-$LAPACK_VERSION/make.inc
done
for dir in haswell nehalem skylake ; do
  sed -i -e "s/^BLDOPTS\ *=.*/BLDOPTS\ \ = -fPIC -march=$dir/" $dir/lapack-$LAPACK_VERSION/make.inc
done

# Build in each directory
for dir in $ALL_BUILDS ; do
  echo $dir ;
  pushd $dir/lapack-$LAPACK_VERSION/BLAS/SRC ;
  make $MAKE_OPTS ;
  make $MAKE_OPTS libblas.so ;
  cp libblas.so ../.. ;
  popd ;
  pushd $dir/lapack-$LAPACK_VERSION/SRC ;
  make $MAKE_OPTS ;
  make $MAKE_OPTS liblapack.so ;
  cp liblapack.so .. ;
  popd ;
done

# Done
popd
