#!/bin/sh

# Assume these files are present:
#  SuiteSparse-5.10.1.tar.gz
#  arpack-ng-master.zip
#  fftw-3.3.10.tar.gz
#  qrupdate-1.1.2.tar.gz

export LDFLAGS="-L"$LAPACK_DIR

#
# Build arpack-ng
#
rm -Rf arpack-ng-master
unzip arpack-ng-master.zip
pushd arpack-ng-master
sh ./bootstrap
./configure --prefix=$LOCAL_PREFIX --with-blas=-lblas --with-lapack=-llapack
make -j 6 && make install
popd

#
# Build SuiteSparse
#
SUITESPARSE_VER=5.10.1
rm -Rf SuiteSparse-$SUITESPARSE_VER
tar -xf SuiteSparse-$SUITESPARSE_VER.tar.gz
# Building GraphBLAS is very slow so dont
cat > SuiteSparse-$SUITESPARSE_VER".patch.uue" << 'EOF'
begin-base64 644 SuiteSparse-5.10.1.patch
LS0tIFN1aXRlU3BhcnNlLTUuMTAuMS5vcmlnL01ha2VmaWxlCTIwMjEtMDUt
MTggMjM6MDE6MTYuMDAwMDAwMDAwICsxMDAwCisrKyBTdWl0ZVNwYXJzZS01
LjEwLjEvTWFrZWZpbGUJMjAyMS0wOS0yMCAxMjozNToyMS40NDM5NzQ4Nzcg
KzEwMDAKQEAgLTM0LDcgKzM0LDcgQEAKIAkoIGNkIEdQVVFSRW5naW5lICYm
ICQoTUFLRSkgKQogZW5kaWYKIAkoIGNkIFNQUVIgJiYgJChNQUtFKSApCi0J
KCBjZCBHcmFwaEJMQVMgJiYgJChNQUtFKSBKT0JTPSQoSk9CUykgQ01BS0Vf
T1BUSU9OUz0nJChDTUFLRV9PUFRJT05TKScgKQorIwkoIGNkIEdyYXBoQkxB
UyAmJiAkKE1BS0UpIEpPQlM9JChKT0JTKSBDTUFLRV9PUFRJT05TPSckKENN
QUtFX09QVElPTlMpJyApCiAJKCBjZCBTTElQX0xVICYmICQoTUFLRSkgKQog
IwkoIGNkIFBJUk9fQkFORCAmJiAkKE1BS0UpICkKICMJKCBjZCBTS1lMSU5F
X1NWRCAmJiAkKE1BS0UpICkKQEAgLTYzLDcgKzYzLDcgQEAKIAkoIGNkIEdQ
VVFSRW5naW5lICYmICQoTUFLRSkgaW5zdGFsbCApCiBlbmRpZgogCSggY2Qg
U1BRUiAmJiAkKE1BS0UpIGluc3RhbGwgKQotCSggY2QgR3JhcGhCTEFTICYm
ICQoTUFLRSkgSk9CUz0kKEpPQlMpIENNQUtFX09QVElPTlM9JyQoQ01BS0Vf
T1BUSU9OUyknIGluc3RhbGwgKQorIwkoIGNkIEdyYXBoQkxBUyAmJiAkKE1B
S0UpIEpPQlM9JChKT0JTKSBDTUFLRV9PUFRJT05TPSckKENNQUtFX09QVElP
TlMpJyBpbnN0YWxsICkKICMJKCBjZCBQSVJPX0JBTkQgJiYgJChNQUtFKSBp
bnN0YWxsICkKICMJKCBjZCBTS1lMSU5FX1NWRCAmJiAkKE1BS0UpIGluc3Rh
bGwgKQogCSggY2QgU0xJUF9MVSAmJiAkKE1BS0UpIGluc3RhbGwgKQpAQCAt
MTQ0LDcgKzE0NCw3IEBACiAJKCBjZCBHUFVRUkVuZ2luZSAmJiAkKE1BS0Up
IGxpYnJhcnkgKQogZW5kaWYKIAkoIGNkIFNQUVIgJiYgJChNQUtFKSBsaWJy
YXJ5ICkKLQkoIGNkIEdyYXBoQkxBUyAmJiAkKE1BS0UpIEpPQlM9JChKT0JT
KSBDTUFLRV9PUFRJT05TPSckKENNQUtFX09QVElPTlMpJyBsaWJyYXJ5ICkK
KyMJKCBjZCBHcmFwaEJMQVMgJiYgJChNQUtFKSBKT0JTPSQoSk9CUykgQ01B
S0VfT1BUSU9OUz0nJChDTUFLRV9PUFRJT05TKScgbGlicmFyeSApCiAJKCBj
ZCBTTElQX0xVICYmICQoTUFLRSkgbGlicmFyeSApCiAjCSggY2QgUElST19C
QU5EICYmICQoTUFLRSkgbGlicmFyeSApCiAjCSggY2QgU0tZTElORV9TVkQg
JiYgJChNQUtFKSBsaWJyYXJ5ICkKQEAgLTE3Miw3ICsxNzIsNyBAQAogCSgg
Y2QgR1BVUVJFbmdpbmUgJiYgJChNQUtFKSBzdGF0aWMgKQogZW5kaWYKIAko
IGNkIFNQUVIgJiYgJChNQUtFKSBzdGF0aWMgKQotCSggY2QgR3JhcGhCTEFT
ICYmICQoTUFLRSkgSk9CUz0kKEpPQlMpIENNQUtFX09QVElPTlM9JyQoQ01B
S0VfT1BUSU9OUyknIHN0YXRpYyApCisjCSggY2QgR3JhcGhCTEFTICYmICQo
TUFLRSkgSk9CUz0kKEpPQlMpIENNQUtFX09QVElPTlM9JyQoQ01BS0VfT1BU
SU9OUyknIHN0YXRpYyApCiAJKCBjZCBTTElQX0xVICYmICQoTUFLRSkgc3Rh
dGljICkKICMJKCBjZCBQSVJPX0JBTkQgJiYgJChNQUtFKSBzdGF0aWMgKQog
IwkoIGNkIFNLWUxJTkVfU1ZEICYmICQoTUFLRSkgc3RhdGljICkKQEAgLTIz
Myw3ICsyMzMsNyBAQAogCiAjIENyZWF0ZSB0aGUgUERGIGRvY3VtZW50YXRp
b24KIGRvY3M6Ci0JKCBjZCBHcmFwaEJMQVMgJiYgJChNQUtFKSBkb2NzICkK
KyMJKCBjZCBHcmFwaEJMQVMgJiYgJChNQUtFKSBkb2NzICkKIAkoIGNkIE1v
bmdvb3NlICAmJiAkKE1BS0UpIGRvY3MgKQogCSggY2QgQU1EICYmICQoTUFL
RSkgZG9jcyApCiAJKCBjZCBDQU1EICYmICQoTUFLRSkgZG9jcyApCg==
====
EOF
uudecode SuiteSparse-$SUITESPARSE_VER".patch.uue" > \
	 SuiteSparse-$SUITESPARSE_VER".patch"
pushd SuiteSparse-$SUITESPARSE_VER
patch -p 1 < ../SuiteSparse-$SUITESPARSE_VER".patch"
make INSTALL=$LOCAL_PREFIX OPTIMIZATION=-O2 BLAS=-lblas LAPACK=-llapack install
popd

#
# Build qrupdate
#
QRUPDATE_VER=1.1.2
rm -Rf qrupdate-$QRUPDATE_VER
tar -xf qrupdate-$QRUPDATE_VER.tar.gz
pushd qrupdate-$QRUPDATE_VER
rm -f Makeconf
cat > Makeconf << 'EOF'
FC=gfortran
FFLAGS=-fimplicit-none -O2 -funroll-loops 
FPICFLAGS=-fPIC

ifeq ($(strip $(PREFIX)),)
  PREFIX=/usr/local
endif

BLAS=-L$(LAPACK_DIR) -lblas
LAPACK=-L$(LAPACK_DIR) -llapack

VERSION=1.1
MAJOR=1
LIBDIR=lib
DESTDIR=
EOF
make PREFIX=$LOCAL_PREFIX solib install
popd

#
# Build fftw
#
FFTW_VER=3.3.10
rm -Rf fftw-$FFTW_VER
tar -xf fftw-$FFW_VER".tar.gz"
pushd fftw-$FFTW_VER
./configure --prefix=$LOCAL_PREFIX --enable-shared \
            --with-combined-threads --enable-threads 
make -j 6 && make install
popd

#
# Build fftw single-precision
#
rm -Rf fftw-$FFTW_VER
tar -xf fftw-$FFTW_VER".tar.gz"
pushd fftw-$FFTW_VER
./configure --prefix=$LOCAL_PREFIX --enable-shared \
            --with-combined-threads --enable-threads --enable-single
make -j 6 && make install
popd
