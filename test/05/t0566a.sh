#!/bin/sh

prog=kyp_complex_curve_union_test.m

depends="test/kyp_complex_curve_union_test.m test_common.m print_polynomial.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
l = 4
Jl =
   1   0   0   0   0
   0   1   0   0   0
   0   0   1   0   0
   0   0   0   1   0
   0   1   0   0   0
   0   0   1   0   0
   0   0   0   1   0
   0   0   0   0   1

alpha =
  -0.7500  -0.2500   0.2500   0.7500

beta =
  -0.6000  -0.1000   0.4000   0.9000

a = 1
b = 1
a =
   1.0000
   0.7500

b =
   1.0000
   0.6000

a =
   1.0000
   1.0000
   0.1875

b =
   1.000000
   0.700000
   0.060000

a =
   1.000000
   0.750000
  -0.062500
  -0.046875

b =
   1.000000
   0.300000
  -0.220000
  -0.024000

a =
   1.0000
        0
  -0.6250
        0
   0.0352

b =
   1.000000
  -0.600000
  -0.490000
   0.174000
   0.021600

Psi =
  -2.0000   0.6000   1.1150  -0.1740  -0.0568
   0.6000        0  -0.3750        0   0.0211
   1.1150  -0.3750  -0.6125   0.1087   0.0307
  -0.1740        0   0.1087        0  -0.0061
  -0.0568   0.0211   0.0307  -0.0061  -0.0015

Phi =
 Columns 1 through 4:
        0 +      0i        0 + 0.6000i        0 - 0.1350i        0 - 0.1740i
        0 - 0.6000i        0 +      0i        0 + 0.3750i        0 +      0i
        0 + 0.1350i        0 - 0.3750i        0 +      0i        0 + 0.1087i
        0 + 0.1740i        0 +      0i        0 - 0.1087i        0 +      0i
        0 - 0.0136i        0 + 0.0211i        0 + 0.0037i        0 - 0.0061i
 Column 5:
        0 + 0.0136i
        0 - 0.0211i
        0 - 0.0037i
        0 + 0.0061i
        0 +      0i

Symbolic pkg v3.0.1: Python communication link active, SymPy v1.10.1.
R = (sym 4×4 matrix)
  ⎡r₁₁  r₁₂  r₁₃  r₁₄⎤
  ⎢                  ⎥
  ⎢r₁₂  r₂₂  r₂₃  r₂₄⎥
  ⎢                  ⎥
  ⎢r₁₃  r₂₃  r₃₃  r₃₄⎥
  ⎢                  ⎥
  ⎣r₁₄  r₂₄  r₃₄  r₄₄⎦
ans = (sym 5×5 matrix)
  ⎡  0         ⅈ⋅r₁₁          ⅈ⋅r₁₃           ⅈ⋅r₁₂       ⅈ⋅r₁₄⎤
  ⎢                                                            ⎥
  ⎢-ⅈ⋅r₁₁        0        -ⅈ⋅r₁₂ + ⅈ⋅r₃₃  -ⅈ⋅r₁₄ + ⅈ⋅r₂₃  ⅈ⋅r₃₄⎥
  ⎢                                                            ⎥
  ⎢-ⅈ⋅r₁₃  ⅈ⋅r₁₂ - ⅈ⋅r₃₃        0         ⅈ⋅r₂₂ - ⅈ⋅r₃₄   ⅈ⋅r₂₄⎥
  ⎢                                                            ⎥
  ⎢-ⅈ⋅r₁₂  ⅈ⋅r₁₄ - ⅈ⋅r₂₃  -ⅈ⋅r₂₂ + ⅈ⋅r₃₄        0         ⅈ⋅r₄₄⎥
  ⎢                                                            ⎥
  ⎣-ⅈ⋅r₁₄     -ⅈ⋅r₃₄          -ⅈ⋅r₂₄          -ⅈ⋅r₄₄        0  ⎦
RR =
   6.0000e-01  -1.7400e-01  -1.3500e-01   1.3556e-02
  -1.7400e-01   8.7656e-02   1.3556e-02  -3.7266e-03
  -1.3500e-01   1.3556e-02   2.0100e-01  -2.1094e-02
   1.3556e-02  -3.7266e-03  -2.1094e-02   6.1172e-03

alpha =
     -Inf  -0.6000  -0.1000   0.4000

beta =
  -0.7500  -0.2500   0.2500      Inf

a = 1
b = 1
b =
   1.0000
   0.7500

a =
   1.0000
   0.6000
        0

b =
   1.0000
   1.0000
   0.1875

a =
   1.0000
   0.7000
   0.0600
        0

b =
   1.000000
   0.750000
  -0.062500
  -0.046875

a =
   1.0000
   0.3000
  -0.2200
  -0.0240
        0

Psi =
   2.0000   1.0500  -0.2825  -0.0709        0
   1.0500   0.4500  -0.1837  -0.0321        0
  -0.2825  -0.1837   0.0275   0.0118        0
  -0.0709  -0.0321   0.0118   0.0022        0
        0        0        0        0        0

Phi =
 Columns 1 through 4:
        0 +      0i        0 + 0.4500i        0 + 0.1575i        0 - 0.0229i
        0 - 0.4500i        0 +      0i        0 + 0.1462i        0 + 0.0039i
        0 - 0.1575i        0 - 0.1462i        0 +      0i        0 + 0.0088i
        0 + 0.0229i        0 - 0.0039i        0 - 0.0088i        0 +      0i
        0 +      0i        0 +      0i        0 +      0i        0 +      0i
 Column 5:
        0 +      0i
        0 +      0i
        0 +      0i
        0 +      0i
        0 +      0i

R = (sym 4×4 matrix)
  ⎡r₁₁  r₁₂  r₁₃  r₁₄⎤
  ⎢                  ⎥
  ⎢r₁₂  r₂₂  r₂₃  r₂₄⎥
  ⎢                  ⎥
  ⎢r₁₃  r₂₃  r₃₃  r₃₄⎥
  ⎢                  ⎥
  ⎣r₁₄  r₂₄  r₃₄  r₄₄⎦
ans = (sym 5×5 matrix)
  ⎡  0         ⅈ⋅r₁₁          ⅈ⋅r₁₃           ⅈ⋅r₁₂       ⅈ⋅r₁₄⎤
  ⎢                                                            ⎥
  ⎢-ⅈ⋅r₁₁        0        -ⅈ⋅r₁₂ + ⅈ⋅r₃₃  -ⅈ⋅r₁₄ + ⅈ⋅r₂₃  ⅈ⋅r₃₄⎥
  ⎢                                                            ⎥
  ⎢-ⅈ⋅r₁₃  ⅈ⋅r₁₂ - ⅈ⋅r₃₃        0         ⅈ⋅r₂₂ - ⅈ⋅r₃₄   ⅈ⋅r₂₄⎥
  ⎢                                                            ⎥
  ⎢-ⅈ⋅r₁₂  ⅈ⋅r₁₄ - ⅈ⋅r₂₃  -ⅈ⋅r₂₂ + ⅈ⋅r₃₄        0         ⅈ⋅r₄₄⎥
  ⎢                                                            ⎥
  ⎣-ⅈ⋅r₁₄     -ⅈ⋅r₃₄          -ⅈ⋅r₂₄          -ⅈ⋅r₄₄        0  ⎦
RR =
   0.4500  -0.0229   0.1575        0
  -0.0229   0.0088   0.0039        0
   0.1575   0.0039   0.1234        0
        0        0        0        0

l = 4
Jl =
   1   0   0   0   0
   0   1   0   0   0
   0   0   1   0   0
   0   0   0   1   0
   0   1   0   0   0
   0   0   1   0   0
   0   0   0   1   0
   0   0   0   0   1

alpha =
  -0.7500  -0.2500   0.2500   0.7500

beta =
  -0.6000  -0.1000   0.4000   0.9000

a = 1
b = 1
a =
   1.0000
   0.7500

b =
   1.0000
   0.6000

a =
   1.0000
   1.0000
   0.1875

b =
   1.000000
   0.700000
   0.060000

a =
   1.000000
   0.750000
  -0.062500
  -0.046875

b =
   1.000000
   0.300000
  -0.220000
  -0.024000

a =
   1.0000
        0
  -0.6250
        0
   0.0352

b =
   1.000000
  -0.600000
  -0.490000
   0.174000
   0.021600

Phi =
 Columns 1 through 4:
        0 +      0i        0 + 0.6000i        0 - 0.1350i        0 - 0.1740i
        0 - 0.6000i        0 +      0i        0 + 0.3750i        0 +      0i
        0 + 0.1350i        0 - 0.3750i        0 +      0i        0 + 0.1087i
        0 + 0.1740i        0 +      0i        0 - 0.1087i        0 +      0i
        0 - 0.0136i        0 + 0.0211i        0 + 0.0037i        0 - 0.0061i
 Column 5:
        0 + 0.0136i
        0 - 0.0211i
        0 - 0.0037i
        0 + 0.0061i
        0 +      0i

Psi =
  -2.0000   0.6000   1.1150  -0.1740  -0.0568
   0.6000        0  -0.3750        0   0.0211
   1.1150  -0.3750  -0.6125   0.1087   0.0307
  -0.1740        0   0.1087        0  -0.0061
  -0.0568   0.0211   0.0307  -0.0061  -0.0015

R = (sym 4×4 matrix)
  ⎡r₁₁  r₁₂  r₁₃  r₁₄⎤
  ⎢                  ⎥
  ⎢r₁₂  r₂₂  r₂₃  r₂₄⎥
  ⎢                  ⎥
  ⎢r₁₃  r₂₃  r₃₃  r₃₄⎥
  ⎢                  ⎥
  ⎣r₁₄  r₂₄  r₃₄  r₄₄⎦
ans = (sym 5×5 matrix)
  ⎡  0         ⅈ⋅r₁₁          ⅈ⋅r₁₃           ⅈ⋅r₁₂       ⅈ⋅r₁₄⎤
  ⎢                                                            ⎥
  ⎢-ⅈ⋅r₁₁        0        -ⅈ⋅r₁₂ + ⅈ⋅r₃₃  -ⅈ⋅r₁₄ + ⅈ⋅r₂₃  ⅈ⋅r₃₄⎥
  ⎢                                                            ⎥
  ⎢-ⅈ⋅r₁₃  ⅈ⋅r₁₂ - ⅈ⋅r₃₃        0         ⅈ⋅r₂₂ - ⅈ⋅r₃₄   ⅈ⋅r₂₄⎥
  ⎢                                                            ⎥
  ⎢-ⅈ⋅r₁₂  ⅈ⋅r₁₄ - ⅈ⋅r₂₃  -ⅈ⋅r₂₂ + ⅈ⋅r₃₄        0         ⅈ⋅r₄₄⎥
  ⎢                                                            ⎥
  ⎣-ⅈ⋅r₁₄     -ⅈ⋅r₃₄          -ⅈ⋅r₂₄          -ⅈ⋅r₄₄        0  ⎦
RR =
   6.0000e-01  -1.7400e-01  -1.3500e-01   1.3556e-02
  -1.7400e-01   8.7656e-02   1.3556e-02  -3.7266e-03
  -1.3500e-01   1.3556e-02   2.0100e-01  -2.1094e-02
   1.3556e-02  -3.7266e-03  -2.1094e-02   6.1172e-03

alpha =
     -Inf  -0.6000  -0.1000   0.4000

beta =
  -0.7500  -0.2500   0.2500      Inf

a = 1
b = 1
b =
   1.0000
   0.7500

a =
   1.0000
   0.6000
        0

b =
   1.0000
   1.0000
   0.1875

a =
   1.0000
   0.7000
   0.0600
        0

b =
   1.000000
   0.750000
  -0.062500
  -0.046875

a =
   1.0000
   0.3000
  -0.2200
  -0.0240
        0

Phi =
 Columns 1 through 4:
        0 +      0i        0 + 0.4500i        0 + 0.1575i        0 - 0.0229i
        0 - 0.4500i        0 +      0i        0 + 0.1462i        0 + 0.0039i
        0 - 0.1575i        0 - 0.1462i        0 +      0i        0 + 0.0088i
        0 + 0.0229i        0 - 0.0039i        0 - 0.0088i        0 +      0i
        0 +      0i        0 +      0i        0 +      0i        0 +      0i
 Column 5:
        0 +      0i
        0 +      0i
        0 +      0i
        0 +      0i
        0 +      0i

Psi =
   2.0000   1.0500  -0.2825  -0.0709        0
   1.0500   0.4500  -0.1837  -0.0321        0
  -0.2825  -0.1837   0.0275   0.0118        0
  -0.0709  -0.0321   0.0118   0.0022        0
        0        0        0        0        0

R = (sym 4×4 matrix)
  ⎡r₁₁  r₁₂  r₁₃  r₁₄⎤
  ⎢                  ⎥
  ⎢r₁₂  r₂₂  r₂₃  r₂₄⎥
  ⎢                  ⎥
  ⎢r₁₃  r₂₃  r₃₃  r₃₄⎥
  ⎢                  ⎥
  ⎣r₁₄  r₂₄  r₃₄  r₄₄⎦
ans = (sym 5×5 matrix)
  ⎡  0         ⅈ⋅r₁₁          ⅈ⋅r₁₃           ⅈ⋅r₁₂       ⅈ⋅r₁₄⎤
  ⎢                                                            ⎥
  ⎢-ⅈ⋅r₁₁        0        -ⅈ⋅r₁₂ + ⅈ⋅r₃₃  -ⅈ⋅r₁₄ + ⅈ⋅r₂₃  ⅈ⋅r₃₄⎥
  ⎢                                                            ⎥
  ⎢-ⅈ⋅r₁₃  ⅈ⋅r₁₂ - ⅈ⋅r₃₃        0         ⅈ⋅r₂₂ - ⅈ⋅r₃₄   ⅈ⋅r₂₄⎥
  ⎢                                                            ⎥
  ⎢-ⅈ⋅r₁₂  ⅈ⋅r₁₄ - ⅈ⋅r₂₃  -ⅈ⋅r₂₂ + ⅈ⋅r₃₄        0         ⅈ⋅r₄₄⎥
  ⎢                                                            ⎥
  ⎣-ⅈ⋅r₁₄     -ⅈ⋅r₃₄          -ⅈ⋅r₂₄          -ⅈ⋅r₄₄        0  ⎦
RR =
   0.4500  -0.0229   0.1575        0
  -0.0229   0.0088   0.0039        0
   0.1575   0.0039   0.1234        0
        0        0        0        0


l = 2
Jl =
   1   0   0
   0   1   0
   0   1   0
   0   0   1

Symbolic pkg v3.0.1: Python communication link active, SymPy v1.10.1.
ans = (sym 3×3 matrix)
  ⎡        0                      α₁ + α₂ - β₁ - β₂                         -ⅈ⋅α
  ⎢                                                                             
  ⎢α₁ + α₂ - β₁ - β₂                      0                      α₁⋅α₂⋅β₁ + α₁⋅α
  ⎢                                                                             
  ⎣ⅈ⋅α₁⋅α₂ - ⅈ⋅β₁⋅β₂  α₁⋅α₂⋅β₁ + α₁⋅α₂⋅β₂ - α₁⋅β₁⋅β₂ - α₂⋅β₁⋅β₂                 
  
  ₁⋅α₂ + ⅈ⋅β₁⋅β₂            ⎤
                            ⎥
  ₂⋅β₂ - α₁⋅β₁⋅β₂ - α₂⋅β₁⋅β₂⎥
                            ⎥
       0                    ⎦
ans = (sym 3×3 matrix)
  ⎡ 0       -r₁₁     -r₁₂⎤
  ⎢                      ⎥
  ⎢             ___      ⎥
  ⎢-r₁₁  -r₁₂ - r₁₂  -r₂₂⎥
  ⎢                      ⎥
  ⎢ ___                  ⎥
  ⎣-r₁₂     -r₂₂      0  ⎦
ans = (sym 2×2 matrix)
  ⎡-α₁ - α₂ + β₁ + β₂              ⅈ⋅α₁⋅α₂ - ⅈ⋅β₁⋅β₂             ⎤
  ⎢                                                              ⎥
  ⎣-ⅈ⋅α₁⋅α₂ + ⅈ⋅β₁⋅β₂  -α₁⋅α₂⋅β₁ - α₁⋅α₂⋅β₂ + α₁⋅β₁⋅β₂ + α₂⋅β₁⋅β₂⎦
Phi =
        0 +      0i  -0.3000 +      0i        0 + 0.0700i
  -0.3000 +      0i        0 +      0i  -0.0190 +      0i
        0 - 0.0700i  -0.0190 +      0i        0 +      0i

Psi =
  -2.0000 +      0i        0 + 1.1000i   0.1300 +      0i
        0 - 1.1000i  -0.5600 +      0i        0 + 0.0610i
   0.1300 +      0i        0 - 0.0610i  -0.0060 +      0i


EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.ok "; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave --no-gui -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.ok"; fail; fi

#
# this much worked
#
pass

