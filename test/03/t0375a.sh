#!/bin/sh

prog=saramakiFAvNewton_test.m
depends="saramakiFAvNewton_test.m test_common.m saramakiFAvNewton.m \
saramakiFAv.m local_max.m qroots.m qzsolve.oct"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
echo $here
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
n =  6
m =  5
fp =  0.10000
fs =  0.20000
dBap =  0.010000
delta1 =  0.0011506
zeta =

  -0.080701  -0.025086

iFmin =

      1
    960
   1804

ans =

     462662861.76780
   88151616104.15921
   34815183409.50711

A =

  -4.9839e+10  -2.4882e+10  -1.0000e+00
   2.1662e+13  -1.6949e+13  -1.0000e+00
   2.2040e+12   5.3234e+12  -1.0000e+00

b =

    -462662861.76780
  -88151616104.15921
  -34815183409.50711

x =

          -0.0068090
          -0.0035538
   890438899.6268742

alpha =

  -0.068971  -0.047178

del_lambda =  890438899.62687
lambda =  890438899.62687
iFmin =

      1
    766
   1762

ans =

    1411373037.76673
   35304685284.84563
   14214538873.48432

A =

  -2.4043e+11  -8.3974e+10  -1.0000e+00
   7.3948e+12  -5.7647e+12  -1.0000e+00
   7.6381e+11   1.8385e+12  -1.0000e+00

b =

    -520934138.13986
  -34414246385.21876
  -13324099973.85744

x =

  -6.7649e-03
  -3.1260e-03
   2.4099e+09

alpha =

  -0.075736  -0.050304

del_lambda =  2409885509.38930
lambda =  3300324409.01617
iFmin =

      1
    578
   1723

ans =

    9566654584.91420
   15180341073.09399
    6933576966.81629

A =

  -3.8524e+12  -6.2790e+11  -1.0000e+00
   2.7400e+12  -2.1146e+12  -1.0000e+00
   3.2337e+11   7.9234e+11  -1.0000e+00

b =

   -6266330175.89803
  -11880016664.07782
   -3633252557.80012

x =

  -2.6061e-04
   2.6202e-03
   5.6251e+09

alpha =

  -0.075997  -0.047684

del_lambda =  5625091586.56476
lambda =  8925415995.58093
iFmin =

      1
    605
   1748

ans =

    9035311614.89281
   10296025051.95647
    9408098229.32797

A =

  -3.8401e+12  -5.4584e+11  -1.0000e+00
   1.7031e+12  -1.2688e+12  -1.0000e+00
   4.2922e+11   1.2078e+12  -1.0000e+00

b =

   -109895619.31188
  -1370609056.37554
   -482682233.74704

x =

  -1.9367e-04
   2.5892e-04
   7.1227e+08

alpha =

  -0.076191  -0.047425

del_lambda =  712270250.16412
lambda =  9637686245.74506
iFmin =

      1
    604
   1750

ans =

   9675661292.21486
   9663144767.37709
   9642896525.97674

A =

  -4.2889e+12  -5.7997e+11  -1.0000e+00
   1.5768e+12  -1.1701e+12  -1.0000e+00
   4.3745e+11   1.2543e+12  -1.0000e+00

b =

  -37975046.46980
  -25458521.63203
   -5210280.23168

x =

   3.1216e-06
   9.8192e-06
   1.8892e+07

alpha =

  -0.076187  -0.047415

del_lambda =  18891781.17380
lambda =  9656578026.91885
iFmin =

      1
    604
   1750

ans =

   9656602297.74362
   9656584301.75777
   9656591721.42377

A =

  -4.2775e+12  -5.7865e+11  -1.0000e+00
   1.5762e+12  -1.1686e+12  -1.0000e+00
   4.3810e+11   1.2569e+12  -1.0000e+00

b =

  -24270.82476
   -6274.83892
  -13694.50491

x =

   2.9033e-09
  -1.6968e-09
   1.2834e+04

alpha =

  -0.076187  -0.047415

del_lambda =  12833.78250
lambda =  9656590860.70135
iFmin =

      1
    604
   1750

ans =

   9656590860.71215
   9656590860.70422
   9656590860.70154

A =

  -4.2775e+12  -5.7865e+11  -1.0000e+00
   1.5762e+12  -1.1686e+12  -1.0000e+00
   4.3810e+11   1.2569e+12  -1.0000e+00

b =

  -0.01079941
  -0.00287628
  -0.00019455

x =

   1.5377e-15
   1.8272e-15
   3.1647e-03

alpha =

  -0.076187  -0.047415

del_lambda =  0.0031647
lambda =  9656590860.70451
beta =

  -0.29382 + 0.14006i
  -0.29382 - 0.14006i
  -0.04918 + 0.28649i
  -0.04918 - 0.28649i
   0.20686 + 0.14654i
   0.20686 - 0.14654i

z =

   0.27418 + 0.96168i
   0.27418 - 0.96168i
  -0.10473 + 0.99450i
  -0.10473 - 0.99450i
  -1.00000 + 0.00000i

p =

   0.69304 + 0.60140i
   0.69304 - 0.60140i
   0.64214 + 0.40980i
   0.64214 - 0.40980i
   0.62984 + 0.14642i
   0.62984 - 0.14642i

K =  0.0033317
dBas =  67.447
iter =  6
b =

   0.0033317   0.0022026   0.0051516   0.0051516   0.0022026   0.0033317

a =

   1.00000  -3.93003   6.98428  -7.03616   4.20291  -1.40391   0.20429

EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.ok"; fail; fi

#
# run and see if the results match
#
echo "Running octave-cli -q " $prog
echo "warning('off');" >> .octaverc
octave-cli -q $prog > test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.ok"; fail; fi

#
# this much worked
#
pass
