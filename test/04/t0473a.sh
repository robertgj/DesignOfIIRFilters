#!/bin/sh

prog=mcclellanFIRdifferentiator_test.m

depends="test/mcclellanFIRdifferentiator_test.m test_common.m \
print_polynomial.m mcclellanFIRdifferentiator.m local_max.m qroots.oct \
"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test_hM.ok << 'EOF'
hM = [  0.000474368370, -0.000083283228, -0.000046608864,  0.000034095330, ... 
        0.000050054699, -0.000026780767, -0.000054365196,  0.000023771143, ... 
        0.000058210413, -0.000021890168, -0.000061288931,  0.000020974512, ... 
        0.000064125498, -0.000020832925, -0.000067248454,  0.000020962330, ... 
        0.000070700957, -0.000021016675, -0.000074246079,  0.000021017447, ... 
        0.000077784199, -0.000021099414, -0.000081425540,  0.000021239523, ... 
        0.000085254860, -0.000021308179, -0.000089199950,  0.000021269672, ... 
        0.000093158112, -0.000021208442, -0.000097140363,  0.000021181616, ... 
        0.000101224549, -0.000021145045, -0.000105426427,  0.000021042514, ... 
        0.000109693389, -0.000020892784, -0.000114005485,  0.000020743928, ... 
        0.000118411512, -0.000020586148, -0.000122954412,  0.000020362604, ... 
        0.000127615158, -0.000020048038, -0.000132357240,  0.000019666134, ... 
        0.000137188557, -0.000019228675, -0.000142142511,  0.000018702489, ... 
        0.000147218372, -0.000018053452, -0.000152379822,  0.000017290327, ... 
        0.000157608388, -0.000016439853, -0.000162922836,  0.000015499452, ... 
        0.000168338586, -0.000014443892, -0.000173838210,  0.000013268998, ... 
        0.000179399138, -0.000011998362, -0.000185029199,  0.000010644728, ... 
        0.000190752382, -0.000009190743, -0.000196571329,  0.000007617500, ... 
        0.000202467735, -0.000005930891, -0.000208436076,  0.000004143760, ... 
        0.000214493180, -0.000002246313, -0.000220649604,  0.000000213782, ... 
        0.000226891418,  0.000001963090, -0.000233200916, -0.000004274847, ... 
        0.000239580313,  0.000006720052, -0.000246040379, -0.000009316332, ... 
        0.000252575293,  0.000012078745, -0.000259165854, -0.000015002637, ... 
        0.000265804492,  0.000018078671, -0.000272500561, -0.000021314010, ... 
        0.000279258715,  0.000024725317, -0.000286067072, -0.000028317008, ... 
        0.000292913614,  0.000032081249, -0.000299802202, -0.000036018595, ... 
        0.000306741807,  0.000040144557, -0.000313727574, -0.000044472026, ... 
        0.000320744690,  0.000048999225, -0.000327787310, -0.000053722189, ... 
        0.000334860856,  0.000058649805, -0.000341964884, -0.000063796448, ... 
        0.000349085685,  0.000069165176, -0.000356210512, -0.000074749340, ... 
        0.000363339456,  0.000080549136, -0.000370475989, -0.000086575549, ... 
        0.000377612880,  0.000092836113, -0.000384736847, -0.000099326965, ... 
        0.000391843466,  0.000106044225, -0.000398937328, -0.000112995457, ... 
        0.000406017639,  0.000120192599, -0.000413073201, -0.000127638821, ... 
        0.000420094306,  0.000135331021, -0.000427081044, -0.000143273033, ... 
        0.000434034390,  0.000151477185, -0.000440945317, -0.000159951868, ... 
        0.000447799893,  0.000168695830, -0.000454591460, -0.000177708077, ... 
        0.000461319793,  0.000186996362, -0.000467979368, -0.000196570353, ... 
        0.000474556658,  0.000206431350, -0.000481040710, -0.000216575708, ... 
        0.000487429238,  0.000227005971, -0.000493720411, -0.000237731304, ... 
        0.000499904341,  0.000248757061, -0.000505968160, -0.000260081155, ... 
        0.000511905667,  0.000271702975, -0.000517715345, -0.000283629672, ... 
        0.000523390285,  0.000295869475, -0.000528916788, -0.000308423346, ... 
        0.000534283589,  0.000321288615, -0.000539486184, -0.000334468023, ... 
        0.000544519401,  0.000347968994, -0.000549371013, -0.000361794620, ... 
        0.000554027046,  0.000375941511, -0.000558479795, -0.000390407895, ... 
        0.000562725401,  0.000405198401, -0.000566755405, -0.000420317928, ... 
        0.000570556428,  0.000435765217, -0.000574118182, -0.000451536884, ... 
        0.000577436220,  0.000467634998, -0.000580504936, -0.000484065637, ... 
        0.000583312505,  0.000500831065, -0.000585845905, -0.000517928546, ... 
        0.000588097292,  0.000535357413, -0.000590061101, -0.000553122306, ... 
        0.000591726951,  0.000571227221, -0.000593080219, -0.000589670355, ... 
        0.000594109190,  0.000608448139, -0.000594806877, -0.000627561499, ... 
        0.000595164799,  0.000647013953, -0.000595169328, -0.000666805022, ... 
        0.000594806620,  0.000686930058, -0.000594067747, -0.000707386692, ... 
        0.000592945538,  0.000728177145, -0.000591428521, -0.000749302789, ... 
        0.000589501991,  0.000770760200, -0.000587154101, -0.000792545168, ... 
        0.000584376703,  0.000814657743, -0.000581159626, -0.000837099877, ... 
        0.000577488028,  0.000859869680, -0.000573347104, -0.000882961783, ... 
        0.000568726224,  0.000906372952, -0.000563615753, -0.000930103481, ... 
        0.000558002140,  0.000954152182, -0.000551869525, -0.000978513474, ... 
        0.000545205109,  0.001003181381, -0.000537999350, -0.001028153721, ... 
        0.000530240826,  0.001053429649, -0.000521914377, -0.001079004890, ... 
        0.000513005434,  0.001104872667, -0.000503503107, -0.001131028646, ... 
        0.000493396863,  0.001157471598, -0.000482672367, -0.001184198774, ... 
        0.000471313305,  0.001211203700, -0.000459305949, -0.001238479909, ... 
        0.000446638822,  0.001266024164, -0.000433298180, -0.001293833817, ... 
        0.000419266941,  0.001321902781, -0.000404528798, -0.001350222815, ... 
        0.000389070634,  0.001378787865, -0.000372879361, -0.001407594247, ... 
        0.000355938598,  0.001436636563, -0.000338230705, -0.001465906294, ... 
        0.000319740626,  0.001495395387, -0.000300455098, -0.001525098819, ... 
        0.000280358586,  0.001555011940, -0.000259432693, -0.001585127149, ... 
        0.000237659820,  0.001615435373, -0.000215024855, -0.001645929721, ... 
        0.000191512084,  0.001676605149, -0.000167102555, -0.001707454738, ... 
        0.000141776222,  0.001738468797, -0.000115515200, -0.001769638159, ... 
        0.000088302732,  0.001800956100, -0.000060119714, -0.001832415775, ... 
        0.000030944596,  0.001864007584, -0.000000756707, -0.001895720890, ... 
       -0.000030462643,  0.001927547184,  0.000062733107, -0.001959479487, ... 
       -0.000096077405,  0.001991509130,  0.000130519250, -0.002023625338, ... 
       -0.000166080765,  0.002055818220,  0.000202783805, -0.002088080101, ... 
       -0.000240652985,  0.002120402996,  0.000279715464, -0.002152776474, ... 
       -0.000319998005,  0.002185189368,  0.000361526320, -0.002217632353, ... 
       -0.000404327757,  0.002250097073,  0.000448432830, -0.002282573351, ... 
       -0.000493873149,  0.002315049172,  0.000540679337, -0.002347513403, ... 
       -0.000588882475,  0.002379956716,  0.000638516680, -0.002412369294, ... 
       -0.000689618677,  0.002444739243,  0.000742225342, -0.002477054357, ... 
       -0.000796373532,  0.002509304226,  0.000852102648, -0.002541479193, ... 
       -0.000909455837,  0.002573567978,  0.000968478132, -0.002605557899, ... 
       -0.001029214956,  0.002637437226,  0.001091713687, -0.002669195666, ... 
       -0.001156025862,  0.002700822231,  0.001222206612, -0.002732304081, ... 
       -0.001290312638,  0.002763628228,  0.001360402416, -0.002794783222, ... 
       -0.001432538571,  0.002825758056,  0.001506788798, -0.002856540242, ... 
       -0.001583224308,  0.002887116298,  0.001661918934, -0.002917473782, ... 
       -0.001742950905,  0.002947601494,  0.001826404876, -0.002977487550, ... 
       -0.001912371525,  0.003007118589,  0.002000946195, -0.003036481314, ... 
       -0.002092229645,  0.003065563715,  0.002186330452, -0.003094353884, ... 
       -0.002283365958,  0.003122838415,  0.002383461271, -0.003151002984, ... 
       -0.002486749137,  0.003178834015,  0.002593372091, -0.003206318606, ... 
       -0.002703484610,  0.003233442868,  0.002817253230, -0.003260191455, ... 
       -0.002934856229,  0.003286548983,  0.003056485317, -0.003312500897, ... 
       -0.003182348632,  0.003338032332,  0.003312672457, -0.003363126863, ... 
       -0.003447701612,  0.003387767125,  0.003587700981, -0.003411936085, ... 
       -0.003732959058,  0.003435616699,  0.003883791468, -0.003458790414, ... 
       -0.004040543046,  0.003481436829,  0.004203590100, -0.003503534788, ... 
       -0.004373344782,  0.003525062773,  0.004550260756, -0.003545997673, ... 
       -0.004734838187,  0.003566313693,  0.004927628431, -0.003585982777, ... 
       -0.005129240601,  0.003604975309,  0.005340350574, -0.003623259349, ... 
       -0.005561710850,  0.003640799051,  0.005794160589, -0.003657554076, ... 
       -0.006038637601,  0.003673479889,  0.006296194007, -0.003688527161, ... 
       -0.006568015108,  0.003702639775,  0.006855440543, -0.003715752895, ... 
       -0.007159989028,  0.003727791952,  0.007483389280, -0.003738671243, ... 
       -0.007827618504,  0.003748290860,  0.008194948678, -0.003756532523, ... 
       -0.008588002397,  0.003763255434,  0.009009822537, -0.003768291531, ... 
       -0.009463960497,  0.003771438325,  0.009954587421, -0.003772448641, ... 
       -0.010486634644,  0.003771017594,  0.011065973999, -0.003766765998, ... 
       -0.011699653217,  0.003759217262,  0.012396206156, -0.003747764298, ... 
       -0.013166065660,  0.003731622909,  0.014022121425, -0.003709765811, ... 
       -0.014980487624,  0.003680826115,  0.016061578378, -0.003642951792, ... 
       -0.017291643791,  0.003593581634,  0.018705014100, -0.003529091784, ... 
       -0.020347465999,  0.003444218825,  0.022281425989, -0.003331080441, ... 
       -0.024594295798,  0.003177438274,  0.027412327299, -0.002963452450, ... 
       -0.030924903401,  0.002655221373,  0.035429631862, -0.002190874424, ... 
       -0.041422533248,  0.001447507599,  0.049796453726, -0.000151587549, ... 
       -0.062337096505, -0.002412242404,  0.083211116973,  0.008646613091, ... 
       -0.124918503922, -0.031280712567,  0.249959246371,  0.314222198325 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test_hM.ok"; fail; fi

#
# run and see if the results match
#
echo "Running $prog" 

octave --no-gui -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test_hM.ok mcclellanFIRdifferentiator_test_hM_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test_hM.ok"; fail; fi

#
# this much worked
#
pass

