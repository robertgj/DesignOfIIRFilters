#!/bin/sh

prog=mcclellanFIRdifferentiator_test.m

depends="mcclellanFIRdifferentiator_test.m test_common.m \
print_polynomial.m mcclellanFIRdifferentiator.m local_max.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test_hM.ok << 'EOF'
hM = [  0.000474368971, -0.000083291282, -0.000046606421,  0.000034103103, ... 
        0.000050050814, -0.000026787579, -0.000054359480,  0.000023776752, ... 
        0.000058202991, -0.000021894452, -0.000061280407,  0.000020977140, ... 
        0.000064116515, -0.000020833506, -0.000067239449,  0.000020960752, ... 
        0.000070692316, -0.000021013170, -0.000074238317,  0.000021012356, ... 
        0.000077777869, -0.000021093055, -0.000081420992,  0.000021232293, ... 
        0.000085252209, -0.000021300656, -0.000089199218,  0.000021262508, ... 
        0.000093159287, -0.000021202177, -0.000097143288,  0.000021176652, ... 
        0.000101228846, -0.000021141732, -0.000105431592,  0.000021041157, ... 
        0.000109698928, -0.000020893520, -0.000114010920,  0.000020746665, ... 
        0.000118416321, -0.000020590643, -0.000122958060,  0.000020368552, ... 
        0.000127617226, -0.000020055056, -0.000132357483,  0.000019673716, ... 
        0.000137186857, -0.000019236238, -0.000142138837,  0.000018709494, ... 
        0.000147212825, -0.000018059452, -0.000152372691,  0.000017294939, ... 
        0.000157600102, -0.000016442751, -0.000162913874,  0.000015500439, ... 
        0.000168329437, -0.000014442958, -0.000173829399,  0.000013266289, ... 
        0.000179391201, -0.000011994116, -0.000185022597,  0.000010639271, ... 
        0.000190747434, -0.000009184514, -0.000196568226,  0.000007611028, ... 
        0.000202466566, -0.000005924705, -0.000208436803,  0.000004138333, ... 
        0.000214495596, -0.000002242066, -0.000220653356,  0.000000211085, ... 
        0.000226896077,  0.000001963972, -0.000233206020, -0.000004273810, ... 
        0.000239585362,  0.000006717146, -0.000246044850, -0.000009311717, ... 
        0.000252578713,  0.000012072680, -0.000259167858, -0.000014995499, ... 
        0.000265804833,  0.000018070936, -0.000272499093, -0.000021306189, ... 
        0.000279255409,  0.000024717895, -0.000286062051, -0.000028310433, ... 
        0.000292907148,  0.000032075927, -0.000299794656, -0.000036014846, ... 
        0.000306733597,  0.000040142563, -0.000313719166, -0.000044471821, ... 
        0.000320736584,  0.000049000720, -0.000327779988, -0.000053725192, ... 
        0.000334854721,  0.000058654006, -0.000341960241, -0.000063801426, ... 
        0.000349082746,  0.000069170455, -0.000356209383, -0.000074754442, ... 
        0.000363340106,  0.000080553605, -0.000370478241, -0.000086578959, ... 
        0.000377616448,  0.000092838103, -0.000384741377, -0.000099327290, ... 
        0.000391848541,  0.000106042778, -0.000398942482, -0.000112992248, ... 
        0.000406022397,  0.000120187747, -0.000413077140, -0.000127632559, ... 
        0.000420097080,  0.000135323695, -0.000427082389, -0.000143265065, ... 
        0.000434034136,  0.000151469019, -0.000440943419, -0.000159943946, ... 
        0.000447796447,  0.000168688578, -0.000454586677, -0.000177701878, ... 
        0.000461313968,  0.000186991508, -0.000467972866, -0.000196567018, ... 
        0.000474549907,  0.000206429596, -0.000481034166, -0.000216575494, ... 
        0.000487423331,  0.000227007145, -0.000493715510, -0.000237733598, ... 
        0.000499900749,  0.000248760120, -0.000505966098, -0.000260084582, ... 
        0.000511905245,  0.000271706356, -0.000517716543, -0.000283632593, ... 
        0.000523392965,  0.000295871543, -0.000528920723, -0.000308424236, ... 
        0.000534288474,  0.000321288101, -0.000539491644, -0.000334465981, ... 
        0.000544525017,  0.000347965397, -0.000549376371, -0.000361789549, ... 
        0.000554031772,  0.000375935161, -0.000558483568, -0.000390400555, ... 
        0.000562727966,  0.000405190422, -0.000566756601, -0.000420309690, ... 
        0.000570556210,  0.000435757117, -0.000574116619, -0.000451529314, ... 
        0.000577433473,  0.000467628305, -0.000580501247, -0.000484060089, ... 
        0.000583308194,  0.000500826836, -0.000585841346, -0.000517925722, ... 
        0.000588092876,  0.000535355980, -0.000590057200, -0.000553122141, ... 
        0.000591723898,  0.000571228102, -0.000593078299, -0.000589671987, ... 
        0.000594108612,  0.000608450187, -0.000594807748, -0.000627563599, ... 
        0.000595167120,  0.000647015731, -0.000595173006, -0.000666806129, ... 
        0.000594811480,  0.000686930208, -0.000594073535, -0.000707385675, ... 
        0.000592951929,  0.000728174832, -0.000591435161, -0.000749299137, ... 
        0.000589508524,  0.000770755271, -0.000587160193, -0.000792539120, ... 
        0.000584382052,  0.000814650812, -0.000581163992, -0.000837092350, ... 
        0.000577491254,  0.000859861883, -0.000573349131, -0.000882954063, ... 
        0.000568727081,  0.000906365651, -0.000563615553, -0.000930096897, ... 
        0.000558001076,  0.000954146554, -0.000551867864, -0.000978508973, ... 
        0.000545203163,  0.001003178103, -0.000537997444, -0.001028151669, ... 
        0.000530239281,  0.001053428733, -0.000521913492, -0.001079004941, ... 
        0.000513005466,  0.001104873457, -0.000503504244, -0.001131029900, ... 
        0.000493399208,  0.001157473011, -0.000482675941, -0.001184200028, ... 
        0.000471318050,  0.001211204504, -0.000459311729, -0.001238480014, ... 
        0.000446645426,  0.001266023376, -0.000433305345, -0.001293832007, ... 
        0.000419274376,  0.001321899898, -0.000404536207, -0.001350218897, ... 
        0.000389077730,  0.001378783027, -0.000372885882, -0.001407588668, ... 
        0.000355944335,  0.001436630472, -0.000338235519, -0.001465899961, ... 
        0.000319744452,  0.001495389104, -0.000300457941, -0.001525092870, ... 
        0.000280360527,  0.001555006578, -0.000259433881, -0.001585122586, ... 
        0.000237660467,  0.001615431769, -0.000215025206, -0.001645927168, ... 
        0.000191512402,  0.001676603660, -0.000167103106, -0.001707454252, ... 
        0.000141777259,  0.001738469191, -0.000115516940, -0.001769639256, ... 
        0.000088305336,  0.001800957677, -0.000060123280, -0.001832417579, ... 
        0.000030949160,  0.001864009359, -0.000000762239, -0.001895722395, ... 
       -0.000030456243,  0.001927548209,  0.000062725999, -0.001959479862, ... 
       -0.000096069792,  0.001991508737,  0.000130511359, -0.002023624128, ... 
       -0.000166072838,  0.002055816211,  0.000202776080, -0.002088077372, ... 
       -0.000240645681,  0.002120399679,  0.000279708757, -0.002152772746, ... 
       -0.000319992020,  0.002185185442,  0.000361521128, -0.002217628458, ... 
       -0.000404323372,  0.002250093431,  0.000448429202, -0.002282570169, ... 
       -0.000493870168,  0.002315046628,  0.000540676852, -0.002347511633, ... 
       -0.000588880301,  0.002379955803,  0.000638514614, -0.002412369260, ... 
       -0.000689616510,  0.002444740055,  0.000742222872, -0.002477055934, ... 
       -0.000796370588,  0.002509306440,  0.000852099099, -0.002541481878, ... 
       -0.000909451595,  0.002573570943,  0.000968473158, -0.002605560950, ... 
       -0.001029209266,  0.002637440176,  0.001091707351, -0.002669198345, ... 
       -0.001156018995,  0.002700824498,  0.001222199360, -0.002732305837, ... 
       -0.001290305169,  0.002763629424,  0.001360394915, -0.002794783857, ... 
       -0.001432531221,  0.002825758173,  0.001506781764, -0.002856539930, ... 
       -0.001583217726,  0.002887115681,  0.001661912907, -0.002917473013, ... 
       -0.001742945497,  0.002947600736,  0.001826400107, -0.002977486969, ... 
       -0.001912367367,  0.003007118338,  0.002000942577, -0.003036481532, ... 
       -0.002092226467,  0.003065564507,  0.002186327587, -0.003094355314, ... 
       -0.002283363263,  0.003122840510,  0.002383458595, -0.003151005731, ... 
       -0.002486746336,  0.003178837363,  0.002593369041, -0.003206322468, ... 
       -0.002703481210,  0.003233447129,  0.002817249411, -0.003260195985, ... 
       -0.002934851953,  0.003286553646,  0.003056480589, -0.003312505560, ... 
       -0.003182343490,  0.003338036871,  0.003312666972, -0.003363131174, ... 
       -0.003447695877,  0.003387771136,  0.003587695109, -0.003411939753, ... 
       -0.003732953173,  0.003435620013,  0.003883785692, -0.003458793394, ... 
       -0.004040537493,  0.003481439525,  0.004203584866, -0.003503537276, ... 
       -0.004373339945,  0.003525065144,  0.004550256366, -0.003546000029, ... 
       -0.004734834263,  0.003566316138,  0.004927624965, -0.003585985411, ... 
       -0.005129237556,  0.003604978219,  0.005340347894, -0.003623262603, ... 
       -0.005561708460,  0.003640802695,  0.005794158403, -0.003657558133, ... 
       -0.006038635527,  0.003673484357,  0.006296191960, -0.003688532017, ... 
       -0.006568013009,  0.003702644971,  0.006855438329, -0.003715758370, ... 
       -0.007159986651,  0.003727797634,  0.007483386714, -0.003738677056, ... 
       -0.007827615745,  0.003748296728,  0.008194945742, -0.003756538373, ... 
       -0.008587999315,  0.003763261206,  0.009009819354, -0.003768297179, ... 
       -0.009463957270,  0.003771443820,  0.009954584212, -0.003772453966, ... 
       -0.010486631514,  0.003771022751,  0.011065971006, -0.003766771004, ... 
       -0.011699650409,  0.003759222145,  0.012396203575, -0.003747769095, ... 
       -0.013166063333,  0.003731627662,  0.014022119366, -0.003709770562, ... 
       -0.014980485836,  0.003680830907,  0.016061576852, -0.003642956660, ... 
       -0.017291642510,  0.003593586608,  0.018705013039, -0.003529096883, ... 
       -0.020347465129,  0.003444224063,  0.022281425281, -0.003331085820, ... 
       -0.024594295223,  0.003177443790,  0.027412326830, -0.002963458092, ... 
       -0.030924903017,  0.002655227126,  0.035429631545, -0.002190880271, ... 
       -0.041422532987,  0.001447513523,  0.049796453512, -0.000151593531, ... 
       -0.062337096334, -0.002412236379,  0.083211116844,  0.008646607037, ... 
       -0.124918503835, -0.031280706494,  0.249959246327,  0.314222192243 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test_hM.ok"; fail; fi

#
# run and see if the results match
#
echo "Running $prog" 

octave-cli -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test_hM.ok mcclellanFIRdifferentiator_test_hM_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test_hM.ok"; fail; fi

#
# this much worked
#
pass

