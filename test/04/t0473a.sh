#!/bin/sh

prog=mcclellanFIRdifferentiator_test.m

depends="mcclellanFIRdifferentiator_test.m test_common.m \
print_polynomial.m mcclellanFIRdifferentiator.m local_max.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test_hM.ok << 'EOF'
hM = [  0.000002471929, -0.000093227154,  0.000014049926,  0.000014156320, ... 
       -0.000007225458, -0.000015416342,  0.000005764365,  0.000016688814, ... 
       -0.000005285027, -0.000018001378,  0.000005076521,  0.000019384277, ... 
       -0.000004923546, -0.000020827349,  0.000004748829,  0.000022275663, ... 
       -0.000004623323, -0.000023740342,  0.000004753067,  0.000025657767, ... 
       -0.000004806039, -0.000026981364,  0.000004544517,  0.000028846918, ... 
       -0.000004435168, -0.000030642094,  0.000004271546,  0.000032487377, ... 
       -0.000004075203, -0.000034413894,  0.000003840777,  0.000036443580, ... 
       -0.000003531473, -0.000038538760,  0.000003157351,  0.000040639138, ... 
       -0.000002830264, -0.000042866106,  0.000002403346,  0.000045031516, ... 
       -0.000001847060, -0.000047413409,  0.000001316523,  0.000049784995, ... 
       -0.000000671050, -0.000052224639, -0.000000046834,  0.000054725632, ... 
        0.000000822356, -0.000057311757, -0.000001676139,  0.000059977734, ... 
        0.000002632026, -0.000062672386, -0.000003641483,  0.000065449000, ... 
        0.000004781825, -0.000068250142, -0.000006033941,  0.000071169123, ... 
        0.000007332951, -0.000074100657, -0.000008780475,  0.000077110776, ... 
        0.000010339464, -0.000080165253, -0.000012002510,  0.000083271751, ... 
        0.000013773596, -0.000086433967, -0.000015676342,  0.000089619049, ... 
        0.000017686811, -0.000092862011, -0.000019852086,  0.000096134666, ... 
        0.000022151509, -0.000099459261, -0.000024559850,  0.000102785495, ... 
        0.000027138825, -0.000106169977, -0.000029857382,  0.000109572378, ... 
        0.000032726313, -0.000112994446, -0.000035747026,  0.000116437964, ... 
        0.000038940310, -0.000119877545, -0.000042288510,  0.000123338210, ... 
        0.000045819516, -0.000126802675, -0.000049524146,  0.000130267175, ... 
        0.000053400469, -0.000133705121, -0.000057479217,  0.000137153309, ... 
        0.000061732515, -0.000140571366, -0.000066179518,  0.000143963429, ... 
        0.000070817918, -0.000147329680, -0.000075667257,  0.000150646075, ... 
        0.000080712515, -0.000153924700, -0.000085966935,  0.000157151695, ... 
        0.000091427252, -0.000160318777, -0.000097100813,  0.000163412056, ... 
        0.000103000071, -0.000166448063, -0.000109105712,  0.000169387998, ... 
        0.000115438805, -0.000172236975, -0.000121989430,  0.000174993464, ... 
        0.000128775415, -0.000177636182, -0.000135786470,  0.000180166243, ... 
        0.000143029712, -0.000182568584, -0.000150503789,  0.000184834269, ... 
        0.000158214533, -0.000186954271, -0.000166162442,  0.000188931393, ... 
        0.000174338033, -0.000190732841, -0.000182761221,  0.000192360859, ... 
        0.000191414480, -0.000193808632, -0.000200311283,  0.000195058280, ... 
        0.000209442725, -0.000196105425, -0.000218812943,  0.000196935139, ... 
        0.000228421042, -0.000197537453, -0.000238268481,  0.000197901164, ... 
        0.000248347911, -0.000198020162, -0.000258654956,  0.000197870737, ... 
        0.000269204721, -0.000197451136, -0.000279976022,  0.000196747968, ... 
        0.000290979047, -0.000195744916, -0.000302203034,  0.000194433673, ... 
        0.000313647494, -0.000192800820, -0.000325308915,  0.000190836405, ... 
        0.000337184992, -0.000188525498, -0.000349264883,  0.000185856408, ... 
        0.000361543956, -0.000182813288, -0.000374028151,  0.000179390678, ... 
        0.000386694247, -0.000175572502, -0.000399549739,  0.000171345255, ... 
        0.000412581210, -0.000166697399, -0.000425783000,  0.000161616307, ... 
        0.000439146058, -0.000156092691, -0.000452663981,  0.000150110565, ... 
        0.000466324717, -0.000143656625, -0.000480120926,  0.000136719616, ... 
        0.000494049152, -0.000129289259, -0.000508084752,  0.000121349600, ... 
        0.000522230328, -0.000112891204, -0.000536468743,  0.000103900816, ... 
        0.000550790391, -0.000094365832, -0.000565180460,  0.000084276777, ... 
        0.000579627685, -0.000073618652, -0.000594117470,  0.000062379820, ... 
        0.000608637457, -0.000050552470, -0.000623177017,  0.000038122944, ... 
        0.000637711334, -0.000025077265, -0.000652235864,  0.000011409655, ... 
        0.000666728090,  0.000002892707, -0.000681174840, -0.000017840597, ... 
        0.000695556506,  0.000033442795, -0.000709857516, -0.000049712118, ... 
        0.000724059303,  0.000066657844, -0.000738142522, -0.000084284812, ... 
        0.000752090575,  0.000102606376, -0.000765878546, -0.000121632444, ... 
        0.000779494092,  0.000141366428, -0.000792909216, -0.000161819645, ... 
        0.000806106608,  0.000182999197, -0.000819061516, -0.000204910978, ... 
        0.000831754274,  0.000227563606, -0.000844162416, -0.000250963766, ... 
        0.000856260138,  0.000275113694, -0.000868025708, -0.000300023171, ... 
        0.000879432650,  0.000325696142, -0.000890461159, -0.000352133533, ... 
        0.000901079655,  0.000379343610, -0.000911267263, -0.000407329048, ... 
        0.000920993898,  0.000436091903, -0.000930235218, -0.000465634970, ... 
        0.000938964845,  0.000495961303, -0.000947152199, -0.000527069943, ... 
        0.000954771422,  0.000558965503, -0.000961792769, -0.000591645995, ... 
        0.000968189064,  0.000625109211, -0.000973926043, -0.000659357895, ... 
        0.000978979457,  0.000694389416, -0.000983314505, -0.000730201865, ... 
        0.000986902048,  0.000766791849, -0.000989711425, -0.000804157674, ... 
        0.000991708168,  0.000842293514, -0.000992862893, -0.000881197528, ... 
        0.000993142240,  0.000920862507, -0.000992513031, -0.000961282743, ... 
        0.000990938489,  0.001002453771, -0.000988390182, -0.001044366801, ... 
        0.000984829344,  0.001087015364, -0.000980222793, -0.001130389796, ... 
        0.000974535783,  0.001174483254, -0.000967730046, -0.001219284015, ... 
        0.000959771940,  0.001264782941, -0.000950624107, -0.001310967464, ... 
        0.000940248945,  0.001357827490, -0.000928606998, -0.001405350959, ... 
        0.000915664394,  0.001453523063, -0.000901378286, -0.001502332000, ... 
        0.000885711354,  0.001551761325, -0.000868624734, -0.001601798706, ... 
        0.000850076215,  0.001652426658, -0.000830026733, -0.001703629337, ... 
        0.000808433791,  0.001755388730, -0.000785255316, -0.001807689300, ... 
        0.000760447861,  0.001860511820, -0.000733970765, -0.001913836457, ... 
        0.000705776128,  0.001967646144, -0.000675820506, -0.002021917742, ... 
        0.000644058757,  0.002076633129, -0.000610442839, -0.002131769302, ... 
        0.000574926119,  0.002187304775, -0.000537458493, -0.002243216442, ... 
        0.000497990523,  0.002299482945, -0.000456470674, -0.002356078609, ... 
        0.000412848147,  0.002412979113, -0.000367066803, -0.002470162396, ... 
        0.000319072538,  0.002527599706, -0.000268808643, -0.002585267704, ... 
        0.000216215614,  0.002643138384, -0.000161233564, -0.002701185514, ... 
        0.000103798757,  0.002759381534, -0.000043847264, -0.002817700142, ... 
       -0.000018689078,  0.002876110864,  0.000083879709, -0.002934585396, ... 
       -0.000151798274,  0.002993096963,  0.000222519937, -0.003051612588, ... 
       -0.000296124238,  0.003110104910,  0.000372694762, -0.003168541959, ... 
       -0.000452318365,  0.003226893592,  0.000535087372, -0.003285128204, ... 
       -0.000621096673,  0.003343215533,  0.000710449049, -0.003401121987, ... 
       -0.000803252010,  0.003458815922,  0.000899618910, -0.003516266351, ... 
       -0.000999670245,  0.003573437122,  0.001103534470, -0.003630297573, ... 
       -0.001211348153,  0.003686812637,  0.001323257072, -0.003742949086, ... 
       -0.001439417812,  0.003798671637,  0.001559995709, -0.003853946447, ... 
       -0.001685171146,  0.003908737292,  0.001815137024, -0.003963009077, ... 
       -0.001950099863,  0.004016726767,  0.002090284635, -0.004069851093, ... 
       -0.002235934132,  0.004122347248,  0.002387310913, -0.004174176073, ... 
       -0.002544700840,  0.004225300238,  0.002708415858, -0.004275679446, ... 
       -0.002878794076,  0.004325274384,  0.003056207967, -0.004374043465, ... 
       -0.003241064539,  0.004421944511,  0.003433809170, -0.004468934707, ... 
       -0.003634935448,  0.004514967055,  0.003844986743, -0.004559996425, ... 
       -0.004064563755,  0.004603972039,  0.004294333763, -0.004646843415, ... 
       -0.004535039882,  0.004688554547,  0.004787509326, -0.004729047733, ... 
       -0.005052670485,  0.004768260142,  0.005331564777, -0.004806123152, ... 
       -0.005625363631,  0.004842563039,  0.005935395061, -0.004877496796, ... 
       -0.006263164120,  0.004910834592,  0.006610385721, -0.004942472132, ... 
       -0.006979022921,  0.004972294135,  0.007371332930, -0.005000165198, ... 
       -0.007789921322,  0.005025930259,  0.008237815969, -0.005049406820, ... 
       -0.008718552425,  0.005070376392,  0.009236283247, -0.005088578156, ... 
       -0.009795923567,  0.005103693430,  0.010403326692, -0.005115331107, ... 
       -0.011065522309,  0.005123000205,  0.011791025726, -0.005126082760, ... 
       -0.012590251085,  0.005123781588,  0.013476067514, -0.005115058978, ... 
       -0.014464569919,  0.005098538169,  0.015576152768, -0.005072355395, ... 
       -0.016837044309,  0.005033940697,  0.018281555151, -0.004979661335, ... 
       -0.019955439996,  0.004904246211,  0.021921104364, -0.004799803850, ... 
       -0.024265928072,  0.004654090550,  0.027116141578, -0.004447258870, ... 
       -0.030661105113,  0.004145401776,  0.035198404371, -0.003686644384, ... 
       -0.041224037945,  0.002948076371,  0.049630828376, -0.001656161547, ... 
       -0.062204457186, -0.000904460028,  0.083111556002,  0.007136421723, ... 
       -0.124852091329, -0.029768914948,  0.249926028362,  0.312709596734 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test_hM.ok"; fail; fi

#
# run and see if the results match
#
echo "Running $prog" 

octave-cli -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test_hM.ok mcclellanFIRdifferentiator_test_hM_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test_hM.ok"; fail; fi

#
# this much worked
#
pass

