#!/bin/sh

prog=mcclellanFIRantisymmetric_flat_differentiator_test.m

depends="mcclellanFIRantisymmetric_flat_differentiator_test.m test_common.m \
mcclellanFIRantisymmetric_flat_differentiator.m local_max.m print_polynomial.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test_hAM58.ok << 'EOF'
hAM58 = [    -0.02133180,    -0.34491358,    -2.75629882,   -14.46165657, ... 
            -55.82996815,  -168.47700961,  -412.18752806,  -837.07632676, ... 
          -1433.37382115, -2091.22315608, -2616.76128266, -2818.69435796, ... 
          -2616.76128266, -2091.22315608, -1433.37382115,  -837.07632676, ... 
           -412.18752806,  -168.47700961,   -55.82996815,   -14.46165657, ... 
             -2.75629882,    -0.34491358,    -0.02133180 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test_hAM58.ok"; fail; fi

cat > test_hA58.ok << 'EOF'
hA58 = [ -0.000000081374,  0.000001532362, -0.000012881260,  0.000062568120, ... 
         -0.000187467506,  0.000328720091, -0.000219448392, -0.000307234777, ... 
          0.000598796500,  0.000328753186, -0.001371663727, -0.000277976322, ... 
          0.002843649388,  0.000153452692, -0.005513081811, -0.000140928378, ... 
          0.010140910469,  0.000825745521, -0.017775333513, -0.003554336155, ... 
          0.029765979287,  0.011102797526, -0.047982382735, -0.029597596056, ... 
          0.076067605837,  0.078085301211, -0.124667350884, -0.298795463498, ... 
         -0.163971911109,  0.163971911144,  0.298795463407,  0.124667350999, ... 
         -0.078085301313, -0.076067605775,  0.029597596040,  0.047982382713, ... 
         -0.011102797486, -0.029765979329,  0.003554336189,  0.017775333490, ... 
         -0.000825745508, -0.010140910475,  0.000140928381,  0.005513081810, ... 
         -0.000153452691, -0.002843649388,  0.000277976322,  0.001371663727, ... 
         -0.000328753186, -0.000598796500,  0.000307234777,  0.000219448392, ... 
         -0.000328720091,  0.000187467506, -0.000062568120,  0.000012881260, ... 
         -0.000001532362,  0.000000081374 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test_hA58.ok"; fail; fi

cat > test_hAM59.ok << 'EOF'
hAM59 = [    -0.00906018,    -0.14939154,    -1.21701206,    -6.50365791, ... 
            -25.54015026,   -78.27452795,  -194.12875209,  -398.80953009, ... 
           -689.23222604, -1012.35679633, -1271.98561272, -1372.03786758, ... 
          -1271.98561272, -1012.35679633,  -689.23222604,  -398.80953009, ... 
           -194.12875209,   -78.27452795,   -25.54015026,    -6.50365791, ... 
             -1.21701206,    -0.14939154,    -0.00906018 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test_hAM59.ok"; fail; fi

cat > test_hA59.ok << 'EOF'
hA59 = [ -0.000000034562,  0.000000605219, -0.000004621120,  0.000019544768, ... 
         -0.000046367212,  0.000044719850,  0.000054618281, -0.000171378952, ... 
         -0.000015142737,  0.000460464444, -0.000180843192, -0.001054444167, ... 
          0.000708689556,  0.002225050989, -0.001819247210, -0.004481129194, ... 
          0.003790820038,  0.008729505835, -0.006790066971, -0.016504360965, ... 
          0.010606128287,  0.030387631679, -0.014172670198, -0.055274228308, ... 
          0.014240281510,  0.103997877660,  0.003129933008, -0.238712985093, ... 
         -0.283057892324, -0.000000000107,  0.283057892504,  0.238712985001, ... 
         -0.003129933017, -0.103997877576, -0.014240281622,  0.055274228407, ... 
          0.014172670135, -0.030387631650, -0.010606128292,  0.016504360960, ... 
          0.006790066978, -0.008729505840, -0.003790820035,  0.004481129192, ... 
          0.001819247210, -0.002225050989, -0.000708689556,  0.001054444167, ... 
          0.000180843192, -0.000460464444,  0.000015142737,  0.000171378952, ... 
         -0.000054618281, -0.000044719850,  0.000046367212, -0.000019544768, ... 
          0.000004621120, -0.000000605219,  0.000000034562 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test_hA59.ok"; fail; fi

#
# run and see if the results match
#
echo "Running $prog" 

octave-cli -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test_hAM58.ok \
mcclellanFIRantisymmetric_flat_differentiator_test_hAM58_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test_hAM58.ok"; fail; fi

diff -Bb test_hA58.ok \
mcclellanFIRantisymmetric_flat_differentiator_test_hA58_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test_hA58.ok"; fail; fi

diff -Bb test_hAM59.ok \
mcclellanFIRantisymmetric_flat_differentiator_test_hAM59_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test_hAM59.ok"; fail; fi

diff -Bb test_hA59.ok \
mcclellanFIRantisymmetric_flat_differentiator_test_hA59_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test_hA59.ok"; fail; fi

#
# this much worked
#
pass

