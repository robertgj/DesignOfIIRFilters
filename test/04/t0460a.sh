#!/bin/sh

prog=affine_mcclellanFIRsymmetric_lowpass_test.m

depends="affine_mcclellanFIRsymmetric_lowpass_test.m test_common.m \
print_polynomial.m faffine.m frefine.m local_max.m directFIRsymmetricA.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test_hM.ok << 'EOF'
hM = [ -0.000049780154,  0.000009861919,  0.000035898843,  0.000071398852, ... 
        0.000104753138,  0.000122956288,  0.000116281912,  0.000082687319, ... 
        0.000029894636, -0.000026196946, -0.000066705145, -0.000076909166, ... 
       -0.000052595648, -0.000002818587,  0.000052536965,  0.000089964196, ... 
        0.000091791963,  0.000054109009, -0.000010383461, -0.000076324591, ... 
       -0.000115430895, -0.000108395008, -0.000054027250,  0.000028567729, ... 
        0.000106376013,  0.000145457502,  0.000125515929,  0.000049889612, ... 
       -0.000053782213, -0.000143345217, -0.000179058301, -0.000140958583, ... 
       -0.000039177094,  0.000087872624,  0.000187685510,  0.000215137707, ... 
        0.000152555228,  0.000019576139, -0.000132297446, -0.000239343995, ... 
       -0.000252108810, -0.000157826079,  0.000011233927,  0.000188195462, ... 
        0.000297729413,  0.000287835037,  0.000153957575, -0.000055540981, ... 
       -0.000256302299, -0.000361631191, -0.000319599083, -0.000137844493, ... 
        0.000115497956,  0.000336832506,  0.000429140717,  0.000344103281, ... 
        0.000106174823, -0.000192986569, -0.000429350130, -0.000497586780, ... 
       -0.000357501663, -0.000055548668,  0.000289460166,  0.000532640624, ... 
        0.000563493648,  0.000355465598, -0.000017373407, -0.000405774435, ... 
       -0.000644593473, -0.000622568151, -0.000333284084,  0.000115696971, ... 
        0.000542013785,  0.000762103370,  0.000669720312,  0.000285998063, ... 
       -0.000242100719, -0.000697321295, -0.000880996812, -0.000699120389, ... 
       -0.000208566348,  0.000398630467,  0.000869740084,  0.000995989717, ... 
        0.000704293124,  0.000096058789, -0.000586487758, -0.001056073488, ... 
       -0.001100679872, -0.000678247661,  0.000056129618,  0.000805821309, ... 
        0.001251770513,  0.001187575852,  0.000613639066, -0.000252051667, ... 
       -0.001055529605, -0.001450841226, -0.001248161129, -0.000502954566, ... 
        0.000494977426,  0.001333082348,  0.001645804288,  0.001272988659, ... 
        0.000338714734, -0.000787170759, -0.001634367003, -0.001827665214, ... 
       -0.001251796949, -0.000113676631,  0.001129684017,  0.001953564193, ... 
        0.001985919267,  0.001173633459, -0.000178977454, -0.001522181984, ... 
       -0.002283051925, -0.002108566405, -0.001026964506,  0.000545486139, ... 
        0.001962805675,  0.002613333071,  0.002182116905,  0.000799742003, ... 
       -0.000991415616, -0.002448085343, -0.002932972507, -0.002191553622, ... 
       -0.000479384577,  0.001521660062,  0.002972910393,  0.003228518334, ... 
        0.002120197665,  0.000052610922, -0.002140581110, -0.003530561628, ... 
       -0.003484362940, -0.001949393557,  0.000494969264,  0.002852352429, ... 
        0.004112808628,  0.003682469025,  0.001657877454, -0.001179658471, ... 
       -0.003661613470, -0.004710072154, -0.003801832009, -0.001220597108, ... 
        0.002021126115,  0.004574608895,  0.005311648358,  0.003817450035, ... 
        0.000606570219, -0.003044979233, -0.005601135658, -0.005905988605, ... 
       -0.003698373036,  0.000225003324,  0.004287343024,  0.006757927454, ... 
        0.006481025765,  0.003403974844, -0.001331969820, -0.005803299024, ... 
       -0.008074802584, -0.007024535378, -0.002876601618,  0.002803300032, ... 
        0.007683326868,  0.009606612986,  0.007524518011,  0.002026223558, ... 
       -0.004788520543, -0.010088029057, -0.011458712365, -0.007969587705, ... 
       -0.000695454587,  0.007565769341,  0.013330103520,  0.013848377169, ... 
        0.008349350694, -0.001431159042, -0.011723440966, -0.018100684660, ... 
       -0.017280726256, -0.008654758566,  0.005112781321,  0.018761032501, ... 
        0.026260926772,  0.023203355776,  0.008878420874, -0.012790677301, ... 
       -0.033942849974, -0.045024747631, -0.037932118907, -0.009014863700, ... 
        0.039115256584,  0.097687059725,  0.153877244574,  0.194338315845, ... 
        0.209060722925 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test_hM.ok"; fail; fi

#
# run and see if the results match
#
echo "Running $prog" 

octave --no-gui -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test_hM.ok affine_mcclellanFIRsymmetric_lowpass_test_hM_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test_hM.ok"; fail; fi

#
# this much worked
#
pass

