#!/bin/sh

prog=tfp2Abcd_test.m

depends="tfp2Abcd_test.m test_common.m print_polynomial.m \
phi2p.m tfp2g.m Abcd2tf.m tf2Abcd.m tfp2Abcd.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
echo $here
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
Prototype lowpass (phi=0.5)
Lowpass-to-lowpass (phi=0.05)
p =

   1.00000  -0.72654

A =

   0.734099   0.440905  -0.283401   0.134994  -0.066191
  -0.010401   0.769528   0.390068  -0.185803   0.091104
   0.014315  -0.059164   0.839499   0.255736  -0.125394
  -0.019703   0.081433  -0.155472   1.024392   0.172590
   0.027119  -0.112083   0.213989  -0.409955   1.138832

B =

   0.10186
  -0.14019
   0.19296
  -0.26559
   0.36555

C =

   0.043071   0.079487   0.125324   0.084229   0.053748

D =  0.0073597
Lowpass-to-highpass (phi=0.35)
p =

   1.00000   0.32492

A =

  -0.3260354  -0.8902642   0.2838110  -0.0817463   0.0218529
   0.0034337  -0.3377322  -0.8734803   0.2515891  -0.0672562
  -0.0105680   0.0394329  -0.3893876  -0.7743117   0.2069933
   0.0325248  -0.1213619   0.1984117  -0.6945972  -0.6370599
  -0.1001012   0.3735135  -0.6106484   1.1377504  -1.1170148

B =

   0.0079385
  -0.0244322
   0.0751947
  -0.2314256
   0.7122546

C =

  -0.084777  -0.171482  -0.306655  -0.202565  -0.165362

D =  0.029998
Lowpass-to-bandpass (phi=[0.2, 0.3])
p =

   1.00000  -0.27346   0.72654

A =

 Columns 1 through 8:

   0.00000   1.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.73410   0.27465  -0.44091   0.06983   0.28340  -0.04489  -0.13499   0.02138
   0.00000   0.00000   0.00000   1.00000   0.00000   0.00000   0.00000   0.00000
   0.01040  -0.00165  -0.76953   0.28027  -0.39007   0.06178   0.18580  -0.02943
   0.00000   0.00000   0.00000   0.00000   0.00000   1.00000   0.00000   0.00000
  -0.01432   0.00227   0.05916  -0.00937  -0.83950   0.29135  -0.25574   0.04050
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   1.00000
   0.01970  -0.00312  -0.08143   0.01290   0.15547  -0.02462  -1.02439   0.32063
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.02712   0.00430   0.11208  -0.01775  -0.21399   0.03389   0.40995  -0.06493

 Columns 9 and 10:

   0.00000   0.00000
   0.06619  -0.01048
   0.00000   0.00000
  -0.09110   0.01443
   0.00000   0.00000
   0.12539  -0.01986
   0.00000   0.00000
  -0.17259   0.02734
   0.00000   1.00000
  -1.13883   0.33876

B =

   0.00000
   0.10186
  -0.00000
  -0.14019
   0.00000
   0.19296
  -0.00000
  -0.26559
   0.00000
   0.36555

C =

 Columns 1 through 6:

  -0.0430711   0.0068218  -0.0794874   0.0125896  -0.1253235   0.0198493

 Columns 7 through 10:

  -0.0842294   0.0133406  -0.0537481   0.0085129

D =  0.0073597
Lowpass-to-triple-bandstop (phi=[0.1 0.15 0.2 0.25 0.3 0.35])
p =

   1.00000  -0.76738   1.59438  -0.91930   1.15838  -0.39100   0.32492

A =

 Columns 1 through 8:

   0.00000   1.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   1.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   1.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   1.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   1.00000   0.00000   0.00000
  -0.32322   0.38978  -1.15606   0.91812  -1.59316   0.76711   0.88918  -0.63658
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   1.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00524  -0.00375   0.00714  -0.00364   0.00375  -0.00083  -0.34108   0.40257
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.01614  -0.01156   0.02198  -0.01120   0.01156  -0.00256  -0.04974   0.03561
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.04967  -0.03556   0.06765  -0.03447   0.03556  -0.00787  -0.15307   0.10959
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.15288  -0.10945   0.20819  -0.10608   0.10945  -0.02421  -0.47111   0.33728

 Columns 9 through 16:

   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   1.21085  -0.61696   0.63658  -0.14083   0.29724  -0.21280   0.40477  -0.20624
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   1.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   1.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   1.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   1.00000   0.00000   0.00000   0.00000   0.00000
  -1.18039   0.93051  -1.60595   0.76994   0.91481  -0.65493   1.24575  -0.63474
   0.00000   0.00000   0.00000   0.00000   0.00000   1.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   1.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   1.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.06773   0.03451  -0.03561   0.00788  -0.26219   0.34609  -1.07296   0.87577
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.20845   0.10621  -0.10959   0.02424   0.19307  -0.13822   0.26292  -0.13396
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.64154   0.32688  -0.33728   0.07462   0.59421  -0.42541   0.80917  -0.41229

 Columns 17 through 24:

   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.21280  -0.04708   0.08059  -0.05770   0.10974  -0.05592   0.05770  -0.01276
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.65493  -0.14489   0.24803  -0.17757   0.33775  -0.17209   0.17757  -0.03928
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   1.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   1.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -1.54947   0.75745   0.76335  -0.54650   1.03950  -0.52965   0.54650  -0.12090
   0.00000   0.00000   0.00000   1.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   1.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   1.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   1.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   1.00000
   0.13822  -0.03058  -0.72833   0.67981  -1.70773   1.19921  -1.88319   0.83128
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.42541  -0.09411  -1.24157   0.88887  -1.69073   0.86147  -0.88887   0.19665

 Columns 25 through 30:

   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.03338  -0.02389   0.04545  -0.02316   0.02389  -0.00529
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.10272  -0.07354   0.13988  -0.07127   0.07354  -0.01627
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.31614  -0.22633   0.43051  -0.21935   0.22633  -0.05007
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.97297  -0.69657   1.32496  -0.67510   0.69657  -0.15410
   0.00000   1.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   1.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   1.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   1.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   1.00000
  -0.08318   0.21793  -0.82919   0.75157  -1.42131   0.72909

B =

   0.00000
   0.00000
   0.00000
   0.00000
   0.00000
   0.01212
   0.00000
   0.00000
   0.00000
   0.00000
   0.00000
   0.03732
   0.00000
   0.00000
   0.00000
   0.00000
   0.00000
   0.11484
   0.00000
   0.00000
   0.00000
   0.00000
   0.00000
   0.35345
   0.00000
   0.00000
   0.00000
   0.00000
   0.00000
   1.08782

C =

 Columns 1 through 7:

   0.114810  -0.082195   0.156343  -0.079661   0.082195  -0.018184   0.134026

 Columns 8 through 14:

  -0.095952   0.182511  -0.092994   0.095952  -0.021228   0.552719  -0.395703

 Columns 15 through 21:

   0.752672  -0.383506   0.395703  -0.087542   0.199967  -0.143160   0.272307

 Columns 22 through 28:

  -0.138747   0.143160  -0.031672   0.422889  -0.302755   0.575875  -0.293423

 Columns 29 and 30:

   0.302755  -0.066979

D =  0.24369
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running octave-cli -q " $prog

octave-cli -q $prog > test.out
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

