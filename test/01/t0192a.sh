#!/bin/sh

prog=tfp2Abcd_test.m

depends="test/tfp2Abcd_test.m test_common.m print_polynomial.m \
phi2p.m tfp2g.m Abcd2tf.m tf2Abcd.m tfp2Abcd.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
Prototype lowpass (phi=0.5)
Lowpass-to-lowpass (phi=0.05)
p =
   1.0000  -0.7265

A =
   0.734099   0.440905  -0.283401   0.134994  -0.066191
  -0.010401   0.769528   0.390068  -0.185803   0.091104
   0.014315  -0.059164   0.839499   0.255736  -0.125394
  -0.019703   0.081433  -0.155472   1.024392   0.172590
   0.027119  -0.112083   0.213989  -0.409955   1.138832

B =
   0.1019
  -0.1402
   0.1930
  -0.2656
   0.3656

C =
   0.043071   0.079487   0.125324   0.084229   0.053748

D = 7.3597e-03
Lowpass-to-highpass (phi=0.35)
p =
   1.0000   0.3249

A =
  -3.2604e-01  -8.9026e-01   2.8381e-01  -8.1746e-02   2.1853e-02
   3.4337e-03  -3.3773e-01  -8.7348e-01   2.5159e-01  -6.7256e-02
  -1.0568e-02   3.9433e-02  -3.8939e-01  -7.7431e-01   2.0699e-01
   3.2525e-02  -1.2136e-01   1.9841e-01  -6.9460e-01  -6.3706e-01
  -1.0010e-01   3.7351e-01  -6.1065e-01   1.1378e+00  -1.1170e+00

B =
   7.9385e-03
  -2.4432e-02
   7.5195e-02
  -2.3143e-01
   7.1225e-01

C =
  -0.084777  -0.171482  -0.306655  -0.202565  -0.165362

D = 0.029998
Lowpass-to-bandpass (phi=[0.2, 0.3])
p =
   1.0000  -0.2735   0.7265

A =
 Columns 1 through 8:
        0   1.0000        0        0        0        0        0        0
  -0.7341   0.2747  -0.4409   0.0698   0.2834  -0.0449  -0.1350   0.0214
        0        0        0   1.0000        0        0        0        0
   0.0104  -0.0016  -0.7695   0.2803  -0.3901   0.0618   0.1858  -0.0294
        0        0        0        0        0   1.0000        0        0
  -0.0143   0.0023   0.0592  -0.0094  -0.8395   0.2913  -0.2557   0.0405
        0        0        0        0        0        0        0   1.0000
   0.0197  -0.0031  -0.0814   0.0129   0.1555  -0.0246  -1.0244   0.3206
        0        0        0        0        0        0        0        0
  -0.0271   0.0043   0.1121  -0.0178  -0.2140   0.0339   0.4100  -0.0649
 Columns 9 and 10:
        0        0
   0.0662  -0.0105
        0        0
  -0.0911   0.0144
        0        0
   0.1254  -0.0199
        0        0
  -0.1726   0.0273
        0   1.0000
  -1.1388   0.3388

B =
        0
   0.1019
        0
  -0.1402
        0
   0.1930
        0
  -0.2656
        0
   0.3656

C =
 Columns 1 through 6:
  -4.3071e-02   6.8218e-03  -7.9487e-02   1.2590e-02  -1.2532e-01   1.9849e-02
 Columns 7 through 10:
  -8.4229e-02   1.3341e-02  -5.3748e-02   8.5129e-03

D = 7.3597e-03
Lowpass-to-triple-bandstop (phi=[0.1 0.15 0.2 0.25 0.3 0.35])
p =
   1.0000  -0.7674   1.5944  -0.9193   1.1584  -0.3910   0.3249

A =
 Columns 1 through 8:
        0   1.0000        0        0        0        0        0        0
        0        0   1.0000        0        0        0        0        0
        0        0        0   1.0000        0        0        0        0
        0        0        0        0   1.0000        0        0        0
        0        0        0        0        0   1.0000        0        0
  -0.3232   0.3898  -1.1561   0.9181  -1.5932   0.7671   0.8892  -0.6366
        0        0        0        0        0        0        0   1.0000
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.0052  -0.0038   0.0071  -0.0036   0.0038  -0.0008  -0.3411   0.4026
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.0161  -0.0116   0.0220  -0.0112   0.0116  -0.0026  -0.0497   0.0356
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.0497  -0.0356   0.0676  -0.0345   0.0356  -0.0079  -0.1531   0.1096
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.1529  -0.1095   0.2082  -0.1061   0.1095  -0.0242  -0.4711   0.3373
 Columns 9 through 16:
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   1.2108  -0.6170   0.6366  -0.1408   0.2972  -0.2128   0.4048  -0.2062
        0        0        0        0        0        0        0        0
   1.0000        0        0        0        0        0        0        0
        0   1.0000        0        0        0        0        0        0
        0        0   1.0000        0        0        0        0        0
        0        0        0   1.0000        0        0        0        0
  -1.1804   0.9305  -1.6059   0.7699   0.9148  -0.6549   1.2458  -0.6347
        0        0        0        0        0   1.0000        0        0
        0        0        0        0        0        0   1.0000        0
        0        0        0        0        0        0        0   1.0000
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
  -0.0677   0.0345  -0.0356   0.0079  -0.2622   0.3461  -1.0730   0.8758
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
  -0.2085   0.1062  -0.1096   0.0242   0.1931  -0.1382   0.2629  -0.1340
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
  -0.6415   0.3269  -0.3373   0.0746   0.5942  -0.4254   0.8092  -0.4123
 Columns 17 through 24:
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.2128  -0.0471   0.0806  -0.0577   0.1097  -0.0559   0.0577  -0.0128
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.6549  -0.1449   0.2480  -0.1776   0.3378  -0.1721   0.1776  -0.0393
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   1.0000        0        0        0        0        0        0        0
        0   1.0000        0        0        0        0        0        0
  -1.5495   0.7574   0.7634  -0.5465   1.0395  -0.5297   0.5465  -0.1209
        0        0        0   1.0000        0        0        0        0
        0        0        0        0   1.0000        0        0        0
        0        0        0        0        0   1.0000        0        0
        0        0        0        0        0        0   1.0000        0
        0        0        0        0        0        0        0   1.0000
   0.1382  -0.0306  -0.7283   0.6798  -1.7077   1.1992  -1.8832   0.8313
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.4254  -0.0941  -1.2416   0.8889  -1.6907   0.8615  -0.8889   0.1966
 Columns 25 through 30:
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
   0.0334  -0.0239   0.0454  -0.0232   0.0239  -0.0053
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
   0.1027  -0.0735   0.1399  -0.0713   0.0735  -0.0163
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
   0.3161  -0.2263   0.4305  -0.2194   0.2263  -0.0501
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
   0.9730  -0.6966   1.3250  -0.6751   0.6966  -0.1541
        0   1.0000        0        0        0        0
        0        0   1.0000        0        0        0
        0        0        0   1.0000        0        0
        0        0        0        0   1.0000        0
        0        0        0        0        0   1.0000
  -0.0832   0.2179  -0.8292   0.7516  -1.4213   0.7291

B =
        0
        0
        0
        0
        0
   0.0121
        0
        0
        0
        0
        0
   0.0373
        0
        0
        0
        0
        0
   0.1148
        0
        0
        0
        0
        0
   0.3535
        0
        0
        0
        0
        0
   1.0878

C =
 Columns 1 through 7:
   0.114810  -0.082195   0.156343  -0.079661   0.082195  -0.018184   0.134026
 Columns 8 through 14:
  -0.095952   0.182511  -0.092994   0.095952  -0.021228   0.552719  -0.395703
 Columns 15 through 21:
   0.752672  -0.383506   0.395703  -0.087542   0.199967  -0.143160   0.272307
 Columns 22 through 28:
  -0.138747   0.143160  -0.031672   0.422889  -0.302755   0.575875  -0.293423
 Columns 29 and 30:
   0.302755  -0.066979

D = 0.2437
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave --no-gui -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

