#!/bin/sh

prog=KW_test.m

depends="KW_test.m test_common.m \
KW.m tf2Abcd.m dlyap_levinson.m dlyap_recursive.m atog.m gtor.m"
tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
K =

 Columns 1 through 8:

   3.42366   0.00000   2.11471   0.00000   0.10151   0.00000  -0.44206   0.00000
   0.00000   3.42366   0.00000   2.11471   0.00000   0.10151   0.00000  -0.44206
   2.11471   0.00000   3.42366   0.00000   2.11471   0.00000   0.10151   0.00000
   0.00000   2.11471   0.00000   3.42366   0.00000   2.11471   0.00000   0.10151
   0.10151   0.00000   2.11471   0.00000   3.42366   0.00000   2.11471   0.00000
   0.00000   0.10151   0.00000   2.11471   0.00000   3.42366   0.00000   2.11471
  -0.44206   0.00000   0.10151   0.00000   2.11471   0.00000   3.42366   0.00000
   0.00000  -0.44206   0.00000   0.10151   0.00000   2.11471   0.00000   3.42366
  -0.00912   0.00000  -0.44206   0.00000   0.10151   0.00000   2.11471   0.00000
   0.00000  -0.00912   0.00000  -0.44206   0.00000   0.10151   0.00000   2.11471
   0.16775   0.00000  -0.00912   0.00000  -0.44206   0.00000   0.10151   0.00000
   0.00000   0.16775   0.00000  -0.00912   0.00000  -0.44206   0.00000   0.10151

 Columns 9 through 12:

  -0.00912   0.00000   0.16775   0.00000
   0.00000  -0.00912   0.00000   0.16775
  -0.44206   0.00000  -0.00912   0.00000
   0.00000  -0.44206   0.00000  -0.00912
   0.10151   0.00000  -0.44206   0.00000
   0.00000   0.10151   0.00000  -0.44206
   2.11471   0.00000   0.10151   0.00000
   0.00000   2.11471   0.00000   0.10151
   3.42366   0.00000   2.11471   0.00000
   0.00000   3.42366   0.00000   2.11471
   2.11471   0.00000   3.42366   0.00000
   0.00000   2.11471   0.00000   3.42366

Kdlyap =

 Columns 1 through 8:

   3.42366   0.00000   2.11471   0.00000   0.10151   0.00000  -0.44206   0.00000
   0.00000   3.42366   0.00000   2.11471   0.00000   0.10151   0.00000  -0.44206
   2.11471   0.00000   3.42366   0.00000   2.11471   0.00000   0.10151   0.00000
   0.00000   2.11471   0.00000   3.42366   0.00000   2.11471   0.00000   0.10151
   0.10151   0.00000   2.11471   0.00000   3.42366   0.00000   2.11471   0.00000
   0.00000   0.10151   0.00000   2.11471   0.00000   3.42366   0.00000   2.11471
  -0.44206   0.00000   0.10151   0.00000   2.11471   0.00000   3.42366   0.00000
   0.00000  -0.44206   0.00000   0.10151   0.00000   2.11471   0.00000   3.42366
  -0.00912   0.00000  -0.44206   0.00000   0.10151   0.00000   2.11471   0.00000
   0.00000  -0.00912   0.00000  -0.44206   0.00000   0.10151   0.00000   2.11471
   0.16775   0.00000  -0.00912   0.00000  -0.44206   0.00000   0.10151   0.00000
   0.00000   0.16775   0.00000  -0.00912   0.00000  -0.44206   0.00000   0.10151

 Columns 9 through 12:

  -0.00912   0.00000   0.16775   0.00000
   0.00000  -0.00912   0.00000   0.16775
  -0.44206   0.00000  -0.00912   0.00000
   0.00000  -0.44206   0.00000  -0.00912
   0.10151   0.00000  -0.44206   0.00000
   0.00000   0.10151   0.00000  -0.44206
   2.11471   0.00000   0.10151   0.00000
   0.00000   2.11471   0.00000   0.10151
   3.42366   0.00000   2.11471   0.00000
   0.00000   3.42366   0.00000   2.11471
   2.11471   0.00000   3.42366   0.00000
   0.00000   2.11471   0.00000   3.42366

K =

   1459.70   1458.64    910.40    845.81   -653.25   -679.81
   1458.64   1459.70    974.44    910.40   -623.17   -653.25
    910.40    974.44   2707.57   2704.46   1090.93    955.99
    845.81    910.40   2704.46   2707.57   1225.90   1090.93
   -653.25   -623.17   1090.93   1225.90   3992.44   3984.49
   -679.81   -653.25    955.99   1090.93   3984.49   3992.44

W =

   0.0127783  -0.0143997   0.0076067  -0.0085859   0.0046600  -0.0050323
  -0.0143997   0.0162918  -0.0083088   0.0093885  -0.0050311   0.0054360
   0.0076067  -0.0083088   0.0107432  -0.0117360   0.0113949  -0.0119882
  -0.0085859   0.0093885  -0.0117360   0.0128342  -0.0122173   0.0128660
   0.0046600  -0.0050311   0.0113949  -0.0122173   0.0189935  -0.0196071
  -0.0050323   0.0054360  -0.0119882   0.0128660  -0.0196071   0.0202701

n =

   0.24524   0.24524

d =

   1.00000  -0.50953

A =  0.50953
B =  1
C =  0.37019
D =  0.24524
K =  1.3507
W =  0.18510
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave-cli -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

