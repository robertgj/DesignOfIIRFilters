#!/bin/sh

prog=KW_test.m

depends="KW_test.m test_common.m \
KW.m tf2Abcd.m dlyap_levinson.m dlyap_recursive.m atog.m gtor.m"
tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
echo $here
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
K =

 Columns 1 through 6:

   3.4237e+00  -1.2546e-14   2.1147e+00   6.3283e-15   1.0151e-01   7.6883e-15
  -1.2546e-14   3.4237e+00  -1.2157e-14   2.1147e+00   2.6645e-15   1.0151e-01
   2.1147e+00  -1.2157e-14   3.4237e+00  -1.0547e-14   2.1147e+00   8.8818e-16
   6.3283e-15   2.1147e+00  -1.0547e-14   3.4237e+00  -1.0159e-14   2.1147e+00
   1.0151e-01   2.6645e-15   2.1147e+00  -1.0159e-14   3.4237e+00  -1.1685e-14
   7.6883e-15   1.0151e-01   8.8818e-16   2.1147e+00  -1.1685e-14   3.4237e+00
  -4.4206e-01   7.3483e-15   1.0151e-01   2.2204e-16   2.1147e+00  -1.4235e-14
  -2.7270e-15  -4.4206e-01   3.3584e-15   1.0151e-01  -6.2381e-15   2.1147e+00
  -9.1188e-03  -4.3160e-15  -4.4206e-01  -3.3376e-15   1.0151e-01  -1.1713e-14
  -8.5765e-15  -9.1188e-03  -6.0299e-15  -4.4206e-01  -5.0515e-15   1.0151e-01
   1.6775e-01  -8.2226e-15  -9.1188e-03  -6.9701e-15  -4.4206e-01  -6.1687e-15
  -2.5344e-15   1.6775e-01  -5.7176e-15  -9.1188e-03  -1.7868e-15  -4.4206e-01

 Columns 7 through 12:

  -4.4206e-01  -2.7270e-15  -9.1188e-03  -8.5765e-15   1.6775e-01  -2.5344e-15
   7.3483e-15  -4.4206e-01  -4.3160e-15  -9.1188e-03  -8.2226e-15   1.6775e-01
   1.0151e-01   3.3584e-15  -4.4206e-01  -6.0299e-15  -9.1188e-03  -5.7176e-15
   2.2204e-16   1.0151e-01  -3.3376e-15  -4.4206e-01  -6.9701e-15  -9.1188e-03
   2.1147e+00  -6.2381e-15   1.0151e-01  -5.0515e-15  -4.4206e-01  -1.7868e-15
  -1.4235e-14   2.1147e+00  -1.1713e-14   1.0151e-01  -6.1687e-15  -4.4206e-01
   3.4237e+00  -1.8818e-14   2.1147e+00  -9.4924e-15   1.0151e-01   4.1356e-15
  -1.8818e-14   3.4237e+00  -1.8846e-14   2.1147e+00  -6.8417e-15   1.0151e-01
   2.1147e+00  -1.8846e-14   3.4237e+00  -1.3989e-14   2.1147e+00   1.8457e-15
  -9.4924e-15   2.1147e+00  -1.3989e-14   3.4237e+00  -1.0131e-14   2.1147e+00
   1.0151e-01  -6.8417e-15   2.1147e+00  -1.0131e-14   3.4237e+00  -2.8866e-15
   4.1356e-15   1.0151e-01   1.8457e-15   2.1147e+00  -2.8866e-15   3.4237e+00

W =

 Columns 1 through 6:

   4.0919e-03   8.4253e-03   5.6544e-03   2.1302e-03   6.0117e-03   4.6684e-03
   8.4253e-03   2.1678e-02   2.2531e-02   1.3734e-02   1.1672e-02   8.0760e-03
   5.6544e-03   2.2531e-02   4.3059e-02   3.8154e-02   1.8746e-03  -5.9977e-03
   2.1302e-03   1.3734e-02   3.8154e-02   4.6771e-02   1.6956e-02   2.8230e-03
   6.0117e-03   1.1672e-02   1.8746e-03   1.6956e-02   8.2326e-02   7.2153e-02
   4.6684e-03   8.0760e-03  -5.9977e-03   2.8230e-03   7.2153e-02   8.2568e-02
  -8.2416e-03  -7.8696e-03   3.2680e-02   3.7327e-02  -5.4492e-02  -3.3080e-02
  -9.1016e-03  -1.4000e-02   2.0826e-02   3.0034e-02  -5.9020e-02  -5.5168e-02
   7.2256e-03   1.1767e-03  -4.9349e-02  -4.1914e-02   9.3718e-02   8.4795e-02
   9.5163e-03   9.4343e-03  -4.1476e-02  -4.8334e-02   8.3596e-02   9.3977e-02
  -4.9808e-03   5.0515e-06   3.4611e-02   1.9632e-02  -8.3295e-02  -5.5935e-02
  -7.8980e-03  -4.6929e-03   4.2443e-02   3.4744e-02  -9.8317e-02  -8.3261e-02

 Columns 7 through 12:

  -8.2416e-03  -9.1016e-03   7.2256e-03   9.5163e-03  -4.9808e-03  -7.8980e-03
  -7.8696e-03  -1.4000e-02   1.1767e-03   9.4343e-03   5.0515e-06  -4.6929e-03
   3.2680e-02   2.0826e-02  -4.9349e-02  -4.1476e-02   3.4611e-02   4.2443e-02
   3.7327e-02   3.0034e-02  -4.1914e-02  -4.8334e-02   1.9632e-02   3.4744e-02
  -5.4492e-02  -5.9020e-02   9.3718e-02   8.3596e-02  -8.3295e-02  -9.8317e-02
  -3.3080e-02  -5.5168e-02   8.4795e-02   9.3977e-02  -5.5935e-02  -8.3261e-02
   1.7351e-01   1.4990e-01  -1.5348e-01  -1.5530e-01   1.3803e-01   1.7048e-01
   1.4990e-01   1.7539e-01  -9.9309e-02  -1.5420e-01   8.6422e-02   1.3794e-01
  -1.5348e-01  -9.9309e-02   2.7660e-01   2.2981e-01  -1.8203e-01  -2.2487e-01
  -1.5530e-01  -1.5420e-01   2.2981e-01   2.7688e-01  -8.9571e-02  -1.8199e-01
   1.3803e-01   8.6422e-02  -1.8203e-01  -8.9571e-02   2.3556e-01   2.1257e-01
   1.7048e-01   1.3794e-01  -2.2487e-01  -1.8199e-01   2.1257e-01   2.3556e-01

K =

   1459.70   1458.64    910.40    845.81   -653.25   -679.81
   1458.64   1459.70    974.44    910.40   -623.17   -653.25
    910.40    974.44   2707.57   2704.46   1090.93    955.99
    845.81    910.40   2704.46   2707.57   1225.90   1090.93
   -653.25   -623.17   1090.93   1225.90   3992.44   3984.49
   -679.81   -653.25    955.99   1090.93   3984.49   3992.44

W =

   0.0127783  -0.0143997   0.0076067  -0.0085859   0.0046600  -0.0050323
  -0.0143997   0.0162918  -0.0083088   0.0093885  -0.0050311   0.0054360
   0.0076067  -0.0083088   0.0107432  -0.0117360   0.0113949  -0.0119882
  -0.0085859   0.0093885  -0.0117360   0.0128342  -0.0122173   0.0128660
   0.0046600  -0.0050311   0.0113949  -0.0122173   0.0189935  -0.0196071
  -0.0050323   0.0054360  -0.0119882   0.0128660  -0.0196071   0.0202701

n =

   0.24524   0.24524

d =

   1.00000  -0.50953

A =  0.50953
B =  1
C =  0.37019
D =  0.24524
K =  1.3507
W =  0.18510
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running octave-cli -q " $prog

octave-cli -q $prog > test.out
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

