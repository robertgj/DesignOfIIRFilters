#!/bin/sh

prog=sv2block_test.m

depends="test/sv2block_test.m test_common.m \
sv2block.m KW.m tf2Abcd.m optKW.m svf.m crossWelch.m \
p2n60.m qroots.oct"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
ngABCDopt = 1.4657
ngABCDoptf = 1.5096
est_nvABCDoptf = 0.4573
nvABCDoptf = 0.4459
Ab =
 Columns 1 through 6:
   3.2966e-01  -7.7337e-02  -1.2059e-01   6.6255e-02   2.8597e-01   3.4655e-01
   8.8985e-02   3.4940e-01  -4.2697e-02   5.4919e-01   1.6682e-02  -2.2943e-01
   1.1821e-01   1.4737e-01   3.1918e-01   3.9583e-01  -1.1571e-03  -6.2841e-02
   1.0207e-01  -4.2635e-01  -3.2160e-01   4.2837e-01   2.6091e-01  -4.1681e-01
  -7.7929e-02   9.7258e-02   1.0396e-01   7.9302e-02   4.4908e-01   4.2867e-01
  -3.1261e-01   1.1423e-01   1.0126e-02   3.7280e-01  -4.7629e-01   3.2105e-01
   6.9914e-02   6.9994e-01  -4.5682e-01  -1.6767e-02   7.9702e-02  -7.9325e-02
   6.2269e-01  -5.8230e-03   2.5123e-01   1.5978e-01  -3.9487e-02   3.5130e-01
 Columns 7 and 8:
  -1.1481e-01  -5.5063e-01
  -5.8865e-01   1.1928e-01
   5.5931e-01  -1.9506e-01
   9.4127e-02  -3.0647e-02
   2.4673e-03   1.9741e-01
   1.8804e-02  -4.3350e-01
   3.1197e-01   9.9798e-02
  -5.5776e-02   3.2285e-01

Bb =
  -2.7905e-01  -2.1996e-01  -1.2982e-01  -1.2256e-02
   1.8884e-02   6.5408e-02   1.0989e-01   1.5358e-01
  -6.5072e-02  -6.9079e-03   6.5003e-02   1.5152e-01
  -2.9878e-01  -3.0994e-01  -3.1900e-01  -3.2932e-01
  -3.1474e-01  -3.6105e-01  -4.0324e-01  -4.3374e-01
  -5.7669e-02  -1.0785e-01  -1.6541e-01  -2.3311e-01
  -2.9485e-03  -2.3889e-02  -4.9890e-02  -8.0137e-02
   1.6718e-02   7.1501e-02   1.0250e-01   9.9401e-02

Cb =
 Columns 1 through 6:
   8.8731e-02  -5.6176e-02  -2.0575e-01  -2.4204e-02  -1.1413e-01   6.6749e-02
   6.4767e-02  -6.3861e-02  -1.6548e-01  -5.1304e-02  -9.5849e-02   5.4656e-02
   3.5657e-02  -7.5596e-02  -1.2493e-01  -7.2373e-02  -8.1839e-02   4.7798e-02
   4.9902e-03  -8.7975e-02  -8.5305e-02  -8.8689e-02  -7.3144e-02   4.4072e-02
 Columns 7 and 8:
  -6.8658e-02  -8.0793e-03
  -1.0073e-01  -3.9187e-02
  -1.1871e-01  -5.9599e-02
  -1.2287e-01  -7.1129e-02

Db =
   0.010374          0          0          0
   0.005723   0.010374          0          0
   0.014231   0.005723   0.010374          0
   0.020802   0.014231   0.005723   0.010374

Abf =
 Columns 1 through 6:
   3.3008e-01  -7.8125e-02  -1.2109e-01   6.6406e-02   2.8516e-01   3.4570e-01
   8.9844e-02   3.4961e-01  -4.2969e-02   5.4883e-01   1.7578e-02  -2.2852e-01
   1.1914e-01   1.4648e-01   3.1836e-01   3.9648e-01  -1.9531e-03  -6.2500e-02
   1.0156e-01  -4.2578e-01  -3.2227e-01   4.2773e-01   2.6172e-01  -4.1602e-01
  -7.8125e-02   9.7656e-02   1.0352e-01   8.0078e-02   4.4922e-01   4.2773e-01
  -3.1250e-01   1.1328e-01   9.7656e-03   3.7305e-01  -4.7656e-01   3.2031e-01
   7.0312e-02   6.9922e-01  -4.5703e-01  -1.7578e-02   8.0078e-02  -8.0078e-02
   6.2305e-01  -5.8594e-03   2.5195e-01   1.6016e-01  -3.9062e-02   3.5156e-01
 Columns 7 and 8:
  -1.1523e-01  -5.5078e-01
  -5.8789e-01   1.1914e-01
   5.5859e-01  -1.9531e-01
   9.3750e-02  -3.1250e-02
   1.9531e-03   1.9727e-01
   1.9531e-02  -4.3359e-01
   3.1250e-01   9.9609e-02
  -5.6641e-02   3.2227e-01

Bbf =
  -2.7930e-01  -2.2070e-01  -1.2891e-01  -1.1719e-02
   1.9531e-02   6.4453e-02   1.0938e-01   1.5430e-01
  -6.4453e-02  -7.8125e-03   6.4453e-02   1.5234e-01
  -2.9883e-01  -3.1055e-01  -3.1836e-01  -3.3008e-01
  -3.1445e-01  -3.6133e-01  -4.0234e-01  -4.3359e-01
  -5.8594e-02  -1.0742e-01  -1.6602e-01  -2.3242e-01
  -3.9062e-03  -2.3438e-02  -5.0781e-02  -8.0078e-02
   1.7578e-02   7.2266e-02   1.0156e-01   9.9609e-02

Cbf =
 Columns 1 through 6:
   8.7891e-02  -5.6641e-02  -2.0508e-01  -2.3438e-02  -1.1328e-01   6.6406e-02
   6.4453e-02  -6.4453e-02  -1.6602e-01  -5.0781e-02  -9.5703e-02   5.4688e-02
   3.5156e-02  -7.6172e-02  -1.2500e-01  -7.2266e-02  -8.2031e-02   4.6875e-02
   5.8594e-03  -8.7891e-02  -8.5938e-02  -8.7891e-02  -7.2266e-02   4.4922e-02
 Columns 7 and 8:
  -6.8359e-02  -7.8125e-03
  -1.0156e-01  -3.9062e-02
  -1.1914e-01  -6.0547e-02
  -1.2305e-01  -7.0312e-02

Dbf =
   0.009766          0          0          0
   0.005859   0.009766          0          0
   0.013672   0.005859   0.009766          0
   0.021484   0.013672   0.005859   0.009766

ngABCDbf = 0.3664
est_nvABCDbf = 0.3374
nvABCDbf = 0.3334
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave --no-gui -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

