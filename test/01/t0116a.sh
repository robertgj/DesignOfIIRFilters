#!/bin/sh

prog=sv2block_test.m

depends="test/sv2block_test.m test_common.m \
sv2block.m KW.m tf2Abcd.m optKW.m svf.m crossWelch.m \
p2n60.m qroots.m qzsolve.oct"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
ngABCDopt = 1.4657
ngABCDoptf = 1.3956
est_nvABCDoptf = 0.4468
nvABCDoptf = 0.4579
Ab =
 Columns 1 through 6:
   3.3999e-01  -2.4906e-01   1.4599e-01   4.8317e-01  -2.6990e-01   1.9036e-01
   1.2026e-01   3.5598e-01  -4.8801e-02   2.9750e-01  -1.0007e-01  -5.7811e-01
  -7.8579e-02   1.0241e-02   3.2211e-01   3.2584e-01  -5.8993e-02   1.3301e-01
  -4.1009e-01  -3.9114e-01  -2.5358e-01   3.2301e-01   3.6482e-01  -2.8538e-01
   3.6619e-01   9.1370e-02   1.7661e-01  -3.1135e-01   3.5855e-01   2.2529e-01
  -6.3280e-02   3.9717e-01  -5.4578e-02   3.9973e-01  -2.3242e-01   3.6879e-01
   5.3885e-01  -2.6504e-04  -5.1976e-01   2.1225e-01   3.1694e-01   8.4053e-02
   1.4125e-01  -5.8476e-01   1.2437e-01  -1.0636e-01  -2.7530e-01   9.8479e-02
 Columns 7 and 8:
  -4.4952e-01   5.4131e-02
  -5.8408e-03   4.2096e-01
   6.4515e-01   3.9339e-03
  -1.1238e-01   2.5247e-01
  -1.2885e-01   4.6584e-01
  -1.2431e-02   5.0698e-02
   3.4273e-01   4.4170e-02
   1.3485e-01   4.2042e-01

Bb =
  -1.8562e-01  -1.0285e-01   2.0827e-04   1.2092e-01
   2.7304e-01   2.9259e-01   2.9378e-01   2.7311e-01
  -1.3878e-01  -8.8097e-02  -1.8721e-02   7.1186e-02
  -2.1738e-01  -2.6631e-01  -3.0044e-01  -3.1288e-01
   5.5109e-02   5.2665e-02   3.5670e-02   1.1099e-02
  -2.5785e-01  -3.1768e-01  -3.8473e-01  -4.5929e-01
  -8.1648e-02  -7.0163e-02  -5.5579e-02  -3.7943e-02
  -1.5114e-01  -1.1461e-01  -9.3309e-02  -9.6158e-02

Cb =
 Columns 1 through 6:
   3.6284e-02  -3.8132e-02  -2.0116e-01  -5.5648e-02  -1.5804e-01  -1.0552e-02
   2.6554e-02  -3.7212e-02  -1.5920e-01  -4.6181e-02  -1.3253e-01  -1.9685e-02
   6.3959e-03  -3.0195e-02  -1.1818e-01  -4.0975e-02  -1.1084e-01  -2.4257e-02
  -1.9760e-02  -1.7888e-02  -7.9358e-02  -3.9642e-02  -9.2871e-02  -2.7019e-02
 Columns 7 and 8:
  -5.9588e-02  -3.4370e-02
  -9.8099e-02  -7.0461e-02
  -1.2590e-01  -9.5467e-02
  -1.4139e-01  -1.1143e-01

Db =
   0.010374          0          0          0
   0.005723   0.010374          0          0
   0.014231   0.005723   0.010374          0
   0.020802   0.014231   0.005723   0.010374

Abf =
   0.3398  -0.2500   0.1465   0.4824  -0.2695   0.1895  -0.4492   0.0547
   0.1211   0.3555  -0.0488   0.2969  -0.0996  -0.5781  -0.0059   0.4219
  -0.0781   0.0098   0.3223   0.3262  -0.0586   0.1328   0.6445   0.0039
  -0.4102  -0.3906  -0.2539   0.3223   0.3652  -0.2852  -0.1133   0.2520
   0.3652   0.0918   0.1758  -0.3105   0.3594   0.2246  -0.1289   0.4668
  -0.0625   0.3965  -0.0547   0.4004  -0.2324   0.3691  -0.0117   0.0508
   0.5391        0  -0.5195   0.2129   0.3164   0.0840   0.3418   0.0449
   0.1406  -0.5840   0.1250  -0.1055  -0.2754   0.0977   0.1348   0.4199

Bbf =
  -0.1855  -0.1035        0   0.1211
   0.2734   0.2930   0.2930   0.2734
  -0.1387  -0.0879  -0.0195   0.0703
  -0.2168  -0.2656  -0.3008  -0.3125
   0.0547   0.0527   0.0352   0.0117
  -0.2578  -0.3184  -0.3848  -0.4590
  -0.0820  -0.0703  -0.0547  -0.0371
  -0.1504  -0.1152  -0.0938  -0.0957

Cbf =
 Columns 1 through 6:
   3.7109e-02  -3.9062e-02  -2.0117e-01  -5.4688e-02  -1.5820e-01  -9.7656e-03
   2.7344e-02  -3.7109e-02  -1.6016e-01  -4.6875e-02  -1.3281e-01  -1.9531e-02
   5.8594e-03  -2.9297e-02  -1.1914e-01  -4.1016e-02  -1.1133e-01  -2.3438e-02
  -1.9531e-02  -1.7578e-02  -8.0078e-02  -3.9062e-02  -9.3750e-02  -2.7344e-02
 Columns 7 and 8:
  -6.0547e-02  -3.5156e-02
  -9.7656e-02  -7.0312e-02
  -1.2500e-01  -9.5703e-02
  -1.4062e-01  -1.1133e-01

Dbf =
   0.009766          0          0          0
   0.005859   0.009766          0          0
   0.013672   0.005859   0.009766          0
   0.021484   0.013672   0.005859   0.009766

ngABCDbf = 0.3664
est_nvABCDbf = 0.3374
nvABCDbf = 0.3407
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave --no-gui -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

