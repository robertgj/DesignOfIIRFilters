#!/bin/sh

prog=sv2block_test.m

depends="sv2block_test.m test_common.m \
sv2block.m KW.m tf2Abcd.m optKW.m svf.m crossWelch.m \
p2n60.m qroots.m qzsolve.oct"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
ngABCDopt = 1.4647
ngABCDoptf = 1.4758
est_nvABCDoptf = 0.4542
nvABCDoptf = 0.4485
Ab =
 Columns 1 through 6:
   3.0894e-01  -2.5104e-02   2.1358e-03   4.2301e-01  -2.4352e-01   4.6651e-01
   3.4490e-02   3.5029e-01  -3.4749e-02   3.3651e-01   2.0420e-01  -1.2558e-01
  -1.1199e-02   1.3050e-01   3.1446e-01   4.2366e-01   3.4880e-02  -2.9973e-02
  -3.5881e-01  -3.3442e-01  -4.1083e-01   3.2915e-01   5.1969e-01  -5.2473e-02
   3.1393e-01  -4.1761e-02   6.1946e-02  -4.3827e-01   3.8849e-01   5.1949e-01
  -3.1662e-01   1.5179e-01   8.0600e-02   2.1544e-01  -3.7857e-01   3.8709e-01
   9.9763e-02   6.7462e-01  -4.8894e-01  -3.5257e-02   1.1214e-01   5.2548e-02
   4.5458e-01  -3.2891e-01  -2.2631e-02   2.7649e-01   1.1640e-01   1.0290e-01
 Columns 7 and 8:
  -1.4782e-01  -3.2360e-01
  -5.4595e-01   4.8397e-01
   5.9084e-01   1.0455e-01
   5.3564e-02  -1.2878e-01
  -4.1041e-03   1.6368e-01
  -7.5663e-03   1.2836e-01
   3.1529e-01   6.1546e-02
   3.7750e-02   4.3786e-01

Bb =
  -0.206183  -0.135403  -0.038917   0.078584
   0.022674   0.073939   0.123744   0.173150
  -0.066015  -0.010199   0.059293   0.143240
  -0.287426  -0.316674  -0.320301  -0.294558
  -0.140530  -0.128333  -0.107955  -0.072589
  -0.291113  -0.355960  -0.421425  -0.483195
  -0.013963  -0.030670  -0.052006  -0.077469
  -0.199126  -0.167425  -0.150888  -0.159292

Cb =
 Columns 1 through 6:
   9.0321e-02  -6.1619e-02  -2.0269e-01   1.1101e-02  -1.2359e-01  -4.9827e-02
   6.7748e-02  -6.7421e-02  -1.6196e-01   7.6501e-03  -1.0247e-01  -4.3453e-02
   4.0522e-02  -7.7464e-02  -1.2084e-01  -2.7468e-04  -8.8085e-02  -3.7538e-02
   1.2085e-02  -8.8358e-02  -8.0656e-02  -1.1393e-02  -7.9412e-02  -3.4014e-02
 Columns 7 and 8:
  -6.9904e-02  -1.9675e-02
  -1.0344e-01  -6.0185e-02
  -1.2282e-01  -8.9214e-02
  -1.2820e-01  -1.0894e-01

Db =
   0.010374          0          0          0
   0.005723   0.010374          0          0
   0.014231   0.005723   0.010374          0
   0.020802   0.014231   0.005723   0.010374

Abf =
 Columns 1 through 6:
   3.0859e-01  -2.5391e-02   1.9531e-03   4.2383e-01  -2.4414e-01   4.6680e-01
   3.5156e-02   3.4961e-01  -3.5156e-02   3.3594e-01   2.0508e-01  -1.2500e-01
  -1.1719e-02   1.3086e-01   3.1445e-01   4.2383e-01   3.5156e-02  -2.9297e-02
  -3.5938e-01  -3.3398e-01  -4.1016e-01   3.3008e-01   5.1953e-01  -5.2734e-02
   3.1445e-01  -4.1016e-02   6.2500e-02  -4.3750e-01   3.8867e-01   5.1953e-01
  -3.1641e-01   1.5234e-01   8.0078e-02   2.1484e-01  -3.7891e-01   3.8672e-01
   9.9609e-02   6.7383e-01  -4.8828e-01  -3.5156e-02   1.1133e-01   5.2734e-02
   4.5508e-01  -3.2812e-01  -2.3438e-02   2.7734e-01   1.1719e-01   1.0352e-01
 Columns 7 and 8:
  -1.4844e-01  -3.2422e-01
  -5.4688e-01   4.8438e-01
   5.9180e-01   1.0547e-01
   5.2734e-02  -1.2891e-01
  -3.9062e-03   1.6406e-01
  -7.8125e-03   1.2891e-01
   3.1445e-01   6.2500e-02
   3.7109e-02   4.3750e-01

Bbf =
  -2.0703e-01  -1.3477e-01  -3.9062e-02   7.8125e-02
   2.3438e-02   7.4219e-02   1.2305e-01   1.7383e-01
  -6.6406e-02  -9.7656e-03   5.8594e-02   1.4258e-01
  -2.8711e-01  -3.1641e-01  -3.2031e-01  -2.9492e-01
  -1.4062e-01  -1.2891e-01  -1.0742e-01  -7.2266e-02
  -2.9102e-01  -3.5547e-01  -4.2188e-01  -4.8242e-01
  -1.3672e-02  -3.1250e-02  -5.2734e-02  -7.8125e-02
  -1.9922e-01  -1.6797e-01  -1.5039e-01  -1.6016e-01

Cbf =
   0.0898  -0.0625  -0.2031   0.0117  -0.1230  -0.0508  -0.0703  -0.0195
   0.0684  -0.0684  -0.1621   0.0078  -0.1016  -0.0430  -0.1035  -0.0605
   0.0410  -0.0781  -0.1211        0  -0.0879  -0.0371  -0.1230  -0.0898
   0.0117  -0.0879  -0.0801  -0.0117  -0.0801  -0.0332  -0.1289  -0.1094

Dbf =
   0.009766          0          0          0
   0.005859   0.009766          0          0
   0.013672   0.005859   0.009766          0
   0.021484   0.013672   0.005859   0.009766

ngABCDbf = 0.3662
est_nvABCDbf = 0.3374
nvABCDbf = 0.3372
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave --no-gui -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

