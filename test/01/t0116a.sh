#!/bin/sh

prog=sv2block_test.m

depends="sv2block_test.m test_common.m \
sv2block.m KW.m tf2Abcd.m optKW.m svf.m crossWelch.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
ngABCDopt = 1.4657
ngABCDoptf = 1.6750
est_nvABCDoptf = 0.4721
nvABCDoptf = 0.4628
Ab =
 Columns 1 through 6:
   3.6494e-01  -2.2072e-01  -5.7976e-02   5.4253e-01   8.9163e-03   2.0993e-01
   1.0529e-01   3.6342e-01  -4.2446e-02   3.1077e-01  -1.1598e-02  -5.7878e-01
   1.6368e-01  -2.2679e-03   3.2285e-01   3.4929e-01   2.8789e-02   1.2102e-01
  -4.7743e-01  -3.9179e-01  -3.1691e-01   3.1013e-01   3.5156e-01  -3.2907e-01
   1.6710e-01  -1.9831e-02   1.0824e-01  -3.2094e-01   3.7265e-01   1.4754e-01
  -7.0686e-02   4.0076e-01  -4.2446e-02   4.4850e-01  -1.2243e-01   3.6685e-01
   5.3371e-01   1.0220e-01  -5.2188e-01  -7.6996e-02   3.8350e-01   8.5025e-04
   1.8328e-01  -5.9081e-01   1.1798e-01  -2.9529e-02  -2.8670e-01   9.4265e-02
 Columns 7 and 8:
  -4.7804e-01   6.6997e-02
  -7.4285e-02   4.2244e-01
   6.1965e-01   1.0064e-02
   1.0528e-01   1.1155e-01
  -2.3402e-01   5.1560e-01
   1.0600e-02   6.1852e-02
   3.1532e-01   3.0487e-02
   7.3280e-02   4.1542e-01

Bb =
  -2.0013e-01  -1.2074e-01  -2.1739e-02   9.4287e-02
   2.7517e-01   2.9391e-01   2.9415e-01   2.7242e-01
  -1.3958e-01  -8.6355e-02  -1.4121e-02   7.8764e-02
  -2.2256e-01  -2.6921e-01  -2.9763e-01  -3.0295e-01
  -6.9221e-03  -2.0485e-02  -4.3636e-02  -6.7814e-02
  -2.5682e-01  -3.1673e-01  -3.8373e-01  -4.5797e-01
  -9.1293e-03  -2.9161e-02  -5.3999e-02  -8.2760e-02
  -1.5293e-01  -1.1651e-01  -9.5187e-02  -9.7881e-02

Cb =
 Columns 1 through 6:
   1.9486e-02  -3.4527e-02  -2.0020e-01  -1.0826e-02  -1.6791e-01  -1.1382e-02
  -5.2325e-03  -3.4034e-02  -1.5891e-01  -8.2695e-03  -1.4075e-01  -1.9856e-02
  -3.5622e-02  -2.7599e-02  -1.1865e-01  -8.9580e-03  -1.1852e-01  -2.3895e-02
  -6.6938e-02  -1.5981e-02  -8.0550e-02  -1.2513e-02  -1.0097e-01  -2.6274e-02
 Columns 7 and 8:
  -7.0263e-02  -3.4385e-02
  -1.0248e-01  -7.0374e-02
  -1.2079e-01  -9.5350e-02
  -1.2538e-01  -1.1136e-01

Db =
   0.010374          0          0          0
   0.005723   0.010374          0          0
   0.014231   0.005723   0.010374          0
   0.020802   0.014231   0.005723   0.010374

Abf =
   0.3652  -0.2207  -0.0586   0.5430   0.0098   0.2090  -0.4785   0.0664
   0.1055   0.3633  -0.0430   0.3105  -0.0117  -0.5781  -0.0742   0.4219
   0.1641  -0.0020   0.3223   0.3496   0.0293   0.1211   0.6191   0.0098
  -0.4766  -0.3926  -0.3164   0.3105   0.3516  -0.3281   0.1055   0.1113
   0.1680  -0.0195   0.1074  -0.3203   0.3730   0.1484  -0.2344   0.5156
  -0.0703   0.4004  -0.0430   0.4492  -0.1230   0.3672   0.0098   0.0625
   0.5332   0.1016  -0.5215  -0.0762   0.3828        0   0.3145   0.0312
   0.1836  -0.5898   0.1172  -0.0293  -0.2871   0.0938   0.0742   0.4160

Bbf =
  -1.9922e-01  -1.2109e-01  -2.1484e-02   9.3750e-02
   2.7539e-01   2.9297e-01   2.9492e-01   2.7148e-01
  -1.3867e-01  -8.5938e-02  -1.3672e-02   7.8125e-02
  -2.2266e-01  -2.6953e-01  -2.9688e-01  -3.0273e-01
  -7.8125e-03  -1.9531e-02  -4.2969e-02  -6.8359e-02
  -2.5586e-01  -3.1641e-01  -3.8281e-01  -4.5703e-01
  -9.7656e-03  -2.9297e-02  -5.4688e-02  -8.2031e-02
  -1.5234e-01  -1.1719e-01  -9.5703e-02  -9.7656e-02

Cbf =
 Columns 1 through 6:
   1.9531e-02  -3.5156e-02  -2.0117e-01  -1.1719e-02  -1.6797e-01  -1.1719e-02
  -5.8594e-03  -3.3203e-02  -1.5820e-01  -7.8125e-03  -1.4062e-01  -1.9531e-02
  -3.5156e-02  -2.7344e-02  -1.1914e-01  -9.7656e-03  -1.1914e-01  -2.3438e-02
  -6.6406e-02  -1.5625e-02  -8.0078e-02  -1.1719e-02  -1.0156e-01  -2.5391e-02
 Columns 7 and 8:
  -7.0312e-02  -3.5156e-02
  -1.0156e-01  -7.0312e-02
  -1.2109e-01  -9.5703e-02
  -1.2500e-01  -1.1133e-01

Dbf =
   0.009766          0          0          0
   0.005859   0.009766          0          0
   0.013672   0.005859   0.009766          0
   0.021484   0.013672   0.005859   0.009766

ngABCDbf = 0.3664
est_nvABCDbf = 0.3374
nvABCDbf = 0.3389
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave-cli -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

