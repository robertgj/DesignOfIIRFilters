#!/bin/sh

prog=sv2block_test.m

depends="sv2block_test.m test_common.m \
sv2block.m KW.m tf2Abcd.m optKW.m svf.m crossWelch.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
echo $here
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
ngABCDopt =    1.4675e+00
ngABCDoptf =    1.8402e+00
est_nvABCDoptf =    4.8650e-01
nvABCDoptf =    4.6207e-01
Ab =

 Columns 1 through 6:

   2.9985e-01  -5.1579e-03   1.3128e-02   4.1933e-01  -2.3297e-02   5.3699e-01
   2.1106e-02   3.6340e-01  -4.2768e-02   3.2500e-01   3.4112e-01  -1.7865e-01
  -2.2807e-02   1.3513e-01   3.1454e-01   4.3447e-01  -1.8549e-01  -4.3417e-02
  -3.4791e-01  -3.3080e-01  -4.2169e-01   3.2705e-01   4.0703e-01  -2.1537e-01
   1.4416e-01  -2.4317e-01   2.5249e-01  -2.7888e-01   3.8863e-01   4.5774e-01
  -4.3304e-01   1.7111e-01   5.0475e-02   3.4629e-01  -3.6876e-01   3.4741e-01
   1.4879e-01   6.4712e-01  -4.1505e-01  -1.5321e-01   1.3469e-01   1.8094e-01
   4.4793e-01  -3.1190e-01  -3.6439e-02   2.9808e-01   1.2716e-01   4.7528e-02

 Columns 7 and 8:

  -1.7566e-01  -3.1541e-01
  -4.7347e-01   4.5542e-01
   5.5230e-01   1.1994e-01
   2.3018e-01  -1.4751e-01
   2.5066e-02   1.6811e-01
  -1.5440e-01   5.9428e-02
   3.5200e-01   1.3967e-01
   8.5495e-02   4.3867e-01

Bb =

  -1.9141e-01  -1.2005e-01  -2.4417e-02   9.0673e-02
   2.3326e-02   7.4303e-02   1.2399e-01   1.7354e-01
  -6.2544e-02  -4.7269e-03   6.6669e-02   1.5220e-01
  -2.9751e-01  -3.2279e-01  -3.2124e-01  -2.8946e-01
  -2.2055e-01  -2.2503e-01  -2.2073e-01  -2.0053e-01
  -2.2033e-01  -2.8480e-01  -3.5255e-01  -4.2190e-01
  -9.1106e-02  -1.1265e-01  -1.3566e-01  -1.5652e-01
  -1.9850e-01  -1.6766e-01  -1.5248e-01  -1.6278e-01

Cb =

 Columns 1 through 6:

   9.1289e-02  -6.0853e-02  -2.0147e-01   1.4762e-02  -1.0170e-01  -3.8281e-03
   6.8504e-02  -6.6640e-02  -1.6171e-01   9.8014e-03  -6.9202e-02  -4.5976e-03
   4.1330e-02  -7.6733e-02  -1.2137e-01   3.4748e-04  -4.7632e-02  -3.5210e-03
   1.3133e-02  -8.7732e-02  -8.1748e-02  -1.2165e-02  -3.6746e-02  -2.7707e-03

 Columns 7 and 8:

  -1.1206e-01  -2.0862e-02
  -1.3432e-01  -6.2630e-02
  -1.4597e-01  -9.2522e-02
  -1.4704e-01  -1.1268e-01

Db =

   1.0375e-02   0.0000e+00   0.0000e+00   0.0000e+00
   5.7233e-03   1.0375e-02   0.0000e+00   0.0000e+00
   1.4232e-02   5.7233e-03   1.0375e-02   0.0000e+00
   2.0803e-02   1.4232e-02   5.7233e-03   1.0375e-02

Abf =

 Columns 1 through 3:

   3.007812500000000e-01  -5.859375000000000e-03   1.367187500000000e-02
   2.148437500000000e-02   3.632812500000000e-01  -4.296875000000000e-02
  -2.343750000000000e-02   1.347656250000000e-01   3.144531250000000e-01
  -3.476562500000000e-01  -3.300781250000000e-01  -4.218750000000000e-01
   1.445312500000000e-01  -2.441406250000000e-01   2.519531250000000e-01
  -4.335937500000000e-01   1.718750000000000e-01   5.078125000000000e-02
   1.484375000000000e-01   6.464843750000000e-01  -4.160156250000000e-01
   4.472656250000000e-01  -3.125000000000000e-01  -3.710937500000000e-02

 Columns 4 through 6:

   4.199218750000000e-01  -2.343750000000000e-02   5.371093750000000e-01
   3.242187500000000e-01   3.417968750000000e-01  -1.777343750000000e-01
   4.335937500000000e-01  -1.855468750000000e-01  -4.296875000000000e-02
   3.261718750000000e-01   4.062500000000000e-01  -2.148437500000000e-01
  -2.792968750000000e-01   3.886718750000000e-01   4.570312500000000e-01
   3.457031250000000e-01  -3.691406250000000e-01   3.476562500000000e-01
  -1.523437500000000e-01   1.347656250000000e-01   1.816406250000000e-01
   2.988281250000000e-01   1.269531250000000e-01   4.687500000000000e-02

 Columns 7 and 8:

  -1.757812500000000e-01  -3.144531250000000e-01
  -4.726562500000000e-01   4.550781250000000e-01
   5.527343750000000e-01   1.191406250000000e-01
   2.304687500000000e-01  -1.484375000000000e-01
   2.539062500000000e-02   1.679687500000000e-01
  -1.542968750000000e-01   5.859375000000000e-02
   3.515625000000000e-01   1.406250000000000e-01
   8.593750000000000e-02   4.394531250000000e-01

Bbf =

 Columns 1 through 3:

  -1.914062500000000e-01  -1.191406250000000e-01  -2.539062500000000e-02
   2.343750000000000e-02   7.421875000000000e-02   1.230468750000000e-01
  -6.250000000000000e-02  -3.906250000000000e-03   6.640625000000000e-02
  -2.968750000000000e-01  -3.222656250000000e-01  -3.203125000000000e-01
  -2.207031250000000e-01  -2.246093750000000e-01  -2.207031250000000e-01
  -2.207031250000000e-01  -2.851562500000000e-01  -3.535156250000000e-01
  -9.179687500000000e-02  -1.132812500000000e-01  -1.347656250000000e-01
  -1.992187500000000e-01  -1.679687500000000e-01  -1.523437500000000e-01

 Column 4:

   8.984375000000000e-02
   1.738281250000000e-01
   1.523437500000000e-01
  -2.890625000000000e-01
  -2.011718750000000e-01
  -4.218750000000000e-01
  -1.562500000000000e-01
  -1.621093750000000e-01

Cbf =

 Columns 1 through 3:

   9.179687500000000e-02  -6.054687500000000e-02  -2.011718750000000e-01
   6.835937500000000e-02  -6.640625000000000e-02  -1.621093750000000e-01
   4.101562500000000e-02  -7.617187500000000e-02  -1.210937500000000e-01
   1.367187500000000e-02  -8.789062500000000e-02  -8.203125000000000e-02

 Columns 4 through 6:

   1.562500000000000e-02  -1.015625000000000e-01  -3.906250000000000e-03
   9.765625000000000e-03  -6.835937500000000e-02  -3.906250000000000e-03
   0.000000000000000e+00  -4.687500000000000e-02  -3.906250000000000e-03
  -1.171875000000000e-02  -3.710937500000000e-02  -1.953125000000000e-03

 Columns 7 and 8:

  -1.113281250000000e-01  -2.148437500000000e-02
  -1.347656250000000e-01  -6.250000000000000e-02
  -1.464843750000000e-01  -9.179687500000000e-02
  -1.464843750000000e-01  -1.132812500000000e-01

Dbf =

 Columns 1 through 3:

   9.765625000000000e-03   0.000000000000000e+00   0.000000000000000e+00
   5.859375000000000e-03   9.765625000000000e-03   0.000000000000000e+00
   1.367187500000000e-02   5.859375000000000e-03   9.765625000000000e-03
   2.148437500000000e-02   1.367187500000000e-02   5.859375000000000e-03

 Column 4:

   0.000000000000000e+00
   0.000000000000000e+00
   0.000000000000000e+00
   9.765625000000000e-03

ngABCDbf =    3.6687e-01
est_nvABCDbf =    3.3750e-01
nvABCDbf =    3.3908e-01
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running octave-cli -q " $prog

octave-cli -q $prog > test.out
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

