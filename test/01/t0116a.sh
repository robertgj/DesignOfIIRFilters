#!/bin/sh

prog=sv2block_test.m

depends="sv2block_test.m test_common.m \
sv2block.m KW.m tf2Abcd.m optKW.m svf.m crossWelch.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
echo $here
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
ngABCDopt =    1.4662e+00
ngABCDoptf =    1.4849e+00
est_nvABCDoptf =    4.5506e-01
nvABCDoptf =    4.5968e-01
Ab =

 Columns 1 through 6:

   3.2371e-01   1.4060e-01  -1.2531e-01   5.2018e-01   1.9890e-01   3.6573e-01
  -7.3500e-02   3.5710e-01  -1.6271e-01   2.9435e-01   1.6329e-01  -3.6110e-01
   1.1794e-01   2.4054e-01   3.1611e-01   2.0816e-01  -6.4282e-02  -1.7339e-01
  -4.6020e-01  -3.3711e-01  -2.4287e-01   3.1203e-01   2.7624e-01  -3.9970e-01
   1.2325e-02   1.2943e-02   1.0802e-01  -1.9158e-01   4.5333e-01   4.4719e-01
  -3.0216e-01   3.1474e-01   1.1678e-01   4.6428e-01  -4.4560e-01   3.2805e-01
  -1.7735e-01   6.6870e-01  -4.2236e-01  -3.3707e-01   5.4613e-02  -4.3166e-02
   4.5814e-01  -1.1690e-01  -2.8518e-01   1.7265e-01   1.6910e-01  -2.2142e-02

 Columns 7 and 8:

   1.1482e-01  -2.7186e-01
  -5.7455e-01   3.1180e-01
   5.3005e-01   3.3407e-01
   3.3106e-01  -1.2014e-01
  -5.1917e-02   2.0794e-01
   8.2838e-03  -1.9391e-02
   2.8811e-01   4.1210e-02
  -4.2681e-03   4.5312e-01

Bb =

  -2.8500e-01  -2.1218e-01  -1.0561e-01   3.1581e-02
  -5.0953e-02  -1.8670e-02   1.7832e-02   6.1198e-02
   2.4163e-02   6.0712e-02   1.0060e-01   1.4544e-01
  -2.2009e-01  -2.7878e-01  -3.1979e-01  -3.3903e-01
  -2.9821e-01  -3.3306e-01  -3.6220e-01  -3.7757e-01
  -1.1591e-01  -1.7495e-01  -2.4054e-01  -3.1386e-01
   3.8949e-02   1.1933e-02  -1.7030e-02  -4.5044e-02
  -1.9434e-01  -1.6800e-01  -1.5802e-01  -1.7387e-01

Cb =

 Columns 1 through 6:

   2.3303e-02  -6.3524e-02  -2.1937e-01   6.0743e-03  -1.2718e-01   4.4876e-02
   1.2741e-02  -6.8911e-02  -1.7417e-01   1.0077e-02  -1.0624e-01   3.6535e-02
  -2.5743e-03  -7.8995e-02  -1.2681e-01   1.2533e-02  -9.0622e-02   3.2424e-02
  -1.9632e-02  -9.0481e-02  -7.9649e-02   1.2730e-02  -8.0950e-02   3.0284e-02

 Columns 7 and 8:

  -6.3804e-02  -3.4693e-02
  -8.6345e-02  -8.2017e-02
  -9.7553e-02  -1.1490e-01
  -9.7261e-02  -1.3548e-01

Db =

   1.0375e-02   0.0000e+00   0.0000e+00   0.0000e+00
   5.7233e-03   1.0375e-02   0.0000e+00   0.0000e+00
   1.4232e-02   5.7233e-03   1.0375e-02   0.0000e+00
   2.0803e-02   1.4232e-02   5.7233e-03   1.0375e-02

Abf =

 Columns 1 through 3:

   3.24218750000000e-01   1.40625000000000e-01  -1.25000000000000e-01
  -7.42187500000000e-02   3.57421875000000e-01  -1.62109375000000e-01
   1.17187500000000e-01   2.40234375000000e-01   3.16406250000000e-01
  -4.60937500000000e-01  -3.37890625000000e-01  -2.42187500000000e-01
   1.17187500000000e-02   1.36718750000000e-02   1.07421875000000e-01
  -3.02734375000000e-01   3.14453125000000e-01   1.17187500000000e-01
  -1.77734375000000e-01   6.67968750000000e-01  -4.21875000000000e-01
   4.58984375000000e-01  -1.17187500000000e-01  -2.85156250000000e-01

 Columns 4 through 6:

   5.19531250000000e-01   1.99218750000000e-01   3.65234375000000e-01
   2.94921875000000e-01   1.64062500000000e-01  -3.61328125000000e-01
   2.08984375000000e-01  -6.44531250000000e-02  -1.73828125000000e-01
   3.12500000000000e-01   2.75390625000000e-01  -4.00390625000000e-01
  -1.91406250000000e-01   4.53125000000000e-01   4.47265625000000e-01
   4.64843750000000e-01  -4.45312500000000e-01   3.28125000000000e-01
  -3.37890625000000e-01   5.46875000000000e-02  -4.29687500000000e-02
   1.71875000000000e-01   1.69921875000000e-01  -2.14843750000000e-02

 Columns 7 and 8:

   1.15234375000000e-01  -2.71484375000000e-01
  -5.74218750000000e-01   3.12500000000000e-01
   5.29296875000000e-01   3.33984375000000e-01
   3.32031250000000e-01  -1.21093750000000e-01
  -5.27343750000000e-02   2.07031250000000e-01
   7.81250000000000e-03  -1.95312500000000e-02
   2.89062500000000e-01   4.10156250000000e-02
  -3.90625000000000e-03   4.53125000000000e-01

Bbf =

 Columns 1 through 3:

  -2.85156250000000e-01  -2.12890625000000e-01  -1.05468750000000e-01
  -5.07812500000000e-02  -1.95312500000000e-02   1.75781250000000e-02
   2.34375000000000e-02   6.05468750000000e-02   1.01562500000000e-01
  -2.20703125000000e-01  -2.79296875000000e-01  -3.20312500000000e-01
  -2.98828125000000e-01  -3.33984375000000e-01  -3.61328125000000e-01
  -1.15234375000000e-01  -1.75781250000000e-01  -2.40234375000000e-01
   3.90625000000000e-02   1.17187500000000e-02  -1.75781250000000e-02
  -1.95312500000000e-01  -1.67968750000000e-01  -1.58203125000000e-01

 Column 4:

   3.12500000000000e-02
   6.05468750000000e-02
   1.44531250000000e-01
  -3.39843750000000e-01
  -3.76953125000000e-01
  -3.14453125000000e-01
  -4.49218750000000e-02
  -1.73828125000000e-01

Cbf =

 Columns 1 through 3:

   2.34375000000000e-02  -6.44531250000000e-02  -2.18750000000000e-01
   1.36718750000000e-02  -6.83593750000000e-02  -1.73828125000000e-01
  -1.95312500000000e-03  -7.81250000000000e-02  -1.26953125000000e-01
  -1.95312500000000e-02  -8.98437500000000e-02  -8.00781250000000e-02

 Columns 4 through 6:

   5.85937500000000e-03  -1.26953125000000e-01   4.49218750000000e-02
   9.76562500000000e-03  -1.05468750000000e-01   3.71093750000000e-02
   1.17187500000000e-02  -8.98437500000000e-02   3.32031250000000e-02
   1.36718750000000e-02  -8.00781250000000e-02   3.12500000000000e-02

 Columns 7 and 8:

  -6.44531250000000e-02  -3.51562500000000e-02
  -8.59375000000000e-02  -8.20312500000000e-02
  -9.76562500000000e-02  -1.15234375000000e-01
  -9.76562500000000e-02  -1.34765625000000e-01

Dbf =

 Columns 1 through 3:

   9.76562500000000e-03   0.00000000000000e+00   0.00000000000000e+00
   5.85937500000000e-03   9.76562500000000e-03   0.00000000000000e+00
   1.36718750000000e-02   5.85937500000000e-03   9.76562500000000e-03
   2.14843750000000e-02   1.36718750000000e-02   5.85937500000000e-03

 Column 4:

   0.00000000000000e+00
   0.00000000000000e+00
   0.00000000000000e+00
   9.76562500000000e-03

ngABCDbf =    3.6654e-01
est_nvABCDbf =    3.3746e-01
nvABCDbf =    3.3466e-01
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running octave-cli -q " $prog

octave-cli -q $prog > test.out
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

