#!/bin/sh

prog=sv2block_test.m

depends="sv2block_test.m test_common.m \
sv2block.m KW.m tf2Abcd.m optKW.m svf.m crossWelch.m \
p2n60.m qroots.m qzsolve.oct"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
ngABCDopt = 1.4592
ngABCDoptf = 1.3856
est_nvABCDoptf = 0.4459
nvABCDoptf = 0.4507
Ab =
 Columns 1 through 6:
   3.2917e-01  -1.0309e-01  -1.0449e-01   3.6691e-01  -2.5780e-01   4.4349e-01
   1.1504e-01   3.4698e-01  -3.9988e-02   3.2765e-01  -1.2842e-01  -1.9554e-01
   9.7909e-02   1.3974e-01   3.1519e-01   2.8712e-01  -2.4756e-01  -6.3030e-02
  -2.0633e-01  -2.1082e-01  -2.1047e-01   4.1980e-01   4.7911e-01   8.3685e-02
   3.2922e-01   2.3744e-01   3.1257e-01  -3.5602e-01   3.2882e-01   6.1197e-01
  -3.0593e-01   1.5036e-01   6.9735e-02   5.1700e-02  -6.0455e-01   3.3560e-01
   7.8859e-02   6.5628e-01  -4.9835e-01   5.4119e-02   1.3468e-01  -2.0192e-03
   5.0558e-01  -3.4797e-01  -3.2507e-02   2.0552e-01  -8.4308e-03   5.3828e-02
 Columns 7 and 8:
  -1.0348e-01  -3.3446e-01
  -5.3018e-01   5.0951e-01
   6.0327e-01   1.0226e-01
   5.8637e-02   1.0745e-01
  -5.7547e-02   1.7407e-01
   5.7366e-03   6.3066e-02
   3.2146e-01   6.0665e-02
   4.0931e-02   4.3455e-01

Bb =
  -2.7939e-01  -2.1585e-01  -1.2016e-01   4.2137e-03
   2.1881e-02   7.3105e-02   1.2285e-01   1.7217e-01
  -5.1963e-02   2.4519e-04   6.4638e-02   1.4229e-01
  -3.2468e-01  -3.6785e-01  -3.9321e-01  -3.9173e-01
  -1.2301e-02   1.0527e-02   2.5576e-02   3.5103e-02
  -2.1916e-01  -2.8381e-01  -3.5199e-01  -4.2224e-01
  -2.0497e-02  -3.6784e-02  -5.8319e-02  -8.4957e-02
  -1.9946e-01  -1.6710e-01  -1.4953e-01  -1.5648e-01

Cb =
 Columns 1 through 6:
   7.7566e-02  -6.2164e-02  -2.0816e-01  -1.0092e-01  -8.7292e-02  -1.3229e-03
   5.7234e-02  -6.7863e-02  -1.6619e-01  -8.3743e-02  -7.3518e-02  -3.0506e-03
   3.1238e-02  -7.7808e-02  -1.2352e-01  -7.3328e-02  -6.1989e-02  -2.6603e-03
   3.1657e-03  -8.8608e-02  -8.1677e-02  -6.9267e-02  -5.2810e-02  -2.3417e-03
 Columns 7 and 8:
  -6.8965e-02  -1.8091e-02
  -1.0421e-01  -5.7235e-02
  -1.2489e-01  -8.5376e-02
  -1.3122e-01  -1.0471e-01

Db =
   0.010374          0          0          0
   0.005723   0.010374          0          0
   0.014231   0.005723   0.010374          0
   0.020802   0.014231   0.005723   0.010374

Abf =
 Columns 1 through 6:
   3.3008e-01  -1.0352e-01  -1.0352e-01   3.6719e-01  -2.5781e-01   4.4336e-01
   1.1523e-01   3.4766e-01  -3.9062e-02   3.2812e-01  -1.2891e-01  -1.9531e-01
   9.7656e-02   1.4062e-01   3.1445e-01   2.8711e-01  -2.4805e-01  -6.2500e-02
  -2.0703e-01  -2.1094e-01  -2.1094e-01   4.1992e-01   4.7852e-01   8.3984e-02
   3.3008e-01   2.3828e-01   3.1250e-01  -3.5547e-01   3.2812e-01   6.1133e-01
  -3.0664e-01   1.5039e-01   7.0312e-02   5.0781e-02  -6.0547e-01   3.3594e-01
   7.8125e-02   6.5625e-01  -4.9805e-01   5.4688e-02   1.3477e-01  -1.9531e-03
   5.0586e-01  -3.4766e-01  -3.3203e-02   2.0508e-01  -7.8125e-03   5.4688e-02
 Columns 7 and 8:
  -1.0352e-01  -3.3398e-01
  -5.2930e-01   5.0977e-01
   6.0352e-01   1.0156e-01
   5.8594e-02   1.0742e-01
  -5.6641e-02   1.7383e-01
   5.8594e-03   6.2500e-02
   3.2227e-01   6.0547e-02
   4.1016e-02   4.3359e-01

Bbf =
  -0.2793  -0.2168  -0.1211   0.0039
   0.0215   0.0723   0.1230   0.1719
  -0.0527        0   0.0645   0.1426
  -0.3242  -0.3672  -0.3926  -0.3926
  -0.0117   0.0098   0.0254   0.0352
  -0.2188  -0.2832  -0.3516  -0.4219
  -0.0195  -0.0371  -0.0586  -0.0840
  -0.1992  -0.1680  -0.1504  -0.1562

Cbf =
 Columns 1 through 6:
   7.8125e-02  -6.2500e-02  -2.0898e-01  -1.0156e-01  -8.7891e-02  -1.9531e-03
   5.6641e-02  -6.8359e-02  -1.6602e-01  -8.3984e-02  -7.4219e-02  -3.9062e-03
   3.1250e-02  -7.8125e-02  -1.2305e-01  -7.4219e-02  -6.2500e-02  -1.9531e-03
   3.9062e-03  -8.7891e-02  -8.2031e-02  -6.8359e-02  -5.2734e-02  -1.9531e-03
 Columns 7 and 8:
  -6.8359e-02  -1.7578e-02
  -1.0352e-01  -5.6641e-02
  -1.2500e-01  -8.5938e-02
  -1.3086e-01  -1.0547e-01

Dbf =
   0.009766          0          0          0
   0.005859   0.009766          0          0
   0.013672   0.005859   0.009766          0
   0.021484   0.013672   0.005859   0.009766

ngABCDbf = 0.3648
est_nvABCDbf = 0.3372
nvABCDbf = 0.3417
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave-cli -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

