#!/bin/sh

prog=sv2block_test.m

depends="sv2block_test.m test_common.m \
sv2block.m KW.m tf2Abcd.m optKW.m svf.m crossWelch.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
echo $here
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
ngABCDopt =    1.4657e+00
ngABCDoptf =    1.6750e+00
est_nvABCDoptf =    4.7214e-01
nvABCDoptf =    4.6278e-01
Ab =

 Columns 1 through 6:

   3.6494e-01  -2.2072e-01  -5.7976e-02   5.4253e-01   8.9163e-03   2.0993e-01
   1.0529e-01   3.6342e-01  -4.2446e-02   3.1077e-01  -1.1598e-02  -5.7878e-01
   1.6368e-01  -2.2679e-03   3.2285e-01   3.4929e-01   2.8789e-02   1.2102e-01
  -4.7743e-01  -3.9179e-01  -3.1691e-01   3.1013e-01   3.5156e-01  -3.2907e-01
   1.6710e-01  -1.9831e-02   1.0824e-01  -3.2094e-01   3.7265e-01   1.4754e-01
  -7.0686e-02   4.0076e-01  -4.2446e-02   4.4850e-01  -1.2243e-01   3.6685e-01
   5.3371e-01   1.0220e-01  -5.2188e-01  -7.6996e-02   3.8350e-01   8.5025e-04
   1.8328e-01  -5.9081e-01   1.1798e-01  -2.9529e-02  -2.8670e-01   9.4265e-02

 Columns 7 and 8:

  -4.7804e-01   6.6997e-02
  -7.4285e-02   4.2244e-01
   6.1965e-01   1.0064e-02
   1.0528e-01   1.1155e-01
  -2.3402e-01   5.1560e-01
   1.0600e-02   6.1852e-02
   3.1532e-01   3.0487e-02
   7.3280e-02   4.1542e-01

Bb =

  -2.0013e-01  -1.2074e-01  -2.1739e-02   9.4287e-02
   2.7517e-01   2.9391e-01   2.9415e-01   2.7242e-01
  -1.3958e-01  -8.6355e-02  -1.4121e-02   7.8764e-02
  -2.2256e-01  -2.6921e-01  -2.9763e-01  -3.0295e-01
  -6.9221e-03  -2.0485e-02  -4.3636e-02  -6.7814e-02
  -2.5682e-01  -3.1673e-01  -3.8373e-01  -4.5797e-01
  -9.1293e-03  -2.9161e-02  -5.3999e-02  -8.2760e-02
  -1.5293e-01  -1.1651e-01  -9.5187e-02  -9.7881e-02

Cb =

 Columns 1 through 6:

   1.9486e-02  -3.4527e-02  -2.0020e-01  -1.0826e-02  -1.6791e-01  -1.1382e-02
  -5.2325e-03  -3.4034e-02  -1.5891e-01  -8.2695e-03  -1.4075e-01  -1.9856e-02
  -3.5622e-02  -2.7599e-02  -1.1865e-01  -8.9580e-03  -1.1852e-01  -2.3895e-02
  -6.6938e-02  -1.5981e-02  -8.0550e-02  -1.2513e-02  -1.0097e-01  -2.6274e-02

 Columns 7 and 8:

  -7.0263e-02  -3.4385e-02
  -1.0248e-01  -7.0374e-02
  -1.2079e-01  -9.5350e-02
  -1.2538e-01  -1.1136e-01

Db =

   1.0374e-02   0.0000e+00   0.0000e+00   0.0000e+00
   5.7230e-03   1.0374e-02   0.0000e+00   0.0000e+00
   1.4231e-02   5.7230e-03   1.0374e-02   0.0000e+00
   2.0802e-02   1.4231e-02   5.7230e-03   1.0374e-02

Abf =

 Columns 1 through 3:

   3.652343750000000e-01  -2.207031250000000e-01  -5.859375000000000e-02
   1.054687500000000e-01   3.632812500000000e-01  -4.296875000000000e-02
   1.640625000000000e-01  -1.953125000000000e-03   3.222656250000000e-01
  -4.765625000000000e-01  -3.925781250000000e-01  -3.164062500000000e-01
   1.679687500000000e-01  -1.953125000000000e-02   1.074218750000000e-01
  -7.031250000000000e-02   4.003906250000000e-01  -4.296875000000000e-02
   5.332031250000000e-01   1.015625000000000e-01  -5.214843750000000e-01
   1.835937500000000e-01  -5.898437500000000e-01   1.171875000000000e-01

 Columns 4 through 6:

   5.429687500000000e-01   9.765625000000000e-03   2.089843750000000e-01
   3.105468750000000e-01  -1.171875000000000e-02  -5.781250000000000e-01
   3.496093750000000e-01   2.929687500000000e-02   1.210937500000000e-01
   3.105468750000000e-01   3.515625000000000e-01  -3.281250000000000e-01
  -3.203125000000000e-01   3.730468750000000e-01   1.484375000000000e-01
   4.492187500000000e-01  -1.230468750000000e-01   3.671875000000000e-01
  -7.617187500000000e-02   3.828125000000000e-01   0.000000000000000e+00
  -2.929687500000000e-02  -2.871093750000000e-01   9.375000000000000e-02

 Columns 7 and 8:

  -4.785156250000000e-01   6.640625000000000e-02
  -7.421875000000000e-02   4.218750000000000e-01
   6.191406250000000e-01   9.765625000000000e-03
   1.054687500000000e-01   1.113281250000000e-01
  -2.343750000000000e-01   5.156250000000000e-01
   9.765625000000000e-03   6.250000000000000e-02
   3.144531250000000e-01   3.125000000000000e-02
   7.421875000000000e-02   4.160156250000000e-01

Bbf =

 Columns 1 through 3:

  -1.992187500000000e-01  -1.210937500000000e-01  -2.148437500000000e-02
   2.753906250000000e-01   2.929687500000000e-01   2.949218750000000e-01
  -1.386718750000000e-01  -8.593750000000000e-02  -1.367187500000000e-02
  -2.226562500000000e-01  -2.695312500000000e-01  -2.968750000000000e-01
  -7.812500000000000e-03  -1.953125000000000e-02  -4.296875000000000e-02
  -2.558593750000000e-01  -3.164062500000000e-01  -3.828125000000000e-01
  -9.765625000000000e-03  -2.929687500000000e-02  -5.468750000000000e-02
  -1.523437500000000e-01  -1.171875000000000e-01  -9.570312500000000e-02

 Column 4:

   9.375000000000000e-02
   2.714843750000000e-01
   7.812500000000000e-02
  -3.027343750000000e-01
  -6.835937500000000e-02
  -4.570312500000000e-01
  -8.203125000000000e-02
  -9.765625000000000e-02

Cbf =

 Columns 1 through 3:

   1.953125000000000e-02  -3.515625000000000e-02  -2.011718750000000e-01
  -5.859375000000000e-03  -3.320312500000000e-02  -1.582031250000000e-01
  -3.515625000000000e-02  -2.734375000000000e-02  -1.191406250000000e-01
  -6.640625000000000e-02  -1.562500000000000e-02  -8.007812500000000e-02

 Columns 4 through 6:

  -1.171875000000000e-02  -1.679687500000000e-01  -1.171875000000000e-02
  -7.812500000000000e-03  -1.406250000000000e-01  -1.953125000000000e-02
  -9.765625000000000e-03  -1.191406250000000e-01  -2.343750000000000e-02
  -1.171875000000000e-02  -1.015625000000000e-01  -2.539062500000000e-02

 Columns 7 and 8:

  -7.031250000000000e-02  -3.515625000000000e-02
  -1.015625000000000e-01  -7.031250000000000e-02
  -1.210937500000000e-01  -9.570312500000000e-02
  -1.250000000000000e-01  -1.113281250000000e-01

Dbf =

 Columns 1 through 3:

   9.765625000000000e-03   0.000000000000000e+00   0.000000000000000e+00
   5.859375000000000e-03   9.765625000000000e-03   0.000000000000000e+00
   1.367187500000000e-02   5.859375000000000e-03   9.765625000000000e-03
   2.148437500000000e-02   1.367187500000000e-02   5.859375000000000e-03

 Column 4:

   0.000000000000000e+00
   0.000000000000000e+00
   0.000000000000000e+00
   9.765625000000000e-03

ngABCDbf =    3.6643e-01
est_nvABCDbf =    3.3745e-01
nvABCDbf =    3.3890e-01
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running octave-cli -q " $prog

octave-cli -q $prog > test.out
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

