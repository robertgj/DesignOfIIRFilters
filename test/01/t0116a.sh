#!/bin/sh

prog=sv2block_test.m

depends="sv2block_test.m test_common.m \
sv2block.m KW.m tf2Abcd.m optKW.m svf.m crossWelch.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
echo $here
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
ngABCDopt =  1.4657
ngABCDoptf =  1.6750
est_nvABCDoptf =  0.47214
nvABCDoptf =  0.46278
Ab =
 Columns 1 through 6:
   0.36493609  -0.22071658  -0.05797590   0.54252775   0.00891626   0.20993466
   0.10528824   0.36342449  -0.04244624   0.31077068  -0.01159803  -0.57878418
   0.16368308  -0.00226794   0.32284599   0.34929331   0.02878876   0.12102414
  -0.47743019  -0.39179338  -0.31691239   0.31012738   0.35156418  -0.32907387
   0.16709744  -0.01983121   0.10824223  -0.32093573   0.37265370   0.14754312
  -0.07068615   0.40076456  -0.04244580   0.44850278  -0.12242742   0.36684716
   0.53371418   0.10220048  -0.52188094  -0.07699633   0.38350041   0.00085025
   0.18328009  -0.59080779   0.11798306  -0.02952929  -0.28669803   0.09426465
 Columns 7 and 8:
  -0.47804047   0.06699710
  -0.07428505   0.42244105
   0.61964590   0.01006379
   0.10527637   0.11154651
  -0.23402117   0.51560300
   0.01060014   0.06185217
   0.31531975   0.03048727
   0.07327969   0.41541565

Bb =
  -0.2001324  -0.1207429  -0.0217394   0.0942867
   0.2751725   0.2939141   0.2941451   0.2724200
  -0.1395809  -0.0863554  -0.0141210   0.0787642
  -0.2225562  -0.2692117  -0.2976301  -0.3029495
  -0.0069221  -0.0204847  -0.0436361  -0.0678144
  -0.2568210  -0.3167278  -0.3837296  -0.4579672
  -0.0091293  -0.0291610  -0.0539994  -0.0827601
  -0.1529266  -0.1165109  -0.0951873  -0.0978812

Cb =
 Columns 1 through 6:
   0.0194860  -0.0345270  -0.2001965  -0.0108255  -0.1679141  -0.0113822
  -0.0052325  -0.0340337  -0.1589106  -0.0082695  -0.1407465  -0.0198559
  -0.0356220  -0.0275995  -0.1186486  -0.0089580  -0.1185200  -0.0238949
  -0.0669382  -0.0159813  -0.0805505  -0.0125134  -0.1009659  -0.0262740
 Columns 7 and 8:
  -0.0702628  -0.0343855
  -0.1024794  -0.0703737
  -0.1207932  -0.0953503
  -0.1253818  -0.1113592

Db =
   0.010374   0.000000   0.000000   0.000000
   0.005723   0.010374   0.000000   0.000000
   0.014231   0.005723   0.010374   0.000000
   0.020802   0.014231   0.005723   0.010374

Abf =
   0.36523  -0.22070  -0.05859   0.54297   0.00977   0.20898  -0.47852   0.06641
   0.10547   0.36328  -0.04297   0.31055  -0.01172  -0.57812  -0.07422   0.42188
   0.16406  -0.00195   0.32227   0.34961   0.02930   0.12109   0.61914   0.00977
  -0.47656  -0.39258  -0.31641   0.31055   0.35156  -0.32812   0.10547   0.11133
   0.16797  -0.01953   0.10742  -0.32031   0.37305   0.14844  -0.23438   0.51562
  -0.07031   0.40039  -0.04297   0.44922  -0.12305   0.36719   0.00977   0.06250
   0.53320   0.10156  -0.52148  -0.07617   0.38281   0.00000   0.31445   0.03125
   0.18359  -0.58984   0.11719  -0.02930  -0.28711   0.09375   0.07422   0.41602

Bbf =
  -0.1992188  -0.1210938  -0.0214844   0.0937500
   0.2753906   0.2929688   0.2949219   0.2714844
  -0.1386719  -0.0859375  -0.0136719   0.0781250
  -0.2226562  -0.2695312  -0.2968750  -0.3027344
  -0.0078125  -0.0195312  -0.0429688  -0.0683594
  -0.2558594  -0.3164062  -0.3828125  -0.4570312
  -0.0097656  -0.0292969  -0.0546875  -0.0820312
  -0.1523438  -0.1171875  -0.0957031  -0.0976562

Cbf =
 Columns 1 through 6:
   0.0195312  -0.0351562  -0.2011719  -0.0117188  -0.1679688  -0.0117188
  -0.0058594  -0.0332031  -0.1582031  -0.0078125  -0.1406250  -0.0195312
  -0.0351562  -0.0273438  -0.1191406  -0.0097656  -0.1191406  -0.0234375
  -0.0664062  -0.0156250  -0.0800781  -0.0117188  -0.1015625  -0.0253906
 Columns 7 and 8:
  -0.0703125  -0.0351562
  -0.1015625  -0.0703125
  -0.1210938  -0.0957031
  -0.1250000  -0.1113281

Dbf =
   0.009766   0.000000   0.000000   0.000000
   0.005859   0.009766   0.000000   0.000000
   0.013672   0.005859   0.009766   0.000000
   0.021484   0.013672   0.005859   0.009766

ngABCDbf =  0.36643
est_nvABCDbf =  0.33745
nvABCDbf =  0.33890
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running octave-cli -q " $prog

octave-cli -q $prog > test.out
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

