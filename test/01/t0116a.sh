#!/bin/sh

prog=sv2block_test.m

depends="sv2block_test.m test_common.m \
sv2block.m KW.m tf2Abcd.m optKW.m svf.m crossWelch.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
echo $here
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
ngABCDopt =    1.4606e+00
ngABCDoptf =    1.5380e+00
est_nvABCDoptf =    4.5989e-01
nvABCDoptf =    4.5770e-01
Ab =

 Columns 1 through 6:

   3.2753e-01  -1.1264e-01  -1.0185e-01   3.5912e-01  -2.2186e-01   4.4286e-01
   1.2599e-01   3.5342e-01  -3.5784e-02   3.4072e-01  -1.0517e-01  -1.8204e-01
   9.7864e-02   1.2936e-01   3.1231e-01   3.1553e-01  -2.5274e-01  -2.9687e-02
  -2.0939e-01  -2.3509e-01  -2.3527e-01   4.1350e-01   4.8814e-01   4.5902e-02
   2.9394e-01   2.2910e-01   3.2223e-01  -3.5078e-01   3.3101e-01   6.1399e-01
  -2.9975e-01   1.5290e-01   4.3574e-02   9.0989e-02  -5.9669e-01   3.4291e-01
   7.4378e-02   6.7124e-01  -5.0502e-01   2.7560e-02   1.3211e-01   7.4270e-03
   5.1903e-01  -3.1444e-01  -3.0014e-02   2.0311e-01   2.3026e-02   5.6153e-02

 Columns 7 and 8:

  -1.2033e-01  -3.5512e-01
  -5.4399e-01   4.7239e-01
   6.0178e-01   1.1089e-01
   6.2495e-02   1.0297e-01
  -7.1211e-02   1.6696e-01
  -6.0990e-03   5.9199e-02
   3.1188e-01   6.0043e-02
   3.3339e-02   4.3899e-01

Bb =

  -2.7450e-01  -2.1268e-01  -1.1927e-01   2.2046e-03
   2.3058e-02   7.5547e-02   1.2684e-01   1.7806e-01
  -6.5118e-02  -9.9904e-03   5.8734e-02   1.4175e-01
  -3.2483e-01  -3.6796e-01  -3.9255e-01  -3.8976e-01
  -3.0894e-02  -1.1042e-02   2.2897e-03   1.2014e-02
  -2.2710e-01  -2.9212e-01  -3.6087e-01  -4.3197e-01
  -8.9029e-03  -2.6611e-02  -4.8373e-02  -7.3384e-02
  -1.9411e-01  -1.6204e-01  -1.4552e-01  -1.5437e-01

Cb =

 Columns 1 through 6:

   8.8464e-02  -6.7101e-02  -2.0084e-01  -9.7503e-02  -9.2652e-02  -1.3966e-03
   6.5868e-02  -7.1791e-02  -1.6010e-01  -8.1097e-02  -7.7529e-02  -3.8906e-03
   3.7611e-02  -8.0650e-02  -1.1881e-01  -7.1219e-02  -6.5191e-02  -4.2143e-03
   7.3375e-03  -9.0350e-02  -7.8412e-02  -6.7454e-02  -5.5714e-02  -4.5408e-03

 Columns 7 and 8:

  -6.9447e-02  -2.1749e-02
  -1.0162e-01  -6.3165e-02
  -1.2001e-01  -9.2761e-02
  -1.2472e-01  -1.1265e-01

Db =

   1.0375e-02   0.0000e+00   0.0000e+00   0.0000e+00
   5.7233e-03   1.0375e-02   0.0000e+00   0.0000e+00
   1.4232e-02   5.7233e-03   1.0375e-02   0.0000e+00
   2.0803e-02   1.4232e-02   5.7233e-03   1.0375e-02

Abf =

 Columns 1 through 3:

   3.28125000000000e-01  -1.13281250000000e-01  -1.01562500000000e-01
   1.26953125000000e-01   3.53515625000000e-01  -3.51562500000000e-02
   9.76562500000000e-02   1.28906250000000e-01   3.12500000000000e-01
  -2.08984375000000e-01  -2.34375000000000e-01  -2.34375000000000e-01
   2.92968750000000e-01   2.28515625000000e-01   3.22265625000000e-01
  -2.98828125000000e-01   1.52343750000000e-01   4.29687500000000e-02
   7.42187500000000e-02   6.71875000000000e-01  -5.05859375000000e-01
   5.19531250000000e-01  -3.14453125000000e-01  -2.92968750000000e-02

 Columns 4 through 6:

   3.59375000000000e-01  -2.22656250000000e-01   4.43359375000000e-01
   3.39843750000000e-01  -1.05468750000000e-01  -1.81640625000000e-01
   3.16406250000000e-01  -2.51953125000000e-01  -2.92968750000000e-02
   4.14062500000000e-01   4.88281250000000e-01   4.68750000000000e-02
  -3.51562500000000e-01   3.30078125000000e-01   6.13281250000000e-01
   9.17968750000000e-02  -5.97656250000000e-01   3.43750000000000e-01
   2.73437500000000e-02   1.32812500000000e-01   7.81250000000000e-03
   2.03125000000000e-01   2.34375000000000e-02   5.66406250000000e-02

 Columns 7 and 8:

  -1.21093750000000e-01  -3.55468750000000e-01
  -5.44921875000000e-01   4.72656250000000e-01
   6.01562500000000e-01   1.11328125000000e-01
   6.25000000000000e-02   1.03515625000000e-01
  -7.03125000000000e-02   1.66015625000000e-01
  -5.85937500000000e-03   5.85937500000000e-02
   3.12500000000000e-01   6.05468750000000e-02
   3.32031250000000e-02   4.39453125000000e-01

Bbf =

 Columns 1 through 3:

  -2.75390625000000e-01  -2.12890625000000e-01  -1.19140625000000e-01
   2.34375000000000e-02   7.61718750000000e-02   1.26953125000000e-01
  -6.44531250000000e-02  -9.76562500000000e-03   5.85937500000000e-02
  -3.24218750000000e-01  -3.67187500000000e-01  -3.92578125000000e-01
  -3.12500000000000e-02  -1.17187500000000e-02   1.95312500000000e-03
  -2.26562500000000e-01  -2.92968750000000e-01  -3.61328125000000e-01
  -9.76562500000000e-03  -2.73437500000000e-02  -4.88281250000000e-02
  -1.93359375000000e-01  -1.62109375000000e-01  -1.46484375000000e-01

 Column 4:

   1.95312500000000e-03
   1.77734375000000e-01
   1.42578125000000e-01
  -3.90625000000000e-01
   1.17187500000000e-02
  -4.31640625000000e-01
  -7.42187500000000e-02
  -1.54296875000000e-01

Cbf =

 Columns 1 through 3:

   8.78906250000000e-02  -6.64062500000000e-02  -2.01171875000000e-01
   6.64062500000000e-02  -7.22656250000000e-02  -1.60156250000000e-01
   3.71093750000000e-02  -8.00781250000000e-02  -1.19140625000000e-01
   7.81250000000000e-03  -8.98437500000000e-02  -7.81250000000000e-02

 Columns 4 through 6:

  -9.76562500000000e-02  -9.17968750000000e-02  -1.95312500000000e-03
  -8.20312500000000e-02  -7.81250000000000e-02  -3.90625000000000e-03
  -7.03125000000000e-02  -6.44531250000000e-02  -3.90625000000000e-03
  -6.83593750000000e-02  -5.66406250000000e-02  -3.90625000000000e-03

 Columns 7 and 8:

  -7.03125000000000e-02  -2.14843750000000e-02
  -1.01562500000000e-01  -6.25000000000000e-02
  -1.19140625000000e-01  -9.17968750000000e-02
  -1.25000000000000e-01  -1.13281250000000e-01

Dbf =

 Columns 1 through 3:

   9.76562500000000e-03   0.00000000000000e+00   0.00000000000000e+00
   5.85937500000000e-03   9.76562500000000e-03   0.00000000000000e+00
   1.36718750000000e-02   5.85937500000000e-03   9.76562500000000e-03
   2.14843750000000e-02   1.36718750000000e-02   5.85937500000000e-03

 Column 4:

   0.00000000000000e+00
   0.00000000000000e+00
   0.00000000000000e+00
   9.76562500000000e-03

ngABCDbf =    3.6515e-01
est_nvABCDbf =    3.3729e-01
nvABCDbf =    3.3641e-01
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running octave-cli -q " $prog

octave-cli -q $prog > test.out
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

