#!/bin/sh

prog=tf2Abcd_test.m
depends="test/tf2Abcd_test.m test_common.m tf2Abcd.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
Caught nargin==0!
Caught nargin==1!
Caught nargin==3!
Caught nargout==0!
Caught nargout==3!
Caught nargout==5!
Caught nargout==6!
Caught nargout==7!
Caught nargout==9!
Caught N is empty!
Caught D is empty!
A = [](0x0)
b = [](0x0)
c = [](0x0)
d = 1.5000
A = [](0x0)
b = [](0x0)
c = [](0x0)
d = 1.5000
dAdx =
{
  [1,1] = [](0x0)
}

dbdx =
{
  [1,1] = [](0x0)
}

dcdx =
{
  [1,1] = [](0x0)
}

dddx =
{
  [1,1] = 1
}

k=1
N=   5.9796e-05   2.9898e-04   5.9796e-04   5.9796e-04   2.9898e-04   5.9796e-05
D=   1.0000  -3.9845   6.4349  -5.2536   2.1651  -0.3599
A =
        0   1.0000        0        0        0
        0        0   1.0000        0        0
        0        0        0   1.0000        0
        0        0        0        0   1.0000
   0.3599  -2.1651   5.2536  -6.4349   3.9845

b =
   0
   0
   0
   0
   1

c =
   8.1318e-05   1.6951e-04   9.1210e-04   2.1318e-04   5.3724e-04

d = 5.9796e-05
dAdx =
{
  [1,1] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,2] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,3] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,4] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,5] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,6] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,7] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0  -1
  [1,8] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0  -1   0
  [1,9] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0  -1   0   0
  [1,10] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0  -1   0   0   0
  [1,11] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
    -1   0   0   0   0
}

dbdx =
{
  [1,1] =
     0
     0
     0
     0
     0
  [1,2] =
     0
     0
     0
     0
     0
  [1,3] =
     0
     0
     0
     0
     0
  [1,4] =
     0
     0
     0
     0
     0
  [1,5] =
     0
     0
     0
     0
     0
  [1,6] =
     0
     0
     0
     0
     0
  [1,7] =
     0
     0
     0
     0
     0
  [1,8] =
     0
     0
     0
     0
     0
  [1,9] =
     0
     0
     0
     0
     0
  [1,10] =
     0
     0
     0
     0
     0
  [1,11] =
     0
     0
     0
     0
     0
}

dcdx =
{
  [1,1] =
     0.3599  -2.1651   5.2536  -6.4349   3.9845
  [1,2] =
     0   0   0   0   1
  [1,3] =
     0   0   0   1   0
  [1,4] =
     0   0   1   0   0
  [1,5] =
     0   1   0   0   0
  [1,6] =
     1   0   0   0   0
  [1,7] =
              0            0            0            0  -5.9796e-05
  [1,8] =
              0            0            0  -5.9796e-05            0
  [1,9] =
              0            0  -5.9796e-05            0            0
  [1,10] =
              0  -5.9796e-05            0            0            0
  [1,11] =
    -5.9796e-05            0            0            0            0
}

dddx =
{
  [1,1] = 1
  [1,2] = 0
  [1,3] = 0
  [1,4] = 0
  [1,5] = 0
  [1,6] = 0
  [1,7] = 0
  [1,8] = 0
  [1,9] = 0
  [1,10] = 0
  [1,11] = 0
}

k=2
N=1
D=   1.0000  -3.9845   6.4349  -5.2536   2.1651  -0.3599
A =
        0   1.0000        0        0        0
        0        0   1.0000        0        0
        0        0        0   1.0000        0
        0        0        0        0   1.0000
   0.3599  -2.1651   5.2536  -6.4349   3.9845

b =
   0
   0
   0
   0
   1

c =
   0.3599  -2.1651   5.2536  -6.4349   3.9845

d = 1
dAdx =
{
  [1,1] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,2] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0  -1
  [1,3] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0  -1   0
  [1,4] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0  -1   0   0
  [1,5] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0  -1   0   0   0
  [1,6] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
    -1   0   0   0   0
}

dbdx =
{
  [1,1] =
     0
     0
     0
     0
     0
  [1,2] =
     0
     0
     0
     0
     0
  [1,3] =
     0
     0
     0
     0
     0
  [1,4] =
     0
     0
     0
     0
     0
  [1,5] =
     0
     0
     0
     0
     0
  [1,6] =
     0
     0
     0
     0
     0
}

dcdx =
{
  [1,1] =
     0.3599  -2.1651   5.2536  -6.4349   3.9845
  [1,2] =
     0   0   0   0  -1
  [1,3] =
     0   0   0  -1   0
  [1,4] =
     0   0  -1   0   0
  [1,5] =
     0  -1   0   0   0
  [1,6] =
    -1   0   0   0   0
}

dddx =
{
  [1,1] = 1
  [1,2] = 0
  [1,3] = 0
  [1,4] = 0
  [1,5] = 0
  [1,6] = 0
}

k=3
N=   5.9796e-05   2.9898e-04   5.9796e-04   5.9796e-04   2.9898e-04   5.9796e-05
D=1
A =
   0   1   0   0   0
   0   0   1   0   0
   0   0   0   1   0
   0   0   0   0   1
   0   0   0   0   0

b =
   0
   0
   0
   0
   1

c =
   5.9796e-05   2.9898e-04   5.9796e-04   5.9796e-04   2.9898e-04

d = 5.9796e-05
dAdx =
{
  [1,1] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,2] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,3] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,4] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,5] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,6] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
}

dbdx =
{
  [1,1] =
     0
     0
     0
     0
     0
  [1,2] =
     0
     0
     0
     0
     0
  [1,3] =
     0
     0
     0
     0
     0
  [1,4] =
     0
     0
     0
     0
     0
  [1,5] =
     0
     0
     0
     0
     0
  [1,6] =
     0
     0
     0
     0
     0
}

dcdx =
{
  [1,1] =
     0   0   0   0   0
  [1,2] =
     0   0   0   0   1
  [1,3] =
     0   0   0   1   0
  [1,4] =
     0   0   1   0   0
  [1,5] =
     0   1   0   0   0
  [1,6] =
     1   0   0   0   0
}

dddx =
{
  [1,1] = 1
  [1,2] = 0
  [1,3] = 0
  [1,4] = 0
  [1,5] = 0
  [1,6] = 0
}

k=4
N=   5.9796e-05   2.9898e-04   5.9796e-04
D=   1.0000  -3.9845   6.4349  -5.2536   2.1651  -0.3599
A =
        0   1.0000        0        0        0
        0        0   1.0000        0        0
        0        0        0   1.0000        0
        0        0        0        0   1.0000
   0.3599  -2.1651   5.2536  -6.4349   3.9845

b =
   0
   0
   0
   0
   1

c =
   2.1522e-05  -1.2947e-04   3.1414e-04   2.1318e-04   5.3724e-04

d = 5.9796e-05
dAdx =
{
  [1,1] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,2] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,3] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,4] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0  -1
  [1,5] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0  -1   0
  [1,6] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0  -1   0   0
  [1,7] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0  -1   0   0   0
  [1,8] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
    -1   0   0   0   0
}

dbdx =
{
  [1,1] =
     0
     0
     0
     0
     0
  [1,2] =
     0
     0
     0
     0
     0
  [1,3] =
     0
     0
     0
     0
     0
  [1,4] =
     0
     0
     0
     0
     0
  [1,5] =
     0
     0
     0
     0
     0
  [1,6] =
     0
     0
     0
     0
     0
  [1,7] =
     0
     0
     0
     0
     0
  [1,8] =
     0
     0
     0
     0
     0
}

dcdx =
{
  [1,1] =
     0.3599  -2.1651   5.2536  -6.4349   3.9845
  [1,2] =
     0   0   0   0   1
  [1,3] =
     0   0   0   1   0
  [1,4] =
              0            0            0            0  -5.9796e-05
  [1,5] =
              0            0            0  -5.9796e-05            0
  [1,6] =
              0            0  -5.9796e-05            0            0
  [1,7] =
              0  -5.9796e-05            0            0            0
  [1,8] =
    -5.9796e-05            0            0            0            0
}

dddx =
{
  [1,1] = 1
  [1,2] = 0
  [1,3] = 0
  [1,4] = 0
  [1,5] = 0
  [1,6] = 0
  [1,7] = 0
  [1,8] = 0
}

k=5
N=   5.9796e-05   2.9898e-04   5.9796e-04   5.9796e-04   2.9898e-04   5.9796e-05
D=   1.0000  -3.9845   6.4349
A =
        0   1.0000        0        0        0
        0        0   1.0000        0        0
        0        0        0   1.0000        0
        0        0        0        0   1.0000
        0        0        0  -6.4349   3.9845

b =
   0
   0
   0
   0
   1

c =
   5.9796e-05   2.9898e-04   5.9796e-04   2.1318e-04   5.3724e-04

d = 5.9796e-05
dAdx =
{
  [1,1] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,2] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,3] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,4] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,5] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,6] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
  [1,7] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0  -1
  [1,8] =
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0   0   0
     0   0   0  -1   0
}

dbdx =
{
  [1,1] =
     0
     0
     0
     0
     0
  [1,2] =
     0
     0
     0
     0
     0
  [1,3] =
     0
     0
     0
     0
     0
  [1,4] =
     0
     0
     0
     0
     0
  [1,5] =
     0
     0
     0
     0
     0
  [1,6] =
     0
     0
     0
     0
     0
  [1,7] =
     0
     0
     0
     0
     0
  [1,8] =
     0
     0
     0
     0
     0
}

dcdx =
{
  [1,1] =
          0        0        0  -6.4349   3.9845
  [1,2] =
     0   0   0   0   1
  [1,3] =
     0   0   0   1   0
  [1,4] =
     0   0   1   0   0
  [1,5] =
     0   1   0   0   0
  [1,6] =
     1   0   0   0   0
  [1,7] =
              0            0            0            0  -5.9796e-05
  [1,8] =
              0            0            0  -5.9796e-05            0
}

dddx =
{
  [1,1] = 1
  [1,2] = 0
  [1,3] = 0
  [1,4] = 0
  [1,5] = 0
  [1,6] = 0
  [1,7] = 0
  [1,8] = 0
}

EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave --no-gui -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi

#
# this much worked
#
pass

