#!/bin/sh

prog=schurdecomp_test.m
descr="schurdecomp_test.m (mfile)"
depends="schurdecomp_test.m test_common.m schurdecomp.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED $descr 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED $descr
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
echo $here
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
Caught schurdecomp([])!
d is empty
Caught schurdecomp(0)!
First element of d is 0
k = [](0x0)
S =    1.0000e+00
schurdecomp(d0):
k =   -1.5838e-01
S =

   9.8738e-01   0.0000e+00
  -1.5838e-01   1.0000e+00

schurdecomp(-d0):
km =   -1.5838e-01
Sm =

  -9.8738e-01   0.0000e+00
   1.5838e-01  -1.0000e+00

ans =    0.0000e+00
ans =    0.0000e+00
schurdecomp(d0):
k =

 Columns 1 through 6:

  -8.1674e-01   9.9818e-01  -8.8440e-01   9.6513e-01  -9.2990e-01   8.8687e-01

 Column 7:

  -5.6357e-01

S =

 Columns 1 through 6:

   5.9755e-04   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -8.4580e-04   1.0356e-03   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   1.7120e-02  -2.7991e-02   1.7152e-02   0.0000e+00   0.0000e+00   0.0000e+00
  -3.2500e-02   8.9721e-02  -9.2414e-02   3.6748e-02   0.0000e+00   0.0000e+00
   1.3548e-01  -4.6485e-01   6.7350e-01  -4.7283e-01   1.4038e-01   0.0000e+00
  -3.5491e-01   1.5638e+00  -2.9666e+00   3.0064e+00  -1.6281e+00   3.8166e-01
   7.3261e-01  -3.8934e+00   9.1556e+00  -1.2116e+01   9.5089e+00  -4.2051e+00
  -5.6357e-01   3.7557e+00  -1.1200e+01   1.9349e+01  -2.0913e+01   1.4167e+01

 Columns 7 and 8:

   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   8.2607e-01   0.0000e+00
  -5.5903e+00   1.0000e+00

schurdecomp(-d0):
km =

 Columns 1 through 6:

  -8.1674e-01   9.9818e-01  -8.8440e-01   9.6513e-01  -9.2990e-01   8.8687e-01

 Column 7:

  -5.6357e-01

Sm =

 Columns 1 through 6:

  -5.9755e-04   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   8.4580e-04  -1.0356e-03   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -1.7120e-02   2.7991e-02  -1.7152e-02   0.0000e+00   0.0000e+00   0.0000e+00
   3.2500e-02  -8.9721e-02   9.2414e-02  -3.6748e-02   0.0000e+00   0.0000e+00
  -1.3548e-01   4.6485e-01  -6.7350e-01   4.7283e-01  -1.4038e-01   0.0000e+00
   3.5491e-01  -1.5638e+00   2.9666e+00  -3.0064e+00   1.6281e+00  -3.8166e-01
  -7.3261e-01   3.8934e+00  -9.1556e+00   1.2116e+01  -9.5089e+00   4.2051e+00
   5.6357e-01  -3.7557e+00   1.1200e+01  -1.9349e+01   2.0913e+01  -1.4167e+01

 Columns 7 and 8:

   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
  -8.2607e-01   0.0000e+00
   5.5903e+00  -1.0000e+00

ans =    0.0000e+00
ans =    0.0000e+00
schurdecomp(d0):
k =

 Columns 1 through 6:

  -8.0578e-01   9.9921e-01  -7.8555e-01   9.7685e-01  -6.7947e-01   6.0937e-01

 Column 7:

  -2.8265e-02

S =

 Columns 1 through 6:

   1.8123e-03   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -2.4658e-03   3.0602e-03   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   7.6920e-02  -1.2401e-01   7.6981e-02   0.0000e+00   0.0000e+00   0.0000e+00
  -9.7726e-02   2.8173e-01  -2.9805e-01   1.2440e-01   0.0000e+00   0.0000e+00
   5.6805e-01  -1.8178e+00   2.6034e+00  -1.8394e+00   5.8151e-01   0.0000e+00
  -5.3852e-01   2.4777e+00  -4.8884e+00   5.2316e+00  -3.0331e+00   7.9257e-01
   6.0913e-01  -3.0103e+00   7.1457e+00  -9.9224e+00   8.5025e+00  -4.2393e+00
  -2.8265e-02   7.2924e-01  -3.2519e+00   7.4291e+00  -1.0128e+01   8.5910e+00

 Columns 7 and 8:

   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   9.9960e-01   0.0000e+00
  -4.2582e+00   1.0000e+00

schurdecomp(-d0):
km =

 Columns 1 through 6:

  -8.0578e-01   9.9921e-01  -7.8555e-01   9.7685e-01  -6.7947e-01   6.0937e-01

 Column 7:

  -2.8265e-02

Sm =

 Columns 1 through 6:

  -1.8123e-03   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   2.4658e-03  -3.0602e-03   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.6920e-02   1.2401e-01  -7.6981e-02   0.0000e+00   0.0000e+00   0.0000e+00
   9.7726e-02  -2.8173e-01   2.9805e-01  -1.2440e-01   0.0000e+00   0.0000e+00
  -5.6805e-01   1.8178e+00  -2.6034e+00   1.8394e+00  -5.8151e-01   0.0000e+00
   5.3852e-01  -2.4777e+00   4.8884e+00  -5.2316e+00   3.0331e+00  -7.9257e-01
  -6.0913e-01   3.0103e+00  -7.1457e+00   9.9224e+00  -8.5025e+00   4.2393e+00
   2.8265e-02  -7.2924e-01   3.2519e+00  -7.4291e+00   1.0128e+01  -8.5910e+00

 Columns 7 and 8:

   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
  -9.9960e-01   0.0000e+00
   4.2582e+00  -1.0000e+00

ans =    0.0000e+00
ans =    0.0000e+00
schurdecomp(d0):
k =

  -3.9699e-01   9.3499e-01  -6.5887e-01   6.2581e-01  -3.1213e-01

S =

   1.8146e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.8488e-02   1.9771e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   5.2119e-01  -4.2820e-01   5.5743e-01   0.0000e+00   0.0000e+00   0.0000e+00
  -4.8823e-01   1.0679e+00  -1.0257e+00   7.4101e-01   0.0000e+00   0.0000e+00
   5.9455e-01  -1.4489e+00   2.2259e+00  -1.7068e+00   9.5004e-01   0.0000e+00
  -3.1213e-01   1.1866e+00  -2.2564e+00   2.8190e+00  -1.9919e+00   1.0000e+00

schurdecomp(-d0):
km =

  -3.9699e-01   9.3499e-01  -6.5887e-01   6.2581e-01  -3.1213e-01

Sm =

  -1.8146e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   7.8488e-02  -1.9771e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -5.2119e-01   4.2820e-01  -5.5743e-01   0.0000e+00   0.0000e+00   0.0000e+00
   4.8823e-01  -1.0679e+00   1.0257e+00  -7.4101e-01   0.0000e+00   0.0000e+00
  -5.9455e-01   1.4489e+00  -2.2259e+00   1.7068e+00  -9.5004e-01   0.0000e+00
   3.1213e-01  -1.1866e+00   2.2564e+00  -2.8190e+00   1.9919e+00  -1.0000e+00

ans =    0.0000e+00
ans =    0.0000e+00
schurdecomp(d0):
k =

  -2.6973e-01   9.5268e-01   5.5805e-02   4.5026e-01   1.5592e-01

S =

   2.5777e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.2203e-02   2.6769e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   8.3893e-01  -4.6380e-01   8.8060e-01   0.0000e+00   0.0000e+00   0.0000e+00
   4.9219e-02   8.1431e-01  -4.1764e-01   8.8197e-01   0.0000e+00   0.0000e+00
   4.4476e-01  -1.5548e-01   1.3226e+00  -4.4292e-01   9.8777e-01   0.0000e+00
   1.5592e-01   3.8035e-01   5.1378e-02   1.3145e+00  -3.7819e-01   1.0000e+00

schurdecomp(-d0):
km =

  -2.6973e-01   9.5268e-01   5.5805e-02   4.5026e-01   1.5592e-01

Sm =

  -2.5777e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   7.2203e-02  -2.6769e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -8.3893e-01   4.6380e-01  -8.8060e-01   0.0000e+00   0.0000e+00   0.0000e+00
  -4.9219e-02  -8.1431e-01   4.1764e-01  -8.8197e-01   0.0000e+00   0.0000e+00
  -4.4476e-01   1.5548e-01  -1.3226e+00   4.4292e-01  -9.8777e-01   0.0000e+00
  -1.5592e-01  -3.8035e-01  -5.1378e-02  -1.3145e+00   3.7819e-01  -1.0000e+00

ans =    0.0000e+00
ans =    0.0000e+00
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match. Suppress m-file warnings.
#
echo "Running $descr"
echo "warning('off');" >> .octaverc

octave-cli -q $prog > test.out
if [ $? -ne 0 ]; then echo "Failed running $descr"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

