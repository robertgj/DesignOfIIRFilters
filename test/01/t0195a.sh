#!/bin/sh

prog=schurOneMscale_test.m
depends="schurOneMscale_test.m test_common.m \
schurdecomp.oct schurexpand.oct schurOneMscale.m schurOneMlatticeFilter.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
epsilon =
   1   1  -1   1  -1

epsilon =
   1   1  -1   1  -1

p =
   1.5523   0.8327   0.9442   0.9843   0.9977

k =
  -0.8167   0.9982  -0.8844   0.9651  -0.9299   0.8869  -0.5636

S =
    0.0006         0         0         0         0         0         0         0
   -0.0008    0.0010         0         0         0         0         0         0
    0.0171   -0.0280    0.0172         0         0         0         0         0
   -0.0325    0.0897   -0.0924    0.0367         0         0         0         0
    0.1355   -0.4649    0.6735   -0.4728    0.1404         0         0         0
   -0.3549    1.5638   -2.9666    3.0064   -1.6281    0.3817         0         0
    0.7326   -3.8934    9.1556  -12.1157    9.5089   -4.2051    0.8261         0
   -0.5636    3.7557  -11.2004   19.3491  -20.9129   14.1672   -5.5903    1.0000

epsilon =
   1   1   1  -1  -1  -1  -1

p =
   0.843394   2.655448   0.080239   0.323962   2.431863   0.463468   1.892785

S1M =
    0.0005         0         0         0         0         0         0         0
   -0.0022    0.0027         0         0         0         0         0         0
    0.0014   -0.0022    0.0014         0         0         0         0         0
   -0.0105    0.0291   -0.0299    0.0119         0         0         0         0
    0.3295   -1.1305    1.6379   -1.1499    0.3414         0         0         0
   -0.1645    0.7248   -1.3749    1.3934   -0.7546    0.1769         0         0
    1.3867   -7.3693   17.3297  -22.9323   17.9983   -7.9594    1.5636         0
   -0.5636    3.7557  -11.2004   19.3491  -20.9129   14.1672   -5.5903    1.0000

c =
 Columns 1 through 7:
  -0.065709   0.051872   2.498011   0.753887   0.089681   0.195515   0.020683
 Column 8:
   0.013694

km =
  -0.8167   0.9982  -0.8844   0.9651  -0.9299   0.8869  -0.5636

Sm =
   -0.0006         0         0         0         0         0         0         0
    0.0008   -0.0010         0         0         0         0         0         0
   -0.0171    0.0280   -0.0172         0         0         0         0         0
    0.0325   -0.0897    0.0924   -0.0367         0         0         0         0
   -0.1355    0.4649   -0.6735    0.4728   -0.1404         0         0         0
    0.3549   -1.5638    2.9666   -3.0064    1.6281   -0.3817         0         0
   -0.7326    3.8934   -9.1556   12.1157   -9.5089    4.2051   -0.8261         0
    0.5636   -3.7557   11.2004  -19.3491   20.9129  -14.1672    5.5903   -1.0000

epsilonm =
   1   1   1  -1  -1  -1  -1

pm =
   0.843394   2.655448   0.080239   0.323962   2.431863   0.463468   1.892785

S1Mm =
   -0.0005         0         0         0         0         0         0         0
    0.0022   -0.0027         0         0         0         0         0         0
   -0.0014    0.0022   -0.0014         0         0         0         0         0
    0.0105   -0.0291    0.0299   -0.0119         0         0         0         0
   -0.3295    1.1305   -1.6379    1.1499   -0.3414         0         0         0
    0.1645   -0.7248    1.3749   -1.3934    0.7546   -0.1769         0         0
   -1.3867    7.3693  -17.3297   22.9323  -17.9983    7.9594   -1.5636         0
    0.5636   -3.7557   11.2004  -19.3491   20.9129  -14.1672    5.5903   -1.0000

cm =
 Columns 1 through 7:
   0.065709  -0.051872  -2.498011  -0.753887  -0.089681  -0.195515  -0.020683
 Column 8:
  -0.013694

ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
stdxf =
   113.75   113.40   127.40   125.12   128.39   128.06   129.28

stdxfr =
 Columns 1 through 6:
   6.4658e+00   6.4811e+00   7.2934e+03   7.1482e+03   1.2859e+02   1.2811e+02
 Column 7:
   1.2950e+02

stdxfr43 =
 Columns 1 through 6:
   1.0426e+05   1.0391e+05   1.1695e+05   7.0463e+03   1.2843e+02   1.2813e+02
 Column 7:
   1.2929e+02

stdxfm =
 Columns 1 through 6:
   1.6118e+02   1.6216e+01   1.9828e+04   1.1956e+03   2.1733e+01   5.9680e+02
 Column 7:
   3.6091e+01

k =
  -0.805776   0.999210  -0.785551   0.976849  -0.679467   0.609371  -0.028265

S =
    0.0018         0         0         0         0         0         0         0
   -0.0025    0.0031         0         0         0         0         0         0
    0.0769   -0.1240    0.0770         0         0         0         0         0
   -0.0977    0.2817   -0.2981    0.1244         0         0         0         0
    0.5680   -1.8178    2.6034   -1.8394    0.5815         0         0         0
   -0.5385    2.4777   -4.8884    5.2316   -3.0331    0.7926         0         0
    0.6091   -3.0103    7.1457   -9.9224    8.5025   -4.2393    0.9996         0
   -0.0283    0.7292   -3.2519    7.4291  -10.1284    8.5910   -4.2582    1.0000

epsilon =
   1   1   1  -1  -1  -1   1

p =
   0.678130   2.067731   0.041115   0.118639   1.096290   0.478934   0.972124

S1M =
    0.0012         0         0         0         0         0         0         0
   -0.0051    0.0063         0         0         0         0         0         0
    0.0032   -0.0051    0.0032         0         0         0         0         0
   -0.0116    0.0334   -0.0354    0.0148         0         0         0         0
    0.6227   -1.9928    2.8541   -2.0166    0.6375         0         0         0
   -0.2579    1.1866   -2.3412    2.5056   -1.4527    0.3796         0         0
    0.5921   -2.9264    6.9465   -9.6458    8.2654   -4.1211    0.9717         0
   -0.0283    0.7292   -3.2519    7.4291  -10.1284    8.5910   -4.2582    1.0000

c =
 Columns 1 through 7:
   0.133885   0.042422  -4.526263  -0.805177   0.262401   0.337743  -0.679848
 Column 8:
   0.340938

km =
  -0.805776   0.999210  -0.785551   0.976849  -0.679467   0.609371  -0.028265

Sm =
   -0.0018         0         0         0         0         0         0         0
    0.0025   -0.0031         0         0         0         0         0         0
   -0.0769    0.1240   -0.0770         0         0         0         0         0
    0.0977   -0.2817    0.2981   -0.1244         0         0         0         0
   -0.5680    1.8178   -2.6034    1.8394   -0.5815         0         0         0
    0.5385   -2.4777    4.8884   -5.2316    3.0331   -0.7926         0         0
   -0.6091    3.0103   -7.1457    9.9224   -8.5025    4.2393   -0.9996         0
    0.0283   -0.7292    3.2519   -7.4291   10.1284   -8.5910    4.2582   -1.0000

epsilonm =
   1   1   1  -1  -1  -1   1

pm =
   0.678130   2.067731   0.041115   0.118639   1.096290   0.478934   0.972124

S1Mm =
   -0.0012         0         0         0         0         0         0         0
    0.0051   -0.0063         0         0         0         0         0         0
   -0.0032    0.0051   -0.0032         0         0         0         0         0
    0.0116   -0.0334    0.0354   -0.0148         0         0         0         0
   -0.6227    1.9928   -2.8541    2.0166   -0.6375         0         0         0
    0.2579   -1.1866    2.3412   -2.5056    1.4527   -0.3796         0         0
   -0.5921    2.9264   -6.9465    9.6458   -8.2654    4.1211   -0.9717         0
    0.0283   -0.7292    3.2519   -7.4291   10.1284   -8.5910    4.2582   -1.0000

cm =
 Columns 1 through 7:
  -0.133885  -0.042422   4.526263   0.805177  -0.262401  -0.337743   0.679848
 Column 8:
  -0.340938

ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
k =
  -0.3970   0.9350  -0.6589   0.6258  -0.3121

S =
   0.1815        0        0        0        0        0
  -0.0785   0.1977        0        0        0        0
   0.5212  -0.4282   0.5574        0        0        0
  -0.4882   1.0679  -1.0257   0.7410        0        0
   0.5945  -1.4489   2.2259  -1.7068   0.9500        0
  -0.3121   1.1866  -2.2564   2.8190  -1.9919   1.0000

epsilon =
   1   1   1  -1  -1

p =
   1.0770   1.6392   0.3005   0.6626   1.3811

S1M =
   0.1954        0        0        0        0        0
  -0.1287   0.3241        0        0        0        0
   0.1566  -0.1287   0.1675        0        0        0
  -0.3235   0.7076  -0.6796   0.4910        0        0
   0.8211  -2.0012   3.0743  -2.3573   1.3121        0
  -0.3121   1.1866  -2.2564   2.8190  -1.9919   1.0000

c =
  -0.209698   0.096836   1.207032   0.533258   0.123815   0.049343

km =
  -0.3970   0.9350  -0.6589   0.6258  -0.3121

Sm =
  -0.1815        0        0        0        0        0
   0.0785  -0.1977        0        0        0        0
  -0.5212   0.4282  -0.5574        0        0        0
   0.4882  -1.0679   1.0257  -0.7410        0        0
  -0.5945   1.4489  -2.2259   1.7068  -0.9500        0
   0.3121  -1.1866   2.2564  -2.8190   1.9919  -1.0000

epsilonm =
   1   1   1  -1  -1

pm =
   1.0770   1.6392   0.3005   0.6626   1.3811

S1Mm =
  -0.1954        0        0        0        0        0
   0.1287  -0.3241        0        0        0        0
  -0.1566   0.1287  -0.1675        0        0        0
   0.3235  -0.7076   0.6796  -0.4910        0        0
  -0.8211   2.0012  -3.0743   2.3573  -1.3121        0
   0.3121  -1.1866   2.2564  -2.8190   1.9919  -1.0000

cm =
   0.209698  -0.096836  -1.207032  -0.533258  -0.123815  -0.049343

ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
k =
  -0.269728   0.952677   0.055805   0.450264   0.155925

S =
   0.2578        0        0        0        0        0
  -0.0722   0.2677        0        0        0        0
   0.8389  -0.4638   0.8806        0        0        0
   0.0492   0.8143  -0.4176   0.8820        0        0
   0.4448  -0.1555   1.3226  -0.4429   0.9878        0
   0.1559   0.3803   0.0514   1.3145  -0.3782   1.0000

epsilon =
   1   1  -1  -1  -1

p =
   2.4237   3.1959   0.4975   0.5261   0.8545

S1M =
   0.6248        0        0        0        0        0
  -0.2308   0.8555        0        0        0        0
   0.4174  -0.2308   0.4381        0        0        0
   0.0259   0.4284  -0.2197   0.4640        0        0
   0.3801  -0.1329   1.1302  -0.3785   0.8441        0
   0.1559   0.3803   0.0514   1.3145  -0.3782   1.0000

c =
   0.044788  -0.085303  -0.102337   0.950011  -0.503287   0.139910

km =
  -0.269728   0.952677   0.055805   0.450264   0.155925

Sm =
  -0.2578        0        0        0        0        0
   0.0722  -0.2677        0        0        0        0
  -0.8389   0.4638  -0.8806        0        0        0
  -0.0492  -0.8143   0.4176  -0.8820        0        0
  -0.4448   0.1555  -1.3226   0.4429  -0.9878        0
  -0.1559  -0.3803  -0.0514  -1.3145   0.3782  -1.0000

epsilonm =
   1   1  -1  -1  -1

pm =
   2.4237   3.1959   0.4975   0.5261   0.8545

S1Mm =
  -0.6248        0        0        0        0        0
   0.2308  -0.8555        0        0        0        0
  -0.4174   0.2308  -0.4381        0        0        0
  -0.0259  -0.4284   0.2197  -0.4640        0        0
  -0.3801   0.1329  -1.1302   0.3785  -0.8441        0
  -0.1559  -0.3803  -0.0514  -1.3145   0.3782  -1.0000

cm =
  -0.044788   0.085303   0.102337  -0.950011   0.503287  -0.139910

ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave-cli -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

