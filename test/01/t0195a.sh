#!/bin/sh

prog=schurOneMscale_test.m
depends="schurOneMscale_test.m test_common.m \
schurdecomp.oct schurexpand.oct schurOneMscale.m schurOneMlatticeFilter.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
epsilon =
   1   1  -1   1  -1

epsilon =
   1   1  -1   1  -1

p =
   1.55227   0.83268   0.94421   0.98426   0.99766

k =
  -0.81674   0.99818  -0.88440   0.96513  -0.92990   0.88687  -0.56357

S =
 Columns 1 through 7:
    0.00060    0.00000    0.00000    0.00000    0.00000    0.00000    0.00000
   -0.00085    0.00104    0.00000    0.00000    0.00000    0.00000    0.00000
    0.01712   -0.02799    0.01715    0.00000    0.00000    0.00000    0.00000
   -0.03250    0.08972   -0.09241    0.03675    0.00000    0.00000    0.00000
    0.13548   -0.46485    0.67350   -0.47283    0.14038    0.00000    0.00000
   -0.35491    1.56379   -2.96665    3.00641   -1.62808    0.38166    0.00000
    0.73261   -3.89335    9.15564  -12.11566    9.50888   -4.20510    0.82607
   -0.56357    3.75572  -11.20037   19.34908  -20.91292   14.16718   -5.59032
 Column 8:
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    1.00000

epsilon =
   1   1   1  -1  -1  -1  -1

p =
   0.843394   2.655448   0.080239   0.323962   2.431863   0.463468   1.892785

S1M =
 Columns 1 through 7:
    0.00050    0.00000    0.00000    0.00000    0.00000    0.00000    0.00000
   -0.00225    0.00275    0.00000    0.00000    0.00000    0.00000    0.00000
    0.00137   -0.00225    0.00138    0.00000    0.00000    0.00000    0.00000
   -0.01053    0.02907   -0.02994    0.01191    0.00000    0.00000    0.00000
    0.32947   -1.13045    1.63787   -1.14986    0.34138    0.00000    0.00000
   -0.16449    0.72477   -1.37495    1.39338   -0.75457    0.17689    0.00000
    1.38668   -7.36928   17.32966  -22.93234   17.99827   -7.95936    1.56357
   -0.56357    3.75572  -11.20037   19.34908  -20.91292   14.16718   -5.59032
 Column 8:
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    1.00000

c =
 Columns 1 through 7:
  -0.065709   0.051872   2.498011   0.753887   0.089681   0.195515   0.020683
 Column 8:
   0.013694

km =
  -0.81674   0.99818  -0.88440   0.96513  -0.92990   0.88687  -0.56357

Sm =
 Columns 1 through 7:
   -0.00060    0.00000    0.00000    0.00000    0.00000    0.00000    0.00000
    0.00085   -0.00104    0.00000    0.00000    0.00000    0.00000    0.00000
   -0.01712    0.02799   -0.01715    0.00000    0.00000    0.00000    0.00000
    0.03250   -0.08972    0.09241   -0.03675    0.00000    0.00000    0.00000
   -0.13548    0.46485   -0.67350    0.47283   -0.14038    0.00000    0.00000
    0.35491   -1.56379    2.96665   -3.00641    1.62808   -0.38166    0.00000
   -0.73261    3.89335   -9.15564   12.11566   -9.50888    4.20510   -0.82607
    0.56357   -3.75572   11.20037  -19.34908   20.91292  -14.16718    5.59032
 Column 8:
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
   -1.00000

epsilonm =
   1   1   1  -1  -1  -1  -1

pm =
   0.843394   2.655448   0.080239   0.323962   2.431863   0.463468   1.892785

S1Mm =
 Columns 1 through 7:
   -0.00050    0.00000    0.00000    0.00000    0.00000    0.00000    0.00000
    0.00225   -0.00275    0.00000    0.00000    0.00000    0.00000    0.00000
   -0.00137    0.00225   -0.00138    0.00000    0.00000    0.00000    0.00000
    0.01053   -0.02907    0.02994   -0.01191    0.00000    0.00000    0.00000
   -0.32947    1.13045   -1.63787    1.14986   -0.34138    0.00000    0.00000
    0.16449   -0.72477    1.37495   -1.39338    0.75457   -0.17689    0.00000
   -1.38668    7.36928  -17.32966   22.93234  -17.99827    7.95936   -1.56357
    0.56357   -3.75572   11.20037  -19.34908   20.91292  -14.16718    5.59032
 Column 8:
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
   -1.00000

cm =
 Columns 1 through 7:
   0.065709  -0.051872  -2.498011  -0.753887  -0.089681  -0.195515  -0.020683
 Column 8:
  -0.013694

ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
stdxf =
   113.75   113.40   127.40   125.12   128.39   128.06   129.28

stdxfr =
 Columns 1 through 6:
      6.4658      6.4811   7293.3601   7148.1894    128.5867    128.1089
 Column 7:
    129.5019

stdxfr43 =
 Columns 1 through 5:
   104257.14640   103911.43096   116946.20092     7046.32121      128.43407
 Columns 6 and 7:
      128.12884      129.29446

stdxfm =
 Columns 1 through 5:
     161.18391      16.21611   19828.35598    1195.55990      21.73285
 Columns 6 and 7:
     596.80049      36.09092

k =
  -0.805776   0.999210  -0.785551   0.976849  -0.679467   0.609371  -0.028265

S =
 Columns 1 through 7:
    0.00181    0.00000    0.00000    0.00000    0.00000    0.00000    0.00000
   -0.00247    0.00306    0.00000    0.00000    0.00000    0.00000    0.00000
    0.07692   -0.12401    0.07698    0.00000    0.00000    0.00000    0.00000
   -0.09773    0.28173   -0.29805    0.12440    0.00000    0.00000    0.00000
    0.56805   -1.81777    2.60337   -1.83945    0.58151    0.00000    0.00000
   -0.53852    2.47769   -4.88844    5.23164   -3.03312    0.79257    0.00000
    0.60913   -3.01029    7.14567   -9.92237    8.50245   -4.23930    0.99960
   -0.02826    0.72924   -3.25191    7.42909  -10.12839    8.59097   -4.25822
 Column 8:
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    1.00000

epsilon =
   1   1   1  -1  -1  -1   1

p =
   0.678130   2.067731   0.041115   0.118639   1.096290   0.478934   0.972124

S1M =
 Columns 1 through 7:
    0.00123    0.00000    0.00000    0.00000    0.00000    0.00000    0.00000
   -0.00510    0.00633    0.00000    0.00000    0.00000    0.00000    0.00000
    0.00316   -0.00510    0.00317    0.00000    0.00000    0.00000    0.00000
   -0.01159    0.03342   -0.03536    0.01476    0.00000    0.00000    0.00000
    0.62275   -1.99280    2.85405   -2.01657    0.63751    0.00000    0.00000
   -0.25792    1.18665   -2.34124    2.50561   -1.45266    0.37959    0.00000
    0.59215   -2.92638    6.94647   -9.64577    8.26543   -4.12112    0.97174
   -0.02826    0.72924   -3.25191    7.42909  -10.12839    8.59097   -4.25822
 Column 8:
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    1.00000

c =
 Columns 1 through 7:
   0.133885   0.042422  -4.526263  -0.805177   0.262401   0.337743  -0.679848
 Column 8:
   0.340938

km =
  -0.805776   0.999210  -0.785551   0.976849  -0.679467   0.609371  -0.028265

Sm =
 Columns 1 through 7:
   -0.00181    0.00000    0.00000    0.00000    0.00000    0.00000    0.00000
    0.00247   -0.00306    0.00000    0.00000    0.00000    0.00000    0.00000
   -0.07692    0.12401   -0.07698    0.00000    0.00000    0.00000    0.00000
    0.09773   -0.28173    0.29805   -0.12440    0.00000    0.00000    0.00000
   -0.56805    1.81777   -2.60337    1.83945   -0.58151    0.00000    0.00000
    0.53852   -2.47769    4.88844   -5.23164    3.03312   -0.79257    0.00000
   -0.60913    3.01029   -7.14567    9.92237   -8.50245    4.23930   -0.99960
    0.02826   -0.72924    3.25191   -7.42909   10.12839   -8.59097    4.25822
 Column 8:
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
   -1.00000

epsilonm =
   1   1   1  -1  -1  -1   1

pm =
   0.678130   2.067731   0.041115   0.118639   1.096290   0.478934   0.972124

S1Mm =
 Columns 1 through 7:
   -0.00123    0.00000    0.00000    0.00000    0.00000    0.00000    0.00000
    0.00510   -0.00633    0.00000    0.00000    0.00000    0.00000    0.00000
   -0.00316    0.00510   -0.00317    0.00000    0.00000    0.00000    0.00000
    0.01159   -0.03342    0.03536   -0.01476    0.00000    0.00000    0.00000
   -0.62275    1.99280   -2.85405    2.01657   -0.63751    0.00000    0.00000
    0.25792   -1.18665    2.34124   -2.50561    1.45266   -0.37959    0.00000
   -0.59215    2.92638   -6.94647    9.64577   -8.26543    4.12112   -0.97174
    0.02826   -0.72924    3.25191   -7.42909   10.12839   -8.59097    4.25822
 Column 8:
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
   -1.00000

cm =
 Columns 1 through 7:
  -0.133885  -0.042422   4.526263   0.805177  -0.262401  -0.337743   0.679848
 Column 8:
  -0.340938

ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
k =
  -0.39699   0.93499  -0.65887   0.62581  -0.31213

S =
   0.18146   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.07849   0.19771   0.00000   0.00000   0.00000   0.00000
   0.52119  -0.42820   0.55743   0.00000   0.00000   0.00000
  -0.48823   1.06788  -1.02571   0.74101   0.00000   0.00000
   0.59455  -1.44893   2.22593  -1.70679   0.95004   0.00000
  -0.31213   1.18656  -2.25644   2.81902  -1.99188   1.00000

epsilon =
   1   1   1  -1  -1

p =
   1.07697   1.63923   0.30047   0.66259   1.38113

S1M =
   0.19543   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.12866   0.32409   0.00000   0.00000   0.00000   0.00000
   0.15660  -0.12866   0.16749   0.00000   0.00000   0.00000
  -0.32349   0.70756  -0.67962   0.49098   0.00000   0.00000
   0.82115  -2.00116   3.07430  -2.35729   1.31213   0.00000
  -0.31213   1.18656  -2.25644   2.81902  -1.99188   1.00000

c =
  -0.209698   0.096836   1.207032   0.533258   0.123815   0.049343

km =
  -0.39699   0.93499  -0.65887   0.62581  -0.31213

Sm =
  -0.18146   0.00000   0.00000   0.00000   0.00000   0.00000
   0.07849  -0.19771   0.00000   0.00000   0.00000   0.00000
  -0.52119   0.42820  -0.55743   0.00000   0.00000   0.00000
   0.48823  -1.06788   1.02571  -0.74101   0.00000   0.00000
  -0.59455   1.44893  -2.22593   1.70679  -0.95004   0.00000
   0.31213  -1.18656   2.25644  -2.81902   1.99188  -1.00000

epsilonm =
   1   1   1  -1  -1

pm =
   1.07697   1.63923   0.30047   0.66259   1.38113

S1Mm =
  -0.19543   0.00000   0.00000   0.00000   0.00000   0.00000
   0.12866  -0.32409   0.00000   0.00000   0.00000   0.00000
  -0.15660   0.12866  -0.16749   0.00000   0.00000   0.00000
   0.32349  -0.70756   0.67962  -0.49098   0.00000   0.00000
  -0.82115   2.00116  -3.07430   2.35729  -1.31213   0.00000
   0.31213  -1.18656   2.25644  -2.81902   1.99188  -1.00000

cm =
   0.209698  -0.096836  -1.207032  -0.533258  -0.123815  -0.049343

ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
k =
  -0.269728   0.952677   0.055805   0.450264   0.155925

S =
   0.25777   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.07220   0.26769   0.00000   0.00000   0.00000   0.00000
   0.83893  -0.46380   0.88060   0.00000   0.00000   0.00000
   0.04922   0.81431  -0.41764   0.88197   0.00000   0.00000
   0.44476  -0.15548   1.32263  -0.44292   0.98777   0.00000
   0.15592   0.38035   0.05138   1.31446  -0.37819   1.00000

epsilon =
   1   1  -1  -1  -1

p =
   2.42373   3.19593   0.49753   0.52611   0.85453

S1M =
   0.62476   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.23076   0.85551   0.00000   0.00000   0.00000   0.00000
   0.41739  -0.23076   0.43812   0.00000   0.00000   0.00000
   0.02589   0.42842  -0.21973   0.46402   0.00000   0.00000
   0.38006  -0.13286   1.13022  -0.37848   0.84408   0.00000
   0.15592   0.38035   0.05138   1.31446  -0.37819   1.00000

c =
   0.044788  -0.085303  -0.102337   0.950011  -0.503287   0.139910

km =
  -0.269728   0.952677   0.055805   0.450264   0.155925

Sm =
  -0.25777   0.00000   0.00000   0.00000   0.00000   0.00000
   0.07220  -0.26769   0.00000   0.00000   0.00000   0.00000
  -0.83893   0.46380  -0.88060   0.00000   0.00000   0.00000
  -0.04922  -0.81431   0.41764  -0.88197   0.00000   0.00000
  -0.44476   0.15548  -1.32263   0.44292  -0.98777   0.00000
  -0.15592  -0.38035  -0.05138  -1.31446   0.37819  -1.00000

epsilonm =
   1   1  -1  -1  -1

pm =
   2.42373   3.19593   0.49753   0.52611   0.85453

S1Mm =
  -0.62476   0.00000   0.00000   0.00000   0.00000   0.00000
   0.23076  -0.85551   0.00000   0.00000   0.00000   0.00000
  -0.41739   0.23076  -0.43812   0.00000   0.00000   0.00000
  -0.02589  -0.42842   0.21973  -0.46402   0.00000   0.00000
  -0.38006   0.13286  -1.13022   0.37848  -0.84408   0.00000
  -0.15592  -0.38035  -0.05138  -1.31446   0.37819  -1.00000

cm =
  -0.044788   0.085303   0.102337  -0.950011   0.503287  -0.139910

ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave-cli -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

