#!/bin/sh

prog=complementaryFIRdecomp_test.m

descr="complementaryFIRdecomp_test.m (mfile)"

depends="complementaryFIRdecomp_test.m test_common.m check_octave_file.m \
complementaryFIRdecomp.m complementaryFIRlattice.m \
minphase.m print_polynomial.m x2tf.m cl2lp.m local_max.m direct_form_scale.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $descr 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $descr
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.brz.ok << 'EOF'
brz = [  -0.00020943,   0.00012020,   0.00129951,   0.00160257, ... 
         -0.00171500,  -0.00682233,  -0.00509864,   0.00872438, ... 
          0.02217082,   0.01042209,  -0.03109532,  -0.06073529, ... 
         -0.01550975,   0.12126308,   0.28012388,   0.35091789, ... 
          0.28012388,   0.12126308,  -0.01550975,  -0.06073529, ... 
         -0.03109532,   0.01042209,   0.02217082,   0.00872438, ... 
         -0.00509864,  -0.00682233,  -0.00171500,   0.00160257, ... 
          0.00129951,   0.00012020,  -0.00020943 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.brz.ok"; fail; fi

cat > test.brzc.ok << 'EOF'
brzc = [   0.34183056,  -0.65764032,   0.17115230,   0.25827457, ... 
           0.05725731,  -0.10262610,  -0.11167508,  -0.02827757, ... 
           0.04484083,   0.05615427,   0.02209269,  -0.01388107, ... 
          -0.02547166,  -0.01584536,  -0.00196617,   0.00457938, ... 
           0.00356440,   0.00036866,  -0.00116782,  -0.00082782, ... 
          -0.00004192,   0.00027633,   0.00017111,   0.00000637, ... 
          -0.00004620,  -0.00002474,  -0.00000122,   0.00000393, ... 
           0.00000142,  -0.00000010,  -0.00000013 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.brzc.ok"; fail; fi

cat > test.krz.ok << 'EOF'
krz = [   0.99999981,   0.99999966,   0.99999683,   0.99994584, ... 
          0.99989530,   0.99999974,   0.99956561,   0.99904361, ... 
          0.99999337,   0.99717346,   0.99514281,   0.99975035, ... 
          0.97757947,   0.98842634,   0.86647943,   0.49700634, ... 
          0.86647943,   0.98842634,   0.97757947,   0.99975035, ... 
          0.99514281,   0.99717346,   0.99999337,   0.99904361, ... 
          0.99956561,   0.99999974,   0.99989530,   0.99994584, ... 
          0.99999683,   0.99999966,  -0.00061267 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.krz.ok"; fail; fi

cat > test.krzhat.ok << 'EOF'
krzhat = [   0.00061267,   0.00082706,  -0.00251720,  -0.01040738, ... 
            -0.01447039,  -0.00072607,   0.02947200,   0.04372493, ... 
             0.00364085,  -0.07513388,  -0.09844181,   0.02234382, ... 
             0.21056680,   0.15170160,  -0.49921277,  -0.86774691, ... 
            -0.49921277,   0.15170160,   0.21056680,   0.02234382, ... 
            -0.09844181,  -0.07513388,   0.00364085,   0.04372493, ... 
             0.02947200,  -0.00072607,  -0.01447039,  -0.01040738, ... 
            -0.00251720,   0.00082706,   0.99999981 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.krzhat.ok"; fail; fi

cat > test.brze.ok << 'EOF'
brze = [   0.00000000,  -0.00020943,   0.00012020,   0.00129951, ... 
           0.00160257,  -0.00171500,  -0.00682233,  -0.00509864, ... 
           0.00872438,   0.02217082,   0.01042209,  -0.03109532, ... 
          -0.06073529,  -0.01550975,   0.12126308,   0.28012388, ... 
           0.35091789,   0.28012388,   0.12126308,  -0.01550975, ... 
          -0.06073529,  -0.03109532,   0.01042209,   0.02217082, ... 
           0.00872438,  -0.00509864,  -0.00682233,  -0.00171500, ... 
           0.00160257,   0.00129951,   0.00012020,  -0.00020943, ... 
           0.00000000 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.brze.ok"; fail; fi

cat > test.brzec.ok << 'EOF'
brzec = [   0.34183058,  -0.65764033,   0.17115227,   0.25827457, ... 
            0.05725733,  -0.10262608,  -0.11167508,  -0.02827757, ... 
            0.04484082,   0.05615426,   0.02209269,  -0.01388106, ... 
           -0.02547165,  -0.01584536,  -0.00196617,   0.00457938, ... 
            0.00356440,   0.00036866,  -0.00116782,  -0.00082782, ... 
           -0.00004192,   0.00027633,   0.00017111,   0.00000637, ... 
           -0.00004620,  -0.00002474,  -0.00000122,   0.00000393, ... 
            0.00000142,  -0.00000010,  -0.00000013,   0.00000000, ... 
            0.00000000 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.brzec.ok"; fail; fi

cat > test.krze.ok << 'EOF'
krze = [   0.99999981,   0.99999966,   0.99999683,   0.99994584, ... 
           0.99989530,   0.99999974,   0.99956561,   0.99904361, ... 
           0.99999337,   0.99717346,   0.99514281,   0.99975035, ... 
           0.97757947,   0.98842634,   0.86647943,   0.49700636, ... 
           0.86647943,   0.98842634,   0.97757947,   0.99975035, ... 
           0.99514281,   0.99717346,   0.99999337,   0.99904361, ... 
           0.99956561,   0.99999974,   0.99989530,   0.99994584, ... 
           0.99999683,   0.99999966,   0.99999981,   0.00000000 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.krze.ok"; fail; fi

cat > test.krzehat.ok << 'EOF'
krzehat = [   0.00061267,   0.00082706,  -0.00251720,  -0.01040738, ... 
             -0.01447038,  -0.00072607,   0.02947200,   0.04372492, ... 
              0.00364085,  -0.07513388,  -0.09844180,   0.02234383, ... 
              0.21056680,   0.15170158,  -0.49921277,  -0.86774690, ... 
             -0.49921277,   0.15170158,   0.21056680,   0.02234383, ... 
             -0.09844180,  -0.07513388,   0.00364085,   0.04372492, ... 
              0.02947200,  -0.00072607,  -0.01447038,  -0.01040738, ... 
             -0.00251720,   0.00082706,   0.00061267,   1.00000000 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.krzehat.ok"; fail; fi

cat > test.b17b.ok << 'EOF'
b17b = [   0.09202089,   0.12004555,   0.02386986,  -0.16085218, ... 
          -0.24574500,  -0.11274575,   0.11917389,   0.22186123, ... 
           0.12463553,  -0.02687458,  -0.07667980,  -0.03250055, ... 
           0.00090041,  -0.01515647,  -0.03327605,  -0.02161084, ... 
           0.02350013 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.b17b.ok"; fail; fi

cat > test.b17bc.ok << 'EOF'
b17bc = [   0.72484441,  -0.27110394,   0.18391585,   0.33466537, ... 
            0.18461460,  -0.01327284,  -0.07986010,  -0.04203080, ... 
           -0.00778946,  -0.01431989,  -0.02387903,  -0.00879194, ... 
            0.01340608,   0.01790940,   0.00693980,  -0.00226428, ... 
           -0.00298340 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.b17bc.ok"; fail; fi

cat > test.k17b.ok << 'EOF'
k17b = [   0.99947486,   0.99984392,   0.99816420,   0.99855351, ... 
           0.99999376,   0.99999986,   0.99817337,   0.99900084, ... 
           0.98732365,   0.93444853,   0.97286252,   0.98001672, ... 
           0.89205469,   0.96028624,   0.99752668,   0.97870897, ... 
           0.12594177 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.k17b.ok"; fail; fi

cat > test.k17bhat.ok << 'EOF'
k17bhat = [  -0.03240390,   0.01766715,   0.06056585,   0.05376689, ... 
              0.00353360,  -0.00052845,   0.06041454,   0.04469141, ... 
             -0.15871990,  -0.35609822,  -0.23138392,   0.19891511, ... 
              0.45192746,   0.27901674,  -0.07028883,  -0.20525288, ... 
              0.99203764 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.k17bhat.ok"; fail; fi

cat > test.hcl.ok << 'EOF'
hcl = [  -0.00823713,   0.00185339,   0.01234130,   0.00068180, ... 
         -0.01756192,  -0.00197480,   0.02475143,   0.00270732, ... 
         -0.03571765,  -0.00281316,   0.05498945,   0.00223191, ... 
         -0.09846323,   0.00044815,   0.31397812,   0.49589152, ... 
          0.31397812,   0.00044815,  -0.09846323,   0.00223191, ... 
          0.05498945,  -0.00281316,  -0.03571765,   0.00270732, ... 
          0.02475143,  -0.00197480,  -0.01756192,   0.00068180, ... 
          0.01234130,   0.00185339,  -0.00823713 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.hcl.ok"; fail; fi

cat > test.hclc.ok << 'EOF'
hclc = [   0.33773800,  -0.52744263,   0.27954887,   0.06909838, ... 
          -0.14588350,  -0.01951933,   0.09548811,   0.00648818, ... 
          -0.07309265,  -0.00448330,   0.06169819,   0.00584421, ... 
          -0.06327563,  -0.02756267,   0.05062538,   0.06008315, ... 
           0.01212108,  -0.01422713,  -0.00239925,   0.00785972, ... 
           0.00100928,  -0.00463513,  -0.00065043,   0.00275384, ... 
           0.00055154,  -0.00156293,  -0.00050340,   0.00076300, ... 
           0.00040932,  -0.00022333,  -0.00020090 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.hclc.ok"; fail; fi

cat > test.kcl.ok << 'EOF'
kcl = [   0.99970272,   0.99946965,   0.99998299,   0.99907702, ... 
          0.99997883,   0.99886639,   0.99996770,   0.99811533, ... 
          0.99997922,   0.99633560,   0.99998852,   0.99093335, ... 
          0.99870685,   0.96734532,   0.91175874,   0.45093590, ... 
          0.91175874,   0.96734532,   0.99870685,   0.99093335, ... 
          0.99998852,   0.99633560,   0.99997922,   0.99811533, ... 
          0.99996770,   0.99886639,   0.99997883,   0.99907702, ... 
          0.99998299,   0.99946965,  -0.02438185 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.kcl.ok"; fail; fi

cat > test.kclhat.ok << 'EOF'
kclhat = [   0.02438185,   0.03256394,  -0.00583219,  -0.04295469, ... 
            -0.00650744,   0.04760182,   0.00803736,  -0.06136606, ... 
            -0.00644615,   0.08552994,  -0.00479066,  -0.13435433, ... 
             0.05083927,   0.25346209,  -0.41072619,  -0.89255634, ... 
            -0.41072619,   0.25346209,   0.05083927,  -0.13435433, ... 
            -0.00479066,   0.08552994,  -0.00644615,  -0.06136606, ... 
             0.00803736,   0.04760182,  -0.00650744,  -0.04295469, ... 
            -0.00583219,   0.03256394,   0.99970272 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat test.kclhat.ok"; fail; fi

#
# run and see if the results match
#
echo "Running $descr"
octave --no-gui -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $descr"; fail; fi

diff -Bb test.brz.ok complementaryFIRdecomp_test_brz_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.brz.ok"; fail; fi

diff -Bb test.brzc.ok complementaryFIRdecomp_test_brzc_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.brzc.ok"; fail; fi

diff -Bb test.krz.ok complementaryFIRdecomp_test_krz_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.krz.ok"; fail; fi

diff -Bb test.krzhat.ok complementaryFIRdecomp_test_krzhat_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.krzhat.ok"; fail; fi

diff -Bb test.brze.ok complementaryFIRdecomp_test_brze_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.brze.ok"; fail; fi

diff -Bb test.brzec.ok complementaryFIRdecomp_test_brzec_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.brzec.ok"; fail; fi

diff -Bb test.krze.ok complementaryFIRdecomp_test_krze_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.krze.ok"; fail; fi

diff -Bb test.krzehat.ok complementaryFIRdecomp_test_krzehat_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.krzehat.ok"; fail; fi

diff -Bb test.b17b.ok complementaryFIRdecomp_test_b17b_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.b17b.ok"; fail; fi

diff -Bb test.b17bc.ok complementaryFIRdecomp_test_b17bc_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.b17bc.ok"; fail; fi

diff -Bb test.k17b.ok complementaryFIRdecomp_test_k17b_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.k17b.ok"; fail; fi

diff -Bb test.k17bhat.ok complementaryFIRdecomp_test_k17bhat_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.k17bhat.ok"; fail; fi

diff -Bb test.hcl.ok complementaryFIRdecomp_test_hcl_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.hcl.ok"; fail; fi

diff -Bb test.hclc.ok complementaryFIRdecomp_test_hclc_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.hclc.ok"; fail; fi

diff -Bb test.kcl.ok complementaryFIRdecomp_test_kcl_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.kcl.ok"; fail; fi

diff -Bb test.kclhat.ok complementaryFIRdecomp_test_kclhat_coef.m
if [ $? -ne 0 ]; then echo "Failed diff -Bb test.kclhat.ok"; fail; fi

#
# this much worked
#
pass

