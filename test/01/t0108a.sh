#!/bin/sh

prog=schurdecomp_test.m
descr="schurdecomp_test.m (octfile)"
depends="schurdecomp_test.m test_common.m schurdecomp.oct"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED $descr 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED $descr
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
echo $here
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
Caught schurdecomp([])!
d is empty
Caught schurdecomp(0)!
First element of d is 0
k = [](0x0)
S =    1.0000e+00
schurdecomp(d0):
k =   -1.5838e-01
S =

   9.8738e-01   0.0000e+00
  -1.5838e-01   1.0000e+00

schurdecomp(-d0):
km =   -1.5838e-01
Sm =

  -9.8738e-01   0.0000e+00
   1.5838e-01  -1.0000e+00

ans =    0.0000e+00
ans =    0.0000e+00
schurdecomp(d0):
k =

 Columns 1 through 6:

  -8.1674e-01   9.9818e-01  -8.8440e-01   9.6512e-01  -9.2990e-01   8.8687e-01

 Column 7:

  -5.6357e-01

S =

 Columns 1 through 6:

   5.9758e-04   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -8.4585e-04   1.0356e-03   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   1.7120e-02  -2.7991e-02   1.7152e-02   0.0000e+00   0.0000e+00   0.0000e+00
  -3.2501e-02   8.9723e-02  -9.2415e-02   3.6749e-02   0.0000e+00   0.0000e+00
   1.3548e-01  -4.6485e-01   6.7350e-01  -4.7283e-01   1.4038e-01   0.0000e+00
  -3.5491e-01   1.5638e+00  -2.9667e+00   3.0064e+00  -1.6281e+00   3.8166e-01
   7.3261e-01  -3.8934e+00   9.1557e+00  -1.2116e+01   9.5089e+00  -4.2051e+00
  -5.6357e-01   3.7557e+00  -1.1200e+01   1.9349e+01  -2.0913e+01   1.4167e+01

 Columns 7 and 8:

   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   8.2607e-01   0.0000e+00
  -5.5903e+00   1.0000e+00

schurdecomp(-d0):
km =

 Columns 1 through 6:

  -8.1674e-01   9.9818e-01  -8.8440e-01   9.6512e-01  -9.2990e-01   8.8687e-01

 Column 7:

  -5.6357e-01

Sm =

 Columns 1 through 6:

  -5.9758e-04   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   8.4585e-04  -1.0356e-03   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -1.7120e-02   2.7991e-02  -1.7152e-02   0.0000e+00   0.0000e+00   0.0000e+00
   3.2501e-02  -8.9723e-02   9.2415e-02  -3.6749e-02   0.0000e+00   0.0000e+00
  -1.3548e-01   4.6485e-01  -6.7350e-01   4.7283e-01  -1.4038e-01   0.0000e+00
   3.5491e-01  -1.5638e+00   2.9667e+00  -3.0064e+00   1.6281e+00  -3.8166e-01
  -7.3261e-01   3.8934e+00  -9.1557e+00   1.2116e+01  -9.5089e+00   4.2051e+00
   5.6357e-01  -3.7557e+00   1.1200e+01  -1.9349e+01   2.0913e+01  -1.4167e+01

 Columns 7 and 8:

   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
  -8.2607e-01   0.0000e+00
   5.5903e+00  -1.0000e+00

ans =    0.0000e+00
ans =    0.0000e+00
schurdecomp(d0):
k =

 Columns 1 through 6:

  -8.0578e-01   9.9921e-01  -7.8555e-01   9.7685e-01  -6.7946e-01   6.0936e-01

 Column 7:

  -2.8261e-02

S =

 Columns 1 through 6:

   1.8124e-03   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -2.4660e-03   3.0604e-03   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   7.6923e-02  -1.2401e-01   7.6984e-02   0.0000e+00   0.0000e+00   0.0000e+00
  -9.7729e-02   2.8174e-01  -2.9806e-01   1.2441e-01   0.0000e+00   0.0000e+00
   5.6806e-01  -1.8178e+00   2.6034e+00  -1.8395e+00   5.8152e-01   0.0000e+00
  -5.3852e-01   2.4777e+00  -4.8884e+00   5.2317e+00  -3.0331e+00   7.9257e-01
   6.0912e-01  -3.0103e+00   7.1456e+00  -9.9223e+00   8.5024e+00  -4.2393e+00
  -2.8261e-02   7.2922e-01  -3.2518e+00   7.4290e+00  -1.0128e+01   8.5909e+00

 Columns 7 and 8:

   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   9.9960e-01   0.0000e+00
  -4.2582e+00   1.0000e+00

schurdecomp(-d0):
km =

 Columns 1 through 6:

  -8.0578e-01   9.9921e-01  -7.8555e-01   9.7685e-01  -6.7946e-01   6.0936e-01

 Column 7:

  -2.8261e-02

Sm =

 Columns 1 through 6:

  -1.8124e-03   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   2.4660e-03  -3.0604e-03   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.6923e-02   1.2401e-01  -7.6984e-02   0.0000e+00   0.0000e+00   0.0000e+00
   9.7729e-02  -2.8174e-01   2.9806e-01  -1.2441e-01   0.0000e+00   0.0000e+00
  -5.6806e-01   1.8178e+00  -2.6034e+00   1.8395e+00  -5.8152e-01   0.0000e+00
   5.3852e-01  -2.4777e+00   4.8884e+00  -5.2317e+00   3.0331e+00  -7.9257e-01
  -6.0912e-01   3.0103e+00  -7.1456e+00   9.9223e+00  -8.5024e+00   4.2393e+00
   2.8261e-02  -7.2922e-01   3.2518e+00  -7.4290e+00   1.0128e+01  -8.5909e+00

 Columns 7 and 8:

   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00
  -9.9960e-01   0.0000e+00
   4.2582e+00  -1.0000e+00

ans =    0.0000e+00
ans =    0.0000e+00
schurdecomp(d0):
k =

  -3.9699e-01   9.3499e-01  -6.5887e-01   6.2581e-01  -3.1213e-01

S =

   1.8146e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.8489e-02   1.9771e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   5.2118e-01  -4.2820e-01   5.5742e-01   0.0000e+00   0.0000e+00   0.0000e+00
  -4.8823e-01   1.0679e+00  -1.0257e+00   7.4101e-01   0.0000e+00   0.0000e+00
   5.9455e-01  -1.4489e+00   2.2259e+00  -1.7068e+00   9.5004e-01   0.0000e+00
  -3.1213e-01   1.1866e+00  -2.2564e+00   2.8190e+00  -1.9919e+00   1.0000e+00

schurdecomp(-d0):
km =

  -3.9699e-01   9.3499e-01  -6.5887e-01   6.2581e-01  -3.1213e-01

Sm =

  -1.8146e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   7.8489e-02  -1.9771e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -5.2118e-01   4.2820e-01  -5.5742e-01   0.0000e+00   0.0000e+00   0.0000e+00
   4.8823e-01  -1.0679e+00   1.0257e+00  -7.4101e-01   0.0000e+00   0.0000e+00
  -5.9455e-01   1.4489e+00  -2.2259e+00   1.7068e+00  -9.5004e-01   0.0000e+00
   3.1213e-01  -1.1866e+00   2.2564e+00  -2.8190e+00   1.9919e+00  -1.0000e+00

ans =    0.0000e+00
ans =    0.0000e+00
schurdecomp(d0):
k =

  -2.6973e-01   9.5268e-01   5.5808e-02   4.5026e-01   1.5593e-01

S =

   2.5777e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.2204e-02   2.6769e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   8.3893e-01  -4.6380e-01   8.8060e-01   0.0000e+00   0.0000e+00   0.0000e+00
   4.9222e-02   8.1431e-01  -4.1764e-01   8.8198e-01   0.0000e+00   0.0000e+00
   4.4476e-01  -1.5548e-01   1.3226e+00  -4.4291e-01   9.8777e-01   0.0000e+00
   1.5593e-01   3.8035e-01   5.1384e-02   1.3145e+00  -3.7819e-01   1.0000e+00

schurdecomp(-d0):
km =

  -2.6973e-01   9.5268e-01   5.5808e-02   4.5026e-01   1.5593e-01

Sm =

  -2.5777e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   7.2204e-02  -2.6769e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -8.3893e-01   4.6380e-01  -8.8060e-01   0.0000e+00   0.0000e+00   0.0000e+00
  -4.9222e-02  -8.1431e-01   4.1764e-01  -8.8198e-01   0.0000e+00   0.0000e+00
  -4.4476e-01   1.5548e-01  -1.3226e+00   4.4291e-01  -9.8777e-01   0.0000e+00
  -1.5593e-01  -3.8035e-01  -5.1384e-02  -1.3145e+00   3.7819e-01  -1.0000e+00

ans =    0.0000e+00
ans =    0.0000e+00
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $descr"

octave-cli -q $prog > test.out
if [ $? -ne 0 ]; then echo "Failed running $descr"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

