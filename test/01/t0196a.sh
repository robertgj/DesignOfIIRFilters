#!/bin/sh

prog=tfp2schurNSlattice2Abcd_test.m
depends="tfp2schurNSlattice2Abcd_test.m test_common.m \
tfp2schurNSlattice2Abcd.m tf2schurNSlattice.m tf2schurOneMlattice.m \
schurNSlattice2Abcd.oct schurOneMlattice2Abcd.oct KW.m optKW.m phi2p.m \
Abcd2tf.m schurNSlatticeNoiseGain.m schurOneMlatticeNoiseGain.m \
schurNSlatticeFilter.m schurOneMlatticeFilter.m crossWelch.m \
schurdecomp.oct schurexpand.oct schurNSscale.oct schurOneMscale.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
ng_opt =  1.0730
ans =  1.5811
ans =  1.6008
ans =  28.545
ans =  43.448
A =
 Columns 1 through 8:
   0.22123   0.97522   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.70854   0.16073   0.68712   0.00000   0.00000   0.00000   0.00000   0.00000
   0.11765  -0.02669   0.12756   0.98447   0.00000   0.00000   0.00000   0.00000
  -0.40771   0.09249  -0.44205   0.10851   0.78615   0.00000   0.00000   0.00000
   0.08214  -0.01863   0.08906  -0.02186   0.09789   0.98738   0.00000   0.00000
  -0.11020   0.02500  -0.11949   0.02933  -0.13133   0.03409  -0.26069   0.05914
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.22123   0.97522
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000  -0.70854   0.16073
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.11765  -0.02669
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000  -0.40771   0.09249
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.08214  -0.01863
   0.25431  -0.05769   0.27574  -0.06768   0.30307  -0.07866  -0.22568   0.05120
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.05372  -0.01219   0.05824  -0.01430   0.06402  -0.01662  -0.23710   0.05379
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.24788   0.05623  -0.26876   0.06597  -0.29539   0.07667   0.06005  -0.01362
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.03723   0.00844  -0.04036   0.00991  -0.04436   0.01151  -0.05068   0.01150
 Columns 9 through 16:
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.28265   0.06938  -0.31066   0.08063   0.06208  -0.01408   0.06731  -0.01652
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.68712   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.12756   0.98447   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.44205   0.10851   0.78615   0.00000   0.00000   0.00000   0.00000   0.00000
   0.08906  -0.02186   0.09789   0.98738   0.00000   0.00000   0.00000   0.00000
  -0.24469   0.06006  -0.26895   0.06980   0.23816  -0.05403   0.25822  -0.06338
   0.00000   0.00000   0.00000   0.00000   0.22123   0.97522   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000  -0.70854   0.16073   0.68712   0.00000
   0.00000   0.00000   0.00000   0.00000   0.11765  -0.02669   0.12756   0.98447
   0.00000   0.00000   0.00000   0.00000  -0.40771   0.09249  -0.44205   0.10851
   0.00000   0.00000   0.00000   0.00000   0.08214  -0.01863   0.08906  -0.02186
  -0.25707   0.06310  -0.28255   0.07334  -0.23439   0.05317  -0.25413   0.06238
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.06511  -0.01598   0.07156  -0.01857   0.20839  -0.04727   0.22594  -0.05546
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.05495   0.01349  -0.06040   0.01568   0.14336  -0.03252   0.15543  -0.03815
 Columns 17 through 24:
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.07398  -0.01920   0.03945  -0.00895   0.04277  -0.01050   0.04701  -0.01220
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.28381  -0.07366  -0.04585   0.01040  -0.04972   0.01220  -0.05464   0.01418
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.78615   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.09789   0.98738   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.27932   0.07250  -0.14284   0.03240  -0.15487   0.03802  -0.17023   0.04418
   0.00000   0.00000   0.22123   0.97522   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000  -0.70854   0.16073   0.68712   0.00000   0.00000   0.00000
   0.00000   0.00000   0.11765  -0.02669   0.12756   0.98447   0.00000   0.00000
   0.00000   0.00000  -0.40771   0.09249  -0.44205   0.10851   0.78615   0.00000
   0.00000   0.00000   0.08214  -0.01863   0.08906  -0.02186   0.09789   0.98738
   0.24834  -0.06446  -0.15989   0.03627  -0.17335   0.04255  -0.19054   0.04945
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.17084  -0.04434  -0.36062   0.08181  -0.39099   0.09598  -0.42975   0.11154
 Columns 25 through 30:
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.24177  -0.05485   0.26213  -0.06434   0.28812  -0.07478
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.05316  -0.01206   0.05763  -0.01415   0.06335  -0.01644
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.21153   0.04799  -0.22935   0.05630  -0.25208   0.06543
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.08586  -0.01948   0.09309  -0.02285   0.10232  -0.02656
   0.22123   0.97522   0.00000   0.00000   0.00000   0.00000
  -0.70854   0.16073   0.68712   0.00000   0.00000   0.00000
   0.11765  -0.02669   0.12756   0.98447   0.00000   0.00000
  -0.40771   0.09249  -0.44205   0.10851   0.78615   0.00000
   0.08214  -0.01863   0.08906  -0.02186   0.09789   0.98738
  -0.15981   0.03625  -0.17327   0.04253  -0.19045   0.04943

B =
   0.00000
   0.00000
   0.00000
   0.00000
   0.00000
   0.21376
  -0.00000
  -0.00000
  -0.00000
  -0.00000
  -0.00000
  -0.08461
   0.00000
   0.00000
   0.00000
   0.00000
   0.00000
   0.03930
  -0.00000
  -0.00000
  -0.00000
  -0.00000
  -0.00000
  -0.18521
   0.00000
   0.00000
   0.00000
   0.00000
   0.00000
   0.10553

C =
 Columns 1 through 7:
   0.816524  -0.185231   0.885306  -0.217312   0.973055  -0.252554   0.284930
 Columns 8 through 14:
  -0.064637   0.308932  -0.075832   0.339552  -0.088130   0.155018  -0.035166
 Columns 15 through 21:
   0.168076  -0.041257   0.184735  -0.047948  -0.414764   0.094090  -0.449702
 Columns 22 through 28:
   0.110386  -0.494276   0.128288   0.703007  -0.159479   0.762226  -0.187100
 Columns 29 and 30:
   0.837776  -0.217443

D =  0.24369
ABCD_nz_coefs =  286
ans =  73.315
ans =  2728.9
NG_ABCD =  6.4380
ABCDopt_nz_coefs =  961
NG_ABCDopt =  6.4380
NG_schurNS =  18.883
est_varyd =  1.6570
varyd =  1.6792
NG_schurOneM =  13.603
est_varyd =  1.2169
varyd =  1.1941
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave-cli -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

