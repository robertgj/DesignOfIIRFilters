#!/bin/sh

prog=tfp2schurNSlattice2Abcd_test.m
depends="tfp2schurNSlattice2Abcd_test.m test_common.m \
tfp2schurNSlattice2Abcd.m tf2schurNSlattice.m tf2schurOneMlattice.m \
schurNSlattice2Abcd.oct schurOneMlattice2Abcd.oct KW.m optKW.m phi2p.m \
Abcd2tf.m schurNSlatticeNoiseGain.m schurOneMlatticeNoiseGain.m \
schurNSlatticeFilter.m schurOneMlatticeFilter.m crossWelch.m \
schurdecomp.oct schurexpand.oct schurNSscale.oct schurOneMscale.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
echo $here
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
ng_opt =    1.0730e+00
ans =    1.5811e+00
ans =    1.6008e+00
ans =    2.8545e+01
ans =    4.3448e+01
A =

 Columns 1 through 6:

   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -1.1020e-01   2.5000e-02  -1.1949e-01   2.9330e-02  -1.3133e-01   3.4086e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   2.5431e-01  -5.7692e-02   2.7574e-01  -6.7684e-02   3.0307e-01  -7.8660e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   5.3718e-02  -1.2186e-02   5.8243e-02  -1.4297e-02   6.4016e-02  -1.6615e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -2.4788e-01   5.6231e-02  -2.6876e-01   6.5970e-02  -2.9539e-01   7.6669e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -3.7226e-02   8.4448e-03  -4.0362e-02   9.9074e-03  -4.4362e-02   1.1514e-02

 Columns 7 through 12:

   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -2.6069e-01   5.9138e-02  -2.8265e-01   6.9380e-02  -3.1066e-01   8.0631e-02
   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -2.2568e-01   5.1197e-02  -2.4469e-01   6.0064e-02  -2.6895e-01   6.9805e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -2.3710e-01   5.3787e-02  -2.5707e-01   6.3102e-02  -2.8255e-01   7.3336e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   6.0048e-02  -1.3622e-02   6.5106e-02  -1.5981e-02   7.1559e-02  -1.8573e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -5.0684e-02   1.1498e-02  -5.4953e-02   1.3489e-02  -6.0400e-02   1.5677e-02

 Columns 13 through 18:

   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   6.2077e-02  -1.4082e-02   6.7307e-02  -1.6521e-02   7.3978e-02  -1.9201e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   2.3816e-01  -5.4026e-02   2.5822e-01  -6.3383e-02   2.8381e-01  -7.3663e-02
   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -2.3439e-01   5.3171e-02  -2.5413e-01   6.2380e-02  -2.7932e-01   7.2496e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   2.0839e-01  -4.7273e-02   2.2594e-01  -5.5461e-02   2.4834e-01  -6.4455e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   1.4336e-01  -3.2521e-02   1.5543e-01  -3.8153e-02   1.7084e-01  -4.4340e-02

 Columns 19 through 24:

   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   3.9446e-02  -8.9485e-03   4.2769e-02  -1.0498e-02   4.7008e-02  -1.2201e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -4.5853e-02   1.0402e-02  -4.9715e-02   1.2203e-02  -5.4643e-02   1.4182e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -1.4284e-01   3.2404e-02  -1.5487e-01   3.8016e-02  -1.7023e-01   4.4181e-02
   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -1.5989e-01   3.6271e-02  -1.7335e-01   4.2552e-02  -1.9054e-01   4.9453e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -3.6062e-01   8.1807e-02  -3.9099e-01   9.5975e-02  -4.2975e-01   1.1154e-01

 Columns 25 through 30:

   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   2.4177e-01  -5.4846e-02   2.6213e-01  -6.4345e-02   2.8812e-01  -7.4780e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   5.3155e-02  -1.2058e-02   5.7633e-02  -1.4147e-02   6.3345e-02  -1.6441e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -2.1153e-01   4.7986e-02  -2.2935e-01   5.6297e-02  -2.5208e-01   6.5427e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   8.5857e-02  -1.9477e-02   9.3089e-02  -2.2850e-02   1.0232e-01  -2.6556e-02
   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -1.5981e-01   3.6254e-02  -1.7327e-01   4.2533e-02  -1.9045e-01   4.9430e-02

B =

   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   2.1376e-01
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -8.4608e-02
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   3.9298e-02
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -1.8521e-01
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   1.0553e-01

C =

 Columns 1 through 6:

   8.1652e-01  -1.8523e-01   8.8531e-01  -2.1731e-01   9.7306e-01  -2.5255e-01

 Columns 7 through 12:

   2.8493e-01  -6.4637e-02   3.0893e-01  -7.5832e-02   3.3955e-01  -8.8130e-02

 Columns 13 through 18:

   1.5502e-01  -3.5166e-02   1.6808e-01  -4.1257e-02   1.8474e-01  -4.7948e-02

 Columns 19 through 24:

  -4.1476e-01   9.4090e-02  -4.4970e-01   1.1039e-01  -4.9428e-01   1.2829e-01

 Columns 25 through 30:

   7.0301e-01  -1.5948e-01   7.6223e-01  -1.8710e-01   8.3778e-01  -2.1744e-01

D =    2.4369e-01
ABCD_nz_coefs =    2.8600e+02
ans =    7.3315e+01
ans =    2.7289e+03
NG_ABCD =    6.4380e+00
ABCDopt_nz_coefs =    9.6100e+02
NG_ABCDopt =    6.4380e+00
NG_schurNS =    1.8883e+01
est_varyd =    1.6570e+00
varyd =    1.6792e+00
NG_schurOneM =    1.3603e+01
est_varyd =    1.2169e+00
varyd =    1.1941e+00
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave-cli -q $prog > test.out
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

