#!/bin/sh

prog=tfp2schurNSlattice2Abcd_test.m
depends="tfp2schurNSlattice2Abcd_test.m test_common.m \
tfp2schurNSlattice2Abcd.m tf2schurNSlattice.m tf2schurOneMlattice.m \
schurNSlattice2Abcd.oct schurOneMlattice2Abcd.oct KW.m optKW.m phi2p.m \
Abcd2tf.m schurNSlatticeNoiseGain.m schurOneMlatticeNoiseGain.m \
schurNSlatticeFilter.m schurOneMlatticeFilter.m crossWelch.m \
schurdecomp.oct schurexpand.oct schurNSscale.oct schurOneMscale.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
echo $here
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
ng_opt =    1.0730e+00
ans =    1.5811e+00
ans =    1.6008e+00
ans =    2.8545e+01
ans =    4.3448e+01
A =

 Columns 1 through 6:

   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -1.1864e-01   2.6914e-02  -1.2863e-01   3.1575e-02  -1.4138e-01   3.6696e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   2.2794e-01  -5.1709e-02   2.4714e-01  -6.0664e-02   2.7164e-01  -7.0502e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   4.7964e-02  -1.0881e-02   5.2004e-02  -1.2765e-02   5.7159e-02  -1.4835e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -2.6052e-01   5.9100e-02  -2.8247e-01   6.9336e-02  -3.1046e-01   8.0580e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -5.1896e-02   1.1773e-02  -5.6268e-02   1.3812e-02  -6.1845e-02   1.6052e-02

 Columns 7 through 12:

   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -2.4477e-01   5.5526e-02  -2.6538e-01   6.5143e-02  -2.9169e-01   7.5707e-02
   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -2.2511e-01   5.1067e-02  -2.4407e-01   5.9911e-02  -2.6826e-01   6.9627e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -2.6117e-01   5.9247e-02  -2.8317e-01   6.9508e-02  -3.1124e-01   8.0781e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   7.3530e-02  -1.6680e-02   7.9724e-02  -1.9569e-02   8.7626e-02  -2.2743e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -4.7724e-02   1.0826e-02  -5.1744e-02   1.2701e-02  -5.6873e-02   1.4761e-02

 Columns 13 through 18:

   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   8.3989e-02  -1.9053e-02   9.1064e-02  -2.2353e-02   1.0009e-01  -2.5978e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   2.5502e-01  -5.7851e-02   2.7650e-01  -6.7871e-02   3.0391e-01  -7.8878e-02
   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -2.2252e-01   5.0478e-02  -2.4126e-01   5.9221e-02  -2.6517e-01   6.8825e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   1.8437e-01  -4.1826e-02   1.9991e-01  -4.9070e-02   2.1972e-01  -5.7028e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   1.3765e-01  -3.1226e-02   1.4924e-01  -3.6634e-02   1.6403e-01  -4.2575e-02

 Columns 19 through 24:

   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   4.3909e-02  -9.9608e-03   4.7607e-02  -1.1686e-02   5.2326e-02  -1.3581e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -4.8356e-02   1.0970e-02  -5.2429e-02   1.2869e-02  -5.7626e-02   1.4957e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -1.3370e-01   3.0330e-02  -1.4496e-01   3.5582e-02  -1.5933e-01   4.1353e-02
   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -1.5994e-01   3.6283e-02  -1.7341e-01   4.2567e-02  -1.9060e-01   4.9471e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -3.6330e-01   8.2415e-02  -3.9390e-01   9.6689e-02  -4.3294e-01   1.1237e-01

 Columns 25 through 30:

   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   2.6214e-01  -5.9466e-02   2.8422e-01  -6.9765e-02   3.1239e-01  -8.1079e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   3.9679e-02  -9.0013e-03   4.3022e-02  -1.0560e-02   4.7286e-02  -1.2273e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -1.9131e-01   4.3399e-02  -2.0743e-01   5.0916e-02  -2.2798e-01   5.9173e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   9.2583e-02  -2.1003e-02   1.0038e-01  -2.4640e-02   1.1033e-01  -2.8636e-02
   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -1.6376e-01   3.7149e-02  -1.7755e-01   4.3583e-02  -1.9515e-01   5.0651e-02

B =

   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   2.0659e-01
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -9.4928e-02
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   5.6744e-02
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -1.8519e-01
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   1.0309e-01

C =

 Columns 1 through 6:

   8.2385e-01  -1.8689e-01   8.9325e-01  -2.1926e-01   9.8179e-01  -2.5482e-01

 Columns 7 through 12:

   2.4449e-01  -5.5462e-02   2.6508e-01  -6.5068e-02   2.9135e-01  -7.5620e-02

 Columns 13 through 18:

   2.1606e-01  -4.9015e-02   2.3426e-01  -5.7503e-02   2.5748e-01  -6.6829e-02

 Columns 19 through 24:

  -4.1454e-01   9.4040e-02  -4.4946e-01   1.1033e-01  -4.9401e-01   1.2822e-01

 Columns 25 through 30:

   6.9365e-01  -1.5736e-01   7.5208e-01  -1.8461e-01   8.2662e-01  -2.1455e-01

D =    2.4369e-01
ABCD_nz_coefs =    2.8600e+02
ans =    1.1731e+02
ans =    2.8181e+03
NG_ABCD =    6.4380e+00
ABCDopt_nz_coefs =    9.6100e+02
NG_ABCDopt =    6.4380e+00
NG_schurNS =    1.8883e+01
est_varyd =    1.6570e+00
varyd =    1.6452e+00
NG_schurOneM =    1.3603e+01
est_varyd =    1.2169e+00
varyd =    1.1945e+00
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave-cli -q $prog > test.out
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

