#!/bin/sh

prog=tfp2schurNSlattice2Abcd_test.m
depends="test/tfp2schurNSlattice2Abcd_test.m test_common.m \
tfp2schurNSlattice2Abcd.m tf2schurNSlattice.m tf2schurOneMlattice.m \
schurNSlattice2Abcd.oct schurOneMlattice2Abcd.oct KW.m optKW.m phi2p.m \
Abcd2tf.m schurNSlatticeNoiseGain.m schurOneMlatticeNoiseGain.m \
schurNSlatticeFilter.m schurOneMlatticeFilter.m crossWelch.m \
schurdecomp.oct schurexpand.oct schurNSscale.oct schurOneMscale.m \
p2n60.m qroots.m qzsolve.oct"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
ng_opt = 1.0730
ans = 1.5811
ans = 1.6008
ans = 11.204
ans = 34.582
A =
 Columns 1 through 8:
   0.2212   0.9752        0        0        0        0        0        0
  -0.7085   0.1607   0.6871        0        0        0        0        0
   0.1176  -0.0267   0.1276   0.9845        0        0        0        0
  -0.4077   0.0925  -0.4421   0.1085   0.7862        0        0        0
   0.0821  -0.0186   0.0891  -0.0219   0.0979   0.9874        0        0
  -0.1086   0.0246  -0.1177   0.0289  -0.1294   0.0336  -0.2945   0.0668
        0        0        0        0        0        0   0.2212   0.9752
        0        0        0        0        0        0  -0.7085   0.1607
        0        0        0        0        0        0   0.1176  -0.0267
        0        0        0        0        0        0  -0.4077   0.0925
        0        0        0        0        0        0   0.0821  -0.0186
   0.0876  -0.0199   0.0949  -0.0233   0.1043  -0.0271  -0.1235   0.0280
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.0592  -0.0134   0.0642  -0.0157   0.0705  -0.0183  -0.1200   0.0272
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
  -0.1892   0.0429  -0.2051   0.0504  -0.2255   0.0585  -0.1521   0.0345
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.2897  -0.0657   0.3141  -0.0771   0.3453  -0.0896  -0.1691   0.0384
 Columns 9 through 16:
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
  -0.3194   0.0784  -0.3510   0.0911   0.0525  -0.0119   0.0569  -0.0140
        0        0        0        0        0        0        0        0
   0.6871        0        0        0        0        0        0        0
   0.1276   0.9845        0        0        0        0        0        0
  -0.4421   0.1085   0.7862        0        0        0        0        0
   0.0891  -0.0219   0.0979   0.9874        0        0        0        0
  -0.1339   0.0329  -0.1471   0.0382   0.1905  -0.0432   0.2065  -0.0507
        0        0        0        0   0.2212   0.9752        0        0
        0        0        0        0  -0.7085   0.1607   0.6871        0
        0        0        0        0   0.1176  -0.0267   0.1276   0.9845
        0        0        0        0  -0.4077   0.0925  -0.4421   0.1085
        0        0        0        0   0.0821  -0.0186   0.0891  -0.0219
  -0.1301   0.0319  -0.1430   0.0371  -0.2369   0.0537  -0.2569   0.0631
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
  -0.1649   0.0405  -0.1813   0.0470   0.2627  -0.0596   0.2848  -0.0699
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
  -0.1833   0.0450  -0.2015   0.0523   0.1268  -0.0288   0.1375  -0.0337
 Columns 17 through 24:
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.0626  -0.0162   0.1845  -0.0418   0.2000  -0.0491   0.2198  -0.0571
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.2270  -0.0589   0.1701  -0.0386   0.1844  -0.0453   0.2027  -0.0526
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.7862        0        0        0        0        0        0        0
   0.0979   0.9874        0        0        0        0        0        0
  -0.2823   0.0733  -0.2608   0.0592  -0.2828   0.0694  -0.3109   0.0807
        0        0   0.2212   0.9752        0        0        0        0
        0        0  -0.7085   0.1607   0.6871        0        0        0
        0        0   0.1176  -0.0267   0.1276   0.9845        0        0
        0        0  -0.4077   0.0925  -0.4421   0.1085   0.7862        0
        0        0   0.0821  -0.0186   0.0891  -0.0219   0.0979   0.9874
   0.3130  -0.0812  -0.2967   0.0673  -0.3217   0.0790  -0.3536   0.0918
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.1511  -0.0392  -0.1536   0.0349  -0.1666   0.0409  -0.1831   0.0475
 Columns 25 through 30:
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
  -0.0874   0.0198  -0.0948   0.0233  -0.1042   0.0270
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
  -0.0356   0.0081  -0.0386   0.0095  -0.0424   0.0110
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
  -0.1964   0.0445  -0.2129   0.0523  -0.2340   0.0607
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
   0.1590  -0.0361   0.1724  -0.0423   0.1895  -0.0492
   0.2212   0.9752        0        0        0        0
  -0.7085   0.1607   0.6871        0        0        0
   0.1176  -0.0267   0.1276   0.9845        0        0
  -0.4077   0.0925  -0.4421   0.1085   0.7862        0
   0.0821  -0.0186   0.0891  -0.0219   0.0979   0.9874
  -0.1243   0.0282  -0.1348   0.0331  -0.1482   0.0385

B =
        0
        0
        0
        0
        0
   0.2147
        0
        0
        0
        0
        0
  -0.2021
        0
        0
        0
        0
        0
   0.0352
        0
        0
        0
        0
        0
  -0.0611
        0
        0
        0
        0
        0
   0.0892

C =
 Columns 1 through 7:
   0.815461  -0.184990   0.884154  -0.217029   0.971789  -0.252225  -0.355733
 Columns 8 through 14:
   0.080699  -0.385699   0.094676  -0.423929   0.110030   0.141773  -0.032162
 Columns 15 through 21:
   0.153716  -0.037732   0.168951  -0.043851   0.205869  -0.046702   0.223211
 Columns 22 through 28:
  -0.054790   0.245335  -0.063676   0.764310  -0.173386   0.828693  -0.203415
 Columns 29 and 30:
   0.910831  -0.236404

D = 0.2437
ABCD_nz_coefs = 286
ans = 137.24
ans = 3463.2
NG_ABCD = 6.4380
ABCDopt_nz_coefs = 961
NG_ABCDopt = 6.4380
NG_schurNS = 18.883
est_varyd = 1.6569
varyd = 1.7615
NG_schurOneM = 13.603
est_varyd = 1.2169
varyd = 1.3363
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave --no-gui -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

