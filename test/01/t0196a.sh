#!/bin/sh

prog=tfp2schurNSlattice2Abcd_test.m
depends="tfp2schurNSlattice2Abcd_test.m test_common.m \
tfp2schurNSlattice2Abcd.m tf2schurNSlattice.m tf2schurOneMlattice.m \
schurNSlattice2Abcd.oct schurOneMlattice2Abcd.oct KW.m optKW.m phi2p.m \
Abcd2tf.m schurNSlatticeNoiseGain.m schurOneMlatticeNoiseGain.m \
schurNSlatticeFilter.m schurOneMlatticeFilter.m crossWelch.m \
schurdecomp.oct schurexpand.oct schurNSscale.oct schurOneMscale.m \
p2n60.m qroots.m qzsolve.oct"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
ng_opt = 1.0730
ans = 1.5811
ans = 1.6008
ans = 28.545
ans = 43.448
A =
 Columns 1 through 8:
   0.2212   0.9752        0        0        0        0        0        0
  -0.7085   0.1607   0.6871        0        0        0        0        0
   0.1176  -0.0267   0.1276   0.9845        0        0        0        0
  -0.4077   0.0925  -0.4421   0.1085   0.7862        0        0        0
   0.0821  -0.0186   0.0891  -0.0219   0.0979   0.9874        0        0
  -0.1102   0.0250  -0.1195   0.0293  -0.1313   0.0341  -0.2607   0.0591
        0        0        0        0        0        0   0.2212   0.9752
        0        0        0        0        0        0  -0.7085   0.1607
        0        0        0        0        0        0   0.1176  -0.0267
        0        0        0        0        0        0  -0.4077   0.0925
        0        0        0        0        0        0   0.0821  -0.0186
   0.2543  -0.0577   0.2757  -0.0677   0.3031  -0.0787  -0.2257   0.0512
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.0537  -0.0122   0.0582  -0.0143   0.0640  -0.0166  -0.2371   0.0538
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
  -0.2479   0.0562  -0.2688   0.0660  -0.2954   0.0767   0.0600  -0.0136
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
  -0.0372   0.0084  -0.0404   0.0099  -0.0444   0.0115  -0.0507   0.0115
 Columns 9 through 16:
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
  -0.2826   0.0694  -0.3107   0.0806   0.0621  -0.0141   0.0673  -0.0165
        0        0        0        0        0        0        0        0
   0.6871        0        0        0        0        0        0        0
   0.1276   0.9845        0        0        0        0        0        0
  -0.4421   0.1085   0.7862        0        0        0        0        0
   0.0891  -0.0219   0.0979   0.9874        0        0        0        0
  -0.2447   0.0601  -0.2689   0.0698   0.2382  -0.0540   0.2582  -0.0634
        0        0        0        0   0.2212   0.9752        0        0
        0        0        0        0  -0.7085   0.1607   0.6871        0
        0        0        0        0   0.1176  -0.0267   0.1276   0.9845
        0        0        0        0  -0.4077   0.0925  -0.4421   0.1085
        0        0        0        0   0.0821  -0.0186   0.0891  -0.0219
  -0.2571   0.0631  -0.2826   0.0733  -0.2344   0.0532  -0.2541   0.0624
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.0651  -0.0160   0.0716  -0.0186   0.2084  -0.0473   0.2259  -0.0555
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
  -0.0550   0.0135  -0.0604   0.0157   0.1434  -0.0325   0.1554  -0.0382
 Columns 17 through 24:
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.0740  -0.0192   0.0394  -0.0089   0.0428  -0.0105   0.0470  -0.0122
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.2838  -0.0737  -0.0459   0.0104  -0.0497   0.0122  -0.0546   0.0142
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.7862        0        0        0        0        0        0        0
   0.0979   0.9874        0        0        0        0        0        0
  -0.2793   0.0725  -0.1428   0.0324  -0.1549   0.0380  -0.1702   0.0442
        0        0   0.2212   0.9752        0        0        0        0
        0        0  -0.7085   0.1607   0.6871        0        0        0
        0        0   0.1176  -0.0267   0.1276   0.9845        0        0
        0        0  -0.4077   0.0925  -0.4421   0.1085   0.7862        0
        0        0   0.0821  -0.0186   0.0891  -0.0219   0.0979   0.9874
   0.2483  -0.0645  -0.1599   0.0363  -0.1734   0.0426  -0.1905   0.0495
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   0.1708  -0.0443  -0.3606   0.0818  -0.3910   0.0960  -0.4297   0.1115
 Columns 25 through 30:
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
   0.2418  -0.0548   0.2621  -0.0643   0.2881  -0.0748
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
   0.0532  -0.0121   0.0576  -0.0141   0.0633  -0.0164
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
  -0.2115   0.0480  -0.2293   0.0563  -0.2521   0.0654
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
        0        0        0        0        0        0
   0.0859  -0.0195   0.0931  -0.0229   0.1023  -0.0266
   0.2212   0.9752        0        0        0        0
  -0.7085   0.1607   0.6871        0        0        0
   0.1176  -0.0267   0.1276   0.9845        0        0
  -0.4077   0.0925  -0.4421   0.1085   0.7862        0
   0.0821  -0.0186   0.0891  -0.0219   0.0979   0.9874
  -0.1598   0.0363  -0.1733   0.0425  -0.1904   0.0494

B =
        0
        0
        0
        0
        0
   0.2138
        0
        0
        0
        0
        0
  -0.0846
        0
        0
        0
        0
        0
   0.0393
        0
        0
        0
        0
        0
  -0.1852
        0
        0
        0
        0
        0
   0.1055

C =
 Columns 1 through 7:
   0.816524  -0.185231   0.885306  -0.217312   0.973055  -0.252554   0.284930
 Columns 8 through 14:
  -0.064637   0.308932  -0.075832   0.339552  -0.088130   0.155018  -0.035166
 Columns 15 through 21:
   0.168076  -0.041257   0.184735  -0.047948  -0.414764   0.094090  -0.449702
 Columns 22 through 28:
   0.110386  -0.494276   0.128288   0.703007  -0.159479   0.762226  -0.187100
 Columns 29 and 30:
   0.837776  -0.217443

D = 0.2437
ABCD_nz_coefs = 286
ans = 73.315
ans = 2728.9
NG_ABCD = 6.4380
ABCDopt_nz_coefs = 961
NG_ABCDopt = 6.4380
NG_schurNS = 18.883
est_varyd = 1.6570
varyd = 1.7615
NG_schurOneM = 13.603
est_varyd = 1.2169
varyd = 1.3363
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave-cli -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

