#!/bin/sh

prog=tfp2schurNSlattice2Abcd_test.m
depends="tfp2schurNSlattice2Abcd_test.m test_common.m \
tfp2schurNSlattice2Abcd.m tf2schurNSlattice.m tf2schurOneMlattice.m \
schurNSlattice2Abcd.oct schurOneMlattice2Abcd.oct KW.m optKW.m phi2p.m \
Abcd2tf.m schurNSlatticeNoiseGain.m schurOneMlatticeNoiseGain.m \
schurNSlatticeFilter.m schurOneMlatticeFilter.m crossWelch.m \
schurdecomp.oct schurexpand.oct schurNSscale.oct schurOneMscale.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
echo $here
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
ng_opt =    1.0730e+00
ans =    1.5811e+00
ans =    1.6008e+00
ans =    6.7613e+01
ans =    7.7946e+01
A =

 Columns 1 through 6:

   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -1.1871e-01   2.6929e-02  -1.2871e-01   3.1593e-02  -1.4146e-01   3.6716e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   2.2769e-01  -5.1651e-02   2.4687e-01  -6.0597e-02   2.7134e-01  -7.0424e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   4.8540e-02  -1.1011e-02   5.2629e-02  -1.2918e-02   5.7845e-02  -1.5014e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -2.6061e-01   5.9121e-02  -2.8257e-01   6.9360e-02  -3.1057e-01   8.0609e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -5.2005e-02   1.1798e-02  -5.6386e-02   1.3841e-02  -6.1975e-02   1.6085e-02

 Columns 7 through 12:

   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -2.4476e-01   5.5525e-02  -2.6538e-01   6.5141e-02  -2.9168e-01   7.5705e-02
   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -2.2510e-01   5.1064e-02  -2.4406e-01   5.9908e-02  -2.6825e-01   6.9624e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -2.6134e-01   5.9286e-02  -2.8336e-01   6.9554e-02  -3.1144e-01   8.0834e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   7.3114e-02  -1.6586e-02   7.9273e-02  -1.9459e-02   8.7131e-02  -2.2615e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -4.7972e-02   1.0882e-02  -5.2013e-02   1.2767e-02  -5.7168e-02   1.4838e-02

 Columns 13 through 18:

   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   8.3509e-02  -1.8944e-02   9.0543e-02  -2.2225e-02   9.9518e-02  -2.5830e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   2.5516e-01  -5.7883e-02   2.7665e-01  -6.7908e-02   3.0407e-01  -7.8922e-02
   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -2.2243e-01   5.0459e-02  -2.4117e-01   5.9199e-02  -2.6507e-01   6.8799e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   1.8435e-01  -4.1820e-02   1.9988e-01  -4.9063e-02   2.1969e-01  -5.7020e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   1.3753e-01  -3.1200e-02   1.4912e-01  -3.6603e-02   1.6390e-01  -4.2539e-02

 Columns 19 through 24:

   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   4.3932e-02  -9.9660e-03   4.7632e-02  -1.1692e-02   5.2353e-02  -1.3588e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -4.8073e-02   1.0906e-02  -5.2123e-02   1.2794e-02  -5.7289e-02   1.4869e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -1.3373e-01   3.0338e-02  -1.4500e-01   3.5592e-02  -1.5937e-01   4.1364e-02
   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -1.5991e-01   3.6277e-02  -1.7338e-01   4.2560e-02  -1.9057e-01   4.9462e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -3.6331e-01   8.2418e-02  -3.9392e-01   9.6693e-02  -4.3296e-01   1.1237e-01

 Columns 25 through 30:

   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   2.6228e-01  -5.9500e-02   2.8438e-01  -6.9805e-02   3.1256e-01  -8.1125e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   4.0079e-02  -9.0920e-03   4.3455e-02  -1.0667e-02   4.7762e-02  -1.2396e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -1.9106e-01   4.3342e-02  -2.0715e-01   5.0848e-02  -2.2768e-01   5.9094e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   9.2629e-02  -2.1013e-02   1.0043e-01  -2.4652e-02   1.1039e-01  -2.8650e-02
   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -1.6381e-01   3.7162e-02  -1.7761e-01   4.3598e-02  -1.9522e-01   5.0668e-02

B =

   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   2.0658e-01
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -9.5024e-02
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   5.6686e-02
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -1.8520e-01
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   1.0306e-01

C =

 Columns 1 through 6:

   8.2375e-01  -1.8687e-01   8.9314e-01  -2.1924e-01   9.8167e-01  -2.5479e-01

 Columns 7 through 12:

   2.4410e-01  -5.5375e-02   2.6466e-01  -6.4966e-02   2.9090e-01  -7.5502e-02

 Columns 13 through 18:

   2.1713e-01  -4.9257e-02   2.3542e-01  -5.7788e-02   2.5876e-01  -6.7160e-02

 Columns 19 through 24:

  -4.1454e-01   9.4040e-02  -4.4946e-01   1.1033e-01  -4.9401e-01   1.2822e-01

 Columns 25 through 30:

   6.9356e-01  -1.5734e-01   7.5199e-01  -1.8459e-01   8.2652e-01  -2.1452e-01

D =    2.4369e-01
ABCD_nz_coefs =    2.8600e+02
ans =    7.6255e+01
ans =    1.9984e+03
NG_ABCD =    6.4380e+00
ABCDopt_nz_coefs =    9.6100e+02
NG_ABCDopt =    6.4380e+00
NG_schurNS =    1.8883e+01
est_varyd =    1.6570e+00
varyd =    1.6452e+00
NG_schurOneM =    1.3603e+01
est_varyd =    1.2169e+00
varyd =    1.1945e+00
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave-cli -q $prog > test.out
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

