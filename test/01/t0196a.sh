#!/bin/sh

prog=tfp2schurNSlattice2Abcd_test.m
depends="tfp2schurNSlattice2Abcd_test.m test_common.m \
tfp2schurNSlattice2Abcd.m tf2schurNSlattice.m tf2schurOneMlattice.m \
schurNSlattice2Abcd.oct schurOneMlattice2Abcd.oct KW.m optKW.m phi2p.m \
Abcd2tf.m schurNSlatticeNoiseGain.m schurOneMlatticeNoiseGain.m \
schurNSlatticeFilter.m schurOneMlatticeFilter.m crossWelch.m \
schurdecomp.oct schurexpand.oct schurNSscale.oct schurOneMscale.m"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
echo $here
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
ng_opt =    1.0730e+00
ans =    1.5811e+00
ans =    1.6008e+00
ans =    2.8545e+01
ans =    4.3448e+01
A =

 Columns 1 through 6:

   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -1.1897e-01   2.6989e-02  -1.2899e-01   3.1664e-02  -1.4178e-01   3.6799e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   2.3159e-01  -5.2536e-02   2.5109e-01  -6.1635e-02   2.7598e-01  -7.1630e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   6.3206e-02  -1.4338e-02   6.8530e-02  -1.6822e-02   7.5322e-02  -1.9550e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -2.6570e-01   6.0276e-02  -2.8809e-01   7.0715e-02  -3.1664e-01   8.2183e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -5.0413e-02   1.1436e-02  -5.4659e-02   1.3417e-02  -6.0077e-02   1.5593e-02

 Columns 7 through 12:

   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -2.3636e-01   5.3619e-02  -2.5627e-01   6.2905e-02  -2.8167e-01   7.3107e-02
   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -2.2571e-01   5.1204e-02  -2.4473e-01   6.0072e-02  -2.6898e-01   6.9814e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -2.6032e-01   5.9053e-02  -2.8224e-01   6.9281e-02  -3.1022e-01   8.0517e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   5.8965e-02  -1.3376e-02   6.3932e-02  -1.5693e-02   7.0269e-02  -1.8238e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -5.0486e-02   1.1453e-02  -5.4738e-02   1.3436e-02  -6.0164e-02   1.5615e-02

 Columns 13 through 18:

   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   7.0422e-02  -1.5975e-02   7.6354e-02  -1.8742e-02   8.3922e-02  -2.1782e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   2.6138e-01  -5.9294e-02   2.8339e-01  -6.9563e-02   3.1148e-01  -8.0844e-02
   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -2.2120e-01   5.0181e-02  -2.3984e-01   5.8872e-02  -2.6361e-01   6.8419e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   1.8189e-01  -4.1263e-02   1.9722e-01  -4.8410e-02   2.1676e-01  -5.6260e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   1.3686e-01  -3.1047e-02   1.4839e-01  -3.6425e-02   1.6310e-01  -4.2332e-02

 Columns 19 through 24:

   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   4.7310e-02  -1.0732e-02   5.1295e-02  -1.2591e-02   5.6379e-02  -1.4633e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -4.6017e-02   1.0439e-02  -4.9893e-02   1.2247e-02  -5.4839e-02   1.4233e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -1.3280e-01   3.0126e-02  -1.4399e-01   3.5344e-02  -1.5826e-01   4.1075e-02
   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -1.6002e-01   3.6301e-02  -1.7350e-01   4.2588e-02  -1.9070e-01   4.9495e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -3.6355e-01   8.2472e-02  -3.9417e-01   9.6756e-02  -4.3324e-01   1.1245e-01

 Columns 25 through 30:

   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   2.6147e-01  -5.9314e-02   2.8349e-01  -6.9587e-02   3.1159e-01  -8.0872e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   5.4252e-02  -1.2307e-02   5.8822e-02  -1.4439e-02   6.4653e-02  -1.6780e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -1.8888e-01   4.2848e-02  -2.0479e-01   5.0269e-02  -2.2509e-01   5.8422e-02
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
   9.3209e-02  -2.1145e-02   1.0106e-01  -2.4807e-02   1.1108e-01  -2.8830e-02
   2.2123e-01   9.7522e-01   0.0000e+00   0.0000e+00   0.0000e+00   0.0000e+00
  -7.0854e-01   1.6073e-01   6.8712e-01   0.0000e+00   0.0000e+00   0.0000e+00
   1.1765e-01  -2.6689e-02   1.2756e-01   9.8447e-01   0.0000e+00   0.0000e+00
  -4.0771e-01   9.2490e-02  -4.4205e-01   1.0851e-01   7.8615e-01   0.0000e+00
   8.2140e-02  -1.8634e-02   8.9060e-02  -2.1861e-02   9.7887e-02   9.8738e-01
  -1.6405e-01   3.7216e-02  -1.7787e-01   4.3662e-02  -1.9550e-01   5.0743e-02

B =

   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   2.1117e-01
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -8.3230e-02
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   5.8554e-02
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -0.0000e+00
  -1.8515e-01
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   0.0000e+00
   1.0301e-01

C =

 Columns 1 through 6:

   8.0790e-01  -1.8327e-01   8.7596e-01  -2.1502e-01   9.6278e-01  -2.4989e-01

 Columns 7 through 12:

   2.9024e-01  -6.5841e-02   3.1469e-01  -7.7245e-02   3.4588e-01  -8.9772e-02

 Columns 13 through 18:

   2.2256e-01  -5.0488e-02   2.4130e-01  -5.9232e-02   2.6522e-01  -6.8838e-02

 Columns 19 through 24:

  -4.1415e-01   9.3952e-02  -4.4904e-01   1.1022e-01  -4.9355e-01   1.2810e-01

 Columns 25 through 30:

   6.9295e-01  -1.5720e-01   7.5132e-01  -1.8442e-01   8.2579e-01  -2.1433e-01

D =    2.4369e-01
ABCD_nz_coefs =    2.8600e+02
ans =    8.2257e+01
ans =    5.1429e+03
NG_ABCD =    6.4380e+00
ABCDopt_nz_coefs =    9.6100e+02
NG_ABCDopt =    6.4380e+00
NG_schurNS =    1.8883e+01
est_varyd =    1.6569e+00
varyd =    1.6452e+00
NG_schurOneM =    1.3603e+01
est_varyd =    1.2169e+00
varyd =    1.1945e+00
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave-cli -q $prog > test.out
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

