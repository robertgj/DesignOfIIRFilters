#!/bin/sh

prog=schurNSscale_test.m
descr="schurNSscale_test.m (mfile)"
depends="test/schurNSscale_test.m test_common.m check_octave_file.m \
schurNSlatticeFilter.m schurNSscale.m schurdecomp.oct schurexpand.oct"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $descr 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $descr
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
Using schurNSscale mfile
Caught schurNSscale([],1)!
c is empty
Caught schurNSscale([1 1],[1 1])!
(length(k)+1) ~= length(c)
warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 29 column 27

s10 = 1
s11 = 0
s20 = 1
s00 = 0
s02 = -1
s22 = 0
k = -0.1584
S =
   0.9874        0
  -0.1584   1.0000

c =
   0.4937   0.4208

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 37 column 27

s10 = 0.4208
s11 = 0.4937
s20 = -0.1584
s00 = 0.9874
s02 = 0.1584
s22 = 0.9874
k =
  -0.3627   0.9744  -0.6339   0.8110  -0.6976   0.5488  -0.2391

S =
   0.0551        0        0        0        0        0        0        0
  -0.0215   0.0592        0        0        0        0        0        0
   0.2564  -0.1885   0.2632        0        0        0        0        0
  -0.2157   0.4860  -0.4538   0.3403        0        0        0        0
   0.4716  -0.9978   1.5044  -1.0747   0.5816        0        0        0
  -0.5662   1.7046  -2.8572   3.0711  -1.9591   0.8117        0        0
   0.5329  -1.9637   4.0556  -5.2940   4.7930  -2.7154   0.9710        0
  -0.2391   1.2175  -3.2025   5.4802  -6.4507   5.4197  -2.9278   1.0000

c =
 Columns 1 through 7:
  -0.179050  -0.191678   0.039563   0.379960   0.356560   0.192704   0.066556
 Column 8:
   0.013687

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 47 column 27

s10 =
  -0.730770   0.149147   0.819950   0.609821   0.313018   0.107484   0.013687

s11 =
  -0.6826   0.9888   0.5724   0.7925   0.9497   0.9942   0.6192

s20 =
  -0.3627   0.9744  -0.6339   0.8110  -0.6976   0.5488  -0.2391

s00 =
   0.9319   0.2249   0.7734   0.5851   0.7165   0.8359   0.9710

s02 =
   0.3627  -0.9744   0.6339  -0.8110   0.6976  -0.5488   0.2391

s22 =
   0.9319   0.2249   0.7734   0.5851   0.7165   0.8359   0.9710

km =
  -0.3627   0.9744  -0.6339   0.8110  -0.6976   0.5488  -0.2391

Sm =
  -0.0551        0        0        0        0        0        0        0
   0.0215  -0.0592        0        0        0        0        0        0
  -0.2564   0.1885  -0.2632        0        0        0        0        0
   0.2157  -0.4860   0.4538  -0.3403        0        0        0        0
  -0.4716   0.9978  -1.5044   1.0747  -0.5816        0        0        0
   0.5662  -1.7046   2.8572  -3.0711   1.9591  -0.8117        0        0
  -0.5329   1.9637  -4.0556   5.2940  -4.7930   2.7154  -0.9710        0
   0.2391  -1.2175   3.2025  -5.4802   6.4507  -5.4197   2.9278  -1.0000

cm =
 Columns 1 through 7:
   0.179050   0.191678  -0.039563  -0.379960  -0.356560  -0.192704  -0.066556
 Column 8:
  -0.013687

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 50 column 33

s10m =
   0.730770  -0.149147  -0.819950  -0.609821  -0.313018  -0.107484  -0.013687

s11m =
   0.6826   0.9888   0.5724   0.7925   0.9497   0.9942   0.6192

s20m =
  -0.3627   0.9744  -0.6339   0.8110  -0.6976   0.5488  -0.2391

s00m =
   0.9319   0.2249   0.7734   0.5851   0.7165   0.8359   0.9710

s02m =
   0.3627  -0.9744   0.6339  -0.8110   0.6976  -0.5488   0.2391

s22m =
   0.9319   0.2249   0.7734   0.5851   0.7165   0.8359   0.9710

ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
stdxf =
   125.32   125.01   128.43   128.57   131.00   128.94   128.66

k =
  -0.282986   0.986441  -0.073636   0.780646   0.243641   0.290874   0.113694

S =
   0.0904        0        0        0        0        0        0        0
  -0.0267   0.0943        0        0        0        0        0        0
   0.5668  -0.3230   0.5746        0        0        0        0        0
  -0.0424   0.5922  -0.3657   0.5762        0        0        0        0
   0.7197  -0.5247   1.6873  -0.6382   0.9219        0        0        0
   0.2316   0.5817  -0.1172   1.6079  -0.4772   0.9506        0        0
   0.2890   0.0970   1.0968  -0.1581   1.8574  -0.4284   0.9935        0
   0.1137   0.2419   0.3102   1.0859  -0.0336   1.8806  -0.3981   1.0000

k =
  -0.282986   0.986441  -0.073636   0.780646   0.243641   0.290874   0.113694

S =
   0.0904        0        0        0        0        0        0        0
  -0.0267   0.0943        0        0        0        0        0        0
   0.5668  -0.3230   0.5746        0        0        0        0        0
  -0.0424   0.5922  -0.3657   0.5762        0        0        0        0
   0.7197  -0.5247   1.6873  -0.6382   0.9219        0        0        0
   0.2316   0.5817  -0.1172   1.6079  -0.4772   0.9506        0        0
   0.2890   0.0970   1.0968  -0.1581   1.8574  -0.4284   0.9935        0
   0.1137   0.2419   0.3102   1.0859  -0.0336   1.8806  -0.3981   1.0000

c =
 Columns 1 through 6:
  -2.2955e-01  -8.7552e-03   2.6614e-01  -1.2044e-01  -3.3385e-01   4.9552e-01
 Columns 7 and 8:
  -2.7118e-01   6.1456e-02

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 78 column 27

s10 =
  -0.038113   0.757008  -0.324091  -0.668287   0.704226  -0.359613   0.061456

s11 =
  -0.9993   0.6534   0.9460   0.7439   0.7100   0.9331   0.7541

s20 =
  -0.282986   0.986441  -0.073636   0.780646   0.243641   0.290874   0.113694

s00 =
   0.9591   0.1641   0.9973   0.6250   0.9699   0.9568   0.9935

s02 =
   0.282986  -0.986441   0.073636  -0.780646  -0.243641  -0.290874  -0.113694

s22 =
   0.9591   0.1641   0.9973   0.6250   0.9699   0.9568   0.9935

km =
  -0.282986   0.986441  -0.073636   0.780646   0.243641   0.290874   0.113694

Sm =
  -0.0904        0        0        0        0        0        0        0
   0.0267  -0.0943        0        0        0        0        0        0
  -0.5668   0.3230  -0.5746        0        0        0        0        0
   0.0424  -0.5922   0.3657  -0.5762        0        0        0        0
  -0.7197   0.5247  -1.6873   0.6382  -0.9219        0        0        0
  -0.2316  -0.5817   0.1172  -1.6079   0.4772  -0.9506        0        0
  -0.2890  -0.0970  -1.0968   0.1581  -1.8574   0.4284  -0.9935        0
  -0.1137  -0.2419  -0.3102  -1.0859   0.0336  -1.8806   0.3981  -1.0000

cm =
 Columns 1 through 6:
   2.2955e-01   8.7552e-03  -2.6614e-01   1.2044e-01   3.3385e-01  -4.9552e-01
 Columns 7 and 8:
   2.7118e-01  -6.1456e-02

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 81 column 33

s10m =
   0.038113  -0.757008   0.324091   0.668287  -0.704226   0.359613  -0.061456

s11m =
   0.9993   0.6534   0.9460   0.7439   0.7100   0.9331   0.7541

s20m =
  -0.282986   0.986441  -0.073636   0.780646   0.243641   0.290874   0.113694

s00m =
   0.9591   0.1641   0.9973   0.6250   0.9699   0.9568   0.9935

s02m =
   0.282986  -0.986441   0.073636  -0.780646  -0.243641  -0.290874  -0.113694

s22m =
   0.9591   0.1641   0.9973   0.6250   0.9699   0.9568   0.9935

ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
k =
  -0.8428   0.9841  -0.9282   0.9443  -0.9276   0.8589  -0.4885

S =
    0.0020         0         0         0         0         0         0         0
   -0.0031    0.0036         0         0         0         0         0         0
    0.0201   -0.0342    0.0204         0         0         0         0         0
   -0.0510    0.1394   -0.1421    0.0550         0         0         0         0
    0.1576   -0.5625    0.8232   -0.5780    0.1669         0         0         0
   -0.4145    1.8568   -3.5493    3.5999   -1.9383    0.4468         0         0
    0.7495   -4.0606    9.6645  -12.8851   10.1446   -4.4804    0.8726         0
   -0.4885    3.3673  -10.3333   18.2900  -20.1779   13.8998   -5.5544    1.0000

c =
 Columns 1 through 6:
  -1.5000e-02   2.4955e-01   2.7252e-01   2.0692e-01   1.0782e-01   3.5239e-02
 Columns 7 and 8:
   9.9566e-03   2.6796e-03

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 97 column 27

s10 =
 Columns 1 through 6:
   9.9820e-01   7.3690e-01   4.8828e-01   2.4657e-01   8.0329e-02   2.2691e-02
 Column 7:
   2.6796e-03

s11 =
  -0.060000   0.676005   0.872685   0.969126   0.996768   0.999743   0.438799

s20 =
  -0.8428   0.9841  -0.9282   0.9443  -0.9276   0.8589  -0.4885

s00 =
   0.5382   0.1775   0.3721   0.3292   0.3736   0.5121   0.8726

s02 =
   0.8428  -0.9841   0.9282  -0.9443   0.9276  -0.8589   0.4885

s22 =
   0.5382   0.1775   0.3721   0.3292   0.3736   0.5121   0.8726

km =
  -0.8428   0.9841  -0.9282   0.9443  -0.9276   0.8589  -0.4885

Sm =
   -0.0020         0         0         0         0         0         0         0
    0.0031   -0.0036         0         0         0         0         0         0
   -0.0201    0.0342   -0.0204         0         0         0         0         0
    0.0510   -0.1394    0.1421   -0.0550         0         0         0         0
   -0.1576    0.5625   -0.8232    0.5780   -0.1669         0         0         0
    0.4145   -1.8568    3.5493   -3.5999    1.9383   -0.4468         0         0
   -0.7495    4.0606   -9.6645   12.8851  -10.1446    4.4804   -0.8726         0
    0.4885   -3.3673   10.3333  -18.2900   20.1779  -13.8998    5.5544   -1.0000

cm =
 Columns 1 through 6:
   1.5000e-02  -2.4955e-01  -2.7252e-01  -2.0692e-01  -1.0782e-01  -3.5239e-02
 Columns 7 and 8:
  -9.9566e-03  -2.6796e-03

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 100 column 33

s10m =
 Columns 1 through 6:
  -9.9820e-01  -7.3690e-01  -4.8828e-01  -2.4657e-01  -8.0329e-02  -2.2691e-02
 Column 7:
  -2.6796e-03

s11m =
   0.060000   0.676005   0.872685   0.969126   0.996768   0.999743   0.438799

s20m =
  -0.8428   0.9841  -0.9282   0.9443  -0.9276   0.8589  -0.4885

s00m =
   0.5382   0.1775   0.3721   0.3292   0.3736   0.5121   0.8726

s02m =
   0.8428  -0.9841   0.9282  -0.9443   0.9276  -0.8589   0.4885

s22m =
   0.5382   0.1775   0.3721   0.3292   0.3736   0.5121   0.8726

ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
k =
 Columns 1 through 6:
  -8.0459e-01   9.9615e-01  -7.7401e-01   9.3306e-01  -5.8373e-01   4.1918e-01
 Column 7:
  -8.5391e-03

S =
   0.0087        0        0        0        0        0        0        0
  -0.0118   0.0147        0        0        0        0        0        0
   0.1673  -0.2697   0.1679        0        0        0        0        0
  -0.2052   0.5938  -0.6303   0.2652        0        0        0        0
   0.6878  -2.2055   3.1908  -2.2846   0.7371        0        0        0
  -0.5299   2.4896  -5.0103   5.5154  -3.3082   0.9079        0        0
   0.4192  -2.1111   5.2886  -7.8318   7.2243  -3.8885   1.0000        0
  -0.0085   0.4524  -2.1729   5.3557  -7.8772   7.2426  -3.8922   1.0000

c =
   0.1208   0.1418  -0.1885  -0.1795   0.2730   0.3220  -0.6457   0.2510

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 115 column 27

s10 =
   0.7610  -0.7113  -0.5609   0.6489   0.6078  -0.7731   0.2510

s11 =
   0.6487   0.7029   0.8279   0.7609   0.7941   0.6343   0.8353

s20 =
 Columns 1 through 6:
  -8.0459e-01   9.9615e-01  -7.7401e-01   9.3306e-01  -5.8373e-01   4.1918e-01
 Column 7:
  -8.5391e-03

s00 =
   0.593827   0.087715   0.633178   0.359732   0.811950   0.907902   0.999964

s02 =
 Columns 1 through 6:
   8.0459e-01  -9.9615e-01   7.7401e-01  -9.3306e-01   5.8373e-01  -4.1918e-01
 Column 7:
   8.5391e-03

s22 =
   0.593827   0.087715   0.633178   0.359732   0.811950   0.907902   0.999964

km =
 Columns 1 through 6:
  -8.0459e-01   9.9615e-01  -7.7401e-01   9.3306e-01  -5.8373e-01   4.1918e-01
 Column 7:
  -8.5391e-03

Sm =
  -0.0087        0        0        0        0        0        0        0
   0.0118  -0.0147        0        0        0        0        0        0
  -0.1673   0.2697  -0.1679        0        0        0        0        0
   0.2052  -0.5938   0.6303  -0.2652        0        0        0        0
  -0.6878   2.2055  -3.1908   2.2846  -0.7371        0        0        0
   0.5299  -2.4896   5.0103  -5.5154   3.3082  -0.9079        0        0
  -0.4192   2.1111  -5.2886   7.8318  -7.2243   3.8885  -1.0000        0
   0.0085  -0.4524   2.1729  -5.3557   7.8772  -7.2426   3.8922  -1.0000

cm =
  -0.1208  -0.1418   0.1885   0.1795  -0.2730  -0.3220   0.6457  -0.2510

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 118 column 33

s10m =
  -0.7610   0.7113   0.5609  -0.6489  -0.6078   0.7731  -0.2510

s11m =
  -0.6487   0.7029   0.8279   0.7609   0.7941   0.6343   0.8353

s20m =
 Columns 1 through 6:
  -8.0459e-01   9.9615e-01  -7.7401e-01   9.3306e-01  -5.8373e-01   4.1918e-01
 Column 7:
  -8.5391e-03

s00m =
   0.593827   0.087715   0.633178   0.359732   0.811950   0.907902   0.999964

s02m =
 Columns 1 through 6:
   8.0459e-01  -9.9615e-01   7.7401e-01  -9.3306e-01   5.8373e-01  -4.1918e-01
 Column 7:
   8.5391e-03

s22m =
   0.593827   0.087715   0.633178   0.359732   0.811950   0.907902   0.999964

ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match. Suppress m-file warnings.
#
echo "Running $descr"
octave --no-gui -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $descr"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

