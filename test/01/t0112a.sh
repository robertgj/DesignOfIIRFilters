#!/bin/sh

prog=schurNSscale_test.m
descr="schurNSscale_test.m (mfile)"
depends="schurNSscale_test.m test_common.m check_octave_file.m \
schurNSlatticeFilter.m schurNSscale.m schurdecomp.oct schurexpand.oct"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $descr 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $descr
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
Using schurNSscale mfile
Caught schurNSscale([],1)!
c is empty
Caught schurNSscale([1 1],[1 1])!
(length(k)+1) ~= length(c)
warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 29 column 27
s10 =  1
s11 = 0
s20 =  1
s00 = 0
s02 = -1
s22 = 0
k = -0.15838
S =
   0.98738   0.00000
  -0.15838   1.00000

c =
   0.49369   0.42081

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 37 column 27
s10 =  0.42081
s11 =  0.49369
s20 = -0.15838
s00 =  0.98738
s02 =  0.15838
s22 =  0.98738
k =
  -0.36272   0.97439  -0.63391   0.81099  -0.69759   0.54885  -0.23909

S =
   0.05514   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.02146   0.05917   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.25641  -0.18846   0.26315   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.21569   0.48601  -0.45384   0.34025   0.00000   0.00000   0.00000   0.00000
   0.47165  -0.99776   1.50438  -1.07470   0.58157   0.00000   0.00000   0.00000
  -0.56622   1.70460  -2.85723   3.07106  -1.95913   0.81168   0.00000   0.00000
   0.53293  -1.96367   4.05556  -5.29404   4.79305  -2.71544   0.97100   0.00000
  -0.23909   1.21746  -3.20250   5.48023  -6.45075   5.41972  -2.92776   1.00000

c =
 Columns 1 through 7:
  -0.179050  -0.191678   0.039563   0.379960   0.356560   0.192704   0.066556
 Column 8:
   0.013687

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 47 column 27
s10 =
  -0.730770   0.149147   0.819950   0.609821   0.313018   0.107484   0.013687

s11 =
  -0.68262   0.98881   0.57244   0.79254   0.94975   0.99421   0.61922

s20 =
  -0.36272   0.97439  -0.63391   0.81099  -0.69759   0.54885  -0.23909

s00 =
   0.93190   0.22486   0.77340   0.58506   0.71650   0.83592   0.97100

s02 =
   0.36272  -0.97439   0.63391  -0.81099   0.69759  -0.54885   0.23909

s22 =
   0.93190   0.22486   0.77340   0.58506   0.71650   0.83592   0.97100

km =
  -0.36272   0.97439  -0.63391   0.81099  -0.69759   0.54885  -0.23909

Sm =
  -0.05514   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.02146  -0.05917   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.25641   0.18846  -0.26315   0.00000   0.00000   0.00000   0.00000   0.00000
   0.21569  -0.48601   0.45384  -0.34025   0.00000   0.00000   0.00000   0.00000
  -0.47165   0.99776  -1.50438   1.07470  -0.58157   0.00000   0.00000   0.00000
   0.56622  -1.70460   2.85723  -3.07106   1.95913  -0.81168   0.00000   0.00000
  -0.53293   1.96367  -4.05556   5.29404  -4.79305   2.71544  -0.97100   0.00000
   0.23909  -1.21746   3.20250  -5.48023   6.45075  -5.41972   2.92776  -1.00000

cm =
 Columns 1 through 7:
   0.179050   0.191678  -0.039563  -0.379960  -0.356560  -0.192704  -0.066556
 Column 8:
  -0.013687

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 50 column 33
s10m =
   0.730770  -0.149147  -0.819950  -0.609821  -0.313018  -0.107484  -0.013687

s11m =
   0.68262   0.98881   0.57244   0.79254   0.94975   0.99421   0.61922

s20m =
  -0.36272   0.97439  -0.63391   0.81099  -0.69759   0.54885  -0.23909

s00m =
   0.93190   0.22486   0.77340   0.58506   0.71650   0.83592   0.97100

s02m =
   0.36272  -0.97439   0.63391  -0.81099   0.69759  -0.54885   0.23909

s22m =
   0.93190   0.22486   0.77340   0.58506   0.71650   0.83592   0.97100

ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
stdxf =
   125.32   125.01   128.43   128.57   131.00   128.94   128.66

k =
  -0.282986   0.986441  -0.073636   0.780646   0.243641   0.290874   0.113694

S =
   0.09045   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.02669   0.09430   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.56682  -0.32301   0.57461   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.04243   0.59221  -0.36574   0.57617   0.00000   0.00000   0.00000   0.00000
   0.71969  -0.52472   1.68729  -0.63820   0.92191   0.00000   0.00000   0.00000
   0.23159   0.58173  -0.11716   1.60790  -0.47724   0.95056   0.00000   0.00000
   0.28899   0.09697   1.09685  -0.15808   1.85742  -0.42839   0.99352   0.00000
   0.11369   0.24185   0.31016   1.08592  -0.03359   1.88064  -0.39812   1.00000

k =
  -0.282986   0.986441  -0.073636   0.780646   0.243641   0.290874   0.113694

S =
   0.09045   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.02669   0.09430   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.56682  -0.32301   0.57461   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.04243   0.59221  -0.36574   0.57617   0.00000   0.00000   0.00000   0.00000
   0.71969  -0.52472   1.68729  -0.63820   0.92191   0.00000   0.00000   0.00000
   0.23159   0.58173  -0.11716   1.60790  -0.47724   0.95056   0.00000   0.00000
   0.28899   0.09697   1.09685  -0.15808   1.85742  -0.42839   0.99352   0.00000
   0.11369   0.24185   0.31016   1.08592  -0.03359   1.88064  -0.39812   1.00000

c =
 Columns 1 through 6:
  -0.2295513  -0.0087552   0.2661417  -0.1204416  -0.3338535   0.4955198
 Columns 7 and 8:
  -0.2711784   0.0614562

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 78 column 27
s10 =
  -0.038113   0.757008  -0.324091  -0.668287   0.704226  -0.359613   0.061456

s11 =
  -0.99927   0.65341   0.94603   0.74390   0.70998   0.93310   0.75408

s20 =
  -0.282986   0.986441  -0.073636   0.780646   0.243641   0.290874   0.113694

s00 =
   0.95912   0.16412   0.99729   0.62497   0.96987   0.95676   0.99352

s02 =
   0.282986  -0.986441   0.073636  -0.780646  -0.243641  -0.290874  -0.113694

s22 =
   0.95912   0.16412   0.99729   0.62497   0.96987   0.95676   0.99352

km =
  -0.282986   0.986441  -0.073636   0.780646   0.243641   0.290874   0.113694

Sm =
  -0.09045   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.02669  -0.09430   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.56682   0.32301  -0.57461   0.00000   0.00000   0.00000   0.00000   0.00000
   0.04243  -0.59221   0.36574  -0.57617   0.00000   0.00000   0.00000   0.00000
  -0.71969   0.52472  -1.68729   0.63820  -0.92191   0.00000   0.00000   0.00000
  -0.23159  -0.58173   0.11716  -1.60790   0.47724  -0.95056   0.00000   0.00000
  -0.28899  -0.09697  -1.09685   0.15808  -1.85742   0.42839  -0.99352   0.00000
  -0.11369  -0.24185  -0.31016  -1.08592   0.03359  -1.88064   0.39812  -1.00000

cm =
 Columns 1 through 6:
   0.2295513   0.0087552  -0.2661417   0.1204416   0.3338535  -0.4955198
 Columns 7 and 8:
   0.2711784  -0.0614562

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 81 column 33
s10m =
   0.038113  -0.757008   0.324091   0.668287  -0.704226   0.359613  -0.061456

s11m =
   0.99927   0.65341   0.94603   0.74390   0.70998   0.93310   0.75408

s20m =
  -0.282986   0.986441  -0.073636   0.780646   0.243641   0.290874   0.113694

s00m =
   0.95912   0.16412   0.99729   0.62497   0.96987   0.95676   0.99352

s02m =
   0.282986  -0.986441   0.073636  -0.780646  -0.243641  -0.290874  -0.113694

s22m =
   0.95912   0.16412   0.99729   0.62497   0.96987   0.95676   0.99352

ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
k =
  -0.84280   0.98412  -0.92820   0.94426  -0.92758   0.85895  -0.48851

S =
 Columns 1 through 7:
    0.00195    0.00000    0.00000    0.00000    0.00000    0.00000    0.00000
   -0.00306    0.00363    0.00000    0.00000    0.00000    0.00000    0.00000
    0.02012   -0.03420    0.02045    0.00000    0.00000    0.00000    0.00000
   -0.05101    0.13939   -0.14210    0.05496    0.00000    0.00000    0.00000
    0.15763   -0.56253    0.82318   -0.57795    0.16694    0.00000    0.00000
   -0.41445    1.85678   -3.54934    3.59986   -1.93825    0.44681    0.00000
    0.74948   -4.06061    9.66449  -12.88509   10.14464   -4.48035    0.87256
   -0.48851    3.36735  -10.33334   18.29001  -20.17789   13.89975   -5.55436
 Column 8:
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    1.00000

c =
 Columns 1 through 6:
  -0.0149997   0.2495468   0.2725160   0.2069190   0.1078154   0.0352394
 Columns 7 and 8:
   0.0099566   0.0026796

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 97 column 27
s10 =
 Columns 1 through 6:
   0.9981984   0.7368970   0.4882840   0.2465660   0.0803294   0.0226907
 Column 7:
   0.0026796

s11 =
  -0.060000   0.676005   0.872685   0.969126   0.996768   0.999743   0.438799

s20 =
  -0.84280   0.98412  -0.92820   0.94426  -0.92758   0.85895  -0.48851

s00 =
   0.53823   0.17749   0.37209   0.32921   0.37362   0.51207   0.87256

s02 =
   0.84280  -0.98412   0.92820  -0.94426   0.92758  -0.85895   0.48851

s22 =
   0.53823   0.17749   0.37209   0.32921   0.37362   0.51207   0.87256

km =
  -0.84280   0.98412  -0.92820   0.94426  -0.92758   0.85895  -0.48851

Sm =
 Columns 1 through 7:
   -0.00195    0.00000    0.00000    0.00000    0.00000    0.00000    0.00000
    0.00306   -0.00363    0.00000    0.00000    0.00000    0.00000    0.00000
   -0.02012    0.03420   -0.02045    0.00000    0.00000    0.00000    0.00000
    0.05101   -0.13939    0.14210   -0.05496    0.00000    0.00000    0.00000
   -0.15763    0.56253   -0.82318    0.57795   -0.16694    0.00000    0.00000
    0.41445   -1.85678    3.54934   -3.59986    1.93825   -0.44681    0.00000
   -0.74948    4.06061   -9.66449   12.88509  -10.14464    4.48035   -0.87256
    0.48851   -3.36735   10.33334  -18.29001   20.17789  -13.89975    5.55436
 Column 8:
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
    0.00000
   -1.00000

cm =
 Columns 1 through 6:
   0.0149997  -0.2495468  -0.2725160  -0.2069190  -0.1078154  -0.0352394
 Columns 7 and 8:
  -0.0099566  -0.0026796

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 100 column 33
s10m =
 Columns 1 through 6:
  -0.9981984  -0.7368970  -0.4882840  -0.2465660  -0.0803294  -0.0226907
 Column 7:
  -0.0026796

s11m =
   0.060000   0.676005   0.872685   0.969126   0.996768   0.999743   0.438799

s20m =
  -0.84280   0.98412  -0.92820   0.94426  -0.92758   0.85895  -0.48851

s00m =
   0.53823   0.17749   0.37209   0.32921   0.37362   0.51207   0.87256

s02m =
   0.84280  -0.98412   0.92820  -0.94426   0.92758  -0.85895   0.48851

s22m =
   0.53823   0.17749   0.37209   0.32921   0.37362   0.51207   0.87256

ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
k =
 Columns 1 through 6:
  -0.8045927   0.9961456  -0.7740062   0.9330557  -0.5837269   0.4191815
 Column 7:
  -0.0085391

S =
   0.00875   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.01185   0.01473   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.16726  -0.26967   0.16790   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.20525   0.59380  -0.63035   0.26517   0.00000   0.00000   0.00000   0.00000
   0.68780  -2.20552   3.19082  -2.28463   0.73714   0.00000   0.00000   0.00000
  -0.52995   2.48956  -5.01027   5.51542  -3.30823   0.90787   0.00000   0.00000
   0.41917  -2.11113   5.28858  -7.83177   7.22434  -3.88849   0.99996   0.00000
  -0.00854   0.45239  -2.17289   5.35566  -7.87722   7.24263  -3.89221   1.00000

c =
   0.12085   0.14176  -0.18853  -0.17954   0.27302   0.32201  -0.64574   0.25098

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 115 column 27
s10 =
   0.76101  -0.71133  -0.56086   0.64891   0.60777  -0.77308   0.25098

s11 =
   0.64874   0.70286   0.82791   0.76086   0.79411   0.63430   0.83528

s20 =
 Columns 1 through 6:
  -0.8045927   0.9961456  -0.7740062   0.9330557  -0.5837269   0.4191815
 Column 7:
  -0.0085391

s00 =
   0.593827   0.087715   0.633178   0.359732   0.811950   0.907902   0.999964

s02 =
 Columns 1 through 6:
   0.8045927  -0.9961456   0.7740062  -0.9330557   0.5837269  -0.4191815
 Column 7:
   0.0085391

s22 =
   0.593827   0.087715   0.633178   0.359732   0.811950   0.907902   0.999964

km =
 Columns 1 through 6:
  -0.8045927   0.9961456  -0.7740062   0.9330557  -0.5837269   0.4191815
 Column 7:
  -0.0085391

Sm =
  -0.00875   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
   0.01185  -0.01473   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
  -0.16726   0.26967  -0.16790   0.00000   0.00000   0.00000   0.00000   0.00000
   0.20525  -0.59380   0.63035  -0.26517   0.00000   0.00000   0.00000   0.00000
  -0.68780   2.20552  -3.19082   2.28463  -0.73714   0.00000   0.00000   0.00000
   0.52995  -2.48956   5.01027  -5.51542   3.30823  -0.90787   0.00000   0.00000
  -0.41917   2.11113  -5.28858   7.83177  -7.22434   3.88849  -0.99996   0.00000
   0.00854  -0.45239   2.17289  -5.35566   7.87722  -7.24263   3.89221  -1.00000

cm =
  -0.12085  -0.14176   0.18853   0.17954  -0.27302  -0.32201   0.64574  -0.25098

warning: Using Octave m-file version of function schurNSscale()!
warning: called from
    schurNSscale at line 37 column 3
    schurNSscale_test at line 118 column 33
s10m =
  -0.76101   0.71133   0.56086  -0.64891  -0.60777   0.77308  -0.25098

s11m =
  -0.64874   0.70286   0.82791   0.76086   0.79411   0.63430   0.83528

s20m =
 Columns 1 through 6:
  -0.8045927   0.9961456  -0.7740062   0.9330557  -0.5837269   0.4191815
 Column 7:
  -0.0085391

s00m =
   0.593827   0.087715   0.633178   0.359732   0.811950   0.907902   0.999964

s02m =
 Columns 1 through 6:
   0.8045927  -0.9961456   0.7740062  -0.9330557   0.5837269  -0.4191815
 Column 7:
   0.0085391

s22m =
   0.593827   0.087715   0.633178   0.359732   0.811950   0.907902   0.999964

ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
ans = 0
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match. Suppress m-file warnings.
#
echo "Running $descr"
octave-cli -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $descr"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

