#!/bin/sh

prog=schurOneMR2lattice2Abcd_test.m
depends="schurOneMR2lattice2Abcd_test.m test_common.m schurOneMR2lattice2Abcd.m \
tf2schurOneMlattice.m Abcd2tf.m schurOneMscale.m schurdecomp.oct \
schurexpand.oct svf.m KW.m crossWelch.m reprand.oct"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
A =
        0   1.0000
   0.3874        0

B =
        0
   1.3874

C =
   0.1865   0.1965

D = 0.1865
Aap =
        0   1.0000
   0.3874        0

Bap =
        0
   1.3874

Cap =
   0.6126        0

Dap = -0.3874
ng = 0.1956
ngap = 1.0000
est_varyd = 0.099634
varyd = 0.1008
stdxx =
   128.60   128.60

est_varydap = 0.1667
varydap = 0.1701
stdxxap =
   128.60   128.60

indexABCap =
   1   2   3   5

A =
        0   1.0000        0        0        0
   0.7882        0        0        0   1.7882
   0.2118        0        0        0  -0.7882
   0.1286   0.1383        0        0   0.1922
        0        0  -0.4863        0        0

B =
        0
        0
        0
        0
   0.5137

C =
        0        0        0   1.0000   0.1383

D = 0.078437
Aap =
        0   1.0000        0        0
   0.7882        0        0   1.7882
   0.2118        0        0  -0.7882
        0        0  -0.4863        0

Bap =
        0
        0
        0
   0.5137

Cap =
        0        0   1.4863        0

Dap = 0.4863
ng = 0.4813
ngap = 3.0000
est_varyd = 0.1234
varyd = 0.1233
stdxx =
   129.42   129.43   128.27   130.50   128.28

est_varydap = 0.3333
varydap = 0.3327
stdxxap =
   129.42   129.43   128.27   128.28

indexABCap =
   1   2   3   5   6   8

A =
        0   1.0000        0        0        0        0        0        0
   0.8611        0        0        0   0.1389        0        0        0
   1.8611        0        0        0  -0.8611        0        0        0
   0.2800   0.3155        0        0   0.0521        0        0        0
        0        0  -0.8665        0        0        0        0   1.8665
        0        0   0.1335        0        0        0        0   0.8665
        0        0        0   1.0000   0.0397        0        0   0.1499
        0        0        0        0        0   0.4480        0        0

B =
        0
        0
        0
        0
        0
        0
        0
   0.5520

C =
        0        0        0        0        0        0   1.0000   0.1340

D = 0.045209
Aap =
        0   1.0000        0        0        0        0
   0.8611        0        0   0.1389        0        0
   1.8611        0        0  -0.8611        0        0
        0        0  -0.8665        0        0   1.8665
        0        0   0.1335        0        0   0.8665
        0        0        0        0   0.4480        0

Bap =
        0
        0
        0
        0
        0
   0.5520

Cap =
        0        0        0        0   1.4480        0

Dap = -0.4480
ng = 0.7790
ngap = 5.0000
est_varyd = 0.1482
varyd = 0.1466
stdxx =
   129.64   129.64   129.10   130.58   129.11   128.45   131.00   128.48

est_varydap = 0.5000
varydap = 0.4980
stdxxap =
   129.64   129.64   129.10   129.11   128.45   128.48

indexABCap =
    1    2    3    5    6    8    9   11   12   14   15   17

A =
 Columns 1 through 8:
        0   1.0000        0        0        0        0        0        0
   0.2950        0        0        0   0.7050        0        0        0
   1.2950        0        0        0  -0.2950        0        0        0
   0.1160   0.3343        0        0   0.3627        0        0        0
        0        0  -0.3414        0        0        0        0   1.3414
        0        0   0.6586        0        0        0        0   0.3414
        0        0        0   1.0000   0.3184        0        0   0.2044
        0        0        0        0        0   0.1959        0        0
        0        0        0        0        0   1.1959        0        0
        0        0        0        0        0        0   1.0000  -0.0188
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
 Columns 9 through 16:
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0   0.8041        0        0        0        0        0
        0        0  -0.1959        0        0        0        0        0
        0        0  -0.0929        0        0        0        0        0
  -0.0886        0        0        0        0   0.9114        0        0
   1.0886        0        0        0        0   0.0886        0        0
        0   1.0000  -0.0636        0        0  -0.0015        0        0
        0        0        0   0.0354        0        0        0        0
        0        0        0   1.0354        0        0        0        0
        0        0        0        0   1.0000   0.0250        0        0
        0        0        0        0        0        0  -0.0054        0
 Column 17:
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
   0.9646
  -0.0354
   0.0156
        0

B =
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
   0.9946

C =
   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   1   0

D = 0
Aap =
 Columns 1 through 8:
        0   1.0000        0        0        0        0        0        0
   0.2950        0        0   0.7050        0        0        0        0
   1.2950        0        0  -0.2950        0        0        0        0
        0        0  -0.3414        0        0   1.3414        0        0
        0        0   0.6586        0        0   0.3414        0        0
        0        0        0        0   0.1959        0        0   0.8041
        0        0        0        0   1.1959        0        0  -0.1959
        0        0        0        0        0        0  -0.0886        0
        0        0        0        0        0        0   1.0886        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
 Columns 9 through 12:
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0   0.9114        0        0
        0   0.0886        0        0
   0.0354        0        0   0.9646
   1.0354        0        0  -0.0354
        0        0  -0.0054        0

Bap =
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
   0.9946

Cap =
 Columns 1 through 8:
        0        0        0        0        0        0        0        0
 Columns 9 through 12:
        0        0   1.0054        0

Dap = 5.3802e-03
ng = 3.4586
ngap = 11.000
est_varyd = 0.3715
varyd = 0.3726
stdxx =
 Columns 1 through 8:
   127.85   127.86   127.50   128.06   127.50   128.05   128.63   128.06
 Columns 9 through 16:
   128.04   128.36   128.06   127.99   128.17   128.02   127.97   128.20
 Column 17:
   128.00

est_varydap = 1.0000
varydap = 0.9971
stdxxap =
 Columns 1 through 8:
   127.85   127.86   127.50   127.50   128.05   128.06   128.04   128.06
 Columns 9 through 12:
   127.99   128.02   127.97   128.00

indexABCap =
 Columns 1 through 16:
    1    2    3    5    6    8    9   11   12   14   15   17   18   20   21   23
 Columns 17 through 20:
   24   26   27   29

A =
 Columns 1 through 8:
        0   1.0000        0        0        0        0        0        0
  -0.6673        0        0        0   1.6673        0        0        0
   0.3327        0        0        0   0.6673        0        0        0
   0.0704  -0.0128        0        0  -0.2993        0        0        0
        0        0  -0.4964        0        0        0        0   0.5036
        0        0   1.4964        0        0        0        0   0.4964
        0        0        0   1.0000  -0.4822        0        0  -0.1625
        0        0        0        0        0  -0.3463        0        0
        0        0        0        0        0   0.6537        0        0
        0        0        0        0        0        0   1.0000   0.1224
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
 Columns 9 through 16:
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0   1.3463        0        0        0        0        0
        0        0   0.3463        0        0        0        0        0
        0        0   0.3958        0        0        0        0        0
  -0.4174        0        0        0        0   0.5826        0        0
   1.4174        0        0        0        0   0.4174        0        0
        0   1.0000   0.3004        0        0   0.0172        0        0
        0        0        0  -0.2972        0        0        0        0
        0        0        0   0.7028        0        0        0        0
        0        0        0        0   1.0000  -0.0825        0        0
        0        0        0        0        0        0  -0.2512        0
        0        0        0        0        0        0   1.2512        0
        0        0        0        0        0        0        0   1.0000
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
 Columns 17 through 24:
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   1.2972        0        0        0        0        0        0        0
   0.2972        0        0        0        0        0        0        0
  -0.0795        0        0        0        0        0        0        0
        0        0        0   0.7488        0        0        0        0
        0        0        0   0.2512        0        0        0        0
  -0.0125        0        0  -0.0099        0        0        0        0
        0  -0.1512        0        0        0        0   0.8488        0
        0   1.1512        0        0        0        0   0.1512        0
        0        0   1.0000  -0.0353        0        0  -0.0256        0
        0        0        0        0  -0.1021        0        0        0
        0        0        0        0   0.8979        0        0        0
        0        0        0        0        0   1.0000   0.0048        0
        0        0        0        0        0        0        0  -0.0363
        0        0        0        0        0        0        0   1.0363
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
 Columns 25 through 29:
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0   1.1021        0        0        0
        0   0.1021        0        0        0
        0   0.0246        0        0        0
        0        0        0        0   0.9637
        0        0        0        0   0.0363
   1.0000   0.0165        0        0   0.0028
        0        0  -0.0150        0        0

B =
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
   0.9850

C =
 Columns 1 through 8:
        0        0        0        0        0        0        0        0
 Columns 9 through 16:
        0        0        0        0        0        0        0        0
 Columns 17 through 24:
        0        0        0        0        0        0        0        0
 Columns 25 through 29:
        0        0        0   1.0000   0.0013

D = 5.8052e-03
Aap =
 Columns 1 through 8:
        0   1.0000        0        0        0        0        0        0
  -0.6673        0        0   1.6673        0        0        0        0
   0.3327        0        0   0.6673        0        0        0        0
        0        0  -0.4964        0        0   0.5036        0        0
        0        0   1.4964        0        0   0.4964        0        0
        0        0        0        0  -0.3463        0        0   1.3463
        0        0        0        0   0.6537        0        0   0.3463
        0        0        0        0        0        0  -0.4174        0
        0        0        0        0        0        0   1.4174        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
 Columns 9 through 16:
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0   0.5826        0        0        0        0        0        0
        0   0.4174        0        0        0        0        0        0
  -0.2972        0        0   1.2972        0        0        0        0
   0.7028        0        0   0.2972        0        0        0        0
        0        0  -0.2512        0        0   0.7488        0        0
        0        0   1.2512        0        0   0.2512        0        0
        0        0        0        0  -0.1512        0        0   0.8488
        0        0        0        0   1.1512        0        0   0.1512
        0        0        0        0        0        0  -0.1021        0
        0        0        0        0        0        0   0.8979        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
 Columns 17 through 20:
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0   1.1021        0        0
        0   0.1021        0        0
  -0.0363        0        0   0.9637
   1.0363        0        0   0.0363
        0        0  -0.0150        0

Bap =
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
   0.9850

Cap =
 Columns 1 through 8:
        0        0        0        0        0        0        0        0
 Columns 9 through 16:
        0        0        0        0        0        0        0        0
 Columns 17 through 20:
        0        0   1.0150        0

Dap = 0.015043
ng = 3.5706
ngap = 19.000
est_varyd = 0.3809
varyd = 0.3876
stdxx =
 Columns 1 through 8:
   127.61   127.61   127.30   127.60   127.31   127.02   127.78   127.03
 Columns 9 through 16:
   127.33   128.29   127.35   127.71   127.93   127.74   127.66   128.29
 Columns 17 through 24:
   127.69   127.78   128.24   127.81   127.95   128.25   128.00   127.92
 Columns 25 through 29:
   128.23   127.97   127.97   128.26   128.02

est_varydap = 1.6667
varydap = 1.6607
stdxxap =
 Columns 1 through 8:
   127.61   127.61   127.30   127.31   127.02   127.03   127.33   127.35
 Columns 9 through 16:
   127.71   127.74   127.66   127.69   127.78   127.81   127.95   128.00
 Columns 17 through 20:
   127.92   127.97   127.97   128.02

EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match. .
#
echo "Running $prog"

octave-cli -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi

#
# this much worked
#
pass

