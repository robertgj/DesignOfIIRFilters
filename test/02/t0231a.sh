#!/bin/sh

prog=schurOneMR2lattice2Abcd_test.m
depends="test/schurOneMR2lattice2Abcd_test.m test_common.m svf.m crossWelch.m \
schurOneMR2lattice2Abcd.m tf2schurOneMlattice.m Abcd2tf.m schurOneMscale.m KW.m \
p2n60.m qroots.oct schurdecomp.oct schurexpand.oct reprand.oct"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
A =
        0   1.0000
   0.3874        0

B =
        0
   1.3874

C =
   0.1865   0.1965

D = 0.1865
Aap =
        0   1.0000
   0.3874        0

Bap =
        0
   1.3874

Cap =
   0.6126        0

Dap = -0.3874
ng = 0.1956
ngap = 1.0000
n60 = 15
est_varyd = 0.099634
varyd = 0.1009
stdxx =
   128.58   128.57

est_varydap = 0.1667
varydap = 0.1701
stdxxap =
   128.58   128.57

A =
        0   1.0000        0        0        0
   0.7882        0        0        0   1.7882
   0.2118        0        0        0  -0.7882
   0.1286   0.1383        0        0   0.1922
        0        0  -0.4863        0        0

B =
        0
        0
        0
        0
   0.5137

C =
        0        0        0   1.0000   0.1383

D = 0.078437
Aap =
        0   1.0000        0        0
   0.7882        0        0   1.7882
   0.2118        0        0  -0.7882
        0        0  -0.4863        0

Bap =
        0
        0
        0
   0.5137

Cap =
        0        0   1.4863        0

Dap = 0.4863
ng = 0.4813
ngap = 3.0000
n60 = 39
est_varyd = 0.1234
varyd = 0.1228
stdxx =
   129.45   129.44   128.29   130.43   128.27

est_varydap = 0.3333
varydap = 0.3328
stdxxap =
   129.45   129.44   128.29   128.27

A =
        0   1.0000        0        0        0        0        0        0
   0.8611        0        0        0   0.1389        0        0        0
   1.8611        0        0        0  -0.8611        0        0        0
   0.2800   0.3155        0        0   0.0521        0        0        0
        0        0  -0.8665        0        0        0        0   1.8665
        0        0   0.1335        0        0        0        0   0.8665
        0        0        0   1.0000   0.0397        0        0   0.1499
        0        0        0        0        0   0.4480        0        0

B =
        0
        0
        0
        0
        0
        0
        0
   0.5520

C =
        0        0        0        0        0        0   1.0000   0.1340

D = 0.045209
Aap =
        0   1.0000        0        0        0        0
   0.8611        0        0   0.1389        0        0
   1.8611        0        0  -0.8611        0        0
        0        0  -0.8665        0        0   1.8665
        0        0   0.1335        0        0   0.8665
        0        0        0        0   0.4480        0

Bap =
        0
        0
        0
        0
        0
   0.5520

Cap =
        0        0        0        0   1.4480        0

Dap = -0.4480
ng = 0.7790
ngap = 5.0000
n60 = 98
est_varyd = 0.1482
varyd = 0.1478
stdxx =
   129.64   129.65   129.14   130.33   129.15   128.48   130.72   128.49

est_varydap = 0.5000
varydap = 0.4997
stdxxap =
   129.64   129.65   129.14   129.15   128.48   128.49

A =
 Columns 1 through 8:
        0   1.0000        0        0        0        0        0        0
   0.2950        0        0        0   0.7050        0        0        0
   1.2950        0        0        0  -0.2950        0        0        0
   0.1160   0.3343        0        0   0.3627        0        0        0
        0        0  -0.3414        0        0        0        0   1.3414
        0        0   0.6586        0        0        0        0   0.3414
        0        0        0   1.0000   0.3184        0        0   0.2044
        0        0        0        0        0   0.1959        0        0
        0        0        0        0        0   1.1959        0        0
        0        0        0        0        0        0   1.0000  -0.0188
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
 Columns 9 through 16:
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0   0.8041        0        0        0        0        0
        0        0  -0.1959        0        0        0        0        0
        0        0  -0.0929        0        0        0        0        0
  -0.0886        0        0        0        0   0.9114        0        0
   1.0886        0        0        0        0   0.0886        0        0
        0   1.0000  -0.0636        0        0  -0.0015        0        0
        0        0        0   0.0354        0        0        0        0
        0        0        0   1.0354        0        0        0        0
        0        0        0        0   1.0000   0.0250        0        0
        0        0        0        0        0        0  -0.0054        0
 Column 17:
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
   0.9646
  -0.0354
   0.0156
        0

B =
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
   0.9946

C =
   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   1   0

D = 0
Aap =
 Columns 1 through 8:
        0   1.0000        0        0        0        0        0        0
   0.2950        0        0   0.7050        0        0        0        0
   1.2950        0        0  -0.2950        0        0        0        0
        0        0  -0.3414        0        0   1.3414        0        0
        0        0   0.6586        0        0   0.3414        0        0
        0        0        0        0   0.1959        0        0   0.8041
        0        0        0        0   1.1959        0        0  -0.1959
        0        0        0        0        0        0  -0.0886        0
        0        0        0        0        0        0   1.0886        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
 Columns 9 through 12:
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0   0.9114        0        0
        0   0.0886        0        0
   0.0354        0        0   0.9646
   1.0354        0        0  -0.0354
        0        0  -0.0054        0

Bap =
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
   0.9946

Cap =
 Columns 1 through 8:
        0        0        0        0        0        0        0        0
 Columns 9 through 12:
        0        0   1.0054        0

Dap = 5.3802e-03
ng = 3.4586
ngap = 11.000
n60 = 25
est_varyd = 0.3715
varyd = 0.3744
stdxx =
 Columns 1 through 8:
   127.88   127.88   127.52   128.07   127.53   128.08   128.62   128.09
 Columns 9 through 16:
   128.06   128.36   128.07   128.01   128.18   128.03   128.00   128.21
 Column 17:
   128.01

est_varydap = 1.0000
varydap = 0.9948
stdxxap =
 Columns 1 through 8:
   127.88   127.88   127.52   127.53   128.08   128.09   128.06   128.07
 Columns 9 through 12:
   128.01   128.03   128.00   128.01

A =
 Columns 1 through 8:
        0   1.0000        0        0        0        0        0        0
  -0.6673        0        0        0   1.6673        0        0        0
   0.3327        0        0        0   0.6673        0        0        0
   0.0704  -0.0128        0        0  -0.2993        0        0        0
        0        0  -0.4964        0        0        0        0   0.5036
        0        0   1.4964        0        0        0        0   0.4964
        0        0        0   1.0000  -0.4822        0        0  -0.1625
        0        0        0        0        0  -0.3463        0        0
        0        0        0        0        0   0.6537        0        0
        0        0        0        0        0        0   1.0000   0.1224
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
 Columns 9 through 16:
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0   1.3463        0        0        0        0        0
        0        0   0.3463        0        0        0        0        0
        0        0   0.3958        0        0        0        0        0
  -0.4174        0        0        0        0   0.5826        0        0
   1.4174        0        0        0        0   0.4174        0        0
        0   1.0000   0.3004        0        0   0.0172        0        0
        0        0        0  -0.2972        0        0        0        0
        0        0        0   0.7028        0        0        0        0
        0        0        0        0   1.0000  -0.0825        0        0
        0        0        0        0        0        0  -0.2512        0
        0        0        0        0        0        0   1.2512        0
        0        0        0        0        0        0        0   1.0000
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
 Columns 17 through 24:
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
   1.2972        0        0        0        0        0        0        0
   0.2972        0        0        0        0        0        0        0
  -0.0795        0        0        0        0        0        0        0
        0        0        0   0.7488        0        0        0        0
        0        0        0   0.2512        0        0        0        0
  -0.0125        0        0  -0.0099        0        0        0        0
        0  -0.1512        0        0        0        0   0.8488        0
        0   1.1512        0        0        0        0   0.1512        0
        0        0   1.0000  -0.0353        0        0  -0.0256        0
        0        0        0        0  -0.1021        0        0        0
        0        0        0        0   0.8979        0        0        0
        0        0        0        0        0   1.0000   0.0048        0
        0        0        0        0        0        0        0  -0.0363
        0        0        0        0        0        0        0   1.0363
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
 Columns 25 through 29:
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0        0        0        0        0
        0   1.1021        0        0        0
        0   0.1021        0        0        0
        0   0.0246        0        0        0
        0        0        0        0   0.9637
        0        0        0        0   0.0363
   1.0000   0.0165        0        0   0.0028
        0        0  -0.0150        0        0

B =
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
   0.9850

C =
 Columns 1 through 8:
        0        0        0        0        0        0        0        0
 Columns 9 through 16:
        0        0        0        0        0        0        0        0
 Columns 17 through 24:
        0        0        0        0        0        0        0        0
 Columns 25 through 29:
        0        0        0   1.0000   0.0013

D = 5.8052e-03
Aap =
 Columns 1 through 8:
        0   1.0000        0        0        0        0        0        0
  -0.6673        0        0   1.6673        0        0        0        0
   0.3327        0        0   0.6673        0        0        0        0
        0        0  -0.4964        0        0   0.5036        0        0
        0        0   1.4964        0        0   0.4964        0        0
        0        0        0        0  -0.3463        0        0   1.3463
        0        0        0        0   0.6537        0        0   0.3463
        0        0        0        0        0        0  -0.4174        0
        0        0        0        0        0        0   1.4174        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
 Columns 9 through 16:
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0   0.5826        0        0        0        0        0        0
        0   0.4174        0        0        0        0        0        0
  -0.2972        0        0   1.2972        0        0        0        0
   0.7028        0        0   0.2972        0        0        0        0
        0        0  -0.2512        0        0   0.7488        0        0
        0        0   1.2512        0        0   0.2512        0        0
        0        0        0        0  -0.1512        0        0   0.8488
        0        0        0        0   1.1512        0        0   0.1512
        0        0        0        0        0        0  -0.1021        0
        0        0        0        0        0        0   0.8979        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
        0        0        0        0        0        0        0        0
 Columns 17 through 20:
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0        0        0        0
        0   1.1021        0        0
        0   0.1021        0        0
  -0.0363        0        0   0.9637
   1.0363        0        0   0.0363
        0        0  -0.0150        0

Bap =
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
        0
   0.9850

Cap =
 Columns 1 through 8:
        0        0        0        0        0        0        0        0
 Columns 9 through 16:
        0        0        0        0        0        0        0        0
 Columns 17 through 20:
        0        0   1.0150        0

Dap = 0.015043
ng = 3.5706
ngap = 19.000
n60 = 47
est_varyd = 0.3809
varyd = 0.3763
stdxx =
 Columns 1 through 8:
   127.69   127.69   127.39   127.67   127.38   127.10   127.88   127.10
 Columns 9 through 16:
   127.39   128.36   127.40   127.75   128.03   127.77   127.71   128.37
 Columns 17 through 24:
   127.72   127.84   128.33   127.84   128.01   128.34   128.01   127.98
 Columns 25 through 29:
   128.30   127.98   128.02   128.33   128.02

est_varydap = 1.6667
varydap = 1.6375
stdxxap =
 Columns 1 through 8:
   127.69   127.69   127.39   127.38   127.10   127.10   127.39   127.40
 Columns 9 through 16:
   127.75   127.77   127.71   127.72   127.84   127.84   128.01   128.01
 Columns 17 through 20:
   127.98   127.98   128.02   128.02

EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match. .
#
echo "Running $prog"

octave --no-gui -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi

#
# this much worked
#
pass

