#!/bin/sh

prog=iir_frm_parallel_allpass_slb_exchange_constraints_test.m

depends="iir_frm_parallel_allpass_slb_exchange_constraints_test.m \
iir_frm_parallel_allpass_slb_exchange_constraints.m \
iir_frm_parallel_allpass_slb_show_constraints.m \
iir_frm_parallel_allpass_slb_update_constraints.m \
iir_frm_parallel_allpass_struct_to_vec.m \
iir_frm_parallel_allpass_vec_to_struct.m \
iir_frm_parallel_allpass.m \
test_common.m allpassP.m allpassT.m tf2a.m a2tf.m local_max.m local_peak.m"
tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
echo $here
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
maxiter =  2000
verbose = 1
tol =    5.0000e-06
Mmodel =  9
Dmodel =  9.5000
dmask =  8.5000
Tnominal =  94
fap =  0.30000
dBap =  0.10000
Wap =  1
tpr =  2
Wtp =  1
fas =  0.31000
dBas =  50
Was =  10
rho =  0.96875
vRx0 before exchange constraints:
Current constraints:
al=[ 74 150 177 270 296 400 519 585 601 ]
f(al)=[ 0.036500 0.074500 0.088000 0.134500 0.147500 0.199500 0.259000 0.292000 0.300000 ](fs=1)
Asql=[ -0.232833 -0.240943 -0.223016 -0.312030 -0.123054 -0.205195 -0.326703 -0.251955 -1.522420 ](dB)
au=[ 60 89 104 163 233 285 361 385 504 532 552 571 621 624 633 643 664 711 728 754 795 826 846 ]
f(au)=[ 0.029500 0.044000 0.051500 0.081000 0.116000 0.142000 0.180000 0.192000 0.251500 0.265500 0.275500 0.285000 0.310000 0.311500 0.316000 0.321000 0.331500 0.355000 0.363500 0.376500 0.397000 0.412500 0.422500 ](fs=1)
Asqu=[ 0.309388 0.046440 0.073215 0.232969 0.130771 0.197739 0.045858 0.392773 0.522841 0.050136 0.222000 0.132356 -37.957360 -46.504026 -46.109196 -47.493088 -47.256355 -44.626399 -41.614934 -44.306392 -44.902397 -45.018787 -47.031347 ](dB)
tl=[ 276 521 ]
f(tl)=[ 0.137500 0.260000 ](fs=1)
Tl=[ 92.868073 92.902995 ](Samples)
tu=[ 508 590 ]
f(tu)=[ 0.253500 0.294500 ](fs=1)
Tu=[ 96.316934 95.707358 ](Samples)
vSx1 before exchange constraints:
Current constraints:
al=[ 273 402 487 521 537 585 601 ]
f(al)=[ 0.136000 0.200500 0.243000 0.260000 0.268000 0.292000 0.300000 ](fs=1)
Asql=[ -0.138495 -0.121986 -0.149291 -0.222838 -0.187911 -0.281591 -0.627673 ](dB)
au=[ 30 104 164 193 252 302 315 387 504 553 572 595 621 629 642 661 707 728 755 799 831 888 905 931 954 999 ]
f(au)=[ 0.014500 0.051500 0.081500 0.096000 0.125500 0.150500 0.157000 0.193000 0.251500 0.276000 0.285500 0.297000 0.310000 0.314000 0.320500 0.330000 0.353000 0.363500 0.377000 0.399000 0.415000 0.443500 0.452000 0.465000 0.476500 0.499000 ](fs=1)
Asqu=[ 0.000247 0.000418 0.000077 0.000102 0.000495 0.000581 0.000352 0.001887 0.000318 0.000536 0.004316 0.015603 -23.024579 -35.499289 -37.441143 -39.308167 -34.657541 -33.652618 -36.036039 -37.506194 -36.363660 -42.196295 -42.153356 -41.253390 -38.110311 -40.105740 ](dB)
tl=[ 64 278 390 543 ]
f(tl)=[ 0.031500 0.138500 0.194500 0.271000 ](fs=1)
Tl=[ 92.139682 92.014386 91.990800 92.659110 ](Samples)
tu=[ 1 20 37 302 323 467 502 592 ]
f(tu)=[ 0.000000 0.009500 0.018000 0.150500 0.161000 0.233000 0.250500 0.295500 ](fs=1)
Tu=[ 95.632441 95.600662 95.430499 95.099795 95.668638 95.083456 96.015119 95.857890 ](Samples)
Exchanged constraint from vR.tl(276) to vS
vRx1 after exchange constraints:
Current constraints:
al=[ 74 150 177 270 296 400 519 585 601 ]
f(al)=[ 0.036500 0.074500 0.088000 0.134500 0.147500 0.199500 0.259000 0.292000 0.300000 ](fs=1)
Asql=[ -0.075658 -0.053697 -0.045168 -0.128745 -0.021071 -0.117859 -0.217790 -0.281591 -0.627673 ](dB)
au=[ 60 89 104 163 233 285 361 385 504 532 552 571 621 624 633 643 664 711 728 754 795 826 846 ]
f(au)=[ 0.029500 0.044000 0.051500 0.081000 0.116000 0.142000 0.180000 0.192000 0.251500 0.265500 0.275500 0.285000 0.310000 0.311500 0.316000 0.321000 0.331500 0.355000 0.363500 0.376500 0.397000 0.412500 0.422500 ](fs=1)
Asqu=[ -0.002965 -0.009781 0.000418 -0.000535 -0.035162 -0.081855 -0.039698 -0.004819 0.000318 -0.180298 -0.001382 0.000193 -23.024579 -38.155070 -41.185365 -37.456181 -39.887502 -36.264665 -33.652618 -36.060806 -37.846408 -36.990119 -43.620291 ](dB)
tl=[ 521 ]
f(tl)=[ 0.260000 ](fs=1)
Tl=[ 93.160472 ](Samples)
tu=[ 508 590 ]
f(tu)=[ 0.253500 0.294500 ](fs=1)
Tu=[ 95.574357 95.706659 ](Samples)
vSx1 after exchange constraints:
Current constraints:
al=[ 273 402 487 521 537 585 601 ]
f(al)=[ 0.136000 0.200500 0.243000 0.260000 0.268000 0.292000 0.300000 ](fs=1)
Asql=[ -0.138495 -0.121986 -0.149291 -0.222838 -0.187911 -0.281591 -0.627673 ](dB)
au=[ 30 104 164 193 252 302 315 387 504 553 572 595 621 629 642 661 707 728 755 799 831 888 905 931 954 999 ]
f(au)=[ 0.014500 0.051500 0.081500 0.096000 0.125500 0.150500 0.157000 0.193000 0.251500 0.276000 0.285500 0.297000 0.310000 0.314000 0.320500 0.330000 0.353000 0.363500 0.377000 0.399000 0.415000 0.443500 0.452000 0.465000 0.476500 0.499000 ](fs=1)
Asqu=[ 0.000247 0.000418 0.000077 0.000102 0.000495 0.000581 0.000352 0.001887 0.000318 0.000536 0.004316 0.015603 -23.024579 -35.499289 -37.441143 -39.308167 -34.657541 -33.652618 -36.036039 -37.506194 -36.363660 -42.196295 -42.153356 -41.253390 -38.110311 -40.105740 ](dB)
tl=[ 64 276 278 390 543 ]
f(tl)=[ 0.031500 0.137500 0.138500 0.194500 0.271000 ](fs=1)
Tl=[ 92.139682 92.056262 92.014386 91.990800 92.659110 ](Samples)
tu=[ 1 20 37 302 323 467 502 592 ]
f(tu)=[ 0.000000 0.009500 0.018000 0.150500 0.161000 0.233000 0.250500 0.295500 ](fs=1)
Tu=[ 95.632441 95.600662 95.430499 95.099795 95.668638 95.083456 96.015119 95.857890 ](Samples)
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running octave-cli -q " $prog

octave-cli -q $prog > test.out
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

