#!/bin/sh

prog=iir_frm_slb_exchange_constraints_test.m

depends="iir_frm_slb_exchange_constraints_test.m test_common.m \
iir_frm_slb_exchange_constraints.m iir_frm_slb_show_constraints.m \
iir_frm_slb_update_constraints.m iir_frm_struct_to_vec.m \
iir_frm_vec_to_struct.m iir_frm.m iirA.m iirP.m iirT.m iirdelAdelw.m \
fixResultNaN.m xConstraints.m tf2x.m zp2x.m x2tf.m local_max.m \
qroots.m qzsolve.oct"

tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
echo $here
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
maxiter =  2000
tol =  0.000010000
verbose = 1
tol =  0.0000010000
constraints_tol =  0.00000010000
maxiter =  5000
verbose = 1
Mmodel =  9
Dmodel =  7
dmask =  20
fap =  0.30000
dBap =  0.10000
Wap =  1
tpr =  1
Wtp =  0.050000
fas =  0.31000
dBas =  40
Was =  50
vS =
  scalar structure containing the fields:
    al =
       156
       201
       218
       241
    au =
         1
        23
        41
        66
        81
       108
       123
       149
       163
       171
       186
       195
       208
       234
       249
       251
       258
       268
       282
       290
       297
       309
       315
       331
       339
       349
       353
       359
       371
       375
       381
       392
       399
    tl =
       173
       184
       195
       206
       218
       229
       240
    tu =
       168
       179
       190
       200
       212
       223
       234

vS =
  scalar structure containing the fields:
    al =
       236
       241
    au =
         7
        27
        38
        64
        78
       105
       111
       121
       134
       147
       159
       180
       188
       204
       217
       230
       239
       249
       255
       266
       274
       290
    tl = [](0x1)
    tu =  241

vR before exchange constraints:
Current constraints:
al=[ 156 201 218 241 ]
f(al)=[ 0.193750 0.250000 0.271250 0.300000 ](fs=1)
Asql=[ -0.113036 -0.117298 -0.123432 -0.913177 ](dB)
au=[ 1 23 41 66 81 108 123 149 163 171 186 195 208 234 249 251 258 268 282 290 297 309 315 331 339 349 353 359 371 375 381 392 399 ]
f(au)=[ 0.000000 0.027500 0.050000 0.081250 0.100000 0.133750 0.152500 0.185000 0.202500 0.212500 0.231250 0.242500 0.258750 0.291250 0.310000 0.312500 0.321250 0.333750 0.351250 0.361250 0.370000 0.385000 0.392500 0.412500 0.422500 0.435000 0.440000 0.447500 0.462500 0.467500 0.475000 0.488750 0.497500 ](fs=1)
Asqu=[ 0.023313 0.068088 0.056911 0.063322 0.022362 0.057309 0.052935 0.060551 0.072267 0.000651 0.010674 0.079371 0.103211 0.198610 -30.606949 -36.884567 -38.312065 -37.949801 -38.155167 -38.566248 -37.925647 -38.598944 -39.432589 -38.557600 -38.127080 -37.190023 -38.346668 -39.587391 -39.635062 -39.232311 -38.079998 -37.852882 -38.610141 ](dB)
tl=[ 173 184 195 206 218 229 240 ]
f(tl)=[ 0.215000 0.228750 0.242500 0.256250 0.271250 0.285000 0.298750 ](fs=1)
Tl=[ -0.925120 -1.081451 -0.543874 -0.903471 -1.444718 -1.726174 -1.408118 ](Samples)
tu=[ 168 179 190 200 212 223 234 ]
f(tu)=[ 0.208750 0.222500 0.236250 0.248750 0.263750 0.277500 0.291250 ](fs=1)
Tu=[ 0.762132 0.763501 0.932677 0.885758 0.982456 1.277266 1.328132 ](Samples)
vS before exchange constraints:
Current constraints:
al=[ 236 241 ]
f(al)=[ 0.293750 0.300000 ](fs=1)
Asql=[ -0.106587 -0.100019 ](dB)
au=[ 7 27 38 64 78 105 111 121 134 147 159 180 188 204 217 230 239 249 255 266 274 290 ]
f(au)=[ 0.007500 0.032500 0.046250 0.078750 0.096250 0.130000 0.137500 0.150000 0.166250 0.182500 0.197500 0.223750 0.233750 0.253750 0.270000 0.286250 0.297500 0.310000 0.317500 0.331250 0.341250 0.361250 ](fs=1)
Asqu=[ 0.003888 0.003917 0.006088 0.000811 0.000447 0.003452 0.001639 0.004973 0.014304 0.008627 0.004378 0.001197 0.000831 0.000672 0.051384 0.056960 0.000010 -22.906005 -36.776159 -37.982212 -37.810370 -35.950530 ](dB)
tu=[ 241 ]
f(tu)=[ 0.300000 ](fs=1)
Tu=[ 0.773922 ](Samples)
Exchanged constraint from vR.au(249) to vS
vRx1k =
  scalar structure containing the fields:
    al =
       156
       201
       218
       241
    au =
         1
        23
        41
        66
        81
       108
       123
       149
       163
       171
       186
       195
       208
       234
       251
       258
       268
       282
       290
       297
       309
       315
       331
       339
       349
       353
       359
       371
       375
       381
       392
       399
    tl =
       173
       184
       195
       206
       218
       229
       240
    tu =
       168
       179
       190
       200
       212
       223
       234

vSx1k =
  scalar structure containing the fields:
    al =
       236
       241
    au =
         7
        27
        38
        64
        78
       105
       111
       121
       134
       147
       159
       180
       188
       204
       217
       230
       239
       249
       255
       266
       274
       290
    tl = [](0x0)
    tu =  241

exchanged = 1
vR after exchange constraints:
Current constraints:
al=[ 156 201 218 241 ]
f(al)=[ 0.193750 0.250000 0.271250 0.300000 ](fs=1)
Asql=[ -0.006296 -0.005265 0.045389 -0.100019 ](dB)
au=[ 1 23 41 66 81 108 123 149 163 171 186 195 208 234 251 258 268 282 290 297 309 315 331 339 349 353 359 371 375 381 392 399 ]
f(au)=[ 0.000000 0.027500 0.050000 0.081250 0.100000 0.133750 0.152500 0.185000 0.202500 0.212500 0.231250 0.242500 0.258750 0.291250 0.312500 0.321250 0.333750 0.351250 0.361250 0.370000 0.385000 0.392500 0.412500 0.422500 0.435000 0.440000 0.447500 0.462500 0.467500 0.475000 0.488750 0.497500 ](fs=1)
Asqu=[ -0.010167 -0.005250 -0.000028 -0.000868 -0.002374 0.002048 -0.000016 0.001154 0.000129 -0.019668 -0.000018 -0.011937 -0.022307 -0.076747 -39.471522 -43.119555 -39.880720 -51.483771 -35.950530 -49.926409 -58.769797 -48.409468 -60.511164 -61.314411 -48.712180 -52.803599 -55.967403 -58.516925 -50.727663 -44.408909 -51.343643 -49.991365 ](dB)
tl=[ 173 184 195 206 218 229 240 ]
f(tl)=[ 0.215000 0.228750 0.242500 0.256250 0.271250 0.285000 0.298750 ](fs=1)
Tl=[ 0.035394 0.020224 -0.002753 -0.145091 -0.143882 -0.273850 -0.148516 ](Samples)
tu=[ 168 179 190 200 212 223 234 ]
f(tu)=[ 0.208750 0.222500 0.236250 0.248750 0.263750 0.277500 0.291250 ](fs=1)
Tu=[ -0.029564 -0.032593 -0.002033 0.135542 0.100510 0.166197 0.317581 ](Samples)
vS after exchange constraints:
Current constraints:
al=[ 236 241 ]
f(al)=[ 0.293750 0.300000 ](fs=1)
Asql=[ -0.106587 -0.100019 ](dB)
au=[ 7 27 38 64 78 105 111 121 134 147 159 180 188 204 217 230 239 249 255 266 274 290 ]
f(au)=[ 0.007500 0.032500 0.046250 0.078750 0.096250 0.130000 0.137500 0.150000 0.166250 0.182500 0.197500 0.223750 0.233750 0.253750 0.270000 0.286250 0.297500 0.310000 0.317500 0.331250 0.341250 0.361250 ](fs=1)
Asqu=[ 0.003888 0.003917 0.006088 0.000811 0.000447 0.003452 0.001639 0.004973 0.014304 0.008627 0.004378 0.001197 0.000831 0.000672 0.051384 0.056960 0.000010 -22.906005 -36.776159 -37.982212 -37.810370 -35.950530 ](dB)
tu=[ 241 ]
f(tu)=[ 0.300000 ](fs=1)
Tu=[ 0.773922 ](Samples)
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running octave-cli -q " $prog

octave-cli -q $prog > test.out
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

