#!/bin/sh

prog=local_peak_test.m

depends="iirA.m local_max.m \
test_common.m print_polynomial.m print_pole_zero.m \
local_peak.m local_peak_test.m fixResultNaN.m"
tmp=/tmp/$$
here=`pwd`
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi

fail()
{
        echo FAILED ${0#$here"/"} $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED ${0#$here"/"} $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
for file in $depends;do \
  cp -R src/$file $tmp; \
  if [ $? -ne 0 ]; then echo "Failed cp "$file; fail; fi \
done
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the output should look like this
#
cat > test.ok << 'EOF'
xpeak = [   1.0000000000 ];
ypeak = [   1.0000000000 ];
xpeak = [   1.0000000000 ];
ypeak = [   1.0000000000 ];
ipeak = [    1 ];
idxpeak = [   21,   83,  140,  351, ... 
             413,  478,  691,  817, ... 
            1024 ]';
idxtrough = [    1,   66,   98,  253, ... 
               390,  453,  582,  783, ... 
               913 ]';
xpeak = [  21.3061158377,  82.5340375202, 140.4145230793, 350.6809209417, ... 
          412.8313717463, 478.2955497848, 690.5483875879, 817.0666719841, ... 
          1024.0000000000 ];
ypeak = [   0.9215761123,   0.5141867233,   0.8111575908,   0.9890623887, ... 
            0.6731980982,   0.4830237989,   1.0541250574,   0.4379462964, ... 
            1.3480787315 ];
xpeak = [  21.3061158377,  82.5340375202, 140.4145230793, 350.6809209417, ... 
          412.8313717463, 478.2955497848, 690.5483875879, 817.0666719841, ... 
          1024.0000000000 ];
ypeak = [   0.9215761123,   0.5141867233,   0.8111575908,   0.9890623887, ... 
            0.6731980982,   0.4830237989,   1.0541250574,   0.4379462964, ... 
            1.3480787315 ];
ipeak = [   21,   82,  140,  350, ... 
           412,  478,  690,  817, ... 
          1024 ];
xtrough = [   1.0000000000,  65.8337228793,  98.4862697185, 252.5867141991, ... 
            389.6961633848, 452.7632431220, 582.2224376906, 783.0197667606, ... 
            912.6768055158 ]';
ytrough = [  -0.5493090829,  -0.4994858932,  -0.5016706578,   1.5898798214, ... 
             -0.5929607232,  -0.3801500477,   1.6607317769,  -0.1062006952, ... 
              1.4728999518 ]';
itrough = [    1,   65,   98,  252, ... 
             389,  452,  582,  783, ... 
             912 ]';
xpeak = [   0.1247185618,   0.5007756272,   0.8562730039,   2.1477126341, ... 
            2.5294358006,   2.9315116184,   4.2351518059,   5.0122171291, ... 
            6.2831853072 ];
ypeak = [   0.9215761123,   0.5141867233,   0.8111575908,   0.9890623887, ... 
            0.6731980982,   0.4830237989,   1.0541250574,   0.4379462964, ... 
            1.3480787315 ];
ipeak = [   21,   82,  140,  350, ... 
           412,  478,  690,  817, ... 
          1024 ];
xtrough = [   0.0000000000,   0.3982036119,   0.5987529790,   1.5452257538, ... 
              2.3873411757,   2.7746942048,   3.5698223663,   4.8031037228, ... 
              5.5994470277 ]';
ytrough = [  -0.5493090829,  -0.4994858932,  -0.5016706578,   1.5898798214, ... 
             -0.5929607232,  -0.3801500477,   1.6607317769,  -0.1062006952, ... 
              1.4728999518 ]';
itrough = [    1,   65,   98,  252, ... 
             389,  452,  582,  783, ... 
             912 ]';
wAl = [   0.3842569045,   0.9409128250,   1.9426898051,   2.2935774543, ... 
          2.8352256050 ]';
dAl = [  -0.0968199074,   0.0553457382,  -0.0022206610,  -0.0000367142, ... 
         -0.0000883830 ]';
EOF
if [ $? -ne 0 ]; then echo "Failed output cat"; fail; fi

#
# run and see if the results match
#
echo "Running $prog"

octave-cli -q $prog >test.out 2>&1
if [ $? -ne 0 ]; then echo "Failed running $prog"; fail; fi

diff -Bb test.ok test.out
if [ $? -ne 0 ]; then echo "Failed diff -Bb"; fail; fi


#
# this much worked
#
pass

