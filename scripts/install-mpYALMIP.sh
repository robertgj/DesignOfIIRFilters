#!/bin/sh
# Install sdpa_gmp as a YALMIP solver

#
# Run this script as root!
#

#
# Set Octave directories
#
OCTAVE_VER=8.4.0
OCTAVE_DIR="/usr/local/octave-"$OCTAVE_VER
OCTAVE_SHARE_DIR=$OCTAVE_DIR/share/octave
OCTAVE_BIN_DIR=$OCTAVE_DIR/bin
OCTAVE_CLI=$OCTAVE_BIN_DIR/octave-cli
OCTAVE_LOCAL_VERSION="`$OCTAVE_CLI --eval 'disp(OCTAVE_VERSION);'`"
OCTAVE_SITE_M_DIR=$OCTAVE_SHARE_DIR/$OCTAVE_LOCAL_VERSION/site/m
OCTAVE_MKOCTFILE="$OCTAVE_BIN_DIR/mkoctfile --mex"

#
# Install mpYALMIP
#
MP_YALMIP_VER=1.1.2
MP_YALMIP_ARCHIVE="mpYALMIP-"$MP_YALMIP_VER".tar.gz"
MP_YALMIP_URL="https://github.com/aeroimperial-optimization/mpYALMIP/archive/refs/tags/v"$MP_YALMIP_VER".tar.gz"
if ! test -f $MP_YALMIP_ARCHIVE ; then
    wget -c $MP_YALMIP_URL
    mv "v"$MP_YALMIP_VER".tar.gz" $MP_YALMIP_ARCHIVE
fi
rm -Rf mpYALMIP-$MP_YALMIP_VER
tar -xf $MP_YALMIP_ARCHIVE
cat > mpYALMIP-$MP_YALMIP_VER".patch.uue" <<EOF
begin-base64 644 mpYALMIP-1.1.2.patch
LS0tIG1wWUFMTUlQLTEuMS4yLm9yaWcvaW5zdGFsbF9zZHBhX2dtcC5tCTIw
MTctMDgtMjMgMTg6MDE6NDcuMDAwMDAwMDAwICsxMDAwCisrKyBtcFlBTE1J
UC0xLjEuMi9pbnN0YWxsX3NkcGFfZ21wLm0JMjAyNC0wMi0xMSAxODozMDo0
MC40MTc1NzQ5NzIgKzExMDAKQEAgLTM4LDE1ICszOCw3IEBACiAlIENIRUNL
IElGIFlBTE1JUCBJUyBJTlNUQUxMRUQKICUgLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0gJQogJSBDb3BpZWQgYW5kIGVkaXRlZCBmcm9tIHlhbG1pcHRl
c3QubSwgWUFMTUlQCi1kZXRlY3RlZCA9IHdoaWNoKCd5YWxtaXAubScsJy1h
bGwnKTsKLWlmIGlzYShkZXRlY3RlZCwnY2VsbCcpICYmIH5pc2VtcHR5KGRl
dGVjdGVkKQotICAgIGlmIGxlbmd0aChkZXRlY3RlZCk+MQotICAgICAgICBk
aXNwKCdZb3Ugc2VlbSB0byBoYXZlIG11bHRpcGxlIGluc3RhbGxhdGlvbnMg
b2YgWUFMTUlQIGluIHlvdXIgcGF0aDonKTsKLSAgICAgICAgZGlzcChkZXRl
Y3RlZCkKLSAgICAgICAgZGlzcCgnUGxlYXNlIGNvcnJlY3QgdGhpcywgdGhl
biBydW4gdGhlIGluc3RhbGxhdGlvbiBhZ2Fpbi4nKTsKLSAgICAgICAgcmV0
dXJuCi0gICAgZW5kCi1lbHNlCitpZiB+ZXhpc3QoInlhbG1pcC5tIikKICAg
ICBlcnJvcihbJ0Egd29ya2luZyB2ZXJzaW9uIG9mIFlBTE1JUCBpcyByZXF1
aXJlZC5cbiAnLi4uCiAgICAgICAgICdQbGVhc2UgY29ycmVjdCB0aGlzLCB0
aGVuIHJ1biB0aGUgaW5zdGFsbGF0aW9uIGFnYWluLiddKTsKIGVuZApAQCAt
MTkyLDcgKzE4NCw3IEBACiAlIFJVTiBNRVgKICUgLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0gJQogY2QgdXRpbHM7Ci1tZXggLXNpbGVudCAtbGFyZ2VB
cnJheURpbXMgc2RwYWdtcF9yZWFkX291dHB1dC5jcHAKK21leCgic2RwYWdt
cF9yZWFkX291dHB1dC5jcHAiKTsKIGNkIC4uOwogCiBlbmQKXCBObyBuZXds
aW5lIGF0IGVuZCBvZiBmaWxlCi0tLSBtcFlBTE1JUC0xLjEuMi5vcmlnL3V0
aWxzL2dlbnNkcGFnbXBmaWxlLm0JMjAxNy0wOC0yMyAxODowMTo0Ny4wMDAw
MDAwMDAgKzEwMDAKKysrIG1wWUFMTUlQLTEuMS4yL3V0aWxzL2dlbnNkcGFn
bXBmaWxlLm0JMjAyNC0wMi0xMSAxODozMTozMS43NzYxNzc5NTkgKzExMDAK
QEAgLTQ1LDcgKzQ1LDYgQEAKICVzaG91bGQgYmUgY2hhbmdlZCB0byBmdWxs
IGZvcm1hdCBmaXJzdCBmb3IgdGhlIHJlc3Qgb2YgdGhpcyBmdW5jdGlvbiB0
bwogJW1ha2Ugc2Vuc2UgKHNlZSBiZWxvdyBjYWxscyB0byBiTE9DS3NUUlVD
VChsKSwgYyhrKSBhbmQgdG1wRj1Ge2wsa307CiAldG1wRihpLGopKS4KLUYg
PSBjZWxsZnVuKEBmdWxsLEYsJ1VuaWZvcm1PdXRwdXQnLGZhbHNlKTsKIGMg
PSBmdWxsKGMpOwogYkxPQ0tzVFJVQ1QgPSBmdWxsKGJMT0NLc1RSVUNUKTsK
IApAQCAtODgsNyArODcsNyBAQAogZm9yIGs9MTptRElNKzEKICAgZm9yIGw9
MTpuQkxPQ0sKICAgICBkaW09YWJzKGJMT0NLc1RSVUNUKGwpKTsKLSAgICB0
bXBGPUZ7bCxrfTsKKyAgICB0bXBGPWZ1bGwoRntsLGt9KTsKICAgICBpZiBp
c2VtcHR5KHRtcEYpIAogICAgICAgY29udGludWU7IAogICAgIGVuZAo=
====
EOF
uudecode mpYALMIP-$MP_YALMIP_VER.patch.uue
pushd mpYALMIP-$MP_YALMIP_VER
patch -p 1 < ../mpYALMIP-$MP_YALMIP_VER.patch
rm -Rf $OCTAVE_SITE_M_DIR/SDPA_GMP
mkdir $OCTAVE_SITE_M_DIR/SDPA_GMP
cp -Rf * $OCTAVE_SITE_M_DIR/SDPA_GMP
pushd $OCTAVE_SITE_M_DIR/SDPA_GMP
$OCTAVE_CLI --eval "uninstall_sdpa_gmp;"
OCTAVE_MP_YALMIP_INSTALL_CMD="install_sdpa_gmp(\"$OCTAVE_BIN_DIR/sdpa_gmp\");"
$OCTAVE_CLI --eval $OCTAVE_MP_YALMIP_INSTALL_CMD
popd
popd
# Done
rm -Rf mpYALMIP-$MP_YALMIP_VER
rm -f mpYALMIP-$MP_YALMIP_VER.patch.uue mpYALMIP-$MP_YALMIP_VER.patch

#
# Test
#
$OCTAVE_BIN_DIR/octave --eval "SDPexample"
