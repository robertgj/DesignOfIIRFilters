% bin2SD_test.m
% Copyright (C) 2017,2018 Robert G. Jenssen

test_common;

unlink("bin2SD_test.diary");
unlink("bin2SD_test.diary.tmp");
diary bin2SD_test.diary.tmp

check_octave_file("bin2SD");

try
  y=bin2SD([6:7],4,1);
catch err
  printf("Caught sd=bin2SD([6:7],4,1): %s\n",err.message);
end_try_catch

% Test vectors : {num, nbits, ndigits}
max_nbits=floor(log2(flintmax()))-2;
testvecs={...
{1,max_nbits,max_nbits+1},...
{1,max_nbits+1,max_nbits},...
{1,8,9},...
{1,8,0},...
{1,8,-1},...
{1,0,8},...
{1,0,0},...
{0,8,1},...
{0,8,1},...
{0,8,8},...
{0,8,8},...
{0,1,1},...
{1,1,1},...
{2,1,1},...
{-1,1,1},...
{0,2,1},...
{1,2,1},...
{-1,2,1},...
{-2,2,1},...
{1,8,1},...
{1,8,1},...
{1,8,8},...
{1,8,8},...
{-1,8,1},...
{-1,8,1},...
{-1,8,8},...
{-1,8,8},...
{1.5,8,1},...
{-1.5,8,1},...
{1.5,8,2},...
{-1.5,8,2},...
{1.5,8,8},...
{-1.5,8,8},...
{-43,7,1},...
{-43,7,2},...
{-43,7,3},...
{-43,7,4},...
{-43,7,5},...
{43,7,1},...
{43,7,2},...
{43,7,3},...
{43,7,4},...
{43,7,5},...
{-43.4,7,1},...
{-43.4,7,2},...
{-43.4,7,3},...
{-43.4,7,4},...
{-43.4,7,5},...
{43.4,7,1},...
{43.4,7,2},...
{43.4,7,3},...
{43.4,7,4},...
{43.4,7,5},...
{-43.6,7,1},...
{-43.6,7,2},...
{-43.6,7,3},...
{-43.6,7,4},...
{-43.6,7,5},...
{43.6,7,1},...
{43.6,7,2},...
{43.6,7,3},...
{43.6,7,4},...
{43.6,7,5},...
{-42.9,7,1},...
{-42.9,7,2},...
{-42.9,7,3},...
{-42.9,7,4},...
{-42.9,7,5},...
{42.9,7,1},...
{42.9,7,2},...
{42.9,7,3},...
{42.9,7,4},...
{42.9,7,5},...
{bin2dec("010001101"),9,4},...
{-bin2dec("010001101"),9,4},...
{bin2dec("10101010"),9,1},...
{bin2dec("10101010"),9,2},...
{bin2dec("10101010"),9,3},...
{bin2dec("10101010"),9,4},...
{bin2dec("10101010"),9,5},...
{-bin2dec("10101010"),9,1},...
{-bin2dec("10101010"),9,2},...
{-bin2dec("10101010"),9,3},...
{-bin2dec("10101010"),9,4},...
{-bin2dec("10101010"),9,5},...
{128,8,1},...
{128,9,1},...
{-128,8,1},...
{127,8,1},...
{127,8,2},...
{127,8,8},...
{127,max_nbits,8},...
{127,max_nbits,max_nbits},...
{-128,max_nbits,8},...
{-128,max_nbits,max_nbits},...
{128,8,2},...
{-129,8,2},...
{63.49,7,2},...
{63.51,7,2}};

function sd=testfun(vec)
  args=cell2mat(vec);
  x=args(1);
  nbits=args(2);
  ndigits=args(3);
  try
    y=bin2SD(x,nbits,ndigits);
    try
      spt=bin2SPT(y,nbits);
      printf("x=%6g, y=%d, spt(%d:-1:1)=[ ",x,y,nbits);
      printf("%2d ",fliplr(spt(:)'));
      printf("], ndigits=%d\n",sum(abs(spt)));
    catch err
      printf("Caught spt=bin2SPT(%g,%d): %s\n",x,nbits,err.message);
    end_try_catch
  catch err
    printf("Caught y=bin2SD(%g,%d,%d): %s\n",x,nbits,ndigits,err.message);
  end_try_catch
endfunction

cellfun(@testfun,testvecs,"UniformOutput",false);

% Exhaustive test
nbits=8;
ndigits=2;
nscale=2^(nbits-1);
for k=-nscale:(nscale-1)
  y=bin2SD(k,nbits,ndigits);
  spt=bin2SPT(y,nbits);
  printf("k=%4d, y=%4d, k-y=%2d, spt(%d:-1:1)=[",k,y,k-y,nbits);
  printf("%2d ",fliplr(spt(:)'));
  printf("], ndigits=%d\n",sum(abs(spt)));
endfor

% Done
diary off
movefile bin2SD_test.diary.tmp bin2SD_test.diary;
