% sv_feedback_symbolic_test.m
% Copyright (C) 2024-2025 Robert G. Jenssen

test_common;

strf="sv_feedback_symbolic_test";
delete(strcat(strf,".diary.tmp"));
delete(strcat(strf,".diary"));
eval(sprintf("diary %s.diary.tmp",strf));

pkg load symbolic

%
% Problem 8.9 from p.175 of "Digital Signal Processing", Roberts and Mullis
%

syms X1p A1 x1 B1 B2 u1 u2 y1 y2 C1 C2 D11 D12 D21 D22
x1p=A1*x1+[B1,B2]*[u1;u2]
y1=C1*x1+[D11,D12]*[u1;u2]
y2=C2*x1+[D21,D22]*[u1;u2]

syms x2p A2 x2 b1 b2 w1 w2 v1 v2 c1 c2 d11 d12 d21 d22
x2p=A2*x2+[b1,b2]*[w1;w2]
v1=c1*x2+[d11,d12]*[w1;w2]
v2=c2*x2+[d21,d22]*[w1;w2]

I=1
M1=[[0, c1,0, d12]; ...
    [I, 0, 0, 0]; ...
    [0, I, 0, 0]; ...
    [0, 0, I, 0]; ...
    [0, 0, 0, I]]
M2=[[B2,  A1, 0,  B1, 0]; ...
    [D12, C1, 0, D11, 0]; ...
    [D22, C2, 0, D21, 0]; ...
    [  I,  0, 0,   0, 0]; ...
    [  0,  I, 0,   0, 0]; ...
    [  0,  0, I,   0, 0]; ...
    [  0,  0, 0,   I, 0]; ...
    [  0,  0, 0,   0, I]]
M3=[[0,  0,  b1,  0,  0, A2, 0,  b2]; ...
    [0,  0, d21,  0,  0, c2, 0, d22]; ...
    [I,  0,   0,  0,  0,  0, 0,   0]; ...
    [0,  I,   0,  0,  0,  0, 0,   0]; ...
    [0,  0,   I,  0,  0,  0, 0,   0]; ...
    [0,  0,   0,  I,  0,  0, 0,   0]; ...
    [0,  0,   0,  0,  I,  0, 0,   0]; ...
    [0,  0,   0,  0,  0,  I, 0,   0]; ...
    [0,  0,   0,  0,  0,  0, I,   0]; ...
    [0,  0,   0,  0,  0,  0, 0,   I]]
M4=[[0,  0,   I,  0,  0,  0, 0,   0, 0, 0]; ...
    [I,  0,   0,  0,  0,  0, 0,   0, 0, 0]; ...
    [0,  0,   0,  I,  0,  0, 0,   0, 0, 0]; ...
    [0,  I,   0,  0,  0,  0, 0,   0, 0, 0]]

MAbcd=M4*M3*M2*M1

Abcd=[A1,B2*c1,B1,B2*d12; ...
      b1*C2,(b1*D22*c1+A2),b1*D21,(b1*D22*d12+b2); ...
      C1,D12*c1,D11,D12*d12; ...
      d21*C2,(d21*D22*c1+c2),d21*D21,(d21*D22*d12+d22)];

if any(any(MAbcd-Abcd))
  error("any(any(MAbcd-Abcd))");
endif

%
% Alternative feedback connection
%
syms A
x1p = A*x1 + [B1,B2]*[u1;u2]
y1 = C1*x1 + [D11,D12]*[u1;u2]
y2 = C2*x1 + [D21,D22]*[u1;u2]

syms a b c d v w
x2p = a*x2 + b*w
v = c*x2+d*w

N1=[[0, c, 0]; ...
    [I, 0, 0]; ...
    [0, I, 0]; ...
    [0, 0, I]]
N2=[[B2,   A, 0,  B1]; ...
    [D12, C1, 0, D11]; ...
    [D22, C2, 0, D21]; ...
    [  I,  0, 0,   0]; ...
    [  0,  I, 0,   0]; ...
    [  0,  0, I,   0]; ...
    [  0,  0, 0,   I]]
N3=[[  0,  0, b,   0, 0, a, 0]; ...
    [  I,  0, 0,   0, 0, 0, 0]; ...
    [  0,  I, 0,   0, 0, 0, 0]; ...
    [  0,  0, I,   0, 0, 0, 0]; ...
    [  0,  0, 0,   I, 0, 0, 0]; ...
    [  0,  0, 0,   0, I, 0, 0]; ...
    [  0,  0, 0,   0, 0, I, 0]; ...
    [  0,  0, 0,   0, 0, 0, I]]
N4=[[  0,  I, 0,   0, 0, 0, 0, 0]; ...
    [  I,  0, 0,   0, 0, 0, 0, 0]; ...
    [  0,  0, I,   0, 0, 0, 0, 0]; ...
    [  0,  0, 0,   I, 0, 0, 0, 0]]

NAbcd=N4*N3*N2*N1

Abcd=[A,B2*c,B1; ...
      b*C2,(b*c*D22)+a,b*D21; ...
      C1,c*D12,D11; ...
      C2,c*D22,D21];

if any(any(NAbcd-Abcd))
  error("any(any(NAbcd-Abcd))");
endif

%
% Another feedback connection
%
syms A
x1p = A*x1 + [B1,B2]*[u1;u2]
y1 = C1*x1 + [D11,D12]*[u1;u2]
y2 = C2*x1 + [D21,D22]*[u1;u2]

syms a b c d v w
x2p = a*x2 + b*w
v = c*x2 + d*w

O1=[[C2, 0, D21]; ...
    [I, 0, 0]; ...
    [0, I, 0]; ...
    [0, 0, I]]
O2=[[b, 0, a, 0]; ...
    [d, 0, c, 0]; ...
    [I, 0, 0, 0]; ...
    [0, I, 0, 0]; ...
    [0, 0, I, 0]; ...
    [0, 0, 0, I]]
O3=[[  B2,  0, 0,  A, 0, B1 ]; ...
    [ D12,  0, 0, C1, 0, D11]; ...
    [   I,  0, 0,  0, 0, 0]; ...
    [   0,  I, 0,  0, 0, 0]; ...
    [   0,  0, I,  0, 0, 0]; ...
    [   0,  0, 0,  I, 0, 0]; ...
    [   0,  0, 0,  0, I, 0]; ...
    [   0,  0, 0,  0, 0, I]]
O4=[[ I, 0, 0, 0, 0, 0, 0, 0]; ...
    [ 0, 0, I, 0, 0, 0, 0, 0]; ...
    [ 0, I, 0, 0, 0, 0, 0, 0]; ...
    [ 0, 0, 0, 0, I, 0, 0, 0]]

OAbcd=O4*O3*O2*O1

Abcd=[A + (B2*b*C2),B2*a,B1 + (B2*b*D21); ...
      b*C2,a,b*D21; ...
      C1 + (D12*b*C2),D12*a,D11 + (D12*b*D21); ...
      C2,0,D21];

if any(any(OAbcd-Abcd))
  error("any(any(OAbcd-Abcd))");
endif

% Done
diary off
movefile(strcat(strf,".diary.tmp"),strcat(strf,".diary"));
