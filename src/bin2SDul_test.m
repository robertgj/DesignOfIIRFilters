% bin2SDul_test.m
% Copyright (C) 2017,2018 Robert G. Jenssen

test_common;

unlink("bin2SDul_test.diary");
unlink("bin2SDul_test.diary.tmp");
diary bin2SDul_test.diary.tmp

format short e

try
  [yu,yl]=bin2SDul([6:7],4,1);
catch err
  printf("Caught sd=bin2SDul([6:7],4,1): %s\n",err.message);
end_try_catch

% Test vectors : {num, nbits, ndigits}
max_nbits=floor(log2(flintmax()))-2;
testvecs={...
{1,max_nbits,max_nbits+1},...
{1,max_nbits+1,max_nbits},...
{1,8,9},...
{1,8,0},...
{1,8,-1},...
{1,0,8},...
{1,0,0},...
{0,8,1},...
{0,8,1},...
{0.499999,8,1},...
{-0.499999,8,1},...
{0.5,8,1},...
{-0.5,8,1},...
{0.500001,8,1},...
{-0.500001,8,1},...
{0,8,8},...
{0,8,8},...
{0,1,1},...
{1,1,1},...
{2,1,1},...
{-1,1,1},...
{0,2,1},...
{1,2,1},...
{-1,2,1},...
{-2,2,1},...
{1,8,1},...
{1,8,1},...
{1,8,8},...
{1,8,8},...
{-1,8,1},...
{-1,8,1},...
{-1,8,8},...
{-1,8,8},...
{1.5,8,1},...
{-1.5,8,1},...
{1.5,8,2},...
{-1.5,8,2},...
{1.5,8,8},...
{-1.5,8,8},...
{-43,7,1},...
{-43,7,2},...
{-43,7,3},...
{-43,7,4},...
{-43,7,5},...
{43,7,1},...
{43,7,2},...
{43,7,3},...
{43,7,4},...
{43,7,5},...
{-43.4,7,1},...
{-43.4,7,2},...
{-43.4,7,3},...
{-43.4,7,4},...
{-43.4,7,5},...
{43.4,7,1},...
{43.4,7,2},...
{43.4,7,3},...
{43.4,7,4},...
{43.4,7,5},...
{-43.6,7,1},...
{-43.6,7,2},...
{-43.6,7,3},...
{-43.6,7,4},...
{-43.6,7,5},...
{43.6,7,1},...
{43.6,7,2},...
{43.6,7,3},...
{43.6,7,4},...
{43.6,7,5},...
{-42.9,7,1},...
{-42.9,7,2},...
{-42.9,7,3},...
{-42.9,7,4},...
{-42.9,7,5},...
{42.9,7,1},...
{42.9,7,2},...
{42.9,7,3},...
{42.9,7,4},...
{42.9,7,5},...
{bin2dec("010001101"),9,4},...
{-bin2dec("010001101"),9,4},...
{bin2dec("10101010"),9,1},...
{bin2dec("10101010"),9,2},...
{bin2dec("10101010"),9,3},...
{bin2dec("10101010"),9,4},...
{bin2dec("10101010"),9,5},...
{-bin2dec("10101010"),9,1},...
{-bin2dec("10101010"),9,2},...
{-bin2dec("10101010"),9,3},...
{-bin2dec("10101010"),9,4},...
{-bin2dec("10101010"),9,5},...
{128,8,1},...
{128,9,1},...
{-128,8,1},...
{127,8,1},...
{127,8,2},...
{127,8,8},...
{127,max_nbits,8},...
{127,max_nbits,max_nbits},...
{-128,max_nbits,8},...
{-128,max_nbits,max_nbits},...
{128,8,2},...
{-129,8,2},...
{63.49,7,2},...
{63.51,7,2}};

function sd=testfun(vec)
  args=cell2mat(vec);
  x=args(1);
  nbits=args(2);
  ndigits=args(3);
  try
    [yu,yl]=bin2SDul(x,nbits,ndigits);
    if yu<x
      error("yu(%d)<x(%d)",yu,x);
    endif
    if yl>x
      error("yl(%d)>x(%d)",yl,x);
    endif
    try
      sptu=bin2SPT(yu,nbits);
      printf("x=%6g, yu=%d, spt(%d:-1:1)=[ ",x,yu,nbits);
      printf("%2d ",fliplr(sptu(:)'));
      printf("], ndigits=%d\n",sum(abs(sptu)));

      sptl=bin2SPT(yl,nbits);
      printf("x=%6g, yl=%d, sptl(%d:-1:1)=[ ",x,yl,nbits);
      printf("%2d ",fliplr(sptl(:)'));
      printf("], ndigits=%d\n",sum(abs(sptl)));
    catch err
      printf("Caught spt=bin2SPT(%g,%d): %s\n",x,nbits,err.message);
    end_try_catch
  catch err
    printf("Caught [yu,yl]=bin2SDul(%g,%d,%d):%s\n",x,nbits,ndigits,err.message);
  end_try_catch

endfunction

cellfun(@testfun,testvecs,"UniformOutput",false);

% Exhaustive test
nbits=8;
ndigits=2;
nscale=2^(nbits-1);
for k=(-nscale):0.25:(nscale-1)
  [yu,yl]=bin2SDul(k,nbits,ndigits);
  if yu<k
    error("yu(%d)<k(%d)",yu,k);
  endif
  if yl>k
    error("yl(%d)>k(%d)",yl,k);
  endif
%
  sptu=bin2SPT(yu,nbits);
  printf("k=%4d, yu=%4d, k-yu=%2d, sptu(%d:-1:1)=[",k,yu,k-yu,nbits);
  printf("%2d ",fliplr(sptu(:)'));
  printf("], ndigits=%d\n",sum(abs(sptu)));
%
  sptl=bin2SPT(yl,nbits);
  printf("k=%4d, yl=%4d, k-yl=%2d, sptl(%d:-1:1)=[",k,yl,k-yl,nbits);
  printf("%2d ",fliplr(sptl(:)'));
  printf("], ndigits=%d\n",sum(abs(sptl)));
endfor

% Done
diary off
movefile bin2SDul_test.diary.tmp bin2SDul_test.diary;
