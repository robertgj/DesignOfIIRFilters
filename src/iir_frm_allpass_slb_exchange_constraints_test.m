% iir_frm_allpass_slb_exchange_constraints_test.m
% Copyright (C) 2017-2020 Robert G. Jenssen

test_common;

delete("iir_frm_allpass_slb_exchange_constraints_test.diary");
delete("iir_frm_allpass_slb_exchange_constraints_test.diary.tmp");
diary iir_frm_allpass_slb_exchange_constraints_test.diary.tmp


maxiter=2000
tol=5e-6
verbose=true

%
% Filter specification
%
Mmodel=9; % Model filter decimation
Dmodel=9; % Desired model filter passband delay
dmask=16 % FIR masking filter delay
tp=(Mmodel*Dmodel)+dmask % FRM filter nominal passband delay
fap=0.3; % Pass band edge
dBap=0.1; % Pass band amplitude ripple
Wap=1; % Pass band amplitude weight
tpr=2; % Pass band delay ripple
Wtp=1; % Pass band delay weight
fas=0.31; % Pass band edge
dBas=50; % Stop band amplitude ripple
Was=10; % Stop band amplitude weight
rho=31/32; % Stability constraint on pole radius

%
% Use the filters found by tarczynski_frm_allpass_test.m
% and iir_frm_allpass_slb_test.m
%
x0.R = 1;
x0.r = [   1.0000000000,   0.1111701595,   0.4712820723,  -0.0512805016, ... 
          -0.0836348855,   0.0288364356,   0.0159210683,  -0.0225225935, ... 
           0.0238732656,  -0.0284983899,   0.0059206039 ]';
x0.aa = [  0.0025077062,   0.0058072416,  -0.0007421407,  -0.0055606315, ... 
           0.0040763056,   0.0086813387,  -0.0058418127,  -0.0080984186, ... 
           0.0101746570,   0.0016145508,  -0.0245720071,   0.0002811194, ... 
           0.0298163129,  -0.0161047983,  -0.0436018451,   0.0360554548, ... 
           0.0491578998,  -0.0847490457,  -0.0492554433,   0.3149080798, ... 
           0.5554585515,   0.3149080798,  -0.0492554433,  -0.0847490457, ... 
           0.0491578998,   0.0360554548,  -0.0436018451,  -0.0161047983, ... 
           0.0298163129,   0.0002811194,  -0.0245720071,   0.0016145508, ... 
           0.0101746570,  -0.0080984186,  -0.0058418127,   0.0086813387, ... 
           0.0040763056,  -0.0055606315,  -0.0007421407,   0.0058072416, ... 
           0.0025077062 ]';
x0.ac = [ -0.0053954280,  -0.0022268914,   0.0077389437,  -0.0013056655, ... 
          -0.0095571878,   0.0056395569,   0.0028485881,  -0.0110688241, ... 
           0.0067042914,  -0.0034449590,  -0.0220966358,   0.0219303388, ... 
           0.0152287988,  -0.0466602405,   0.0130432437,   0.0412544031, ... 
          -0.0703443720,   0.0137981670,   0.1134886186,  -0.2850078130, ... 
          -0.6368691872,  -0.2850078130,   0.1134886186,   0.0137981670, ... 
          -0.0703443720,   0.0412544031,   0.0130432437,  -0.0466602405, ... 
           0.0152287988,   0.0219303388,  -0.0220966358,  -0.0034449590, ... 
           0.0067042914,  -0.0110688241,   0.0028485881,   0.0056395569, ... 
          -0.0095571878,  -0.0013056655,   0.0077389437,  -0.0022268914, ... 
          -0.0053954280 ]';
x1.R = 1;
x1.r = [   1.0000000000,  -0.0066627365,   0.5019431735,  -0.0188210659, ... 
          -0.1087625979,   0.0037712106,   0.0446205663,  -0.0240548408, ... 
           0.0093578228,  -0.0096691538,   0.0016004592 ]';
x1.aa = [ -0.0049945828,   0.0010840695,   0.0069182190,  -0.0067958974, ... 
          -0.0028147376,   0.0082495103,  -0.0033163893,  -0.0091390993, ... 
           0.0085612358,   0.0170333231,  -0.0162234133,  -0.0169425248, ... 
           0.0345376475,  -0.0004946352,  -0.0440868969,   0.0319383949, ... 
           0.0523588686,  -0.0830048075,  -0.0688828272,   0.3065072427, ... 
           0.5776234066,   0.3065072427,  -0.0688828272,  -0.0830048075, ... 
           0.0523588686,   0.0319383949,  -0.0440868969,  -0.0004946352, ... 
           0.0345376475,  -0.0169425248,  -0.0162234133,   0.0170333231, ... 
           0.0085612358,  -0.0091390993,  -0.0033163893,   0.0082495103, ... 
          -0.0028147376,  -0.0067958974,   0.0069182190,   0.0010840695, ... 
          -0.0049945828 ]';
x1.ac = [  0.0023700162,  -0.0051952222,   0.0037855376,   0.0022131331, ... 
          -0.0062056424,   0.0020676710,   0.0067617111,  -0.0100252351, ... 
           0.0025128287,   0.0144155373,  -0.0242446441,   0.0098442111, ... 
           0.0209659840,  -0.0342315570,   0.0046912057,   0.0476970408, ... 
          -0.0659309309,   0.0049578111,   0.1337063068,  -0.2821383795, ... 
          -0.6536933528,  -0.2821383795,   0.1337063068,   0.0049578111, ... 
          -0.0659309309,   0.0476970408,   0.0046912057,  -0.0342315570, ... 
           0.0209659840,   0.0098442111,  -0.0242446441,   0.0144155373, ... 
           0.0025128287,  -0.0100252351,   0.0067617111,   0.0020676710, ... 
          -0.0062056424,   0.0022131331,   0.0037855376,  -0.0051952222, ... 
           0.0023700162 ]';

% Frequency vectors
n=1000;
w=(0:(n-1))'*pi/n;
nap=ceil(fap*n/0.5)+1;
nas=floor(fas*n/0.5)+1;

% Amplitude constraints
Wa=[Wap*ones(nap,1);zeros(nas-nap-1,1);Was*ones(n-nas+1,1)];
Asqd=[ones(nap,1);zeros(n-nap,1)];
Asqdu=[ones(nas-1,1);(10^(-dBas/10))*ones(n-nas+1,1)];
Asqdl=[(10^(-dBap/10))*ones(nap,1);zeros(n-nap,1)];

% Group delay constraints
Wt=Wtp*ones(nap,1);
Td=zeros(nap,1);
Tdu=Td+(tpr/2);
Tdl=Td-(tpr/2);

% Convert x0 and x1 to vector form
[x0k,Vr,Qr,Rr,na,nc]=iir_frm_allpass_struct_to_vec(x0);
[x1k,Vr,Qr,Rr,na,nc]=iir_frm_allpass_struct_to_vec(x1);

% Response of x0k
[Asqx0,Tx0]=iir_frm_allpass(w,x0k,Vr,Qr,Rr,na,nc,Mmodel,Dmodel);
Tx0=Tx0(1:nap);

% Response of x1k
[Asqx1,Tx1]=iir_frm_allpass(w,x1k,Vr,Qr,Rr,na,nc,Mmodel,Dmodel);
Tx1=Tx1(1:nap);

% Update constraints
vRx0=iir_frm_allpass_slb_update_constraints ...
       (Asqx0,Asqdu,Asqdl,Wa,Tx0,Tdu,Tdl,Wt,tol);
vSx1=iir_frm_allpass_slb_update_constraints ...
       (Asqx1,Asqdu,Asqdl,Wa,Tx1,Tdu,Tdl,Wt,tol);

% Show constraints
printf("vRx0 before exchange constraints:\n");
iir_frm_allpass_slb_show_constraints(vRx0,w,Asqx0,Tx0);
printf("vSx1 before exchange constraints:\n");
iir_frm_allpass_slb_show_constraints(vSx1,w,Asqx1,Tx1);

% Plot amplitude
strd=sprintf("iir_frm_allpass_slb_exchange_constraints_test_%%s");
strM=sprintf("%%s:fap=%g,dBap=%g,Wap=%g,fas=%g,dBas=%g,Was=%g,tpr=%g,Wtp=%g",
             fap,dBap,Wap,fas,dBas,Was,tpr,Wtp);
f=w*0.5/pi;
subplot(211);
plot(f(1:nap),10*log10([Asqx0(1:nap),Asqdu(1:nap),Asqdl(1:nap)]), ...
     f(vRx0.al),10*log10(Asqx0(vRx0.al)),'*', ...
     f(vRx0.au),10*log10(Asqx0(vRx0.au)),'+');
axis([0,fap,-1,1]);
strMx0=sprintf(strM,"x0");
title(strMx0);
ylabel("Amplitude(dB)");
subplot(212);
plot(f(nas:end),10*log10([Asqx0(nas:end),Asqdu(nas:end)]), ...
     f(vRx0.al),10*log10(Asqx0(vRx0.al)),'*', ...
     f(vRx0.au),10*log10(Asqx0(vRx0.au)),'+');
axis([fas,0.5,-60,-40]);
ylabel("Amplitude(dB)");
xlabel("Frequency")
print(sprintf(strd,"x0A"),"-dpdflatex");
close

% Plot group delay
ft=w(1:nap)*0.5/pi;
plot(ft,[Tx0(1:nap),Tdu,Tdl], ...
     ft(vRx0.tl),Tx0(vRx0.tl),'*', ...
     ft(vRx0.tu),Tx0(vRx0.tu),'+');
title(strMx0);
ylabel("Delay(samples)");
xlabel("Frequency")
print(sprintf(strd,"x0T"),"-dpdflatex");
close

% Exchange constraints
[vRx1,vSx1,exchanged] = ...
iir_frm_allpass_slb_exchange_constraints ...
  (vSx1,vRx0,Asqx1,Asqdu,Asqdl,Tx1,Tdu,Tdl,tol);
printf("vRx1 after exchange constraints:\n");
iir_frm_allpass_slb_show_constraints(vRx1,w,Asqx1,Tx1);
printf("vSx1 after exchange constraints:\n");
iir_frm_allpass_slb_show_constraints(vSx1,w,Asqx1,Tx1);

% Plot amplitude
subplot(211);
plot(f(1:nap),10*log10([Asqx0(1:nap),Asqx1(1:nap), ...
                 Asqdu(1:nap),Asqdl(1:nap)]), ...
     f(vRx0.al),10*log10(Asqx0(vRx0.al)),'*', ...
     f(vRx0.au),10*log10(Asqx0(vRx0.au)),'+', ...
     f(vSx1.al),10*log10(Asqx0(vSx1.al)),'*', ...
     f(vSx1.au),10*log10(Asqx1(vSx1.au)),'+');
axis([0,fap,-1,1]);
strMx1=sprintf(strM,"x1");
title(strMx1);
ylabel("Amplitude(dB)");
subplot(212);
plot(f(nas:end), ...
     10*log10([Asqx0(nas:end),Asqx1(nas:end),Asqdu(nas:end), ...
               Asqdu(nas:end)+tol*ones(n-nas+1,1)]), ...
     f(vRx0.al),10*log10(Asqx0(vRx0.al)),'*', ...
     f(vRx0.au),10*log10(Asqx0(vRx0.au)),'+', ...
     f(vSx1.al),10*log10(Asqx1(vSx1.al)),'*', ...
     f(vSx1.au),10*log10(Asqx1(vSx1.au)),'+');
% axis([0,0.5,0,10^(-2*dBas/20)]);
axis([fas 0.5 -60 -30]);
ylabel("Amplitude(dB)");
xlabel("Frequency")
legend("Asqx0","Asqx1","Asqdu","Asqdu+tol","location","north");
legend("boxoff");
print(sprintf(strd,"x1A"),"-dpdflatex");
close

% Plot group delay
plot(ft,[Tx0(1:nap),Tx1(1:nap),Tdu,Tdl], ...
     ft(vRx0.tl),Tx0(vRx0.tl),'*',f(vRx0.tu),Tx0(vRx0.tu),'+', ...
     ft(vSx1.tl),Tx1(vSx1.tl),'*',f(vSx1.tu),Tx1(vSx1.tu),'+');
axis([0 fap -(tpr*2) +(tpr*15)]);
title(strMx1);
ylabel("Delay(samples)");
xlabel("Frequency")
legend("Tx0","Tx1","Tdu","Tdl","location","northwest");
legend("boxoff");
print(sprintf(strd,"x1T"),"-dpdflatex");
close

% Done
diary off
movefile iir_frm_allpass_slb_exchange_constraints_test.diary.tmp ...
       iir_frm_allpass_slb_exchange_constraints_test.diary;
